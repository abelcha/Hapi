var archiveReglementController = function(edisonAPI, TabContainer, $routeParams, $location, LxProgressService) {

    var tab = TabContainer.getCurrentTab();
    var _this = this;
    _this.title = 'Archives Reglements'
    tab.setTitle('archives RGL')
    LxProgressService.circular.show('#5fa2db', '#globalProgress');
    edisonAPI.compta.archivesReglement().success(function(resp) {
        LxProgressService.circular.hide()
        _this.data = resp
    })
    _this.moment = moment;
    _this.openLink = function(link) {
        $location.url(link)
    }
}

angular.module('edison').controller('archivesReglementController', archiveReglementController);

var archivesPaiementController = function(edisonAPI, TabContainer, $routeParams, $location, LxProgressService) {
    var _this = this;
    var tab = TabContainer.getCurrentTab();
    _this.type = 'paiement'
    _this.title = 'Archives Paiements'
    tab.setTitle('archives PAY')
    LxProgressService.circular.show('#5fa2db', '#globalProgress');
    edisonAPI.compta.archivesPaiement().success(function(resp) {
        LxProgressService.circular.hide()
        _this.data = resp
    })
    _this.moment = moment;
    _this.openLink = function(link) {
        $location.url(link)
    }
}

angular.module('edison').controller('archivesPaiementController', archivesPaiementController);
 angular.module('edison').directive('artisanCategorie', ['config', function(config) {
     "use strict";
     return {
         replace: true,
         restrict: 'E',
         templateUrl: '/Templates/artisan-categorie.html',
         transclude: true,
         scope: {
             model: "=",
         },
         link: function(scope, element, attrs) {
             scope.config = config
             scope.findColor = function(categorie) {
                 var f = _.find(scope.model.categories, function(e)  {
                     return e === categorie.short_name
                 })
                 return f ? categorie.color : "white";

             }
             scope.toggleCategorie = function(categorie) {
                var f = scope.model.categories.indexOf(categorie);
                if (f >= 0) {
                    scope.model.categories.splice(f, 1);
                } else {
                    scope.model.categories.push(categorie)
                }
             }
         },
     }

 }]);
var ArtisanCtrl = function($timeout, $rootScope, $scope, edisonAPI, $location, $routeParams, ContextMenu, LxProgressService, LxNotificationService, TabContainer, config, dialog, artisanPrm, Artisan) {
    "use strict";
    var _this = this;
    _this.config = config;
    _this.dialog = dialog;
    _this.moment = moment;
    _this.contextMenu = new ContextMenu('artisan')
    console.log('==>', artisanPrm)
    var tab = TabContainer.getCurrentTab();
    if (!tab.data) {
        var artisan = new Artisan(artisanPrm.data)
        tab.setData(artisan);
        if ($routeParams.id.length > 12) {
            _this.isNew = true;
            artisan.tmpID = $routeParams.id;
            tab.setTitle('SST  ' + moment((new Date(parseInt(artisan.tmpID))).toISOString()).format("HH:mm").toString());
        } else {
            tab.setTitle('SST  ' + $routeParams.id);
            if (!artisan) {
                LxNotificationService.error("Impossible de trouver les informations !");
                $location.url("/dashboard");
                TabContainer.remove(tab);
                return 0;
            }
        }
    } else {
        var artisan = tab.data;
    }
    _this.data = tab.data;
    _this.saveArtisan = function(options) {
        artisan.save(function(err, resp) {
            if (err) {
                return false
            } else if (options.contrat) {
                artisan = new Artisan(resp);
                artisan.envoiContrat.bind(resp)(function(err, res) {
                    if (!err) {
                        TabContainer.close(tab);
                    }
                });
            } else {
                TabContainer.close(tab);
            }
        })
    }
    _this.onArtisanFileUpload = function(file, name) {
        LxProgressService.circular.show('#5fa2db', '#fileUploadProgress');
        edisonAPI.artisan.upload(file, name, artisan.id).then(function() {
            console.log('reload')
            LxProgressService.circular.hide()
            _this.loadFilesList();
        })
    }

    _this.artisanClickTrigger = function(elem) {
        setTimeout(function() {
            angular.element("#file_" + elem + ">input").trigger('click');
        }, 0)

    }
    _this.rightClick = function($event) {
        console.log('rightClick')
        _this.contextMenu.setPosition($event.pageX, $event.pageY)
        _this.contextMenu.setData(artisan);
        _this.contextMenu.open();
    }

    _this.fileExist = function(name) {
        if (!artisan.file)
            return false;
        return _.find(artisan.file, function(e) {
            return _.startsWith(e, name)
        });
    }

    _this.loadFilesList = function() {
        edisonAPI.artisan.getFiles(artisan.id).then(function(result) {
            artisan.file = result.data;
            console.log('==>', artisan.file)
        }, console.log)
    }
    if (artisan.id) {
        _this.loadFilesList();
    }

    _this.addComment = function() {

        artisan.comments.push({
            login: $rootScope.user.login,
            text: _this.commentText,
            date: new Date()
        })
        if (artisan.id) {
            edisonAPI.artisan.comment(artisan.id, _this.commentText)
        }
        _this.commentText = "";
    }
    var updateTmpArtisan = _.after(5, _.throttle(function() {
        edisonAPI.artisan.saveTmp(artisan);

    }, 2000))

    if (!artisan.id) {
        $scope.$watch(function() {
            return artisan;
        }, updateTmpArtisan, true)
    }
}
angular.module('edison').controller('ArtisanController', ArtisanCtrl);
var AvoirsController = function(TabContainer, openPost, edisonAPI, $rootScope, LxProgressService, LxNotificationService, FlushList) {
    "use strict";
    var _this = this
    var tab = TabContainer.getCurrentTab();
    tab.setTitle('Avoirs')
    _this.loadData = function(prevChecked) {
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        edisonAPI.compta.avoirs().then(function(result) {
            console.log(result)
            $rootScope.avoirs = result.data
            LxProgressService.circular.hide()
        })
    }
    if (!$rootScope.avoirs)
        _this.loadData()

    _this.reloadAvoir = function() {
        _this.loadData()
    }

    _this.print = function(type) {
        console.log($rootScope.avoirs);
        openPost('/api/intervention/printAvoir', {
            data: $rootScope.avoirs
        });
    }

    _this.flush = function() {
        var list = _.filter($rootScope.avoirs, {
            checked: true
        })
        edisonAPI.compta.flushAvoirs(list).then(function(resp) {
            LxNotificationService.success(resp.data);
            _this.reloadAvoir()
        }).catch(function(err) {
            LxNotificationService.error(err.data);
        })
    }

}


angular.module('edison').controller('avoirsController', AvoirsController);
var ContactArtisanController = function($scope, $timeout, TabContainer, LxProgressService, FiltersFactory, ContextMenu, edisonAPI, DataProvider, $routeParams, $location, $q, $rootScope, $filter, config, ngTableParams) {
    "use strict";
    var _this = this;

    _this.loadPanel = function(id) {
        edisonAPI.artisan.get(id)
            .then(function(resp) {
                _this.sst = resp.data;
                console.log(TabContainer)
                _this.tab.setTitle('@' + _this.sst.nomSociete.slice(0, 10));

            })
        edisonAPI.artisan.getStats(id).then(function(resp) {
            new Chartist.Pie('.ct-chart', {
                series: [{
                    value: resp.data.envoye.total,
                    name: 'En cours',
                    className: 'ct-orange',
                    meta: 'Meta One'
                }, {
                    value: resp.data.annule.total,
                    name: 'annulé',
                    className: 'ct-red',
                    meta: 'Meta One'
                }, {
                    value: resp.data.paye.total,
                    name: 'payé',
                    className: 'ct-green',
                    meta: 'Meta One'
                }]
            }, {
                total: resp.data.annule.total + resp.data.paye.total + resp.data.envoye.total,
                donut: true,
                startAngle: 270,
                donutWidth: 62,
                /* donut: true,
                 total: 100 +resp.data.annule.total + resp.data.paye.total + resp.data.envoye.total,
                 showLabel: false*/
            });
            _this.stats = resp.data
        })

    }

    _this.reloadStats = function() {
        edisonAPI.artisan.statsMonths($routeParams.sstid).then(function(resp) {
            var series = ['Annulé', 'Payé'];
            var labels = []
            var data = [
                [],
                []
            ];
            _.each(resp.data, function(e) {
                labels.push(_.capitalize(moment([e.year, e.month - 1]).format('MMMM YYYY')))
                data[0].push(e.annule);
                data[1].push(e.paye);
            })
            _this.sstChart = {
                series: series,
                data: data,
                labels: labels,
                options: {
                    scaleBeginAtZero: true,
                },
                colours: [
                    '#F7464A', // red
                    '#46BFBD', // green
                   
                ]
            }
        });
    }


    _this.tbz = ['informations', 'interventions', 'historique', 'stats', 'paiements'];
    var ind = _this.tbz.indexOf($location.hash());
    $scope.selectedIndex = ind >= 0 ? ind : 0
    _this.tab = TabContainer.getCurrentTab();

    _this.recap = $location.url().includes('recap') ? $routeParams.sstid : undefined

    if (_this.recap) {
        _this.loadPanel(_this.recap)
    } else {
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        var dataProvider = new DataProvider('artisan');
        dataProvider.init(function(err, resp) {
            _this.config = config;
            _this.moment = moment;
            if (!dataProvider.isInit()) {
                dataProvider.setData(resp);
            }
            _this.tableFilter = "";
            _this.tableLimit = 20;
            $rootScope.expendedRow = $routeParams.sstid || 45
                // if (_this.recap) {
                //     $scope.selectedIndex = 1;
                // }
            _this.tableData = dataProvider.getData()
            _this.loadPanel(_this.tableData[0].id)
            LxProgressService.circular.hide();
        });
    }

    _this.getStaticMap = function(address) {
        if (_this.sst && this.sst.address)
            return "/api/mapGetStatic?width=500&height=400&precision=0&zoom=6&origin=" + _this.sst.address.lt + ", " + _this.sst.address.lg;
    }

    _this.reloadData = function() {
        _this.tableData = $filter('contactFilter')(dataProvider.getData(), _this.tableFilter);
    }

    _this.loadMore = function() {
        _this.tableLimit += 10;
    }

    /*
        $rootScope.$watch('tableilter', _this.reloadData);
    */
    $rootScope.$on('ARTISAN_CACHE_LIST_CHANGE', function() {
        if (_this.tab.fullUrl === TabContainer.getCurrentTab().fullUrl) {
            dataProvider.applyFilter(currentFilter, _this.tab.hash);
        }
    })

    _this.contextMenu = new ContextMenu('artisan')

    _this.rowRightClick = function($event, inter) {
        console.log('contactclick')
        _this.contextMenu.setPosition($event.pageX, $event.pageY + 200)
        edisonAPI.artisan.get(inter.id)
            .then(function(resp) {
                _this.contextMenu.setData(resp.data);
                _this.contextMenu.open();
            })
    }

    $scope.addComment = function() {
        edisonAPI.artisan.comment(_this.sst.id, $scope.commentText).then(function() {
            _this.loadPanel(_this.sst.id);
            $scope.commentText = "";
        })
    }

    _this.rowClick = function($event, inter) {
        if (_this.contextMenu.active)
            return _this.contextMenu.close();
        if ($event.metaKey || $event.ctrlKey) {
            TabContainer.addTab('/artisan/' + inter.id, {
                title: ('#' + inter.id),
                setFocus: false,
                allowDuplicates: false
            });
        } else {
            if ($rootScope.expendedRow === inter.id) {
                return 0;
            } else {
                $rootScope.expendedRow = inter.id
                _this.loadPanel(inter.id)
                $location.search('sstid', inter.id);
            }
        }
    }


    $scope.$watchCollection('[selectedIndex, expendedRow]', function(current, prev) {
        if (current && current[0] !== void(0)) {
            $location.hash(_this.tbz[current[0]]);
        }
        if (_this.tbz[current[0]] === 'stats') {
            _this.reloadStats();
        }
    })


}
angular.module('edison').controller('ContactArtisanController', ContactArtisanController);
var DashboardController = function($rootScope, statsTelepro, dialog, user, edisonAPI, $scope, $filter, TabContainer, NgTableParams, $routeParams, $location, LxProgressService) {
    var _this = this;
    $scope._ = _;
    $scope.root = $rootScope;

    _this.openLink = function(link) {
        $location.url(link)
    }


    _this.addTask = function() {
        edisonAPI.task.add(_this.newTask).then(_.partial(_this.reloadTask, _this.newTask.to));
    }

    _this.check = function(task) {
        edisonAPI.task.check(task._id).then(_.partial(_this.reloadTask, _this.newTask.to))
    }


    console.log('==>', _.find(statsTelepro.data, 'login', user.login))

    _this.reloadTask = function(usr) {
        _this.newTask = {
            to: usr,
            from: user.login
        }
        edisonAPI.task.listRelevant({
            login: usr
        }).then(function(resp) {
            _this.taskList = resp.data;
        })
    }

    _this.reloadTask(user.login);

    _this.reloadDashboardStats = function(date) {

        edisonAPI.intervention.dashboardStats(date).then(function(resp) {
            _this.tableParams = new NgTableParams({
                count: resp.data.weekStats.length,
                sorting: {
                    total: 'desc'
                }
            }, {
                counts: [],
                data: resp.data.weekStats
            });
            _this.stats = resp.data
        })
    }

    _this.dateSelect = [{
        nom: 'Du jour',
        date: moment().startOf('day').toDate()
    }, {
        nom: 'De la semaine',
        date: moment().startOf('week').toDate()
    }, {
        nom: 'Du mois',
        date: moment().startOf('month').toDate()
    }, {
        nom: "De l'année",
        date: moment().startOf('year').toDate()
    }]
    _this.dateChoice = _this.dateSelect[1];
    this.reloadDashboardStats(_this.dateChoice);

}



angular.module('edison').controller('DashboardController', DashboardController);
 angular.module('edison').directive('edisonMap', ['$window', 'Map', 'mapAutocomplete', 'Address',
     function($window, Map, mapAutocomplete, Address) {
         "use strict";
         return {
             replace: true,
             restrict: 'E',
             templateUrl: '/Templates/autocomplete-map.html',
             scope: {
                 data: "=",
                 client: "=",
                 height: "@",
                 xmarkers: "=",
                 markerClick: '&',
                 isNew: "=",
                 firstAddress: "=",
                 showAddress: "="
             },
             link: function(scope, element, attrs) {
                 scope._height = scope.height || 315;
                 scope.map = new Map();
                 scope.map.setZoom(_.get(scope, 'client.address') ? 12 : 6)
                 if (scope.isNew) {
                     scope.map.show()
                 }
                 scope.autocomplete = mapAutocomplete;

                 scope.mapShow = function() {
                     scope.mapDisplay = true
                 }

                 if (_.get(scope, 'client.address.lt')) {
                     scope.client.address = Address(scope.client.address, true); //true -> copyContructor
                     scope.map.setCenter(scope.client.address);
                 } else {
                     scope.map.setCenter(Address({
                         lat: 46.3333,
                         lng: 2.6
                     }));
                     scope.map.setZoom(5)
                 }

                 scope.changeAddress = function(place) {
                     scope.firstAddress = true;
                     mapAutocomplete.getPlaceAddress(place).then(function(addr) {
                         scope.map.setZoom(12);
                         scope.map.setCenter(addr)
                         scope.client.address = addr;
                     });
                 }

                 scope.getStaticMap = function() {
                     if (!_.get(scope, 'data.client.address.lt') && !_.get(scope, 'data.address.lt'))
                         return 0
                     var q = "?width=" + Math.round($window.outerWidth * (scope.height === "small" ? 0.8 : 1.2));
                     if (scope.client && scope.client.address && scope.client.address.latLng)
                         q += ("&origin=" + scope.client.address.latLng);
                     if (scope.data.artisan && scope.data.artisan.address)
                         q += ("&destination=" + scope.data.artisan.address.lt + "," + scope.data.artisan.address.lg);
                     return "/api/mapGetStatic" + q;
                 }
                 scope.showClientMarker = function() {
                     return scope.client.address && scope.client.address.latLng;
                 }
                 scope.clickOnArtisanMarker = function(event, sst) {
                    scope.markerClick({
                        sst:sst
                    })
                 }
             }
         }
     }
 ]);
 angular.module('edison').directive('creditCard', ['config', function(config) {
     "use strict";
     return {
         replace: true,
         restrict: 'E',
         templateUrl: '/Templates/credit-card.html',
         scope: {
             model: "=",
         },
         link: function(scope, element, attrs) {
             scope.config = config
         },
     }

 }]);
var DevisCtrl = function(edisonAPI, $scope, $rootScope, $location, $routeParams, LxProgressService, LxNotificationService, TabContainer, config, dialog, devisPrm, Devis) {
    "use strict";
    var _this = this;
    _this.config = config;
    _this.dialog = dialog;
    _this.moment = moment;
    var tab = TabContainer.getCurrentTab();
    if (!tab.data) {
        var devis = new Devis(devisPrm.data)
        tab.setData(devis);
        if ($routeParams.id.length > 12) {
            _this.isNew = true;
            devis.tmpID = $routeParams.id;
            tab.setTitle('DEVIS ' + moment((new Date(parseInt(devis.tmpID))).toISOString()).format("HH:mm").toString());
        } else {
            tab.setTitle('DEVIS ' + $routeParams.id);
            if (!devis) {
                LxNotificationService.error("Impossible de trouver les informations !");
                $location.url("/dashboard");
                TabContainer.remove(tab);
                return 0;
            }
        }
    } else {
        var devis = tab.data;
    }
    _this.data = tab.data;

    var closeTab = function(err) {
        console.log('=========>', err)
        if (!err)
            TabContainer.close(tab);
    }

    _this.saveDevis = function(options) {
        if (!devis.produits ||  !devis.produits.length) {
            return LxNotificationService.error("Veuillez ajouter au moins 1 produit");
        }
        devis.save(function(err, resp) {
            if (err) {
                return false;
            } else if (options.envoi) {
                console.log(resp);
                Devis(resp).sendDevis(closeTab);
            } else if (options.annulation) {
                Devis(resp).annulation(closeTab);
            } else if (options.transfert) {
                Devis(resp).transfert()
            } else {
                closeTab();
            }
        })
    }

    $scope.$watch(function() {
        return devis.client.civilite
    }, function(newVal, oldVal) {
        if (oldVal !== newVal) {
            devis.tva = (newVal == 'Soc.' ? 20 : 10);
        }
    })

    var updateTmpDevis = _.after(5, _.throttle(function() {
        edisonAPI.devis.saveTmp(devis);
    }, 2000))

    if (!devis.id) {
        $scope.$watch(function() {
            return devis;
        }, updateTmpDevis, true)
    }

}
angular.module('edison').controller('DevisController', DevisCtrl);
 angular.module('edison').directive('infoCategorie', ['config', function(config) {
     "use strict";
     return {
         replace: true,
         restrict: 'E',
         templateUrl: '/Templates/info-categorie.html',
         transclude: true,
         scope: {
             model: "=",
             change: '&'
         },
         link: function(scope, element, attrs) {
             scope.config = config
             scope.callback = function(newCategorie) {
                 scope.model = newCategorie;
                 if (typeof scope.change === 'function')  {
                     scope.change({
                         newCategorie: newCategorie
                     })
                 }
             }
         },
     }

 }]);
 angular.module('edison').directive('infoClient', ['config', 'edisonAPI', function(config, edisonAPI) {
     "use strict";
     return {
         replace: true,
         restrict: 'E',
         templateUrl: '/Templates/info-client.html',
         transclude: true,
         scope: {
             client: '=model',
             data: '=',
             noDetails:'@'
         },
         link: function(scope, element, attrs) {
             scope.config = config;
             scope.searchPhone = function(tel) {
                 if (tel.length > 2) {
                     edisonAPI.searchPhone(tel)
                         .success(function(tel) {
                             scope.searchedPhone = tel
                         }).catch(function() {
                             scope.searchedPhone = {};
                         })
                 }
             }
         }
     }

 }]);
angular.module('edison').directive('infoCompta', ['config', 'Paiement',
    function(config, Paiement) {
        "use strict";
        return {
            restrict: 'E',
            templateUrl: '/Templates/info-compta.html',
            scope: {
                data: "=",
                displayReglement: '@',
                dialog: '@',
                displayPaiement: '@',
            },
            link: function(scope, element, attrs) {
                scope.config = config
                var reglement = scope.data.compta.reglement
                var paiement = scope.data.compta.paiement
                if (!scope.data.tva) {
                    scope.data.tva = (scope.data.client.civilite == 'Soc.' ? 20 : 10)
                }
                if (!paiement.mode) {
                    paiement.mode = _.get(scope.data.sst, 'document.rib.file') ? "VIR" : "CHQ"
                }

                scope.compta = new Paiement(scope.data)
                reglement.montantTTC = scope.compta.getMontantTTC()

                scope.$watchGroup(['data.compta.reglement.montantTTC',
                    'data.compta.reglement.avoir',
                    'data.tva'
                ], function(current, prev) {
                    var montant = reglement.montantTTC || 0
                    var coeff = 100 * (100 / (100 + scope.data.tva));
                    reglement.montant = Paiement().applyCoeff(reglement.montantTTC, coeff)
                    if (!paiement.base) {
                        paiement.base = _.round(reglement.montant - (reglement.avoir ||  0), 2)
                    }
                })

                var change = function(newValues, oldValues, scope) {
                    if (!_.isEqual(newValues, oldValues)) {
                        scope.compta = new Paiement(scope.data)
                        paiement.montant = scope.compta.montantTotal
                    }
                }
                scope.$watch('data.fourniture', change, true)
                scope.$watchGroup(['data.compta.reglement.montant',
                    'data.compta.paiement.base',
                    'data.compta.paiement.tva',
                    'data.compta.paiement.pourcentage.deplacement',
                    'data.compta.paiement.pourcentage.fourniture',
                    'data.compta.paiement.pourcentage.maindOeuvre',
                ], change, true);
                if (!scope.data.compta.paiement.base && scope.data.compta.reglement.montant) {
                    scope.data.compta.paiement.base = scope.data.compta.reglement.montant;
                    scope.compta = new Paiement(scope.data)
                    paiement.montant = scope.compta.montantTotal
                }
            },

        }

    }
]);
 angular.module('edison').directive('produits',
     function(config, productsList, dialog, openPost, LxNotificationService, Intervention, Devis, Combo, edisonAPI) {
         "use strict";
         return {
             restrict: 'E',
             templateUrl: '/Templates/info-produit.html',
             scope: {
                 data: "=",
                 tva: '=',
                 display: '@',
                 model: "@",
                 embedded: "="
             },
             link: function(scope, element, attrs) {
                 var model = scope.data;
                 scope.config = config
                 model.produits = model.produits || [];
                 scope.config = config;
                 scope.produits = new productsList(model.produits);
                 edisonAPI.combo.list().then(function(resp) {
                     scope.combo = resp.data
                 })

                 scope.Intervention = Intervention;
                 scope.Devis = Devis;

                 if (!scope.data.reglementSurPlace) {
                     scope.display = true;
                 }


                 scope.$watch('data.produits', function(curr, prev) {
                     if (!_.isEqual(curr, prev)) {
                         scope.data.prixFinal = scope.produits.total()
                         scope.data.prixAnnonce = scope.produits.total()
                     }
                 }, true)

                 scope.$watch('data.combo', function(curr, prev) {
                     if (curr && !_.isEqual(curr, prev)) {
                         var prod = _.find(scope.combo, function(e) {
                             return e.ref === curr;
                         })
                         _.each(prod.produits, function(e) {
                             if (!e.ref) {
                                 e.ref = e.desc.toUpperCase().slice(0, 3) + '0' + _.random(9, 99)
                             }
                         })
                         model.comboText = prod.text;
                         model.produits = prod.produits || [];
                         scope.produits = new productsList(model.produits);
                     }
                 }, true)

                 scope.displayfact = function() {
                     return scope.data.produits.length > 0 || !scope.data.reglementSurPlace || scope.dsf;
                 }

                 scope.changeElemTitle = function(elem) {
                     if (!elem.showDesc) {
                         elem.desc = elem.title
                     }
                 }

                 scope.createProd = function() {
                     /*                     scope.produits.add({
                                              ref: 'EDIXX',
                                              desc: "",
                                              pu: 10,
                                              quantite: 1,
                                              focus: true,
                                          })*/
                     model.produits.push({
                             showDesc: false,
                             desc: '',
                             title: '',
                             pu: 0,
                             quantite: 0,
                         })
                         /*  dialog.addProd(function(resp) {
                               console.log(resp);
                               model.produits.push(resp)
                           });*/
                 }
                 scope.printDevis = function() {
                     openPost('/api/intervention/printDevis', {
                         data: JSON.stringify(scope.data),
                         html: true
                     })
                 }

                 scope.printFactureAcquitte = function() {
                     openPost('/api/intervention/printFactureAcquitte', {
                         data: JSON.stringify(scope.data),
                         html: true
                     })
                 }
             },
         }

     }
 );
var InterventionCtrl = function(Description, Signalement, ContextMenu, $window, $timeout, $rootScope, $scope, $location, $routeParams, dialog, fourniture, LxNotificationService, LxProgressService, TabContainer, edisonAPI, Address, $q, mapAutocomplete, productsList, config, interventionPrm, Intervention, Map) {
    "use strict";
    var _this = this;
    _this.config = config;
    _this.dialog = dialog;
    _this.autocomplete = mapAutocomplete;
    var tab = TabContainer.getCurrentTab();

    if (!tab.data) {
        var intervention = new Intervention(interventionPrm.data)

        intervention.sst__id = intervention.sst ? intervention.sst.id : 0;
        tab.setData(intervention);
        if ($routeParams.id.length > 12) {
            _this.isNew = true;
            intervention.tmpID = $routeParams.id;
            intervention.tmpDate = moment.unix(intervention.tmpID / 1000).format('HH[h]mm')
            tab.setTitle(intervention.tmpDate);
        } else {
            if (intervention && intervention.client.nom) {
                var __title = intervention.client.civilite + intervention.client.nom
                __title = __title.slice(0, 10);
            } else {
                var __title = '#' + $routeParams.id;
            }
            tab.setTitle(__title);
            if (!intervention) {
                LxNotificationService.error("Impossible de trouver les informations !");
                $location.url("/dashboard");
                TabContainer.remove(tab);
                return 0;
            }
        }
    } else {
        var intervention = tab.data;
    }
    if ($routeParams.d) {
        intervention.devisOrigine = parseInt($routeParams.d)
        intervention.date = {
            ajout: new Date(),
            intervention: new Date(),
        }
        intervention.reglementSurPlace = true;
        intervention.modeReglement = 'CH';
        intervention.remarque = 'PAS DE REMARQUES';
    }
    _this.data = tab.data;

    $scope.bv = {
        show: function(view) {
            if (this[view]) {
                return (this[view] = false);
            }
            this.historique = false;
            this.absence = false;
            this.signalement = false;
            this[view] = true;
        },
        init: function() {
            this.historique = this.absence = this.signalement = false;
            _this.searchArtisans(intervention.categorie)
            $timeout(function() {
                _this.searchArtisans(intervention.categorie)
            }, 666)
        }
    }

    var updateTitle = _.throttle(function() {
        tab.setTitle(_.template("{{typeof tmpDate == 'undefined' ? id : tmpDate}} - {{client.civilite}} {{client.nom}} ({{client.address.cp}})")(intervention));
    }, 1000)

    $scope.$watch('vm.data.client', updateTitle, true)
    updateTitle();
    _this.description = new Description(intervention);
    _this.signalement = new Signalement(intervention)
    _this.contextMenu = new ContextMenu('intervention')
    _this.contextMenu.setData(intervention);
    _this.rowRightClick = function($event, inter) {
        if ($('.listeInterventions').has($event.target).length == 0) {
            _this.contextMenu.setPosition($event.pageX, $event.pageY + 200)
            _this.contextMenu.open();
        }
    }

    Mousetrap.bind(['command+k', 'ctrl+k', 'command+f1', 'ctrl+f1'], function() {
        $window.open("appurl:", '_self');
        edisonAPI.intervention.scan(intervention.id).then(function() {
            $scope.loadFilesList();
            LxNotificationService.success("Le fichier est enregistré");
        })
        return false;
    });


    $scope.calculPrixFinal = function() {
        intervention.prixFinal = 0;
        _.each(intervention.produits, function(e)  {
            intervention.prixFinal += (e.pu * e.quantite)
        })
        intervention.prixFinal = Math.round(intervention.prixFinal * 100) / 100;
    }



    $scope.addLitige = function() {
        dialog.getText({
            title: "Description du Litige",
            text: ""
        }, function(resp) {
            if (!intervention.litiges)
                intervention.litiges = [];
            intervention.litiges.push({
                date: new Date(),
                login: $rootScope.user.login,
                description: resp,
                regle: false
            })
        })
    }

    $scope.smsArtisan = function() {
        intervention.smsArtisan(function(err, resp) {
            if (!err)
                intervention.sst.sms.unshift(resp)
        })
    }


    $scope.clickTrigger = function(elem) {
        angular.element(elem).trigger('click');
    }


    $scope.$watch('fileupload', function(file) {
        if (file && file.length === 1) {
            intervention.fileUpload(file[0], function(err, resp) {
                $scope.fileUploadText = "";
                $scope.loadFilesList();
            });
        }
    })

    $scope.loadFilesList = function() {
        edisonAPI.intervention.getFiles(intervention.id || intervention.tmpID).then(function(result) {
            intervention.files = result.data;
        }, console.log)
    }

    $scope.loadFilesList();

    var postSave = function(options, resp, cb) {
        if (options && options.envoiFacture && options.verification) {
            intervention.envoiFactureVerif(cb)
        } else if (options && options.envoiFacture) {
            intervention.sendFacture(cb)
        } else if (options && options.envoi === true) {
            resp.files = intervention.files;
            intervention.envoi.bind(resp)(cb);
        } else if (options && options.annulation) {
            intervention.annulation(cb);
        } else if (options && options.verification) {
            intervention.verificationSimple(cb);
        } else {
            cb(null)
        }
    }

    var saveInter = function(options) {
        $scope.saveInter = function() {
            console.log('noope')
        }
        intervention.save(function(err, resp) {
            if (!err) {
                var files = intervention.files
                intervention = new Intervention(resp);
                intervention.files = files
                postSave(options, resp, function(err) {
                    if (!err) {
                        TabContainer.close(tab);
                    }
                    $scope.saveInter = saveInter;
                })
            } else {
                $scope.saveInter = saveInter;
            }
        })
    }

    $scope.saveInter = saveInter;


    var latLng = function(add) {
        return add.lt + ', ' + add.lg
    }
    _this.selectArtisan = function(sst, first) {

        if (!sst) {
            intervention.sst = intervention.artisan = null
            return false;
        }
        $q.all([
            edisonAPI.artisan.get(sst.id, {
                cache: false
            }),
            edisonAPI.artisan.getStats(sst.id, {
                cache: true
            })
        ]).then(function(result) {
            intervention.sst = intervention.artisan = result[0].data;
            intervention.sst.stats = result[1].data
            if (!first) {
                intervention.compta.paiement.pourcentage = _.clone(intervention.sst.pourcentage);
                intervention.newOs = intervention.sst.newOs;
            }
            edisonAPI.getDistance(latLng(sst.address), latLng(intervention.client.address))
                .then(function(dir) {
                    intervention.sst.stats.direction = dir.data;
                })
            _this.recapFltr = {
                ai: intervention.sst.id
            }
        });
    }

    _this.showInterList = function() {
        //console.log('uauau')
        //$scope.interList = true;
    }

    _this.sstBase = intervention.sst;
    if (intervention.sst) {
        _this.selectArtisan(intervention.sst, true);
    }

    _this.searchArtisans = function(categorie) {
        if (_.get(intervention, 'client.address.lt')) {
            edisonAPI.artisan.getNearest(intervention.client.address, categorie || intervention.categorie)
                .success(function(result) {
                    _this.nearestArtisans = result;
                });
        }
    }
    _this.searchArtisans();

    $scope.$watch(function() {
        return intervention.client.address;
    }, function() {
        _this.searchArtisans(intervention.categorie);
    })


    $scope.$watch(function() {
        return intervention.client.civilite;
    }, function(curr, prev) {
        if (curr !== prev && curr === 'Soc.') {
            intervention.tva = 20;
            LxNotificationService.info("La TVA à été mise a 20%");
        }
    })

    var updateTmpIntervention = _.after(5, _.throttle(function() {
        edisonAPI.intervention.saveTmp(intervention);
    }, 2000))

    if (!intervention.id) {
        $scope.$watch(function() {
            return intervention;
        }, updateTmpIntervention, true)
    }

}

angular.module('edison').controller('InterventionController', InterventionCtrl);
var LpaController = function(openPost, socket, ContextMenu, $location, $window, TabContainer, edisonAPI, $rootScope, LxProgressService, LxNotificationService, FlushList) {
    "use strict";
    var _this = this
    var tab = TabContainer.getCurrentTab();
    tab.setTitle('LPA')
    _this.search = $location.search();
    _this.contextMenu = new ContextMenu('intervention')

    _this.loadData = function(prevChecked) {
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        edisonAPI.compta.lpa($location.search()).then(function(result) {
            _.each(result.data, function(sst) {
                sst.list = new FlushList(sst.list, prevChecked);
                if (_this.search.d) {
                    _this.checkArtisan(sst);
                }
                _this.reloadList(sst)
            })
            $rootScope.lpa = result.data
            LxProgressService.circular.hide()
        })
    }


    _this.rowRightClick = function($event, inter) {
        edisonAPI.intervention.get(inter.id, {
                populate: 'sst'
            })
            .then(function(resp) {
                _this.contextMenu.setData(resp.data);
                _this.contextMenu.setPosition($event.pageX, $event.pageY + 200)
                _this.contextMenu.open();
            })
    }



    if (!$rootScope.lpa)
        _this.loadData()
    _this.checkArtisan = function(sst) {

        sst.checked = !sst.checked
        _.each(sst.list.getList(), function(e) {
            e.checked = sst.checked;
        })
    }
    _this.updateNumeroCheque = function(index) {
        var base = $rootScope.lpa[index].numeroCheque;
        if (base) {
            for (var i = index; i < $rootScope.lpa.length; i++) {
                if ($rootScope.lpa[i].list.getList()[0].mode === 'CHQ' /*&& _.find($rootScope.lpa[i].list.getList(), 'checked', true)*/) {
                    $rootScope.lpa[i].numeroCheque = base++
                }
            };
        }
    }
    _this.flush = function() {
        var rtn = [];

        var lpa = [];
        _.each(_.cloneDeep($rootScope.lpa), function(e) {
            e.list.__list = _.filter(e.list.__list, 'checked', true);
            if (e.list.__list.length) {
                lpa.push(e);
            }
        })
        console.log(lpa);
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        edisonAPI.compta.flush(lpa).then(function(resp) {
            edisonAPI.compta.flushMail(lpa).then(function(resp) {
                console.log('yayaya')
            });
        })
    }

    socket.on('intervention_db_flushMail', function(data) {
        if (data === 100) {
            $rootScope.globalProgressCounter = "";
            LxProgressService.circular.hide();
            _this.reloadLPA()
        } else {
            $rootScope.globalProgressCounter = data + '%';
        }

    })

    _this.selectToggle = function(artisan, item) {
        if (this.search.d) {
            return false;
        }
        item.checked = !item.checked;
        _this.reloadList(artisan)
    }
    _this.reloadList = function(artisan) {

        artisan.total = artisan.list.getTotal()
        artisan.total = artisan.list.getTotal(true)
        artisan.total = artisan.list.getTotal()
    }
    _this.reloadLPA = function() {
        var rtn = [];
        _.each($rootScope.lpa, function(sst) {
            _.each(sst.list.getList(), function(e) {
                if (e.checked) {
                    rtn.push(e.id);
                }
            })
        })
        _this.loadData(rtn)
    }

    _this.clickTrigger = function(elem) {
        window.setTimeout(function() {
            angular.element(elem).trigger('click');
        }, 0)
    }

    _this.onFileUpload = function(file) {
        var ids = _($rootScope.lpa).map(_.partial(_.pick, _, 'numeroCheque', 'id')).value();
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        edisonAPI.file.uploadScans(file, {
                ids: ids,
                date: _this.search.d
            }).then(function(resp) {
                LxProgressService.circular.hide()
                console.log('==>', resp);
            })
    }

    _this.print = function(type) {
        openPost('/api/intervention/print', {
            type: type,
            data: $rootScope.lpa
        });
    }
}


angular.module('edison').controller('LpaController', LpaController);
angular.module('edison').controller('ListeArtisanController', _.noop);
angular.module('edison').controller('ListeDevisController', _.noop);
angular.module('edison').controller('ListeInterventionController', _.noop);
var listeSignalements = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Liste Signalements');
    var q = $location.search();
    edisonAPI.signalement.list($location.search()).then(function(resp) {
        $scope.pl = resp.data;
        console.log('-->', resp.data)
    })

}
angular.module('edison').controller('listeSignalements', listeSignalements);
var SearchController = function(edisonAPI, TabContainer, $routeParams, $location, LxProgressService) {
    var tab = TabContainer.getCurrentTab();
    tab.setTitle('Search')
    var _this = this;
    LxProgressService.circular.show('#5fa2db', '#globalProgress');
    edisonAPI.searchText($routeParams.query).success(function(resp) {
        LxProgressService.circular.hide()
        _this.data = resp
    })
    _this.openLink = function(link) {
        $location.url(link)
    }
}

angular.module('edison').controller('SearchController', SearchController);
var StatsController = function(DateSelect, TabContainer, $routeParams, edisonAPI, $rootScope, $scope, $location, LxProgressService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Stats');


    var dateSelect = new DateSelect;
    _this.yearSelect = [];
    _.times(dateSelect.current.y - dateSelect.start.y + 1, function(k) {
        _this.yearSelect.push(dateSelect.start.y + k);
    })
    $scope.selectedYear = dateSelect.current.y

    $scope.$watch("selectedYear", function(curr) {
        edisonAPI.intervention.statsBen({
            y: curr
        }).then(function(resp) {
            console.log(resp.data)
            $('#chartContainer2 > *').remove()
            var svg = dimple.newSvg("#chartContainer2", 1070, 400);
            var myChart = new dimple.chart(svg, resp.data);
            myChart.setBounds(60, 30, 1000, 300)
            var x = myChart.addCategoryAxis("x", "mth");
            var y = myChart.addMeasureAxis("y", "montant");
            y.tickFormat = ',.0f';
            myChart.addSeries("potentiel", dimple.plot.bar);
            myChart.addLegend(60, 10, 410, 20, "right");
            myChart.draw();

            $scope.totalYear = {
                potentiel: 0,
                recu: 0
            }

            _.each(resp.data, function(e) {
                $scope.totalYear[e.potentiel ? 'potentiel' : 'recu'] += e.montant
            })
            console.log($scope.totalYear);
            /*
                        $('#chartContainer3 > *').remove()
                        var svg2 = dimple.newSvg("#chartContainer3", 100, 400);
                        var myChart2 = new dimple.chart(svg2, resp.data);
                        myChart.setBounds(60, 30, 50, 300)
            */
        })
    });




    $scope.$watch("selectedDate", function(curr) {
        if (!curr ||  !curr.m || !curr.y)
            return false;
        $location.search('m', curr.m);
        $location.search('y', curr.y);
        edisonAPI.intervention.statsBen(curr).then(function(resp) {
            $('#chartContainer > *').remove()
            var svg = dimple.newSvg("#chartContainer", 1300, 400);
            var myChart = new dimple.chart(svg, resp.data);
            myChart.setBounds(60, 30, 1000, 300)
            var x = myChart.addCategoryAxis("x", "day");
            //x.addOrderRule("dt");
            var y = myChart.addMeasureAxis("y", "prix");
            y.tickFormat = ',.0f';
            myChart.addSeries("recu", dimple.plot.bar);
            //myChart.addPctAxis("y", "paye");
            myChart.assignColor("En Attente", "#2196F3");
            myChart.assignColor("Encaissé", "#4CAF50");
            myChart.addLegend(60, 10, 410, 20, "right");
            myChart.draw();

        })
    })
    if ($location.search().m)  {
        dateSelect.current.m = parseInt($location.search().m)
    }
    if ($location.search().y)  {
        dateSelect.current.y = parseInt($location.search().y)
    }
    _this.dateSelect = dateSelect.list()
    $scope.selectedDate = _.find(dateSelect.list(), dateSelect.current)
}
angular.module('edison').controller('StatsController', StatsController);
var CommissionsController = function(DateSelect, TabContainer, $routeParams, edisonAPI, $rootScope, $scope, $location, LxProgressService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Coms.');

    _this.xcalc = function(e) {
        return e.categorie === 'VT' ? 1.5 : _.round(e.compta.reglement.montant * 0.01, 2);
    }

    _this.getTotal = function() {
        var rtn = {
            com: 0,
            all: 0
        }
        _.each($scope.list, function(x) {
            rtn.com += _this.xcalc(x);
            console.log(x.id, x.compta.reglement.montant)
            rtn.all += x.compta.reglement.montant || 0
        })
        return rtn;
    }

    var dateSelect = new DateSelect;

    $scope.usrs = _.filter(window.app_users, 'service', 'INTERVENTION');

    $scope.selectedUser = $location.search().l ||  $scope.usrs[0].login

    var actualise = _.debounce(function() {
        LxProgressService.circular.show('#5fa2db', '#globalProgress');

        edisonAPI.intervention.commissions(_.merge($scope.selectedDate, {
            l: $scope.selectedUser
        })).then(function(resp) {
            LxProgressService.circular.hide();
            $scope.list = resp.data
            $scope.total = _this.getTotal()
        })
    }, 50)
    console.log('test')
    $scope.$watch("selectedUser", function(curr, prev) {
        $location.search('l', curr);
        actualise();
        /* */
    })
    $scope.$watch("selectedDate", function(curr, prev) {
        $location.search('m', curr.m);
        $location.search('y', curr.y);
        actualise();
        /* $location.search('m', curr.m);
         $location.search('y', curr.y);
         edisonAPI.intervention.commissions(curr).then(function(resp) {
             console.log('==>', resp.data)
         })*/
    })
    if ($location.search().m)  {
        dateSelect.current.m = parseInt($location.search().m)
    }
    if ($location.search().y)  {
        dateSelect.current.y = parseInt($location.search().y)
    }
    _this.dateSelect = dateSelect.list()
    $scope.selectedDate = _.find(dateSelect.list(), dateSelect.current)
}
angular.module('edison').controller('CommissionsController', CommissionsController);
var editCombos = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Combos');


    var base = {
        "id": 29300,
        "categorie": "EL",
        "description": "RECHERCHE DE PANNE ELCTRIQUE",
        "sst": 31,
        "file": [],
        "tva": 10,
        "coutFourniture": 0,
        "enDemarchage": false,
        "aDemarcher": false,
        "reglementSurPlace": false,
        "prixFinal": 0,
        "prixAnnonce": 130,
        "modeReglement": "CH",
        "fourniture": [],
        "produits": [],
        "remarque": "Pas de remarque(s)",
        "descriptionTags": [],
        "artisan": {
            "id": 31,
            "nomSociete": "SODESEN"
        },
        "savEnCours": true,
        "litigesEnCours": true,
        "litiges": [],
        "sav": [],
        "client": {
            "civilite": "M.",
            "nom": "DELORME",
            "email": "",
            "location": [
                45.7592,
                4.77779
            ],
            "address": {
                "n": "19",
                "r": "RUE DES CERISIERS",
                "v": "TASSIN-LA-DEMI-LUNE",
                "cp": "69160",
                "lt": 45.7592,
                "lg": 4.77779
            },
            "telephone": {
                "tel1": "0478346059",
                "origine": "0478346059"
            },
            "prenom": "CHRISTIAN"
        },
        "facture": {
            "civilite": "M.",
            "nom": "DELORME",
            "email": "",
            "location": [
                45.7592,
                4.77779
            ],
            "address": {
                "n": "19",
                "r": "RUE DES CERISIERS",
                "v": "TASSIN-LA-DEMI-LUNE",
                "cp": "69160",
                "lt": 45.7592,
                "lg": 4.77779
            },
            "telephone": {
                "tel1": "0478346059",
                "origine": "0478346059"
            },
            "prenom": "CHRISTIAN"
        },
        "produits": [],
        "historique": [],
        "comments": [],
        "date": {
            "intervention": "2015-09-17T11:00:00.000Z",
            "envoi": "2015-09-17T09:11:14.000Z",
            "ajout": "2015-09-17T09:11:14.000Z"
        },
        "login": {
            "ajout": "clement_b",
            "envoi": "clement_b"
        },
        "status": "ENC"
    }



    edisonAPI.combo.list().then(function(resp) {
        $scope.plSave = resp.data
        $scope.pl = _.map(resp.data, _this.extend);
    })

    _this.extend = function(e) {
        var z = _.assign(_.clone(base), e)
        console.log(z, e);
        return z;
    }

    _this.save = function() {
        edisonAPI.combo.save($scope.pl).then(function(resp) {
            $scope.pl = _.map(resp.data, _this.extend);
            LxNotificationService.success("Les produits on été mis a jour");
        }, function(err) {
            LxNotificationService.error("Une erreur est survenu (" + JSON.stringify(err.data) + ')');
            //  edisonAPI.combo.save($scope.plSave);
        })
    }
    _this.remove = function(obj) {
        $scope.pl.splice(_.findIndex($scope.pl, '_id', obj._id), 1);
    }

    _this.getInter = function(prods)  {
        var x = _.clone(base)
        x.produits = prods.produits;
        return x;
    }

    _this.add = function() {
        $scope.pl.push({
            produits: [],
            title: '',
            open: true,
            text: ""
        })
    }



}
angular.module('edison').controller('editCombos', editCombos);
var editComptes = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('grand Comptes');

    edisonAPI.compte.list().then(function(resp) {
        $scope.pl = resp.data
        console.log($scope.pl)
    })


    _this.save = function() {
        edisonAPI.compte.save($scope.pl).then(function(resp) {
            LxNotificationService.success("Les comptes on été mis a jour");
        }, function(err) {
            LxNotificationService.error("Une erreur est survenu (" + JSON.stringify(err.data) + ')');
        })
    }
    _this.remove = function(obj) {
        $scope.pl.splice(_.findIndex($scope.pl, '_id', obj._id), 1);
    }
}

angular.module('edison').controller('editComptes', editComptes);
var editProducts = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Produits');


    var single = function(e) {
        e.single = (_(e.desc).deburr().toLowerCase() !== _(e.title).deburr().toLowerCase())
        return e;
    }

    edisonAPI.product.list().then(function(resp) {
        $scope.pl = _.map(resp.data, single);
    })

    _this.remove = function(obj) {
        $scope.pl.splice(_.findIndex($scope.pl, '_id', obj._id), 1);
    }

    _this.save = function() {
        edisonAPI.product.save($scope.pl).then(function(resp) {
            $scope.pl = _.map(resp.data, single);
            LxNotificationService.success("Les produits on été mis a jour");
        }, function(err) {
            LxNotificationService.error("Une erreur est survenu (" + JSON.stringify(err.data) + ')');
        })
    }

    /* $scope.$watch('pl', function(curr, prev) {
         if (curr && prev && !_.isEqual(prev, curr)) {
             save()
         }
     }, true)*/


}
angular.module('edison').controller('editProducts', editProducts);
var editSignalements = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Signalements');


    edisonAPI.signal.list().then(function(resp) {
        $scope.pl = resp.data;
    })

    _this.remove = function(obj) {
        $scope.pl.splice(_.findIndex($scope.pl, '_id', obj._id), 1);
    }
    _this.save = function() {
        edisonAPI.signal.save($scope.pl).then(function(resp) {
            $scope.pl = resp.data;
            LxNotificationService.success("Les produits on été mis a jour");
        }, function(err) {
            LxNotificationService.error("Une erreur est survenu (" + JSON.stringify(err.data) + ')');
        })
    }


}
angular.module('edison').controller('editSignalements', editSignalements);
var editUsers = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxNotificationService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('Utilisateurs');



    edisonAPI.users.list().then(function(resp) {
        $scope.usrs = resp.data
    })

    _this.save = function() {
        edisonAPI.users.save($scope.usrs).then(function() {
            LxNotificationService.success("Les utilisateurs on été mis a jour");
        }, function(err) {
            LxNotificationService.error("Une erreur est survenu (" + JSON.stringify(err.data) + ')');
        })
    }
    _this.remove = function(obj) {
        $scope.usrs.splice(_.findIndex($scope.usrs, '_id', obj._id), 1);
    }


}
angular.module('edison').controller('editUsers', editUsers);
var telephoneMatch = function(TabContainer, edisonAPI, $rootScope, $scope, $location, LxProgressService, socket) {
    "use strict";
    var _this = this;
    _this.tab = TabContainer.getCurrentTab();
    _this.tab.setTitle('TelMatch');
    $scope.__txt_tel = $rootScope.__txt_tel
    $rootScope.getTelMatch = function() {
        LxProgressService.circular.show('#5fa2db', '#globalProgress');
        $rootScope.__txt_tel = $scope.__txt_tel
        edisonAPI.intervention.getTelMatch({
            q: $rootScope.__txt_tel
        }).then(_.noop, function() {
        LxProgressService.circular.hide()

        })
    }

    socket.on('intervention_db_telMatches', function(data) {
        console.log('uyau')
        $rootScope.globalProgressCounter = data + '%';
    })

    socket.on('telephoneMatch', function(data) {
        $rootScope.globalProgressCounter = ""
        LxProgressService.circular.hide()
        $scope.resp = data
    })

}
angular.module('edison').controller('telephoneMatch', telephoneMatch);
 angular.module('edison').directive('absenceSst', function(edisonAPI, LxNotificationService, user) {
    "use strict";
    return {
        replace: false,
        restrict: 'E',
        templateUrl: '/Templates/absence-sst.html',
        scope: {
            data: '=',
            exit: '&',
        },
        link: function(scope, elem) {
            scope.absence = {
                start: moment().add(-1, 'hours').toDate(),
                end: moment().hour(23).minute(43).toDate()
            }
            scope.save = function() {
                edisonAPI.artisan.absence(scope.data.id, scope.absence).then(function() {
                    console.log('yaya')
                })
                LxNotificationService.success("L'absence à été enregistrer");
                console.log('==>', scope.exit);
                (scope.exit || _.noop)();
            }
        }
    }
 });
angular.module('edison').directive('allowPattern', [allowPatternDirective]);

function allowPatternDirective() {
    return {
        restrict: "A",
        compile: function(tElement, tAttrs) {
            return function(scope, element, attrs) {
                // I handle key events
                element.bind("keypress", function(event) {
                    var keyCode = event.which || event.keyCode; // I safely get the keyCode pressed from the event.
                    var keyCodeChar = String.fromCharCode(keyCode); // I determine the char from the keyCode.

                    // If the keyCode char does not match the allowed Regex Pattern, then don't allow the input into the field.
                    if (!keyCodeChar.match(new RegExp(attrs.allowPattern, "i"))) {
                        event.preventDefault();
                        return false;
                    }

                });
            };
        }
    };
}
angular.module('edison').directive('capitalize', function() {
    "use strict";
    return {
        require: 'ngModel',
        link: function(scope, element, attrs, modelCtrl) {
            modelCtrl.$parsers.push(function(input) {
                return typeof input === "string" ? input.toUpperCase() : "";
            });
            element.css("text-transform", "uppercase");
        }
    };
});
angular.module('edison').directive('creditcard', function() {
    "use strict";
    return {
        require: 'ngModel',
        scope: {
            inline: "=",
        },
        link: function(scope, element, attrs, modelCtrl) {
            modelCtrl.$parsers.push(function(input) {
                return input.replace('x', 'AAA')
            });
        }
    };
});
angular.module('edison').directive('dropdownRow', function(Devis, productsList, edisonAPI, config, $q, $timeout, Intervention) {
    "use strict";

    return {
        restrict: 'E',
        replace: true,
        templateUrl: '/Directives/dropdown-row.html',
        scope: {
            model: "@",
            row: '=',
        },
        link: function(scope, element, attrs) {
            scope._ = _;
            scope.Intervention = Intervention
            scope.Devis = Devis
            scope._model = scope.model || "intervention"

            scope.expendedStyle = {
                height: 0,
                overflow: 'hidden'
            };
            scope.expendedReady = false;
            scope.data = {};
            scope.config = config
            if (scope._model === "intervention") {
                edisonAPI.intervention.get(scope.row.id, {
                    populate: ['sst', 'devisOrigine'].join(',')
                }).then(function(result) {
                    scope.data = result.data;
                    if (scope.data.produits) {
                        scope.produits = new productsList(scope.data.produits);
                    }
                    scope.client = scope.data.client;
                    scope.address = scope.client.address;

                })

            } else if (scope._model === "devis") {
                var pAll = [
                    edisonAPI.devis.get(scope.row.id, {
                        populate: 'transfertId'
                    }),
                ]
                var pThen = function(result) {
                    scope.data = result[0].data;
                    scope.produits = new productsList(scope.data.produits);
                    scope.hist = scope.data.historique
                    scope.client = scope.data.client;
                    scope.address = scope.client.address;
                }
            } else if (scope._model === 'artisan') {
                pAll = [
                    edisonAPI.artisan.get(scope.row.id),
                    edisonAPI.artisan.getStats(scope.row.id)
                ]
                pThen = function(result) {
                    scope.data = result[0].data;
                    scope.artisan = scope.data;
                    scope.artisan.stats = result[1].data;
                    scope.address = scope.artisan.address
                }
            }

            $q.all(pAll).then(pThen)
            scope.getStaticMap = function() {
                var q = "?format=jpg&width=411&height=210px&precision=0&origin=" + scope.address.lt + ", " + scope.address.lg;
                if (_.get(scope, 'data.artisan.address.lt'))
                    q += "&destination=" + scope.data.artisan.address.lt + ", " + scope.data.artisan.address.lg;
                else
                    q += "&zoom=15";
                return "/api/mapGetStatic" + q;
            }

        }
    };
});
angular.module('edison').directive('elastic', [
    '$timeout',
    function($timeout) {
        return {
            restrict: 'A',
            link: function($scope, element) {
                $scope.initialHeight = $scope.initialHeight || element[0].style.height;
                var resize = function() {
                    element[0].style.height = $scope.initialHeight;
                    element[0].style.height = "" + element[0].scrollHeight + "px";
                };
                element.on("input change", resize);
                $timeout(resize, 0);
            }
        };
    }
]);angular.module('edison').directive('ngEnter', function () {
    "use strict";
    return function (scope, element, attrs) {
        element.bind("keydown keypress", function (event) {
            if(event.which === 13) {
                scope.$apply(function (){
                    scope.$eval(attrs.ngEnter);
                });

                event.preventDefault();
            }
        });
    };
});angular.module('edison').directive('historiqueSst', function(edisonAPI) {
    "use strict";

    return {
        restrict: 'E',
        replace: true,
        templateUrl: '/Templates/historique-sst.html',
        scope: {
            data: "=",
            exit: '&'
        },
        link: function(scope, element, attrs) {

            var reload = function() {
                edisonAPI.artisan.fullHistory(scope.data.id).then(function(resp) {
                    scope.hist = resp.data;
                })
            }

            scope.$watch('data.id', reload)
            scope.check = function(sign) {
                /*  if (sign.ok)
                      return 0;*/
                edisonAPI.signalement.check(sign._id, sign.text).then(function(resp) {
                    sign = _.merge(sign, resp.data);
                })
                scope.exit && scope.exit();
                console.log('=>', sign)
            }
            scope.comment = function() {
                edisonAPI.artisan.comment(scope.data.id, scope.comm).then(reload)
                scope.comm = ""
            }
        }
    };
});
 angular.module('edison').directive('infoComment', function(user) {
     "use strict";
     return {
         replace: false,
         restrict: 'E',
         templateUrl: '/Templates/info-comment.html',
         scope: {
             data: '=',
         },
         link: function(scope, elem, attr) {
             scope.height = attr.height ||  216;
             scope.user = user;
             scope.addComment = function() {
                 scope.data.comments.push({
                     login: user.login,
                     text: scope.commentText,
                     date: new Date()
                 })
                 scope.commentText = "";
             }
         }
     }
 });
 angular.module('edison').directive('infoLitige', function() {
     "use strict";
     return {
         replace: false,
         restrict: 'E',
         templateUrl: '/Templates/info-litige.html',
         scope: {
             data: '=',
         },
         link: function(scope, elem) {
             scope.$watch('data.litige.description', function(curr, prev) {
                 if (scope.data.litige && !scope.data.litige.closed && scope.data.litige.description)
                     scope.data.litige.open = true
                 if (scope.data.litige && !scope.data.litige.description) {
                     scope.data.litige.open = false
                 }
             })
         }
     }
 });
 angular.module('edison').directive('infoSav', function(config) {
     "use strict";
     return {
         replace: false,
         restrict: 'E',
         templateUrl: '/Templates/info-sav.html',
         scope: {
             data: '=',
             artisans: '='
         },
         link: function(scope, elem) {
            scope.config = config;
            console.log(config.savStatus)
         }
     }
 });
 var Controller = function($timeout, TabContainer, FiltersFactory, user, ContextMenu, LxProgressService, edisonAPI, DataProvider, $routeParams, $location, $rootScope, $filter, config, ngTableParams) {
    var _this = this;
    LxProgressService.circular.show('#5fa2db', '#globalProgress');
    var currentFilter;
    var currentHash = $location.hash();
    var dataProvider = new DataProvider(_this.model, $routeParams.hashModel);
    var filtersFactory = new FiltersFactory(_this.model)
    if ($routeParams.fltr) {
        currentFilter = filtersFactory.getFilterByUrl($routeParams.fltr)
    }


    _this.routeParamsFilter = $routeParams.fltr;
    if (_this.embedded) {
        _this.$watch('filter', function() {
            if (_.size(_this.filter)) {
                _this.customFilter = function(inter) {
                    for (var i in _this.filter) {
                        if (_this.filter[i] !== inter[i])
                            return false
                    }
                    return true
                }
                if (_this.tableParams) {
                    dataProvider.applyFilter({}, _this.tab.hash, _this.customFilter);
                    _this.tableParams.reload();
                }
            }
        })

    }

    _this.displaySubRow = function(inter) {
        return _this.expendedRow && _this.expendedRow === inter.id;
    }

    _this.smallWin = window.innerWidth < 1400
    $(window).resize(function() {
        _this.smallWin = window.innerWidth < 1400
    })

    _this.tab = TabContainer.getCurrentTab();
    _this.tab.hash = currentHash;
    _this.config = config;
    var title = currentFilter ? currentFilter.long_name : _this.model;
    if ($routeParams.sstid) {
        var id = parseInt($routeParams.sstid)
        _this.customFilter = function(inter) {
            return inter.ai === id;
        }
    } else {
        _this.tab.setTitle(title, currentHash);
    }
    if ($routeParams.sstids_in) {
        _this.customFilter = function(inter) {
            return _.contains($routeParams.sstids_in, inter.id);
        }
    }

    _this.$watch(function() {
        return $location.search()
    }, _.after(2, function(nw, old) {
        _this.tableParams.filter(_.omit(nw, 'hashModel', 'page', 'sstid'))
    }), true)


    var actualiseUrl = _.throttle(function(fltrs, page) {
        $location.search('page', page !== 1 ? page : undefined);
        _.each(fltrs, function(e, k) {
            // console.log(e, k)
            if (!e) e = undefined;
            if (e !== "hashModel") {
                $location.search(k, e);

            } else {
                //console.log(e)
            }
        })
    }, 250)
    if (_this.routeParamsFilter === 'relanceClient') {
        sorting = {
            l: 'asc'
        }
    } else {
        sorting = {
            id: 'desc'
        }
    }
    dataProvider.init(function(err, resp) {


        dataProvider.applyFilter(currentFilter, _this.tab.hash, _this.customFilter);
        var tableParameters = {
            page: $location.search()['page'] ||  1,
            total: dataProvider.filteredData.length,
            filter: _this.embedded ? {} : _.omit($location.search(), 'hashModel', 'page', 'sstid'),
            sorting: sorting,
            count: _this.limit || 100
        };
        var tableSettings = {
            total: dataProvider.filteredData,
            getData: function($defer, params) {
                actualiseUrl(params.filter(), params.page())
                var data = dataProvider.filteredData;
                if (!_this.embedded) {
                    data = $filter('tableFilter')(data, params.filter());
                }
                _this.currentFilter = _.clone(params.filter());
                params.total(data.length);
                data = $filter('orderBy')(data, params.orderBy());
                $defer.resolve(data.slice((params.page() - 1) * params.count(), params.page() * params.count()));
            },
            filterDelay: 100
        }
        _this.tableParams = new ngTableParams(tableParameters, tableSettings);
        LxProgressService.circular.hide()
    })

    var lastChange = 0;
    $rootScope.$on(_this.model.toUpperCase() + '_CACHE_LIST_CHANGE', function(event, newData) {
        if (TabContainer.getCurrentTab() && _this.tab.fullUrl === TabContainer.getCurrentTab().fullUrl) {
            dataProvider.applyFilter(currentFilter, _this.tab.hash, _this.customFilter);
            _this.tableParams.reload();
            //_this.tableParams.orderBy(_this.tableParams.$params.sorting)
            //_this.tableParams.filter(_this.tableParams.$params.filter)
        }
    })


    _this.contextMenu = new ContextMenu(_this.model)


    if (user.service === 'COMPTABILITE') {
        var subs = _.findIndex(_this.contextMenu.list, "title", "Appels");
        if (subs) {
            var tmp = _this.contextMenu.list[subs]
            _this.contextMenu.list.splice(subs, 1);
            _this.contextMenu.list.push(tmp);
        }
    }
    _this.rowRightClick = function($event, inter) {
        edisonAPI[_this.model].get(inter.id, {
                populate: 'sst'
            })
            .then(function(resp) {
                _this.contextMenu.setData(resp.data);
                _this.contextMenu.setPosition($event.pageX - (($routeParams.sstid ||  _this.embedded) ? 50 : 0), $event.pageY + ($routeParams.sstid ||  _this.embedded ? 0 : 200))
                _this.contextMenu.open();
            })
    }

    _this.rowClick = function($event, inter) {
        if (_this.contextMenu.active)
            return _this.contextMenu.close();
        if ($event.metaKey || $event.ctrlKey) {
            TabContainer.addTab('/' + _this.model + '/' + inter.id, {
                title: ('#' + inter.id),
                setFocus: false,
                allowDuplicates: false
            });
        } else {
            // $('.drpdwn').remove()
            if (_this.expendedRow === inter.id) {
                _this.expendedRow = undefined;
            } else {
                _this.expendedRow = inter.id
            }
        }
    }
 }



 angular.module('edison').directive('lineupIntervention', function($timeout, TabContainer, FiltersFactory, user, ContextMenu, LxProgressService, edisonAPI, DataProvider, $routeParams, $location, $rootScope, $filter, config, ngTableParams) {
    "use strict";
    var arg = arguments;
    return {
        replace: false,
        restrict: 'E',
        templateUrl: '/Templates/lineup-intervention.html',
        scope: {
            limit: '=',
            embedded: '=',
            filter: '=',
        },
        controller: function($scope) {

            $scope.model = 'intervention'
            Controller.apply($scope, arg)
        }
    }
 });

 angular.module('edison').directive('lineupDevis', function($timeout, TabContainer, FiltersFactory, user, ContextMenu, LxProgressService, edisonAPI, DataProvider, $routeParams, $location, $rootScope, $filter, config, ngTableParams) {
    "use strict";
    var arg = arguments;
    return {
        replace: false,
        restrict: 'E',
        templateUrl: '/Templates/lineup-devis.html',
        scope: {
            filter: '=',
        },
        controller: function($scope) {
            $scope.model = 'devis'
            Controller.apply($scope, arg)
        }
    }
 });

 angular.module('edison').directive('lineupArtisan', function($timeout, TabContainer, FiltersFactory, user, ContextMenu, LxProgressService, edisonAPI, DataProvider, $routeParams, $location, $rootScope, $filter, config, ngTableParams) {
    "use strict";
    var arg = arguments;
    return {
        replace: false,
        restrict: 'E',
        templateUrl: '/Templates/lineup-artisan.html',
        scope: {

        },
        controller: function($scope) {
            $scope.model = 'artisan'

            Controller.apply($scope, arg)
        }
    }
 });
angular.module('edison').directive('ngRightClick', function($parse) {
    "use strict";
    return function(scope, element, attrs) {
        element.bind('contextmenu', function(event) {
            if (!(event.altKey ||  event.ctrlKey || event.shiftKey ||  ["INPUT", "TEXTAREA"].indexOf(event.target.nodeName) >= 0)) {
                scope.$apply(function() {
                    event.preventDefault();
                    $parse(attrs.ngRightClick)(scope, {
                        $event: event
                    });
                });
            }
        });
    };
});
 angular.module('edison').directive('link', ['FiltersFactory', '$rootScope', function(FiltersFactory, $rootScope) {
     "use strict";
     return {
         restrict: 'AE',
         replace: true,
         template: '<li>' +
             '      <a href="{{fullUrl}}" >' +
             '            <i ng-if="icon" class = "menu-icon fa fa-{{icon}}"> </i>' +
             '            <span ng-class="{bold : bold, textWhite: textWhite}" class="mm-text">{{title || exFltr.long_name}}</span>' +
             '            <span ng-if="total"class="label label-{{_color}}">{{total}}</span>' +
             '        </a>' +
             '      </li>',
         scope: {
             fltr: '@',
             login: '@',
             today: '@',
             icon: '@',
             title: '@',
             url: '@',
             textWhite: '@',
             model: '@',
             bold: '@',
             count: '@',
             noCounter: '@',
             color: '@',
             hashModel: '@'
         },
         link: function(scope, element, attrs) {
             var findTotal = function() {
                if (scope.count) {
                    return scope.count
                }
                 if (scope.noCounter)
                     return undefined;
                 var total = 0;
                 if (scope.login) {
                     var t = _.find($rootScope.interventionsStats, function(e) {
                         return e.login === scope.login;
                     })
                     total += _.get(t, scope.fltr + '.total', 0);
                 } else {
                     _.each($rootScope.interventionsStats, function(t) {
                         total += _.get(t, scope.fltr + '.total', 0);
                     })
                 }
                 return total;
             }
             $rootScope.$watch('interventionsStats', function() {
                 scope.total = findTotal();
             })
             scope.$watch('login', function(current, prev) {
                 scope._color = (scope.color || 'success')
                 scope._model = scope.model || 'intervention';
                 var filtersFactory = new FiltersFactory(scope._model);
                 scope.exFltr = filtersFactory.getFilterByName(scope.fltr);
                 scope.total = findTotal();
                 scope.exFltr = scope.exFltr ||  {
                     url: ''
                 };
                 scope._url = scope.exFltr.url.length ? "/" + scope.exFltr.url : scope.exFltr.url;
                 scope._login = scope.login && !scope.hashModel ? ("#" + scope.login) : '';
                 scope._hashModel = scope.hashModel ? ("?" + scope.hashModel + "=" + scope.login) : '';
                 scope.fullUrl = scope.url ||  ('/' + scope._model + '/list' + scope._url + scope._hashModel + scope._login)
             })

         }
     };
 }]);

 angular.module('edison').directive('simpleLink', ['FiltersFactory', '$rootScope', function(FiltersFactory, $rootScope) {
     "use strict";
     return {
         restrict: 'AE',
         replace: true,
         template: '<li>' +
             '      <a href="{{url}}"  target="{{target}}">' +
             '            <i ng-if="icon" class = "menu-icon fa fa-{{icon}}"> </i>' +
             '            <span class="mm-text">{{title}}</span>' +
             '        </a>' +
             '      </li>',
         scope: {
             icon: '@',
             title: '@',
             url: '@',
         },
         link: function(scope, element, attrs) {
             scope.target = (typeof attrs.extern === 'string' ? '_blank' : '')
         }
     };
 }]);


 angular.module('edison').directive('linkSeparator', [function() {
     "use strict";
     return {
         restrict: 'AE',
         replace: true,
         template: '<li>' +
             '      <a>' +
             '            <i ng-if="icon" class = "menu-icon fa fa-{{icon}}"> </i>' +
             '            <strong><span class="mm-text">{{title}}</span></strong>' +
             '        </a>' +
             '      </li>',
         scope: {
             icon: '@',
             title: '@',
         },
         link: function(scope, element, attrs) {

         }
     };
 }]);


 angular.module('edison').service('sidebarSM', function() {

     var C = function() {
         this.display = false;
     };
     C.prototype.set = function(name, value) {
         this[name] = value;
     }
     return new C();

 });



 angular.module('edison').directive('sideBar', ['sidebarSM', function(sidebarSM) {
     "use strict";
     return {
         replace: false,
         restrict: 'E',
         templateUrl: '/Directives/side-bar.html',
         transclude: true,
         scope: {},
         link: function(scope, element, attrs) {
             scope.sidebarSM = sidebarSM;
         }
     }
 }]);

 angular.module('edison').directive('dropDown', ['config', 'sidebarSM', '$timeout', function(config, sidebarSM, $timeout) {
     "use strict";


     return {
         replace: true,
         restrict: 'E',
         templateUrl: '/Directives/dropdown.html',
         transclude: true,
         scope: {
             title: '@',
             icon: '@',
             isOpen: '@',
             openDefault: '&'
         },
         link: function(scope, element, attrs) {
             scope.openDefault = scope.$eval(scope.openDefault)
             scope.isopen = scope.openDefault
             scope.toggleSidebar = function($event, $elem) {
                 var $ul = $(element).find('>ul')
                 if ($('#main-menu').width() > 200) {
                     if (scope.isopen) {
                         $ul.velocity({
                             height: 0
                         }, 200, function() {
                             scope.$apply(function() {
                                 scope.isopen = false;
                             })
                         });
                     } else {
                         $ul.css('height', '100%')
                         scope.isopen = true
                     }
                 } else {

                     $('#mmc-ul > .mmc-wrapper').html($ul.find('> *'));
                     sidebarSM.set("display", true);
                     $timeout(function checkHover() {
                         if (!$('#mmc-ul').is(":hover")) {
                             sidebarSM.set("display", false);
                             $ul.html($('#mmc-ul > .mmc-wrapper').find(">*"))
                             $('#mmc-ul > .mmc-wrapper').html('');
                         } else {
                             $timeout(checkHover, 1000);
                         }
                     }, 1000)
                 }
             }
         }
     };
 }]);
 angular.module('edison').directive('signalement', function(edisonAPI, LxNotificationService) {
    "use strict";
    return {
        replace: false,
        restrict: 'E',
        templateUrl: '/Templates/signalement.html',
        scope: {
            data: '=',
            exit: '&',
        },
        link: function(scope, elem) {
            scope.setSelectedSubType = function(subType) {
                scope.selectedSubType = scope.selectedSubType === subType ? null : subType
            }
            edisonAPI.signal.list().then(function(resp) {
                scope.signalementsGrp = _.groupBy(resp.data, 'subType');
                scope.signalements = resp.data;
            })
            scope.hide = function(signal) {

                edisonAPI.signalement.add(_.merge(signal, {
                    inter_id: scope.data.id || scope.data.tmpID,
                    sst_id: scope.data.sst && scope.data.sst.id,
                    sst_nom: scope.data.sst && scope.data.sst.nomSociete
                })).then(function() {
                    LxNotificationService.success("Le service " + signal.service.toLowerCase() + " en a été notifié");
                })
                console.log('EXIT')
                return scope.exit && scope.exit()
            }
        }
    }
 });
angular.module("edison").filter('contactFilter', ['config', function(config) {
    "use strict";

    var clean = function(str) {
        return _.deburr(str).toLowerCase();
    }

    var compare = function(a, b, strictMode) {
        if (typeof a === "string") {
            return clean(a).includes(b);
        } else if (!strictMode) {
            return clean(String(a)).startsWith(b);
        } else {
            return a === parseInt(b);
        }
    }
    return function(dataContainer, input) {
        var rtn = [];
        input = clean(input);
        _.each(dataContainer, function(data) {
            if (!data.stringify)
                data.stringify = clean(JSON.stringify(data))
            if (!input || data.stringify.indexOf(input) >= 0) {
                rtn.push(data);
            } else {
            }
        })
        return rtn;
    }
}]);
angular.module('edison').filter('crlf', function() {
	"use strict";
    return function(text) {
        return text.split(/\n/g).join('<br>');
    };
});
 angular.module('edison').filter('frnbr', function() {
 	"use strict";
 	return function(num) {
 		var n = _.round((num || 0), 2).toString(),
 			p = n.indexOf('.');
 		return n.replace(/\d(?=(?:\d{3})+(?:\.|$))/g, function($0, i) {
 			return (p < 0 || i < p ? ($0 + ' ') : $0).replace('.', ',');
 		});
 	};
 });
angular.module('edison').filter('loginify', function() {
    "use strict";
    return function(obj) {
        if (!obj)
            return "";
        return obj.slice(0, 1).toUpperCase() + obj.slice(1, -2)
    };
});
angular.module('edison').filter('relativeDate', function() {
    "use strict";
    return function(date, smallWin) {
        var d = moment((date + 137000000) * 10000);
        var l = moment().subtract(4, 'days');
        if (d < l) {
            return smallWin ? d.format('DD/MM') : d.format('DD/MM/YY')
        } else {
            var x = d.fromNow().toString()
            if (smallWin) {
                x = x
                    .replace('quelques secondes', '')
                    .replace(' minutes', 'mn')
                    .replace(' minute', 'mn')
                    .replace(' une', '1')
                    .replace(' heures', 'H')
                    .replace(' heure', 'H')
                    .replace(' jours', 'J')
                    .replace(' jour', 'J')
                    .replace('il y a', '-')
                    .replace(' un', '1')
                    .replace('dans ', '+')
            }
            return x;
        }
        // return moment((date + 1370000000) * 1000).fromNow(no).toString()
    };
});
angular.module('edison').filter('reverse', function() {
    "use strict";
    return function(items) {
        if (!items)
            return [];
        return items.slice().reverse();
    };
});
angular.module("edison").filter('tableFilter', ['config', function(config) {
    "use strict";

    var clean = function(str) {
        return _.deburr(str).toLowerCase();
    }

    var compare = function(a, b, strictMode) {
        if (typeof a === "string") {
            return clean(a).includes(b);
        } else if (!strictMode) {
            return clean(String(a)).startsWith(b);
        } else {
            return a === parseInt(b);
        }
    }
    var compareCustom = function(key, data, input) {
        if (key === '_categorie') {
            var cell = config.categoriesHash()[data.c].long_name;
            return compare(cell, input);
        }
        if (key === '_etat') {
            var cell = config.etatsHash()[data.s].long_name
            return compare(cell, input);
        }
        return true;

    }
    var compareDate = function(key, data, input) {
        var md = (data[key] + 1370000000) * 1000;
        //console.log( input.start, input.end);
        if (md > input.start.getTime() && md < input.end.getTime()) {
            return true
        }
        return false;
    }

    var parseDate = function(e) {
        if (!(/^[0-9\/]+$/).test(e) ||  _.endsWith(e, '/')) {
            return undefined;
        }
        var x = e.split('/');
        if (x.length === 1) {
            var month = parseInt(x[0]);
            return {
                start: new Date(2015, month - 1),
                end: new Date(2015, month)
            }
        } else if (x.length === 2)  {
            var day = parseInt(x[0]);
            var month = parseInt(x[1]);
            return {
                start: new Date(2015, month - 1, day),
                end: new Date(2015, month - 1, day + 1)
            }
        }
        return undefined;
    }


    return function(dataContainer, inputs, strictMode) {
        var rtn = [];
        //console.time('fltr')
        inputs = _.mapValues(inputs, clean);
        _.each(inputs, function(e, k) {
            if (k.charAt(0) === '∆') {
                inputs[k] = parseDate(e);
            }
        })
        _.each(dataContainer, function(data) {
                if (data.id) {
                    var psh = true;
                    _.each(inputs, function(input, k) {
                        if (input && _.size(input) > 0) {
                            if (k.charAt(0) === '_') {
                                if (!compareCustom(k, data, input)) {
                                    psh = false;
                                    return false
                                }
                            } else if (k.charAt(0) === '∆') {
                                if (!compareDate(k.slice(1), data, input)) {
                                    psh = false;
                                    return false
                                }
                            } else {
                                if (!compare(data[k], input, strictMode)) {
                                    psh = false;
                                    return false
                                }
                            }
                        }
                    });
                    if (psh === true) {
                        rtn.push(data);
                    }
                }
            })
            //console.timeEnd('fltr')

        return rtn;
    }
}]);
angular.module('edison').factory('TabContainer', ['$location', '$window', '$q', 'edisonAPI', function($location, $window, $q, edisonAPI) {
    "use strict";
    var Tab = function(args, options, prevTab) {

        if (typeof args === 'object') {
            //copy constructor
            _.each(args, function(e, k) {
                this[k] = e;
            })
        } else {
            this.prevTab = prevTab ||  {}
            this.urlFilter = options.urlFilter
            this.hash = options.hash
            this.url = args;
            this.fullUrl = this.url + ['', $.param(this.urlFilter)].join(_.isEmpty(this.urlFilter) ? '' : '?') + (this.hash ? '#' + this.hash : '')
            this.title = '';
            this.position = null;
            this.deleted = false;
            this._timestamp = Date.now();
        }
    }

    Tab.prototype.setData = function(data) {
        //slice create a copy
        this.data = data;
    }

    Tab.prototype.setTitle = function(title, subTitle) {
        this.title = title;
    }

    var TabContainer = function() {
        this._tabs = [];
        this.selectedTab = 0;
    }

    TabContainer.prototype.loadSessionTabs = function(currentUrl) {
        var _this = this;

        return $q(function(resolve, reject) {
            var currentUrlInSessionTabs = false;
            edisonAPI.request({
                fn: "getSessionData",
            }).then(function(result) {
                _this.selectedTab = result.data.selectedTab;
                for (var i = 0; i < result.data._tabs.length; i++) {
                    _this._tabs.push(new Tab(result.data._tabs[i]))
                    if (result.data._tabs[i].url === currentUrl) {
                        _this.selectedTab = i;
                        currentUrlInSessionTabs = true;
                    }
                }
                if (!currentUrlInSessionTabs) {
                    return reject();
                }
                return resolve();
            }).catch(reject);

        })

    }

    TabContainer.prototype.setFocus = function(tab) {
        this.selectedTab = (typeof tab === 'number' ? tab : tab.position);
    };

    TabContainer.prototype.createTab = function(url, options) {
        var tab = new Tab(url, options, this.getCurrentTab());
        tab.position = this._tabs.length;
        this._tabs.push(tab);
        return (tab);
    }

    TabContainer.prototype.isOpen = function(url, options) {
        var index = _.findIndex(this._tabs, function(e) {
            return !e.deleted && e.url === url &&
                (!options.hash && !e.hash || options.hash == e.hash) &&
                _.isEqual(options.urlFilter, e.urlFilter)
        });
        return (index >= 0);
    };

    TabContainer.prototype.getTab = function(url, options) {

        return _.find(this._tabs, function(e) {
            return !e.deleted && e.url === url &&
                (!options.hash && !e.hash || options.hash == e.hash) &&
                _.isEqual(options.urlFilter, e.urlFilter)
        });
    };

    TabContainer.prototype.getTabSimple = function(url, options) {

        return _.find(this._tabs, function(e) {
            return !e.deleted && e.url.split('/')[1] === url.split('/')[1]
        });
    };

    TabContainer.prototype.len = function() {
        var size = 0;

        this._tabs.forEach(function(e) {
            size += !e.deleted;
        })
        return (size);
    }

    TabContainer.prototype.getPrevTab = function(tab) {

        for (var i = tab.position - 1; i >= 0; i--) {
            if (this._tabs[i].deleted === false)
                return (this._tabs[i]);
        }
    };

    TabContainer.prototype.close = function(tab) {
        if (this.len() > 1) {
            console.log("multiple tabs")
            if (this.remove(tab)) {
                $location.url(tab.prevTab.fullUrl ||  '/intervention/list')
            }
        } else {
            console.log("only tab")
            $location.url(tab.prevTab.fullUrl ||  '/intervention/list');
            this.noClose = true;
            //this.remove(tab);
        }
    }

    TabContainer.prototype.remove = function(tab) {
        var newTabs = [];
        var j = 0;

        if (this._tabs.length <= 1) {
            return false;
        }
        var reload = (this.selectedTab === tab.position);
        for (var i = 0; i < this._tabs.length; i++) {
            if (i !== tab.position) {
                newTabs.push(this._tabs[i]);
                newTabs[j].position = j;
                ++j;
            }
        }
        this._tabs = newTabs;

        if (this.selectedTab === tab.position && this.selectedTab !== 0) {
            this.selectedTab--;
        }
        if (this.selectedTab > tab.position) {
            this.selectedTab--;
        }
        return (reload);
    }

    TabContainer.prototype.getCurrentTab = function() {
        return this._tabs[this.selectedTab];
    }
    TabContainer.prototype.addTab = function(url, options) {
        var tab;
        var noOpen = [
            '/list',
            '/search',
            '/recap',
            'lpa',
            '/artisan/contact',
            '/tools/edit',
        ]
        if (this.noClose) {
            tab = this._tabs[0]
        } else if (_.find(noOpen, _.partial(_.includes, url)) && this.getTabSimple(url)) {
            tab = this.getTabSimple(url);
        } else if (this.noClose || this.isOpen(url, options)) {
            tab = this.getTab(url, options)
        } else {
            tab = this.createTab(url, options);
        }
        this.noClose = false;
        if (!(options && options.setFocus === false)) {
            this.setFocus(tab)
        }
        if (options && options.title) {
            tab.setTitle(options.title);
        }
    }

    return (new TabContainer());

}]);
angular.module('edison').factory('Signalement', function(edisonAPI) {
    "use strict";

    var Signalement = function(inter) {
        this.intervention = inter;
    }

    Signalement.prototype.list = []
    return Signalement;
});
angular.module('edison').factory('Tab', function() {


    var Tab = function(container, location) {
        this.container = container;
        this.title = "...";
        this.path = location.path();
        this.url = location.path().split('/').slice(1)
        this.model = this.url[0]
        this.route = this.url[1]
        this.hash = location.hash();
        this.title = this.url[this.url.length - 1]
        this.date = new Date;
    }
    Tab.prototype.setTitle = function(title) {
        this.title = title
        return this;
    };

    Tab.prototype.close = function() {
        this.container.close(this);
    }

    Tab.prototype.setData = function(data) {
        this.data = data;
        return this;
    };
    return Tab;

})

angular.module('edison').factory('TabContainer', function(Tab, $location) {
    "use strict";

    var TabContainer = {
        __tabs: [],
        __ordered: {}
    }


    TabContainer.find = function(location) {
        var cmp = new Tab(this, location)
        return _.find(this.__tabs, function(e) {
            if (e.route === 'list' && cmp.route === 'list') {
                return cmp.model === e.model
            }
            return e.path == location.path() && e.hash == location.hash()
        })
    }

    TabContainer.ordered = function() {
        return this.__ordered;
    }
    TabContainer.close = function(tab) {
        var index = _.findIndex(this.__tabs, function(e) {
            return e.path == tab.path && e.hash == location.hash
        })
        this.__tabs.splice(index, 1);
        $location.url('/intervention/list');
    }



    TabContainer.add = function(location) {
        var tab = this.find(location);
        if (!tab) {
            this.selectedTab = new Tab(this, location);
            this.__tabs.push(this.selectedTab)
        } else {
            this.selectedTab = tab
        }
        return this;
    }

    TabContainer.getCurrentTab = function() {
        return this.selectedTab;
    }
    TabContainer.order = function() {
        var _this = this;
        var models = ["intervention", "artisan", "devis", 'tools', 'compta'];
        var tmp = {};
        _.each(_this.__tabs, function(e) {
            if (_.includes(models, e.model) && e.url[1] !== 'list' && e.url[1] !== 'contact') {
                var dest =  _.endsWith(e.model, 's') ? e.model : e.model + 's';
            } else {
                dest = 'Recents';
            }
            tmp[dest] = tmp[dest] || {
                title: dest,
                tabs: []
            };
            tmp[dest].tabs.push(e)
        })
        this.__ordered = tmp
        return this;
    }
    TabContainer.getOrdered = function() {
        return this.__ordered;
    }


    return TabContainer

});
angular.module('edison').factory('Address', function() {
    "use strict";

    var Address = function(place, copyContructor) {
        if (place.lat && place.lng) {
            this.lt = place.lat;
            this.lg = place.lng;
        } else if (copyContructor) {
            this.getAddressProprieties(place);
            this.streetAddress = true;
        } else if (this.isStreetAddress(place)) {
            this.getPlaceProprieties(place);
        } else if (this.isLocalityAddress(place)) {
            this.getPlaceLocalityProprieties(place);
        }
        if (place.geometry) {
            this.lt = place.geometry.location.lat();
            this.lg = place.geometry.location.lng();
        }
        this.latLng = this.lt + ', ' + this.lg;
    };

    Address.prototype.getPlaceLocalityProprieties = function(place) {
        var a = place.address_components;
        this.cp = a[1] && a[1].short_name;
        this.v = a[0] && a[0].short_name;
    }

    Address.prototype.getPlaceProprieties = function(place) {
        var a = place.address_components;
        this.n = a[0] && a[0].short_name;
        this.r = a[1] && a[1].short_name;
        this.cp = a[6] && a[6].short_name;
        this.v = a[2] && a[2].short_name;
    }

    Address.prototype.getAddressProprieties = function(address) { 
        this.n = address.n;
        this.r = address.r;
        this.cp = address.cp;
        this.v = address.v;
        this.lt = address.lt;
        this.lg = address.lg;
        this.code = address.code;
        this.etage = address.etage;
        this.batiment = address.batiment;
    }

    Address.prototype.isLocalityAddress = function(place) {
        this.localityAddress = (place.types.indexOf("locality") >= 0);
        return this.localityAddress;
    }

    Address.prototype.isStreetAddress = function(place) {
        var noStreet = ["locality", "country", "postal_code", "route", "sublocality"];
        this.streetAddress = (noStreet.indexOf(place.types[0]) < 0);
        return (this.streetAddress);
    }

    Address.prototype.toString = function() {
        return (this.n + " " + this.r + " " + this.cp + ", " + this.v + ", France")
    }

    return (function(place, copyContructor) {
        return new Address(place, copyContructor);
    })
});
angular.module('edison').factory('edisonAPI', ['$http', '$location', 'Upload', function($http, $location, Upload) {
    "use strict";
    return {
        product: {
            list: function() {
                return $http.get('/api/product/list');
            },
            save: function(data) {
                return $http.post('/api/product/__save', data);
            }
        },
        signal: {
            list: function() {
                return $http.get('/api/signal/list');
            },
            save: function(data) {
                return $http.post('/api/signal/__save', data);
            }
        },
        compte: {
            list: function() {
                return $http.get('/api/compte/list');
            },
            save: function(data) {
                return $http.post('/api/compte/__save', data);
            }
        },
        combo: {
            list: function() {
                return $http.get('/api/combo/list');
            },
            save: function(data) {
                return $http.post('/api/combo/__save', data);
            }
        },
        stats: {
            telepro: function() {
                return $http.get('/api/stats/telepro');
            },
            day: function() {
                return $http.get('/api/stats/day');
            }
        },
        users: {
            logout: function() {
                return $http.get('/logout');
            },
            save: function(data) {
                return $http.post('/api/user/__save', data);
            },
            list: function() {
                return $http.get('/api/user/list');
            }
        },
        bfm: {
            get: function() {
                return $http.get('/api/bfm');
            }
        },
        compta: {
            lpa: function(data) {
                return $http.get('/api/intervention/lpa?d=' + (data.d ||  ''));
            },
            flush: function(data) {
                return $http.post('/api/intervention/flush', data);
            },
            flushMail: function(data) {
                return $http.post('/api/intervention/flushMail', data);
            },
            archivesPaiement: function() {
                return $http.get('/api/intervention/archivePaiement');
            },
            archivesReglement: function() {
                return $http.get('/api/intervention/archiveReglement');
            },
            avoirs: function() {
                return $http.get('/api/intervention/avoirs')
            },
            flushAvoirs: function(data) {
                return $http.post('/api/intervention/flushAvoirs', data);
            },

        },
        devis: {
            saveTmp: function(data) {
                return $http.post('/api/devis/temporarySaving', data);
            },
            getTmp: function(id) {
                return $http.get('/api/devis/temporarySaving?id=' + id);
            },
            get: function(id, options) {
                return $http({
                    method: 'GET',
                    cache: false,
                    url: '/api/devis/' + id,
                    params: options || {}
                }).success(function(result) {
                    return result;
                });
            },
            save: function(params) {
                if (!params.id) {
                    return $http.post("/api/devis", params)
                } else {
                    return $http.post("/api/devis/" + params.id, params)

                }
            },
            envoi: function(id, options) {
                return $http.post("/api/devis/" + id + "/envoi", options);
            },
            annulation: function(id, causeAnnulation) {
                return $http.post("/api/devis/" + id + "/annulation");
            },
            list: function() {
                return $http.get('api/devis/getCacheList')
            },
        },
        intervention: {
            dashboardStats: function(options) {
                return $http.get('/api/intervention/dashboardStats', {
                    params: options
                });
            },
            getTelMatch: function(text) {
                return $http.post('/api/intervention/telMatches', text);
            },
            saveTmp: function(data) {
                return $http.post('/api/intervention/temporarySaving', data);
            },
            getTmp: function(id) {
                return $http.get('/api/intervention/temporarySaving?id=' + id);
            },
            demarcher: function(id) {
                return $http({
                    method: 'POST',
                    url: '/api/intervention/' + id + '/demarcher'
                })
            },
            reactivation: function(id) {
                return $http.post('api/intervention/' + id + '/reactivation')
            },
            list: function() {
                return $http.get('api/intervention/getCacheList')
            },
            get: function(id, options) {
                return $http({
                    method: 'GET',
                    cache: false,
                    url: '/api/intervention/' + id,
                    params: options || {}
                }).success(function(result) {
                    return result;
                });
            },
            getCB: function(id) {
                return $http.get("/api/intervention/" + id + "/CB");
            },
            save: function(params) {
                if (!params.id) {
                    return $http.post("/api/intervention", params)
                } else {
                    return $http.post("/api/intervention/" + params.id, params)

                }
            },
            getFiles: function(id) {
                return $http({
                    method: 'GET',
                    url: "/api/intervention/" + id + "/getFiles"
                });
            },
            verification: function(id, options) {
                return $http.post("/api/intervention/" + id + "/verification", options);
            },
            annulation: function(id, options) {
                return $http.post("/api/intervention/" + id + "/annulation", options);
            },
            envoi: function(id, options) {
                return $http.post("/api/intervention/" + id + "/envoi", options);
            },
            sendFacture: function(id, options) {
                return $http.post("/api/intervention/" + id + "/sendFacture", options);
            },
            sendFactureAcquitte: function(id, options) {
                return $http.post("/api/intervention/" + id + "/sendFactureAcquitte", options);
            },
            statsBen: function(options) {
                return $http({
                    method: 'GET',
                    url: "/api/intervention/statsBen",
                    params: options
                });
            },
            commissions: function(options) {
                return $http({
                    method: 'GET',
                    url: "/api/intervention/commissions",
                    params: options
                });
            },
            scan: function(id) {
                return $http.post("/api/intervention/" + id + "/scan");
            }
        },
        artisan: {
            comment: function(id, text) {
                return $http.post('/api/artisan/' + id + '/comment', {
                    text: text
                })
            },
            absence: function(id, absence) {
                return $http.post('/api/artisan/' + id + '/absence', absence)
            },
            sendFacturier: function(id, facturier, deviseur) {
                return $http.post('/api/artisan/' + id + '/sendFacturier', {
                    facturier: facturier,
                    deviseur: deviseur,
                });
            },
            saveTmp: function(data) {
                return $http.post('/api/artisan/temporarySaving', data);
            },
            fullHistory: function(id) {
                return $http.get('/api/artisan/' + id + '/fullHistory');
            },
            getTmp: function(id) {
                return $http.get('/api/artisan/temporarySaving?id=' + id);
            },
            getCompteTiers: function(id_sst) {
                return $http.get(['/api/artisan', id_sst, 'compteTiers'].join('/'));
            },
            envoiContrat: function(id, options) {
                return $http.post("/api/artisan/" + id + '/sendContrat', options)
            },
            upload: function(file, name, id) {
                return Upload.upload({
                    url: '/api/artisan/' + id + "/upload",
                    fields: {
                        name: name,
                        id: id
                    },
                    file: file
                })
            },
            getFiles: function(id) {
                return $http({
                    method: 'GET',
                    url: "/api/artisan/" + id + "/getFiles"
                });
            },
            extendedStats: function(id) {
                return $http.get('/api/artisan/' + id + "/extendedStats")
            },
            statsMonths: function(id) {
                return $http.get('/api/artisan/' + id + "/statsMonths")
            },
            save: function(params) {
                if (!params.id) {
                    return $http.post("/api/artisan", params)
                } else {
                    return $http.post("/api/artisan/" + params.id, params)

                }
            },
            list: function(options) {
                return $http.get('api/artisan/getCacheList')
            },
            lastInters: function(id) {
                return $http({
                    method: 'GET',
                    url: '/api/artisan/' + id + '/lastInters',
                })
            },
            get: function(id, options) {
                return $http({
                    method: 'GET',
                    cache: false,
                    url: '/api/artisan/' + id,
                    params: options || {}
                }).success(function(result) {
                    return result;
                });
            },
            getNearest: function(address, categorie) {
                return $http({
                    method: 'GET',
                    url: "/api/artisan/rank",
                    cache: false,
                    params: {
                        categorie: categorie,
                        lat: address.lt,
                        lng: address.lg,
                        limit: 50,
                        maxDistance: 100
                    }
                });
            },
            getStats: function(id_sst) {
                return $http({
                    method: 'GET',
                    url: "/api/artisan/" + id_sst + "/stats"
                });
            },
        },
        task: {
            add: function(params) {
                return $http.post('/api/task/add', params)
            },
            check: function(id) {
                return $http.post('/api/task/' + id + '/check')
            },
            listRelevant: function(options) {
                return $http.get('/api/task/relevant', {
                    params: options
                });
            }
        },
        signalement: {
            check: function(id, text) {
                return $http.post('/api/signalement/' + id + '/check', {
                    text: text
                })
            },
            add: function(params) {
                return $http.post('/api/signalement/add', params)
            },
            list: function(params) {
                return $http.get('/api/signalement/list', {
                    params: params
                })
            },
            stats: function() {
                return $http.get('/api/signalement/stats')
            }
        },
        file: {
            uploadScans: function(file, options) {
                return Upload.upload({
                    url: '/api/document/uploadScans',
                    fields: options,
                    file: file
                })
            },
            upload: function(file, options) {
                return Upload.upload({
                    url: '/api/document/upload',
                    fields: options,
                    file: file
                })
            },
            scan: function(options) {
                return $http.post('/api/document/scan', options);
            }
        },
        call: {
            get: function(origin, link) {
                return $http({
                    method: 'GET',
                    url: '/api/calls/get',
                    params: {
                        q: JSON.stringify({
                            link: link
                        })
                    }
                })
            },
            save: function(params) {
                return $http.post('/api/calls', params);
            },
        },
        sms: {
            get: function(origin, link) {
                return $http({
                    method: 'GET',
                    url: '/api/sms/get',
                    params: {
                        q: JSON.stringify({
                            link: link,
                            origin: origin
                        })
                    }
                })
            },
            send: function(params) {
                return $http.post("/api/sms/send", params)
            },

        },
        getDistance: function(origin, destination) {
            return $http({
                method: 'GET',
                cache: true,
                url: '/api/mapGetDistance',
                params: {
                    origin: origin,
                    destination: destination
                }
            })
        },
        request: function(options) {
            return $http({
                method: options.method || 'GET',
                url: '/api/' + options.fn,
                params: options.data
            });
        },
        searchPhone: function(tel) {
            return $http({
                method: 'GET',
                url: "api/arcep/" + tel + "/search"
            });
        },
        getUser: function() {
            return $http({
                method: 'GET',
                cache: true,
                url: "/api/whoAmI"
            });
        },
        searchText: function(text, options) {
            return $http({
                method: 'GET',
                params: options,
                url: ['api', 'search', text].join('/')
            })
        }
    }
}]);
angular.module('edison')
    .factory('Artisan', function($window, $rootScope, user, $location, LxNotificationService, LxProgressService, dialog, edisonAPI, textTemplate) {
        "use strict";
        var Artisan = function(data) {
            if (!(this instanceof Artisan)) {
                return new Artisan(data);
            }
            for (var k in data) {
                this[k] = data[k];
            }
        }

        var appelLocal = function(tel) {
            console.log('---->', tel);
            if (tel) {
                $window.open('callto:' + tel, '_self', false);
            }
        }

        Artisan.prototype.callTel1 = function() {
            appelLocal(this.telephone.tel1)
        }
        Artisan.prototype.callTel2 = function() {
            appelLocal(this.telephone.tel2)
        }


        Artisan.prototype.typeOf = function() {
            return 'Artisan';
        }

        Artisan.prototype.ouvrirFiche = function() {
            $location.url("/artisan/" + this.id);
        }
        Artisan.prototype.ouvrirRecap = function() {
            $location.url("/artisan/" + this.id + '/recap');
        }
        Artisan.prototype.facturierDeviseur = function() {
            var _this = this;
            dialog.facturierDeviseur(this, function(facturier, deviseur) {
                edisonAPI.artisan.sendFacturier(_this.id, facturier, deviseur);
            })
        }

        Artisan.prototype.deArchiver = function() {
            this.status = "ACT";
            Artisan(this).save();
        }
        Artisan.prototype.archiver = function() {
            this.status = "ARC";
            Artisan(this).save();
        }

        Artisan.prototype.call = function(cb) {
            var _this = this;
            var now = Date.now();
            $window.open('callto:' + _this.telephone.tel1, '_self', false)
        };


        Artisan.prototype.save = function(cb) {
            var _this = this;

            edisonAPI.artisan.save(_this)
                .then(function(resp) {
                    LxNotificationService.success("Les données ont à été enregistré");
                    if (typeof cb === 'function')
                        cb(null, resp.data)
                }).catch(function(error) {
                    LxNotificationService.error(error.data);
                    if (typeof cb === 'function')
                        cb(error.data)
                });
        };


        Artisan.prototype.manager = function(cb) {
            var _this = this;
            _this.login.management = user.login;
            edisonAPI.artisan.save(_this)
                .then(function(resp) {
                    LxNotificationService.success("Vous manager désormais " + _this.nomSociete);
                    if (typeof cb === 'function')
                        cb(null, resp.data)
                }).catch(function(error) {
                    LxNotificationService.error(error.data);
                    if (typeof cb === 'function')
                        cb(error.data)
                });
        };

        Artisan.prototype.upload = function(file, name, cb) {
            var _this = this;
            if (file) {
                LxProgressService.circular.show('#5fa2db', '#fileUploadProgress');
                edisonAPI.artisan.upload(file, name, _this.id)
                    .success(function(resp) {
                        _this.document = resp.document;
                        LxProgressService.circular.hide();
                        if (typeof cb === 'function')
                            cb(null, resp);
                    }).catch(function(err) {
                        LxProgressService.circular.hide();
                        if (typeof cb === 'function')
                            cb(err);
                    })
            }
        }

        Artisan.prototype.envoiContrat = function(cb) {
            var _this = this;
            dialog.sendContrat({
                data: _this,
                text: _.template(textTemplate.mail.artisan.envoiContrat())(_this),
            }, function(options) {
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.artisan.envoiContrat(_this.id, {
                    text: options.text,
                    signe: options.signe
                }).success(function(resp) {
                    LxProgressService.circular.hide()
                    if (typeof cb === 'function')
                        cb(null, resp);
                });
            });
        }
        Artisan.prototype.rappelContrat = function(cb) {
            var _this = this;
            _this.datePlain = moment(_this.date.ajout).format('ll')
            dialog.sendContrat({
                data: _this,
                text: _.template(textTemplate.mail.artisan.rappelContrat())(_this),
            }, function(options) {
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.artisan.envoiContrat(_this.id, {
                    text: options.text,
                    signe: options.signe,
                    rappel: true
                }).success(function(resp) {
                    LxProgressService.circular.hide()
                    if (typeof cb === 'function')
                        cb(null, resp);
                });
            });
        }

        Artisan.prototype.ouvrirFiche = function() {
            $location.url("/artisan/" + this.id);
        }
        return Artisan;
    });
angular.module('edison').factory('ContextMenu', function($rootScope, $location, edisonAPI, $window, $timeout, dialog, Devis, Intervention, Artisan, contextMenuData) {
    "use strict";

    var ContextMenu = function(model) {
        var _this = this;
        this.model = model
        this.list = contextMenuData[model];
        $rootScope.$on('closeContextMenu', function() {
            return _this.active && _this.close();
        })
        this.style = {
            left: 0,
            top: 0,
            display: "none"
        }
    }

    ContextMenu.prototype.openSub = function(delay) {
        var _this = this
        this.openSubTimeout = $timeout(function() {
            _this.mouseOverCM = true
        }, delay || 0)

    }

    ContextMenu.prototype.closeSub = function() {
        if (this.openSubTimeout) {
            $timeout.cancel(this.openSubTimeout);
        }
        this.mouseOverCM = false
    }

    ContextMenu.prototype.getData = function() {
        return this.data;
    }
    ContextMenu.prototype.setData = function(data) {
        this.data = data;
    }

    ContextMenu.prototype.setPosition = function(x, y) {
        this.style.left = (x - $('#main-menu-inner').width()) - 4;
        this.style.top = y - 48;
    }

    ContextMenu.prototype.active = false;

    ContextMenu.prototype.open = function() {
        var _this = this;
        this.closeSub()
        this.list.forEach(function(e) {
            if (e.subs) {
                _.each(e.subs, function(sub) {
                    sub.hidden = sub.hide && sub.hide(_this.data);
                })
            } else {
                e.hidden = e.hide && e.hide(_this.data);
            }
        });
        this.style.display = "block";
        this.active = true;
    }

    ContextMenu.prototype.close = function() {
        this.style.display = "none";
        this.active = false;

    }

    ContextMenu.prototype.modelObject = {
        intervention: Intervention,
        devis: Devis,
        artisan: Artisan
    }

    ContextMenu.prototype.tooltip = function(link) {
        return _.get(this.data, link.binding, '');
    }

    ContextMenu.prototype.click = function(link) {
        if (typeof link.action === 'function') {
            return link.action(this.getData())
        } else if (typeof link.action === 'string') {
            return this.modelObject[this.model]()[link.action].bind(this.data)();
        } else {
            console.error("error here")
        }
    }


    return ContextMenu

});
angular.module('edison').factory('DataProvider',function($timeout, edisonAPI, socket, $rootScope, config) {
    "use strict";
    var DataProvider = function(model, hashModel) {
        var _this = this;
        this.model = model;
        this.hashModel = hashModel || 't';
        this.rand = new Date
        socket.on(_this.socketListChange(), function(change) {
            if (_this.appliedList.indexOf(change.ts) === -1) {
                _this.appliedList.push(change.ts)
                _this.updateData(change.data);
            }
        });
    }

    DataProvider.prototype.socketListChange = function() {
        var _this = this;
        return _this.model.toUpperCase() + '_CACHE_LIST_CHANGE';
    }
    DataProvider.prototype.appliedList = [];

    DataProvider.prototype.data = {}

    DataProvider.prototype.setData = function(data) {
        this.data[this.model] = data;
    };

    DataProvider.prototype.init = function(cb) {
        var _this = this;

        if (_this.getData())
            return cb(_this.getData());
        edisonAPI[_this.model].list({
            cache: true
        }).success(function(resp) {
            _this.setData(resp);
            return cb(null, resp);
        })
    }

    DataProvider.prototype.rowFilterFactory = function(filter, hash) {
        var _this = this;
        if (!filter && hash) {
            return function onlyLogin(inter) {
                return inter[_this.hashModel] === hash;
            }
        }
        if (filter && hash) {
            return function loginAndFilter(inter) {
                return inter.f && inter.f[filter.short_name] === 1 && inter[_this.hashModel] === hash;
            }
        }
        if (filter && !hash) {
            return function onlyFilter(inter) {
                return inter.f && inter.f[filter.short_name] === 1;
            }
        }
    }

    DataProvider.prototype.applyFilter = function(filter, hash, customFilter) {
        this.filteredData = this.getData();
        if (this.getData() && (filter || hash || customFilter)) {
            this.filteredData = _.filter(this.getData(), customFilter || this.rowFilterFactory(filter, hash));
        }
    }

    DataProvider.prototype.flash = function(row) {
        row.flash = true;
        $timeout(function() {
            row.flash = false;
        }, 1000)
    }

    DataProvider.prototype.updateData = function(newRows) {
        var _this = this;
        if (this.getData()) {
            var id_list = _(newRows).flatten().map('id').value();
            for (var i = 0; i < _this.getData().length && id_list.length; i++) {
                var pos = id_list.indexOf(_this.getData()[i].id)
                if (pos >= 0) {
                    _this.getData()[i] = newRows[pos];
                    id_list.splice(pos, 1);
                }
            };
            if (id_list.length) {
                var z = _.filter(newRows, function(e) {
                    return _.includes(id_list, e.id);
                })
                _.each(z, function(x) {
                    _this.getData().unshift(x)
                })
            }
            $rootScope.$broadcast(_this.socketListChange());
        }

    }

    DataProvider.prototype.getData = function() {
        return this.data[this.model];
    }


    DataProvider.prototype.isInit = function() {
        return this.model && this.data && this.data[this.model];
    }
    return DataProvider;

});
angular.module('edison').factory('DateSelect', function() {
    "use strict";
    var DateSelect = function() {

        var _this = this;
        var d = new Date();
        _this.start = {
            m: 9,
            y: 2013
        }
        _this.current = {
            m: d.getMonth() + 1,
            y: d.getFullYear()
        }

        var frenchMonths = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
        _this._list = [];
        _.times(_this.current.y - _this.start.y + 1, function(yr) {
            _.times(12, function(mth) {
                _this._list.push({
                    m: mth + 1,
                    y: _this.start.y + yr,
                    t: frenchMonths[mth] + ' ' + (_this.start.y + yr),
                    o: (_this.start.y + yr) + (mth + 1) * 0.01
                })
            })
        })
        _this._list.splice(_this.current.m - 12)
    }
    DateSelect.prototype.list = function() {
        return this._list;
    }
    return DateSelect;
});
angular.module('edison')
    .factory('Devis', function(openPost, $window, $rootScope, $location, LxNotificationService, LxProgressService, dialog, edisonAPI, textTemplate) {
        "use strict";
        var Devis = function(data) {
            if (!(this instanceof Devis)) {
                return new Devis(data);
            }
            for (var k in data) {
                this[k] = data[k];
            }
        }

        var appelLocal = function(tel) {
            console.log('---->', tel);
            if (tel) {
                $window.open('callto:' + tel, '_self', false);
            }
        }

        Devis.prototype.callTel1 = function() {
            appelLocal(this.client.telephone.tel1)
        }
        Devis.prototype.callTel2 = function() {
            appelLocal(this.client.telephone.tel2)
        }
        Devis.prototype.callTel3 = function() {
            appelLocal(this.client.telephone.tel3)
        }

        Devis.prototype.typeOf = function() {
            return 'Devis';
        }
        Devis.prototype.save = function(cb) {
            var _this = this;
            console.log('yay')
            edisonAPI.devis.save(_this)
                .then(function(resp) {
                    console.log('resp')
                    var validationMessage = _.template("Les données du devis {{id}} ont à été enregistré")(resp.data);
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp.data)
                }, function(error) {
                    console.log('err')
                    LxNotificationService.error(error.data);
                    if (typeof cb === 'function')
                        cb("une erreur est " + error.data)
                }).catch(function(e) {
                    console.log('ERRRR:>', e)
                })
        };

        Devis.prototype.devisPreview = function() {
            if (!this.client.nom || !this.client.address.r || !this.client.address.v ||  !this.client.address.cp || !this.client.address.n) {
                return LxNotificationService.error('Les coordonées du devis sont incompletes');
            }
            if (!this.produits || !this.produits.length) {
                return LxNotificationService.error('Veuillez renseigner au moins 1 produits');
            }
            openPost('/api/intervention/devisPreview', {
                data: JSON.stringify(this),
                html: true
            })
        }

        Devis.prototype.sendDevis = function(cb) {
            var _this = this;
            if (!/\S+@\S+\.\S+/.test(_this.client.email)) {
                LxNotificationService.error("L'addresse email est invalide");
                return cb("err");
            }
            var preview = Devis(this).devisPreview.bind(this)
            dialog.getTextDevis(preview, {
                text: textTemplate.mail.devis.envoi.bind(_this)($rootScope.user),
                width: "900px",
                height: "700px"
            }, function(text) {
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.devis.envoi(_this.id, {
                    text: text,
                }).success(function(resp) {
                    LxProgressService.circular.hide()
                    var validationMessage = _.template("le devis {{id}} à été envoyé")(_this);
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function') {
                        console.log('yes cb')
                        cb(null, resp);
                    }
                }, function(err) {
                    LxProgressService.circular.hide()
                    var validationMessage = _.template("L'envoi du devis {{id}} à échoué\n")(_this)
                    if (err && err.data && typeof err.data === 'string')
                        validationMessage += ('\n(' + err.data + ')')
                    LxNotificationService.error(validationMessage);
                    if (typeof cb === 'function')
                        cb(err);
                }).catch(function(err) {
                    LxProgressService.circular.hide()
                    var validationMessage = _.template("L'envoi du devis {{id}} à échoué\n")(_this)
                    if (err && err.data && typeof err.data === 'string')
                        validationMessage += ('\n(' + err.data + ')')
                    LxNotificationService.error(validationMessage);
                    if (typeof cb === 'function')
                        cb(err);
                })

            })
        }
        Devis.prototype.annulation = function(cb) {
            var _this = this;
            edisonAPI.devis.annulation(_this.id)
                .then(function(resp) {
                    var validationMessage = _.template("Le devis {{id}} est annulé")(resp.data)
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp.data)
                });
        };

        Devis.prototype.ouvrirFiche = function() {
            $location.url("/devis/" + this.id);
        }
        Devis.prototype.transfert = function() {
            $location.url("/intervention?devis=" + this.id);
        }
        return Devis;
    });
angular.module('edison').factory('dialog', function(openPost, $mdDialog, edisonAPI, config, $window, LxNotificationService) {
    "use strict";

    return {
        verification: function(inter, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog, config) {
                    $scope.data = inter
                    $scope.config = config;
                    $scope.answer = function(cancel) {
                        $scope.window = $window;
                        $scope.inter = inter;
                        if (!cancel) {
                            if (!$scope.inter.prixFinal) {
                                LxNotificationService.error("Veuillez renseigner un prix final");
                            } else {
                                $mdDialog.hide();
                                cb(inter);
                            }
                        } else {
                            $mdDialog.hide();
                        }
                    }
                },
                templateUrl: '/DialogTemplates/verification.html',
            });
        },
        recouvrement: function(inter, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog, config) {
                    $scope.data = inter
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel) {
                            cb(inter);
                        }
                    }
                },
                templateUrl: '/DialogTemplates/recouvrement.html',
            });
        },
        validationReglement: function(inter, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.data = inter
                    $scope.answer = function(resp) {
                        $scope.data = inter;
                        $mdDialog.hide();
                        if (resp === null) {
                            return cb('nope')
                        }
                        if ($scope.data.compta.reglement.montant !== 0) {
                            $scope.data.compta.reglement.recu = resp;
                        }
                        return cb(null, $scope.data);
                    }
                },
                templateUrl: '/DialogTemplates/validationReglement.html',
            });
        },
        validationPaiement: function(inter, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.data = inter
                    $scope.preview = function() {
                        openPost('/api/intervention/autofacture', {
                            data: JSON.stringify($scope.data),
                            html: true
                        });
                    }
                    $scope.answer = function(resp) {
                        $scope.data = inter;
                        $mdDialog.hide();
                        if (resp === null) {
                            return cb('nope')
                        }
                        return cb(null, $scope.data);
                    }
                },
                templateUrl: '/DialogTemplates/validationPaiement.html',
            });
        },
        facturierDeviseur: function(artisan, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog, config) {
                    $scope.sst = artisan
                    $scope.deviseur = true;
                    $scope.facturier = true;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel) {
                            cb($scope.facturier, $scope.deviseur);
                        }
                    }
                },
                templateUrl: '/DialogTemplates/facturierDeviseur.html',
            });
        },
        envoiFacture: function(inter, text, showAcquitte, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.text = text
                    $scope.date = new Date();
                    $scope.showAcquitte = showAcquitte;
                    $scope.acquitte = showAcquitte;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel) {
                            cb(null, $scope.text, $scope.acquitte, $scope.date);
                        } else {
                            cb('nope')
                        }
                    }
                },
                templateUrl: '/DialogTemplates/envoiFacture.html',
            });
        },
        recap: function(inters) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog, config) {
                    $scope.inters = inters;
                    $scope.config = config
                    $scope.answer = function() {
                        $mdDialog.hide();
                    }
                },
                templateUrl: '/DialogTemplates/recapList.html',
            });
        },
        callsList: function(sst) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.sst = sst;
                    $scope.answer = function() {
                        $mdDialog.hide();
                    }
                },
                templateUrl: '/DialogTemplates/callsList.html',
            });
        },
        smsList: function(sst) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.sst = sst;
                    $scope.answer = function() {
                        $mdDialog.hide();
                    }
                },
                templateUrl: '/DialogTemplates/smsList.html',
            });
        },
        choiceText: function(options, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.options = options;
                    $scope.answer = function(resp, text) {
                        $mdDialog.hide();
                        return cb(resp, text);
                    }
                },
                templateUrl: '/DialogTemplates/choiceText.html',
            });
        },
        addProd: function(cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog, $window) {
                    $scope.pu = 0;
                    $scope.window = $window
                    $scope.quantite = 1;
                    $scope.prod = {
                        quantite: 1,
                        pu: 0,
                        title: "",
                        ref: ""
                    }
                    $scope.$watch('prod', function() {
                        $scope.prod.ref = $scope.prod.ref.toUpperCase();
                        $scope.prod.title = $scope.prod.title.toUpperCase();
                        $scope.prod.desc = $scope.prod.title;
                        $scope.prod.pu = $scope.prod.pu;
                        $scope.prod.quantite = $scope.prod.quantite;
                    }, true)
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel) {
                            return cb($scope.prod);
                        }
                    }
                },
                templateUrl: '/DialogTemplates/getProd.html',
            });
        },
        getCauseAnnulation: function(inter, cb) {
            $mdDialog.show({
                controller: function($scope, config) {
                    $scope.causeAnnulation = config.causeAnnulation;
                    inter.datePlain = moment(inter.date.intervention).format('DD/MM/YYYY')
                    $scope.textSms = _.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} à {{client.address.v}} le {{datePlain}} a été annulé. \nMerci de ne pas intervenir. \nEdison Services")(inter)
                    $scope.answer = function(resp) {
                        if (resp && !$scope.ca) {
                            return LxNotificationService.error("Veuillez renseigner une raison d'annulation");
                        }
                        $mdDialog.hide();
                        if (resp)
                            return cb(null, $scope.ca, $scope.reinit, $scope.sendSms, $scope.textSms);
                        return cb('nope');
                    }
                },
                templateUrl: '/DialogTemplates/causeAnnulation.html',
            });
        },
        sendContrat: function(options, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    options.signe = true;
                    $scope.options = options;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel)
                            return cb($scope.options);
                    }
                },
                templateUrl: '/DialogTemplates/sendContrat.html',
            });
        },
        getText: function(options, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.options = options;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel)
                            return cb($scope.options.text);
                    }
                },
                templateUrl: '/DialogTemplates/text.html',
            });
        },
        getTextDevis: function(previewFunction, options, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.options = options;
                    $scope.previewFunction = previewFunction;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (!cancel)
                            return cb($scope.options.text);
                    }
                },
                templateUrl: '/DialogTemplates/textDevis.html',
            });
        },
        getFileAndText: function(data, text, files, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.Math = Math
                    $scope.xfiles = _.clone(files ||  []);
                    $scope.smsText = text;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (cancel === false) {
                            return cb(null, $scope.smsText, $scope.addedFile);
                        } else {
                            return cb('nope');
                        }
                    }
                },
                templateUrl: '/DialogTemplates/fileAndText.html',
            });
        },
         envoiIntervention: function(data, text, cb) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.data = data;
                    $scope.smsText = text;
                    $scope.answer = function(cancel) {
                        $mdDialog.hide();
                        if (cancel === false) {
                            return cb(null, $scope.smsText, $scope.addedFile);
                        } else {
                            return cb('nope');
                        }
                    }
                },
                templateUrl: '/DialogTemplates/envoi.html',
            });
        },
        editProduct: {
            open: function(produit, cb) {
                $mdDialog.show({
                    controller: function DialogController($scope, $mdDialog) {
                        $scope.produit = _.clone(produit);
                        $scope.mdDialog = $mdDialog;
                        $scope.answer = function(p) {
                            $mdDialog.hide(p);
                            return cb(p);
                        }
                    },
                    templateUrl: '/DialogTemplates/edit.html',
                });
            }
        },
        selectSubProduct: function(elem, callback) {
            $mdDialog.show({
                controller: function DialogController($scope, $mdDialog) {
                    $scope.elem = elem
                    $scope.answer = function(cancel, item) {
                        $mdDialog.hide();
                        if (!cancel) {
                            return callback(item)
                        }
                    }
                },
                templateUrl: '/DialogTemplates/selectSubProduct.html',
            });
        }
    }

});
angular.module('edison').factory('fourniture', [function() {
    "use strict";

    return {
        init: function(fourniture) {
            this.fourniture = fourniture;
            if (!this.fourniture)
                this.fourniture = [];
            return this;
        },
        remove: function(index) {
            this.fourniture.splice(index, 1);
        },
        moveTop: function(index) {
            if (index !== 0) {
                var tmp = this.fourniture[index - 1];
                this.fourniture[index - 1] = this.fourniture[index];
                this.fourniture[index] = tmp;
            }

        },
        moveDown: function(index) {
            if (index !== this.fourniture.length - 1) {
                var tmp = this.fourniture[index + 1];
                this.fourniture[index + 1] = this.fourniture[index];
                this.fourniture[index] = tmp;
            }
        },
        add: function() {
            this.fourniture.push({
                bl: '0',
                title: 'Fourniture',
                quantite: 1,
                pu: 0
            });
        },
        total: function() {
            var total = 0;
            if (this.fourniture) {
                this.fourniture.forEach(function(e) {
                    total += (e.pu * e.quantite);
                })
            }
            return total
        }
    }

}]);
angular.module('edison')
    .factory('Intervention', function($location, $window, openPost, LxNotificationService, LxProgressService, dialog, user, config, edisonAPI, Devis, $rootScope, textTemplate) {
        "use strict";

        var Intervention = function(data) {
            if (!(this instanceof Intervention)) {
                return new Intervention(data);
            }
            for (var k in data) {
                this[k] = data[k];
            }
        };

        var appelLocal = function(tel) {
            console.log('---->', tel);
            if (tel) {
                $window.open('callto:' + tel, '_self', false);
            }
        }

        Intervention.prototype.callTel1 = function() {
            appelLocal(this.client.telephone.tel1)
        }
        Intervention.prototype.callTel2 = function() {
            appelLocal(this.client.telephone.tel2)
        }
        Intervention.prototype.callTel3 = function() {
            appelLocal(this.client.telephone.tel3)
        }

        Intervention.prototype.callSst1 = function() {
            appelLocal(this.sst.telephone.tel1)
        }
        Intervention.prototype.callSst2 = function() {
            appelLocal(this.sst.telephone.tel2)
        }

        Intervention.prototype.callPayeur1 = function() {
            appelLocal(this.facture.tel)
        }

        Intervention.prototype.callPayeur2 = function() {
            appelLocal(this.facture.tel2)
        }

        Intervention.prototype.typeOf = function() {
            return 'Intervention';
        };
        Intervention.prototype.envoiDevis = function(cb) {
            Devis().envoi.bind(this)(cb)
        };

        Intervention.prototype.validerReglement = function(cb) {
            var _this = this;
            dialog.validationReglement(this, function(err, resp) {
                if (err) {
                    return cb && cb(err);
                }
                edisonAPI.intervention.save(_this).then(function(resp) {
                    LxNotificationService.success("L'intervention " + _this.id + " est modifié");
                }, function(err) {
                    LxNotificationService.error("Une erreur est survenu (" + err.data + ")");
                });
            })
        };


        Intervention.prototype.validerPaiement = function(cb) {
            var _this = this;
            dialog.validationPaiement(this, function(err, resp) {
                if (err) {
                    return cb && cb(err);
                }
                edisonAPI.intervention.save(_this).then(function(resp) {
                    LxNotificationService.success("L'intervention " + _this.id + " est modifié");
                }, function(err) {
                    LxNotificationService.error("Une erreur est survenu (" + err.data + ")");
                });
            })
        };

        Intervention.prototype.demarcher = function(cb) {
            edisonAPI.intervention.demarcher(this.id).success(function() {
                LxNotificationService.success("Vous demarchez l'intervention");
            }, function() {
                LxNotificationService.error("Une erreur est survenu");
            })
        };

        Intervention.prototype.facturePreview = function() {
            openPost('/api/intervention/facturePreview', {
                data: JSON.stringify(this),
                html: true
            })
        }

        Intervention.prototype.factureAcquittePreview = function() {

            openPost('/api/intervention/factureAcquittePreview', {
                data: JSON.stringify(this),
                html: true
            })
        }


        Intervention.prototype.sendFactureAcquitte = function(cb) {
            var _this = this;
            var datePlain = moment(this.date.intervention).format('LL');
            var template = textTemplate.mail.intervention.factureAcquitte.bind(_this)(datePlain)
            var mailText = (_.template(template)(this))
            dialog.envoiFacture(_this, mailText, true, function(err, text, acquitte, date) {
                if (err)
                    return cb('nope')
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.intervention.sendFactureAcquitte(_this.id, {
                    text: text,
                    acquitte: acquitte,
                    date: date,
                    data: _this
                }).success(function(resp) {
                    LxProgressService.circular.hide();
                    var validationMessage = _.template("La facture de l'intervention {{id}} à été envoyé")(_this)
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    LxProgressService.circular.hide();
                    var validationMessage = _.template("L'envoi de la facture {{id}} à échoué\n" + "(" + err.data + ")")(_this)
                    LxNotificationService.error(validationMessage);
                    if (typeof cb === 'function')
                        cb(err);
                })
            })
        }

        Intervention.prototype.sendFacture = function(cb) {
            var _this = this;
            var datePlain = moment(this.date.intervention).format('LL');
            var template = textTemplate.mail.intervention.envoiFacture.bind(_this)(datePlain)
            var mailText = (_.template(template)(this))
            dialog.envoiFacture(_this, mailText, false, function(err, text, acquitte, date) {
                if (err)
                    return cb('nope')
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.intervention.sendFacture(_this.id, {
                    text: text,
                }).success(function(resp) {
                    LxProgressService.circular.hide();
                    var validationMessage = _.template("La facture de l'intervention {{id}} à été envoyé")(_this)
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    LxProgressService.circular.hide();
                    var validationMessage = _.template("L'envoi de la facture {{id}} à échoué\n" + "(" + err.data + ")")(_this)
                    LxNotificationService.error(validationMessage);
                    if (typeof cb === 'function')
                        cb(err);
                })
            })
        }

        Intervention.prototype.ouvrirFicheV1 = function() {
            $window.open('http://electricien13003.com/alvin/5_Gestion_des_interventions/show_res_bis_2.php?id_client=' + this.id)
        }
        Intervention.prototype.ouvrirFiche = function() {
            $location.url('/intervention/' + this.id)
        }
        Intervention.prototype.ouvrirRecapSST = function() {
            $location.url(['/artisan', this.artisan.id, 'recap'].join('/') + '#interventions')
        }
        Intervention.prototype.smsArtisan = function(cb) {

            var _this = this;
            var text = textTemplate.sms.intervention.demande.bind(this)(user, config);
            text = _.template(text)(this)
            dialog.getFileAndText(_this, text, [], function(err, text) {
                if (err) {
                    return cb(err)
                }
                edisonAPI.sms.send({
                    link: _this.sst.id,
                    origin: _this.id || _this.tmpID,
                    text: text,
                    to: _this.sst.telephone.tel1,
                }).success(function(resp) {
                    var validationMessage = _.template("Un sms a été envoyé à M. {{sst.representant.nom}}")(_this)
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    LxNotificationService.success("L'envoi du sms a échoué");
                    if (typeof cb === 'function')
                        cb(err);
                })
            })
        };

        Intervention.prototype.callClient = function(cb) {
            var _this = this;
            var now = Date.now();
            $window.open('callto:' + _this.client.telephone.tel1, '_self', false)
            dialog.choiceText({
                subTitle: _this.client.telephone.tel1,
                title: 'Nouvel Appel Client',
            }, function(response, text) {
                edisonAPI.call.save({
                    date: now,
                    to: _this.client.telephone.tel1,
                    link: _this.id,
                    origin: _this.id || _this.tmpID || 0,
                    description: text,
                    response: response
                }).success(function(resp) {
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    if (typeof cb === 'function')
                        cb(err);
                })
            })
        }
        Intervention.prototype.callArtisan = function(cb) {
            var _this = this;
            var now = Date.now();
            $window.open('callto:' + _this.artisan.telephone.tel1, '_self', false)
            dialog.choiceText({
                subTitle: _this.artisan.telephone.tel1,
                title: 'Nouvel Appel',
            }, function(response, text) {
                edisonAPI.call.save({
                    date: now,
                    to: _this.artisan.telephone.tel1,
                    link: _this.artisan.id,
                    origin: _this.id || _this.tmpID || 0,
                    description: text,
                    response: response
                }).success(function(resp) {
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    if (typeof cb === 'function')
                        cb(err);
                })
            })
        };
        Intervention.prototype.save = function(cb) {
            var _this = this;

            var fournitureSansFournisseur = _.find(this.fourniture, function(e) {
                return !e.fournisseur;
            })
            if (fournitureSansFournisseur) {
                LxNotificationService.error("Veuillez renseigner un fournisseur");
                return cb(fournitureSansFournisseur)
            }
            edisonAPI.intervention.save(_this)
                .then(function(resp) {
                    var validationMessage = _.template("Les données de l'intervention {{id}} ont à été enregistré.")(resp.data)
                    if ((_this.tmpID && _this.sst) || (_this.sst__id && _this.sst && _this.sst__id !== _this.sst.id)) {
                        validationMessage += "\n\n Un sms à été envoyé";
                    }
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp.data)
                }, function(error) {
                    LxNotificationService.error(error.data);
                    if (typeof cb === 'function')
                        cb(error.data)
                });
        };

        Intervention.prototype.envoi = function(cb) {
            var _this = this;
            var defaultText = textTemplate.sms.intervention.envoi.bind(_this)(user);
            dialog.envoiIntervention(_this, defaultText, function(err, text, file) {
                if (err)
                    return cb(err)
                LxProgressService.circular.show('#5fa2db', '#globalProgress');
                edisonAPI.intervention.envoi(_this.id, {
                    sms: text,
                    file: file
                }).then(function(resp) {
                    LxProgressService.circular.hide();
                    console.log('ok')
                    var validationMessage = _.template("L'intervention est envoyé")
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function')
                        cb(null, resp.data)

                }, function(error) {
                    LxProgressService.circular.hide();
                    console.log('error')
                    LxNotificationService.error(error.data);
                    if (typeof cb === 'function')
                        cb(error.data);
                });
            })
        };


        Intervention.prototype.reactivation = function(cb) {
            var _this = this;
            edisonAPI.intervention.reactivation(this.id).then(function() {
                LxNotificationService.success("L'intervention " + _this.id + " est à programmer");
            })
        };

        Intervention.prototype.annulation = function(cb) {
            var _this = this;
            dialog.getCauseAnnulation(_this, function(err, causeAnnulation, reinit, sms, textSms) {
                if (err) {
                    return typeof cb === 'function' && cb('err');
                }
                edisonAPI.intervention.annulation(_this.id, {
                        causeAnnulation: causeAnnulation,
                        reinit: reinit,
                        sms: sms,
                        textSms: textSms
                    })
                    .then(function(resp) {
                        var validationMessage = _.template("L'intervention {{id}} est annulé")(resp.data)
                        LxNotificationService.success(validationMessage);
                        if (typeof cb === 'function') {
                            cb(null, resp.data)
                        }
                    });
            });
        };


        Intervention.prototype.envoiFactureVerif = function(cb) {
            var _this = this;

            if (!this.produits.length) {
                LxNotificationService.error("Veuillez renseigner les produits");
                return cb('nope')
            }
            _this.sendFacture(function(err) {
                if (err)
                    return cb(err);
                _this.verificationSimple(cb)
            })
        }

        Intervention.prototype.verificationSimple = function(cb) {
            var _this = this;
            LxProgressService.circular.show('#5fa2db', '#globalProgress');

            edisonAPI.intervention.verification(_this.id)
                .then(function(resp) {
                    LxProgressService.circular.hide()
                    var validationMessage = _.template("L'intervention {{id}} est vérifié")(resp.data)
                    LxNotificationService.success(validationMessage);
                    if (typeof cb === 'function') {
                        cb(null, resp.data);
                    }
                }, function(error) {
                    LxProgressService.circular.hide()
                    LxNotificationService.error(error.data);
                    cb(error.data);
                })
        }

        Intervention.prototype.verification = function(cb) {
            var _this = this;
            if (!_this.reglementSurPlace) {
                return $location.url('/intervention/' + this.id)
            }
            dialog.verification(_this, function(inter) {
                Intervention(inter).save(function(err, resp) {
                    if (!err) {
                        return Intervention(resp).verificationSimple(cb);
                    }
                });
            });
        }


        Intervention.prototype.recouvrement = function(cb) {
            var _this = this;
            dialog.recouvrement(_this, function(inter) {
                Intervention(inter).save(function(err, resp) {
                    return (cb || _.noop)()
                });
            });
        }



        Intervention.prototype.fileUpload = function(file, cb) {

            var _this = this;

            if (file) {
                LxProgressService.circular.show('#5fa2db', '#fileUploadProgress');
                edisonAPI.file.upload(file, {
                    link: _this.id || _this.tmpID,
                    model: 'intervention',
                    type: 'fiche'
                }).success(function(resp) {
                    LxProgressService.circular.hide();
                    if (typeof cb === 'function')
                        cb(null, resp);
                }).catch(function(err) {
                    LxProgressService.circular.hide();
                    if (typeof cb === 'function')
                        cb(err);
                })
            }
        }

        Intervention.prototype.editCB = function() {
            var _this = this;
            edisonAPI.intervention.getCB(this.id).success(function(resp) {
                _this.cb = resp;
            }, function(error) {
                LxNotificationService.error(error.data);
            })
        }

        Intervention.prototype.reinitCB = function() {
            this.cb = {
                number: 0
            }
        }



        return Intervention;
    });
 angular.module('edison').directive('whenScrollEnds', function() {
        return {
            restrict: "A",
            link: function(scope, element, attrs) {
                var visibleHeight = element.height();
                var threshold = 100;

                element.scroll(function() {
                    var scrollableHeight = element.prop('scrollHeight');
                    var hiddenContentHeight = scrollableHeight - visibleHeight;

                    if (hiddenContentHeight - element.scrollTop() <= threshold) {
                        // Scroll is almost at the bottom. Loading more rows
                        scope.$apply(attrs.whenScrollEnds);
                    }
                });
            }
        };
    });angular.module('edison').factory('Map', function() {
    "use strict";

    var Map = function() {
        this.display = false;
    }

    Map.prototype.setCenter = function(address) {
        var myLatLng = new google.maps.LatLng(address.lt, address.lg);
        this.center = address;
        if (window.map)
            window.map.setCenter(myLatLng)
    }

    Map.prototype.setZoom = function(value) {
       // throw new Error('lol')
         if (window.map)
            window.map.setZoom(value)
        this.zoom = value
    }
    Map.prototype.show = function() {
        this.display = true;
    }
    return Map;
});
angular.module('edison').factory('mapAutocomplete', ['$q', 'Address',
    function($q, Address) {
        "use strict";
        var autocomplete = function() {
            this.service = new google.maps.places.AutocompleteService();
            this.geocoder = new google.maps.Geocoder();
        }

        autocomplete.prototype.search = function(input) {
            var deferred = $q.defer();
            this.service.getPlacePredictions({
                input: input,
                componentRestrictions: {
                    country: 'fr'
                }
            }, function(predictions) {
                if (predictions)
                    predictions.forEach(function(e) {
                        if (e.description === input)
                            predictions = null;
                    })
                deferred.resolve(predictions || []);
            });
            return deferred.promise;
        }

        autocomplete.prototype.getPlaceAddress = function(place) {
            var self = this;
            return $q(function(resolve, reject) {
                self.geocoder.geocode({
                    'address': place.description
                }, function(result, status) {
                    if (status !== google.maps.places.PlacesServiceStatus.OK)
                        return reject(status);
                    return resolve(Address(result[0]));
                });

            });
        };

        return new autocomplete();

    }
]);
angular.module('edison').factory('openPost', [function() {
    "use strict";
    return function(url, data) {
        var mapForm = document.createElement("form");
        mapForm.target = "_blank";
        mapForm.method = "POST";
        mapForm.action = url;

        // Create an input
        _.each(data, function(e, i) {
                var mapInput = document.createElement("input");
                mapInput.type = "text";
                mapInput.name = i;
                mapInput.value = typeof e == 'object' ? JSON.stringify(e) : e;
                mapForm.appendChild(mapInput);
            })
            // Add the form to dom
        document.body.appendChild(mapForm);

        // Just submit
        mapForm.submit();
        mapForm.remove();
    }
}]);
angular.module('edison').factory('productsList', function($q, dialog, openPost, edisonAPI) {
    "use strict";
    var Produit = function(produits) {
        this.produits = produits;
        var _this = this
        if (!this.ps) {
            edisonAPI.product.list().then(function(resp) {
                _this.ps = resp.data
            })
        }
        _.each(this.produits, function(e) {
            if (e.desc.toLowerCase() != e.title.toLowerCase()) {
                e.showDesc = true
            }
        })
        this.lastCall = _.now()
    }
    Produit.prototype = {
        remove: function(index) {
            this.produits.splice(index, 1);
        },
        moveTop: function(index) {
            if (index !== 0) {
                var tmp = this.produits[index - 1];
                this.produits[index - 1] = this.produits[index];
                this.produits[index] = tmp;
            }

        },
        moveDown: function(index) {
            if (index !== this.produits.length - 1) {
                var tmp = this.produits[index + 1];
                this.produits[index + 1] = this.produits[index];
                this.produits[index] = tmp;
            }
        },
        edit: function(index) {
            var _this = this;
            dialog.editProduct.open(this.produits[index], function(res) {
                _this.produits[index] = res;
            })
        },
        add: function(prod) {
            if (this.lastCall + 100 > _.now())
                return 0
            this.lastCall = _.now()
            this.searchText = '';
            prod.quantite = 1;
            this.produits.push(prod);
        },
        search: function(text) {
            var rtn = []
            for (var i = 0; i < this.ps.length; ++i) {
                if (text === this.ps[i].title)
                    return [];
                var needle = _.deburr(text).toLowerCase()

                var haystack = _.deburr(this.ps[i].title).toLowerCase();
                var haystack2 = _.deburr(this.ps[i].ref).toLowerCase();
                var haystack3 = _.deburr(this.ps[i].desc).toLowerCase();
                if (_.includes(haystack, needle) ||
                    _.includes(haystack2, needle) ||
                    _.includes(haystack3, needle)) {
                    var x = _.clone(this.ps[i])
                    x.random = _.random();
                    rtn.push(x)
                }
            }
            return rtn
        },
        /*        search: function(text) {
                    var deferred = $q.defer();
                    edisonAPI.searchProduct(text)
                        .success(function(resp) {
                            deferred.resolve(resp)
                        })
                    return deferred.promise;
                },*/
        getDetail: function(elem) {
            if (!elem)
                return 0
            var _this = this;
            dialog.selectSubProduct(elem, function(resp) {
                var rtn = {
                    showDesc: true,
                    quantite: 1,
                    ref: resp.ref,
                    title: elem.nom,
                    desc: resp.nom + '\n' + elem.description.split('-').join('\n'),
                    pu: Number(resp.prix)
                }
                _this.add(rtn)
            })
        },
        flagship: function() {
            return _.max(this.produits, 'pu');
        },
        total: function() {
            var total = _.round(_.sum(this.produits, function(e)  {
                return (e.pu || 0) * (e.quantite || 0);
            }), 2)
            return total;
        },

    }

    return Produit;


});
angular.module('edison').factory('socket', function(socketFactory) {
    "use strict";
    return socketFactory();
});
angular.module('edison').factory('taskList', ['dialog', 'edisonAPI', function(dialog, edisonAPI) {
    "use strict";
    var Task = function(user) {
        edisonAPI.get({
            to: user,
            done: false
        })
    }
    Task.prototype = {
        check: function(_id) {
            edisonAPI.check({
                _id: _id
            })
        },
        add: function(params) {
            edisonAPI.add(params)

        }
    }
    return Task;


}]);
angular.module('edison').factory('user', function($window) {
    "use strict";
    return $window.app_session;
});
 angular.module('edison').directive('infoAppelSst', function(mapAutocomplete, edisonAPI,config) {
     "use strict";
     return {
         restrict: 'E',
         templateUrl: '/Templates/info-appel-sst.html',
         scope: {
             data: "=",
         },
         link: function(scope, element, attrs) {
             console.log('sweg');
         },
     }

 });
 angular.module('edison').directive('infoFacture', function(mapAutocomplete, edisonAPI,config) {
     "use strict";
     return {
         restrict: 'E',
         templateUrl: '/Templates/info-facture.html',
         scope: {
             data: "=",
         },
         link: function(scope, element, attrs) {
             var model = scope.data;
             scope.config = config;
             scope.autocomplete = mapAutocomplete;
             scope.changeAddressFacture = function(place) {
                 mapAutocomplete.getPlaceAddress(place).then(function(addr) {
                     scope.data.facture = scope.data.facture ||  {}
                     scope.data.facture.address = addr;
                 });
             }
             edisonAPI.compte.list().then(function(resp) {
                 scope.grndComptes = resp.data
             })

             scope.changeGrandCompte = function() {
                 // var x = _.clone(config.compteFacturation[scope.data.facture.compte])
                 var x  = scope.data.facture.compte
                 scope.data.facture = _.find(scope.grndComptes, 'ref', scope.data.facture.compte);
                 scope.data.facture.payeur = "GRN";
                 scope.data.facture.compte = x;
             }
         },
     }

 });
angular.module('edison').directive('infoFourniture', ['config', 'fourniture',
    function(config, fourniture) {
        "use strict";
        return {
            restrict: 'E',
            templateUrl: '/Templates/info-fourniture.html',
            scope: {
                data: "=",
                display: "=",
                small:"="
            },
            link: function(scope, element, attrs) {
                scope.config = config
                scope.dsp = scope.display || false
                scope.data.fourniture = scope.data.fourniture || [];
                scope.fourniture = fourniture.init(scope.data.fourniture);
            },
        }

    }
]);
angular.module('edison').directive('mainNavbar', function($q, edisonAPI, TabContainer, $timeout, $rootScope, $location, $window) {
    "use strict";
    return {
        restrict: 'E',
        templateUrl: '/Templates/main-navbar.html',
        scope: {
            data: "=",
            display: "=",
            small: "="
        },
        link: function(scope, element, attrs) {
            scope.root = $rootScope;
            scope._ = _;
            scope.tabContainer = TabContainer;

            scope.select = function(model) {
                if (scope.selectedTab == model) {
                    scope.selectedTab = null
                } else {
                    scope.selectedTab = model
                }
            }
            $('input[type="search"]').ready(function() {
                $timeout(function() {
                    $('input[type="search"]').on('keyup', function(e, w) {
                        if (e.which == 13) {
                            if ($('ul.md-autocomplete-suggestions>li').length) {
                                $location.url('/search/' + $(this).val())
                                $(this).val("")
                                $(this).blur()
                            }
                        }
                    });
                }, 10);
            })

            $rootScope.$on('closeContextMenu', function() {
                scope.selectedTab = null;
            })




            scope.logout = function() {
                edisonAPI.users.logout().then(function() {
                    $window.location.reload()
                })
            }


            $rootScope.$on('closeSearchBar', function() {
                scope.searchBarSize = 100
            })

            var searchInput = 'md-autocomplete.searchBar>md-autocomplete-wrap>input'
            $(searchInput).ready(function() {
                $timeout(function() {
                    $(searchInput).on('focus', function() {
                        scope.searchFocus = true
                        var selectors = ['.navbar-header', '.navbar-nav', '.dropdown-toggle.user-menu']
                        scope.searchBarSize = _.reduce(selectors, function(total, el) {
                            return total -= $(el).width();
                        }, $(window).width() - 70)
                    })
                    $(searchInput).on('blur', function() {
                        scope.searchFocus = false
                        scope.searchBarSize = 100
                    })
                }, 10);
            })

            scope.changeUser = function(usr) {
                $rootScope.displayUser = usr
            }

            scope.searchBox = {
                search: function(x) {
                    var deferred = $q.defer();
                    edisonAPI.searchText(x, {
                        limit: 10,
                        flat: true
                    }).success(function(resp) {
                        deferred.resolve(resp)
                    })
                    return deferred.promise;
                },
                change: function(x) {
                    if (!x.link)
                        return 0;
                    if (x) {
                        $location.url(x.link)
                    }
                    $timeout(function() {
                        $(searchInput).blur();
                    });
                    scope.searchText = "";
                }
            }



        },
    }

});
angular.module('edison', ['chart.js','browserify', 'ui.slimscroll', 'ngMaterial', 'lumx', 'ngAnimate', 'xeditable', 'btford.socket-io', 'ngFileUpload', 'pickadate', 'ngRoute', 'ngResource', 'ngTable', 'ngMap'])
    .config(function($mdThemingProvider) {
        "use strict";
        $mdThemingProvider.theme('default')
            .primaryPalette('indigo')
            .accentPalette('blue-grey');
    })
    .run(function(editableOptions) {
        "use strict";
        editableOptions.theme = 'bs3'; // bootstrap3 theme. Can be also 'bs2', 'default'
    }).run(function($templateCache, $route, $http) {
        var url;
        for (var i in $route.routes) {
            if (url = $route.routes[i].templateUrl) {
                $http.get(url, {
                    cache: $templateCache
                });
            }
        }
        $http.get("/Directives/dropdown-row.html", {
            cache: $templateCache
        });

        $http.get("/Templates/artisan-categorie.html", {
            cache: $templateCache
        });
        $http.get("/Templates/info-client.html", {
            cache: $templateCache
        });
        $http.get("/Templates/info-categorie.html", {
            cache: $templateCache
        });
        $http.get("/Templates/autocomplete-map.html", {
            cache: $templateCache
        });
    }).config(function($compileProvider) {
        $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|callto|mailto|file|tel):/);
    });
angular.module('edison').controller('MainController', function($timeout, LxNotificationService, $q, DataProvider, TabContainer, $scope, socket, config, $rootScope, $location, edisonAPI, taskList, $window) {
    "use strict";

    $rootScope.app_users = app_users;
    $rootScope.displayUser = app_session
    $scope.sidebarHeight = $("#main-menu-bg").height();
    $scope.config = config;
    $scope._ = _;
    $rootScope.loadingData = true;
    $rootScope.$on('$routeChangeSuccess', function() {
        $window.scrollTo(0, 0);
        $rootScope.loadingData = false;
    });
    var _this = this;

    $rootScope.toggleSidebar = function(open) {
        if ($rootScope.sideBarMode === true) {
            $rootScope.sideBarIsClosed = open;
        }
    }

    $rootScope.toggleSidebarMode = function(newVal) {
        $rootScope.sideBarMode = _.isUndefined(newVal) ? !$rootScope.sideBarMode : newVal;
        $rootScope.sideBarIsClosed = $rootScope.sideBarMode
    }

    var checkResize = function() {
        $rootScope.smallWin = window.innerWidth < 1350
        return $rootScope.toggleSidebarMode($rootScope.smallWin);
    }
    $(window).resize(checkResize);
    checkResize();


    $scope.dateFormat = moment().format('llll').slice(0, -5);
    /*    $scope.$watch('tabs.selectedTab', function(prev, curr) {
            if (prev === -1 && curr !== -1) {
                $scope.tabs.selectedTab = curr;
            }
        });*/
    $rootScope.options = {
        showMap: true
    };


    var getSignalementStats = function() {
        edisonAPI.signalement.stats().then(function(resp) {
            $scope.signalementStats = resp.data;
        })
    }
    getSignalementStats()


    /*
        var bfm = function() {
            edisonAPI.bfm.get().then(function(resp) {
                $rootScope.events = resp.data;
            })
        }
        socket.on('event', _.debounce(bfm, _.random(0, 000)));

        bfm();*/

    var reloadStats = function() {
        console.log('reloadstats')
        edisonAPI.stats.telepro()
            .success(function(result) {
                $scope.userStats = _.find(result, function(e) {
                    return e.login === $scope.user.login;
                });
                $rootScope.interventionsStats = result;
            });

        edisonAPI.intervention.dashboardStats({
                date: moment().startOf('day').toDate()
            })
            .then(function(resp) {
                console.log('reload')
                _this.statsTeleproBfm = _.sortBy(resp.data.weekStats, 'total').reverse().slice(0, 6)
                    /*_this.statsTeleproBfm = _.reduce(classement, function(result, n, key) {
                        return result + " " + _.capitalize(n.login).slice(0, -2)
                    }, "")
                    console.log('==>',  _this.statsTeleproBfm)*/
            });

    };

    $rootScope.user = window.app_session
    reloadStats();
    socket.on('filterStatsReload', _.debounce(reloadStats, 1000));

    var notify = function(data) {
        if (!("Notification" in window)) {
            alert("This browser does not support desktop notification");
        }

        // Let's check whether notification permissions have already been granted
        else if (Notification.permission === "granted") {
            // If it's okay let's create a notification

            var notification = new Notification(data.message, {
                icon: '/img/notification.png'
            });
            console.log(notification)

        }

        // Otherwise, we need to ask the user for permission
        else if (Notification.permission !== 'denied') {
            Notification.requestPermission(function(permission) {
                // If the user accepts, let's create a notification
                if (permission === "granted") {
                    var notification = new Notification("Hi there!");
                }
            });
        }

    }

    window.notify = function() {
        LxNotificationService.notify("test", 'android', false, "red");
    }

    socket.on('notification', function(data) {
        if (data.dest === $rootScope.user.login && (data.dest !== data.origin || data.self)) {
       //     notify(data);
            LxNotificationService.notify(data.message, data.icon || 'android', false, data.color);
        }
        if (data.service && data.service === $rootScope.user.service) {
         //   notify(data);
            LxNotificationService.notify(data.message, data.icon || 'android', false, data.color);
        }
    })


    $rootScope.openTab = function(tab) {
        //   console.log('-->', tab);
    }

    $rootScope.closeContextMenu = function(ev) {
        $rootScope.$broadcast('closeContextMenu');
    }

    var devisDataProvider = new DataProvider('devis')
    var artisanDataProvider = new DataProvider('artisan')
    var interventionDataProvider = new DataProvider('intervention')




    this.tabContainer = TabContainer;
    $scope.$on("$locationChangeStart", function(event) {
        if (_.includes(["/intervention", '/devis', '/artisan', '/'], $location.path())) {
            return 0
        }
        TabContainer.add($location).order();
    })


    $scope.taskList = taskList;

    $scope.linkClick = function($event) {
        $event.preventDefault();
        $event.stopPropagation();
    };

    $scope.tabIconClick = function($event, tab) {
        $event.preventDefault();
        $event.stopPropagation();
        $scope.tabs.close(tab)
    };
});
var getIntervention = function($route, $q, edisonAPI) {
    "use strict";
    var id = $route.current.params.id;
    if ($route.current.params.d) {
        var deferred = $q.defer();
        $q.all([
            edisonAPI.devis.get($route.current.params.d, {
                select: 'date login produits tva client prixAnnonce categorie -_id'
            }),
            edisonAPI.intervention.getTmp(0)
        ]).then(function(result) {
            deferred.resolve(_.merge(result[1], result[0]));
        })
        return deferred.promise;

    } else if (id.length > 10) {
        return edisonAPI.intervention.getTmp(id);
    } else {
        return edisonAPI.intervention.get(id, {
            populate: 'sst'
        });
    }
};

var statsTelepro = function($route, $q, edisonAPI) {
    return edisonAPI.stats.telepro()
}

var getDevis = function($route, $q, edisonAPI) {
    "use strict";
    var id = $route.current.params.id;
    if ($route.current.params.i) {
        return edisonAPI.intervention.get($route.current.params.i, {
            select: 'client categorie tva -_id'
        });
    } else if (id.length > 10) {
        return edisonAPI.devis.getTmp(id);
    } else {
        return edisonAPI.devis.get(id);
    }
};
var getArtisan = function($route, $q, edisonAPI) {
    "use strict";
    var id = $route.current.params.id;
    if (id.length > 10) {
        return edisonAPI.artisan.getTmp(id);
    } else {
        return edisonAPI.artisan.get(id);
    }
}

angular.module('edison').config(function($routeProvider, $locationProvider) {
    "use strict";
    $routeProvider
        .when('/', {
            redirectTo: '/dashboard',
        })
        .when('/intervention/list', {
            templateUrl: "Pages/ListeInterventions/listeInterventions.html",
            controller: "ListeInterventionController",
            controllerAs: 'vm',
            reloadOnSearch: false

        })
        .when('/intervention/list/:fltr', {
            templateUrl: "Pages/ListeInterventions/listeInterventions.html",
            controller: "ListeInterventionController",
            controllerAs: 'vm',
            reloadOnSearch: false

        })
        .when('/intervention', {
            redirectTo: function(routeParams, path, params) {
                var url = params.devis ? "?d=" + params.devis : "";
                return '/intervention/' + Date.now() + url;
            }
        })
        .when('/intervention/:id', {
            templateUrl: "Pages/Intervention/intervention.html",
            controller: "InterventionController",
            controllerAs: "vm",
            reloadOnSearch: false,
            resolve: {
                interventionPrm: getIntervention,
            }
        })
        .when('/devis/list', {
            templateUrl: "Pages/ListeDevis/listeDevis.html",
            controller: "ListeDevisController",
            controllerAs: 'vm',
            reloadOnSearch: false

        })
        .when('/devis/list/:fltr', {
            templateUrl: "Pages/ListeDevis/listeDevis.html",
            controller: "ListeDevisController",
            controllerAs: "vm",
            reloadOnSearch: false

        })
        .when('/devis', {
            redirectTo: function(routeParams, path, params) {
                var url = params.i ? "?i=" + params.i : "";
                return '/devis/' + Date.now() + url;
            }
        })
        .when('/devis/:id', {
            templateUrl: "Pages/Intervention/devis.html",
            controller: "DevisController",
            controllerAs: "vm",
            resolve: {
                devisPrm: getDevis,
            }
        })
        .when('/artisan/contact', {
            templateUrl: "Pages/ListeArtisan/contactArtisan.html",
            controller: "ContactArtisanController",
            controllerAs: 'vm',
            reloadOnSearch: false
        })
        .when('/artisan/:sstid/recap', {
            templateUrl: "Pages/ListeArtisan/contactArtisan.html",
            controller: "ContactArtisanController",
            controllerAs: 'vm',
            reloadOnSearch: false

        })
        .when('/artisan/list', {
            templateUrl: "Pages/ListeArtisan/listeArtisan.html",
            controller: "ListeArtisanController",
            controllerAs: 'vm',
            reloadOnSearch: false

        })
        .when('/artisan/list/:fltr', {
            templateUrl: "Pages/ListeArtisan/listeArtisan.html",
            controller: "ListeArtisanController",
            controllerAs: "vm",
            reloadOnSearch: false

        })
        .when('/artisan', {
            redirectTo: function() {
                return '/artisan/' + Date.now();
            }
        })
        .when('/artisan/:id', {
            templateUrl: "Pages/Artisan/artisan.html",
            controller: "ArtisanController",
            controllerAs: "vm",
            resolve: {
                artisanPrm: getArtisan,
            }
        })
        .when('/dashboard', {
            controller: 'DashboardController',
            templateUrl: "Pages/Dashboard/dashboard.html",
            controllerAs: "vm",
            resolve: {
                statsTelepro: statsTelepro
            }
        })
        .when('/search/:query', {
            templateUrl: "Pages/Search/search.html",
            controller: "SearchController",
            controllerAs: "vm",
        })
        .when('/compta/lpa', {
            templateUrl: "Pages/LPA/LPA.html",
            controller: "LpaController",
            controllerAs: "vm",
        })
        .when('/compta/avoirs', {
            templateUrl: "Pages/Avoirs/avoirs.html",
            controller: "avoirsController",
            controllerAs: "vm",
        })
        .when('/compta/archivesPaiement', {
            templateUrl: "Pages/Archives/archives.html",
            controller: "archivesPaiementController",
            controllerAs: "vm",
        })
        .when('/compta/archivesReglement', {
            templateUrl: "Pages/Archives/archives.html",
            controller: "archivesReglementController",
            controllerAs: "vm",
        })
        .when('/tools/telephoneMatch', {
            templateUrl: "Pages/Tools/telephoneMatch.html",
            controller: "telephoneMatch",
            controllerAs: "vm",
        })
        .when('/tools/editProducts', {
            templateUrl: "Pages/Tools/edit-products.html",
            controller: "editProducts",
            controllerAs: "vm",
        })
        .when('/tools/editSignalements', {
            templateUrl: "Pages/Tools/edit-signalements.html",
            controller: "editSignalements",
            controllerAs: "vm",
        })
        .when('/listeSignalements', {
            templateUrl: "Pages/ListeSignalements/liste-signalements.html",
            controller: "listeSignalements",
            controllerAs: "vm",
            // reloadOnSearch: false
        })
        .when('/tools/editComptes', {
            templateUrl: "Pages/Tools/edit-comptes.html",
            controller: "editComptes",
            controllerAs: "vm",
        })
        .when('/tools/editCombos', {
            templateUrl: "Pages/Tools/edit-combos.html",
            controller: "editCombos",
            controllerAs: "vm",
        })
        .when('/tools/editUsers', {
            templateUrl: "Pages/Tools/edit-users.html",
            controller: "editUsers",
            controllerAs: "vm",
        })
        .when('/tools/commissions', {
            templateUrl: "Pages/Tools/commissions.html",
            controller: "CommissionsController",
            controllerAs: "vm",
            reloadOnSearch: false

        })
        .when('/stats/:type', {
            templateUrl: "Pages/Stats/stats.html",
            controller: "StatsController",
            controllerAs: 'vm',
            reloadOnSearch: false
        })
        .otherwise({
            redirectTo: '/dashboard'
        });
    // use the HTML5 History API
    $locationProvider.html5Mode(true);
});
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Edison Services</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <base href="/">
    <link href="/dist/styles.css" rel="stylesheet" type="text/css">
    <script src="/dist/libs.js"></script>
    <script src="//maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>
    <script src="/dist/bundle.js"></script>
    <script src="/dist/all.js"></script>
</head>

<body ng-app="edison" ng-controller="MainController as vm" style="  background: #f4f4f4 url(/img/mooning.png);" class="ng-cloak main-menu-fixed main-navbar-fixed theme-adminflare" ng-class="{'mmc' : sideBarIsClosed}">
    <div ng-if="vm.selectedModel" style="background-color:white;top:{{vm.selectedModel.top + 35}}px;left:{{vm.selectedModel.left}}px;width:300px;z-index:999999;position:absolute;box-shadow: rgba(0, 0, 0, 0.4) 3px 5px 12px;">
        <ul ng-repeat="tab in vm.selectedModel.tabs" style="padding:4px">
            <a class="dropdown-link" style="text-decoration: none!important;" href="{{tab.path}}{{tab.hash ? ('#' + tab.hash) : ''}}">{{tab.title}}</a>
        </ul>
    </div>
    <div id="main-wrapper" ng-hide="loadingData">
        <main-navbar></main-navbar>
        <side-bar ng-if="displayUser.login && interventionsStats" ng-mouseenter="toggleSidebar(false)" ng-mouseleave="toggleSidebar(true)">
            <div style="padding: 11px 33px;" class="menu-content animated fadeIn">
                <a href="/intervention" style="height: 31px;padding: 4px;" class="btn btn-primary btn-block btn-outline dark">Ajout d'une intervention</a>
            </div>
            <div style="padding: 11px 33px;" class="menu-content animated fadeIn">
                <a href="/devis" style="height: 31px;padding: 4px;" class="btn btn-primary btn-block btn-outline dark">Ajout d'un devis</a>
            </div>
            <drop-down id="service-intervention" title="Service Intervention" icon="circle" open-default="displayUser.service === 'INTERVENTION'">
                <link fltr="i_all" icon="th-list" title="Liste Interventions"></link>
                <drop-down title="Mes Interventions" icon="calendar" open-default="displayUser.service === 'INTERVENTION'">
                    <link fltr="i_tall" icon="th-list" color="default" text-white="true" bold="true" title="{{dateFormat}}" login="{{displayUser.login}}"></link>
                    <link fltr="i_tenv" icon="th-list" login="{{displayUser.login}}"></link>
                    <link fltr="i_apr" icon="th-list" color="primary" login="{{displayUser.login}}"></link>
                    <link fltr="i_avr" icon="th-list" color="warning" login="{{displayUser.login}}"></link>
                    <link fltr="i_fact" icon="th-list" color="danger" login="{{displayUser.login}}"></link>
                </drop-down>
                <drop-down title="Mes Factures" icon="dollar">
                    <link fltr="i_fall" icon="th-list" color="default" login="{{displayUser.login}}"></link>
                    <link fltr="i_fact" icon="th-list" color="danger" login="{{displayUser.login}}"></link>
                    <link fltr="i_carl" icon="th-list" color="warning" login="{{displayUser.login}}"></link>
                </drop-down>
                <drop-down icon="hospital-o" title="Mes Devis">
                    <link fltr="d_all" model="devis" icon="th-list" title="Tous les Devis" color="default"></link>
                    <link fltr="d_tall" model="devis" text-white="true" bold="true" title="{{dateFormat}}" color="success" icon="th-list" login="{{displayUser.login}}"></link>
                    <link fltr="d_aev" model="devis" icon="th-list" color="danger" login="{{displayUser.login}}"></link>
                    <link fltr="d_att" model="devis" icon="th-list" color="warning" login="{{displayUser.login}}"></link>
                    <link fltr="d_ann" model="devis" icon="th-list" color="default" login="{{displayUser.login}}"></link>
                </drop-down>
                <drop-down title="Mes Sous-Traitants" icon="truck">
                    <link fltr="i_sarl" icon="th-list" login="{{displayUser.login}}"></link>
                </drop-down>
                <drop-down icon="share" open-default="userStats.i_savEnc.total" title="Mes S.A.V">
                    <link fltr="i_savEnc" icon="th-list" title="SAV en cours" login="{{displayUser.login}}" color="danger"></link>
                </drop-down>
                <drop-down icon="bolt" open-default="userStats.i_litEnc.total" title="Mes Litiges">
                    <link fltr="i_lit" title="Tous les litiges" login="{{displayUser.login}}" icon="th-list"></link>
                    <link fltr="i_lit" login="{{displayUser.login}}" icon="th-list"></link>
                    <link fltr="i_litEnc" login="{{displayUser.login}}" icon="th-list" color="danger"></link>
                </drop-down>
            </drop-down>
            <drop-down title="Service Partenariat" icon="circle" open-default="displayUser.service === 'PARTENARIAT'">
                <link ng-if="signalementStats" title="Signalements Management" count="{{signalementStats[displayUser.service].level1}}" url="/listeSignalements?level=1&service={{displayUser.service}}&ok=false">
                <link ng-if="signalementStats" title="Signalements Avert." count="{{signalementStats[displayUser.service].level2}}" url="/listeSignalements?level=2&service={{displayUser.service}}&ok=false">
                <drop-down icon="truck" title="Artisans">
                    <link fltr="a_all" url="/artisan/contact#informations" icon="th-list" model="artisan" title="Repertoire"></link>
                    <link fltr="a_all" icon="th-list" model="artisan" login='{{displayUser.login}}' title="Mes Artisans"></link>
                    <link fltr="a_all" icon="th-list" model="artisan" title="Tous les Artisans" no-counter="true"></link>
                    <li>
                        <a href="/artisan"><i class="menu-icon fa fa-plus"></i><span class="mm-text">Nouvel Artisan</span></a>
                    </li>
                </drop-down>
                <drop-down icon="phone" title="Démarchage">
                    <link fltr="i_mar" icon="th-list" title="Market"></link>
                    <link fltr="i_pan" icon="th-list" login="{{displayUser.login}}" hash-model="dm" title="Mon Panier"></link>
                    <link fltr="i_davr" icon="th-list" title="Verifs" color="warning"></link>
                    <link fltr="i_hist" icon="th-list" title="Historique" no-counter="true"></link>
                </drop-down>
                <drop-down icon="suitcase" title="Management">
                    <link fltr="i_chq" icon="th-list" login="{{displayUser.login}}" hash-model="dm" title="Relances cheques"></link>
                    <link fltr="a_man" icon="th-list" model="artisan" login="{{displayUser.login}}" hash-model="mn" title="Mes SST"></link>
                </drop-down>
            </drop-down>
            <drop-down title="Service Comptabilité" icon="circle" open-default="displayUser.service === 'COMPTABILITE'">
                <simple-link icon="credit-card" fltr="i_carl" title="Tableau des relances" url="/intervention/list/relanceClient"></simple-link>
                <simple-link icon="credit-card" title="Liste Paiements Att." url="/compta/lpa"></simple-link>
                <simple-link icon="tags" title="Avoirs" url="/compta/avoirs"></simple-link>
                <simple-link icon="database" title="Archives Reglements Clt." url="/compta/archivesReglement"></simple-link>
                <simple-link icon="database" title="Archive Paiements Sst." url="/compta/archivesPaiement"></simple-link>
                <link icon="dollar" title="Intervenant à payer" fltr="i_iar"></link>
            </drop-down>
            <drop-down title="Outils" icon="circle">
                <simple-link ng-if="user.root" icon="wrench" title="Telephone Match" url="/tools/telephoneMatch"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Stats C.A" url="/stats/ca"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Produits" url="/tools/editProducts"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Combos" url="/tools/editCombos"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Utilisateurs" url="/tools/editUsers"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Grand Comptes" url="/tools/editComptes"></simple-link>
                <simple-link ng-if="user.root" icon="wrench" title="Signalements" url="/tools/editSignalements"></simple-link>
                <simple-link ng-if="user.root" icon="dollar" title="Commissions" url="/tools/commissions"></simple-link>
                <simple-link icon="wrench" title="VCF Clients" extern url="/api/intervention/vcf"></simple-link>
                <simple-link icon="wrench" title="VCF Artisan" extern url="/api/artisan/vcf"></simple-link>
            </drop-down>
        </side-bar>
        <div class="page-header" style="background: #f4f4f4 url(/img/mooning.png);">
            <div id="content-wrapper" ng-click="closeContextMenu($event);">
                <div ng-view style="margin-top: 16px;">
                </div>
                <div id="globalProgress" style="position:fixed;top: 50%;left: 57%;z-index: 12222;">
                    <span ng-if="globalProgressCounter">{{globalProgressCounter}}</span>
                </div>
            </div>
        </div>
        <div id="main-menu-bg"></div>
    </div>
    <!-- / #main-wrapper -->
    <div ng-show="loadingData || true" class="animate-loading">
        <div class="spinner">
            <!--             <div class="double-bounce1"></div>
            <div class="double-bounce2"></div> -->
        </div>
    </div>
    <footer class="footer sticky-footer">
        <ul list-justify>
            <li style="margin:0px 10px;padding:5px" ng-repeat="(key, value) in vm.statsTeleproBfm">
                <span class="badge white black-text" style="font-size:15px">{{_.capitalize(value.login).slice(0, -2)}}</span>
                <a href="/intervention/list/ajd?t={{value.login}}"><span class="badge">{{value.total}} Points</span></a>
                <span ng-if="!smallWin">
                <a href="/intervention/list/ajd?t={{value.login}}"><span class="badge blue">{{value.ajout}}</span></a>
                <a href="/intervention/list/envoyeAjd?t={{value.login}}"><span class="badge orange">{{value.envoi}}</span></a>
                <a href="/intervention/list/ajd?_etat=verifier#{{value.login}}"><span class="badge green">{{value.verif}}</span></a>
                <a href="/intervention/list/ajd?_etat=annuler#{{value.login}}"><span class="badge red">{{value.annul}}</span></a>
                </span>
            </li>
        </ul>
        <!--  <h2><marquee scrolldelay="60" scrollamount="14">
                <span style="display:inline;margin-right:120px" ng-repeat='e in events'>{{e.date|date:"HH'h'mm"}} - {{e.message}}</span>
            </marquee></h2> -->
    </footer>
</body>
<script type="text/javascript">
//  window.PixelAdmin.start(init);
String.prototype.replaceAll = function(target, replacement) {
    return this.split(target).join(replacement);
}
_.templateSettings.interpolate = /{{([\s\S]+?)}}/g;
</script>

</html>
<!DOCTYPE html>
<html>

<head>
    <title>
        Edison Services
    </title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="shortcut icon" href="/favicon.ico" />
    <style type="text/css">
    /**
 * parallax.css
 * @Author Original @msurguy -> http://bootsnipp.com/snippets/featured/parallax-login-form
 * @Reworked By @kaptenn_com 
 * @package PARALLAX LOGIN.
 */
    
    body {
        background: radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255, 255, 255, .1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255, 255, 255, .1) 15%, transparent 20%) 8px 9px;
        background-color: #282828;
        background-size: 16px 16px;
    }
    
    .form-signin input[type="text"] {
        margin-bottom: 5px;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .form-signin input[type="password"] {
        margin-bottom: 10px;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    
    .form-signin .form-control {
        position: relative;
        font-size: 16px;
        font-family: 'Open Sans', Arial, Helvetica, sans-serif;
        height: auto;
        padding: 10px;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }
    
    .vertical-offset-100 {
        padding-top: 100px;
    }
    
    .img-responsive {
        display: block;
        max-width: 100%;
        height: auto;
        margin: auto;
    }
    
    #key {
        -webkit-transition-duration: 0.85s;
        -moz-transition-duration: 0.85s;
        -o-transition-duration: 0.85s;
        transition-duration: 0.85s;
    }
    
    .rotated {
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -o-transform: rotate(90deg);
        transform: rotate(90deg);
    }
    
    .panel {
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.75);
        border: 1px solid transparent;
        border-radius: 4px;
        -webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
        box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
    }
    </style>
</head>

<body>
    <div class="container">
        <div class="row vertical-offset-100">
            <div class="col-md-4 col-md-offset-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="row-fluid user-row">
                            <img src="http://s11.postimg.org/7kzgji28v/logo_sm_2_mr_1.png" class="img-responsive" id="key" alt="Conxole Admin" />
                        </div>
                    </div>
                    <div class="panel-body">
                        <form accept-charset="UTF-8" role="form" class="form-signin" action="/login" method="post">
                            <fieldset>
                                <label class="panel-login">
                                    <div class="login_result"></div>
                                </label>
                                <input style="display:none" class="form-control" id="url" name="url" type="text">
                                <input class="form-control" placeholder="Utilisateur" name="username" id="username" type="text">
                                <input class="form-control" placeholder="Mot de passe" name="password" id="password" type="password">
                                <br></br>
                                <input class="btn btn-lg btn-success btn-block" type="submit" id="login" value="Se Connecter">
                            </fieldset>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    $(function() {
        $('#url').val(window.location.pathname);
    })
    $('#password').on('focus', function() {
        $("#key").addClass('rotated')
    })
    $('#password').on('blur', function() {
        $("#key").removeClass('rotated')
    })
    </script>
</body>

</html>
var Description = function(inter) {
    this.inter = inter;
    this.desc = inter.description
}

var rmve = function(str, a) {
    return str.split(a).join('');
}

var strip = function(s) {
    s = rmve(s, " DE ")
    s = rmve(s, " D'")
    s = rmve(s, " AU ")
    s = rmve(s, " A ")
    return s;
}

Description.prototype.search = function(str) {
    var _map = require('lodash/collection/map');
    var _sortBy = require('lodash/collection/sortby');
    var resemblance = require('resemblance');
    str = str.toUpperCase()
    var list = _map(this.data, function(e) {
        var res = 1 - resemblance.compareStrings(strip(e), str)
        return {
            match: res,
            name: e
        }
    })
    list = _sortBy(list, 'match').slice(0, 5)

    return list;
}

Description.prototype.data = [

    "ATTESTATION DE RECHERCHE DE FUITE",
    "BRANCHEMENT MACHINE A LAVER",
    "CHANGEMENT BARILLET",
    "CHANGEMENT CYLINDRE",
    "CHANGEMENT BARILLET",
    "CHANGEMENT CYLINDRE",
    "CHANGEMENT GROUPE DE SÉCURITÉ",
    "CHANGEMENT MÉCANISME WC",
    "CHANGEMENT SERRURE",
    "CHANGEMENT GROUPE DE SECURITÉ",
    "CHANGEMENT MECANISME CHASSE D'EAU",
    "CHANGEMENT SERRURE BOITE AU LETTRE",
    "CHANGEMENT SERRURE",
    "DEBOUCHAGE BAIGNOIRE",
    "DEBOUCHAGE CAMION POMPE",
    "DEBOUCHAGE CAMION",
    "DEBOUCHAGE CANALISATION CUISINE",
    "DEBOUCHAGE CANALISATION DOUCHE",
    "DEBOUCHAGE CANALISATION MACHINE A LAVER",
    "DEBOUCHAGE CANALISATION WC",
    "DEBOUCHAGE CANALISATION ÉVIER",
    "DEBOUCHAGE CANALISATION",
    "DEBOUCHAGE DOUCHE",
    "DEBOUCHAGE EVIER CUISINE",
    "DEBOUCHAGE EVIER",
    "DEBOUCHAGE LAVABO",
    "DEBOUCHAGE MACHINE A LAVER",
    "DEBOUCHAGE SANIBROYEUR",
    "DEBOUCHAGE TOILETTE",
    "DEBOUCHAGE WC",
    "DEBOUCHAGE",
    "DEVIS REMPLACEMENT DE VITRAGE",
    "DEVIS TRAVAUX DE ELECTRIQUE",
    "DEVIS TRAVAUX DE PLOMBERIE",
    "DEVIS TRAVAUX DE SERRURERIE",
    "DIAGNOSTIC DE PANNE ELECTRIQUE",
    "ENTRETIEN CHAUDIÈRE GAZ",
    "ENTRETIEN CHAUFFE EAU ELECTRIQUE",
    "FORFAIT BOITE AU LETTRE",
    "INSTALLATION MACHINE A LAVER",
    "OUVERTURE DE COFFRE FORT",
    "OUVERTURE DE COFFRE",
    "OUVERTURE DE PORTE + CHANGEMENT DE BARILLET",
    "OUVERTURE DE PORTE + CHANGEMENT DE CYLINDRE",
    "OUVERTURE DE PORTE + REMPLACEMENT BARILLET",
    "OUVERTURE DE PORTE + REMPLACEMENT",
    "OUVERTURE DE PORTE CLAQUÉ",
    "OUVERTURE DE PORTE DE CAVE",
    "OUVERTURE DE PORTE DE GARAGE",
    "OUVERTURE DE PORTE ET CHANGEMENT CYLINDRE",
    "OUVERTURE DE PORTE FERMÉE + CHANGEMENT DE BAR",
    "OUVERTURE DE PORTE FERMÉE A CLÉ",
    "OUVERTURE DE PORTE FERMÉE",
    "OUVERTURE DE PORTE WC",
    "OUVERTURE DE PORTE",
    "PACK WC",
    "PROBLEME DE SERRURE",
    "PROBLEME FERMETURE PORTE",
    "RECHERCHE DE FUITE + DEVIS DE TRAVAUX",
    "RECHERCHE DE FUITE + REPARATION SI POSSIBLE",
    "RECHERCHE DE FUITE DOUCHE",
    "RECHERCHE DE FUITE ENTRE MAISON ET COMPTEUR",
    "RECHERCHE DE FUITE GENERALE",
    "RECHERCHE DE FUITE NON VISIBLE",
    "RECHERCHE DE FUITE SALLE DE BAIN",
    "RECHERCHE DE FUITE SOUS BAIGNOIRE",
    "RECHERCHE DE FUITE SOUS LA DOUCHE",
    "RECHERCHE DE FUITE",
    "RECHERCHE DE PANNE + MISE EN SERVICE",
    "RECHERCHE DE PANNE + REMISE EN SERVICE",
    "RECHERCHE DE PANNE + REPARATION SI POSSIBLE",
    "RECHERCHE DE PANNE + REPARATION",
    "RECHERCHE DE PANNE BALLON D'EAU CHAUDE",
    "RECHERCHE DE PANNE BALLON ECS",
    "RECHERCHE DE PANNE BALLON",
    "RECHERCHE DE PANNE CHAUDIÈRE GAZ",
    "RECHERCHE DE PANNE CHAUDIÈRE",
    "RECHERCHE DE PANNE CHAUFFAGE",
    "RECHERCHE DE PANNE CHAUFFE EAU ELECTRIQUE",
    "RECHERCHE DE PANNE CHAUFFE EAU GAZ",
    "RECHERCHE DE PANNE CHAUFFE EAU",
    "RECHERCHE DE PANNE CLIMATISATION",
    "RECHERCHE DE PANNE ELECTRIQUE GENERALE",
    "RECHERCHE DE PANNE ELECTRIQUE PARTIEL",
    "RECHERCHE DE PANNE ELELECTRIQUE + MISE EN SERVICE",
    "RECHERCHE DE PANNE POINT LUMINEUX",
    "RECHERCHE DE PANNE RADIATEUR ELECTRIQUE",
    "RECHERCHE DE PANNE SUR CHAUFFE EAU",
    "RECHERCHE DE PANNE",
    "RECHERCHE DE PANNE ELECTRIQUE",
    "REMPLACEMENT BALLON 100L",
    "REMPLACEMENT BALLON 200L VERTICAL",
    "REMPLACEMENT BALLON 200L",
    "REMPLACEMENT BALLON 300L",
    "REMPLACEMENT BALLON",
    "REMPLACEMENT CHAUFFE EAU 200L",
    "REMPLACEMENT CHAUFFE EAU 300L",
    "REMPLACEMENT CYLINDRE BOITE AUX LETTRES",
    "REMPLACEMENT CYLINDRE EUROPÉEN",
    "REMPLACEMENT CYLINDRE",
    "REMPLACEMENT BARILLET",
    "REMPLACEMENT CYLINDRE",
    "REMPLACEMENT DV",
    "REMPLACEMENT VITRAGE",
    "REMPLACEMENT SIMPLE VITRAGE",
    "REMPLACEMENT DOUBLE VITRAGE",
    "REMPLACEMENT GROUPE DE SÉCURITÉ",
    "REMPLACEMENT MECANISME DE CHASSE D'EAU",
    "REMPLACEMENT MECANISME",
    "REMPLACEMENT MITIGEUR",
    "REMPLACEMENT MÉCANISME DE CHASSE",
    "REMPLACEMENT PACK WC",
    "REMPLACEMENT SANIBROYEUR",
    "REMPLACEMENT SERRURE BOITE AUX LETTRES",
    "REMPLACEMENT SERRURE",
    "REMPLACEMENT VITRAGE",
    "REMPLACEMENT WC",
    "REPARATION FUITE BALLON",
    "REPARATION FUITE CHAUFFE EAU",
    "REPARATION FUITE D'EAU",
    "REPARATION FUITE DERRIERE MACHINE A LAVER",
    "REPARATION FUITE DERRIERE WC",
    "REPARATION FUITE EVIER",
    "REPARATION FUITE MECANISME CHASSE D'EAU",
    "REPARATION FUITE RADIATEUR",
    "REPARATION FUITE SOUS BAIGNOIRE",
    "REPARATION FUITE SOUS CHAUFFE EAU ELECTRIQUE",
    "REPARATION FUITE SOUS CHAUFFE EAU",
    "REPARATION FUITE SOUS EVIER",
    "REPARATION FUITE SOUS LA DOUCHE",
    "REPARATION FUITE SOUS LAVABO",
    "REPARATION FUITE SOUS WC",
    "REPARATION FUITE SOUS ÉVIER",
    "REPARATION FUITE SUR TUYAUTERIE EN CUIVRE",
    "REPARATION FUITE SUR TUYAUTERIE",
    "REPARATION FUITE TUYAUTERIE CUIVRE",
    "REPARATION FUITE TUYAUTERIE PVC",
    "REPARATION FUITE TUYAUTERIE",
    "REPARATION FUITE WC",
    "REPARATION FUITE",
    "REPARATION MECANISME CHASSE D'EAU",
    "REPARATION SERRURE 3 POINTS",
    "REPARATION SERRURE",
    "REPARATION SERRURE",
    "REPARATION SUR SERRURE DE PORTE",
    "TRAVAUX DE PLOMBERIE",
    "TRAVAUX ELECTRIQUE",
    "TRAVAUX PLOMBERIE",
    "WC BOUCHE",
]

module.exports = Description;
var ms = require('milliseconds');
var _each = require('lodash/collection/each');
FiltersFactory = function(model) {
    if (!(this instanceof FiltersFactory)) {
        return new FiltersFactory(model);
    }
    this.model = model

}

var today = function() {
    var today = new Date()
    today.setHours(0)
    return today;
}

var dateInter = function(inter) {
    return (new Date(inter.date.intervention)).getTime()
}

FiltersFactory.prototype.__getFilterBy = function(key, value) {
    var _this = this;
    var rtn;
    _each(_this.list[_this.model], function(e, k) {
        if (e[key] === value) {
            rtn = e
            return false;
        }
    })
    return rtn;
}

FiltersFactory.prototype.getFilterByName = function(name) {
    return this.__getFilterBy('short_name', name);
}


FiltersFactory.prototype.getFilterByUrl = function(url) {
    return this.__getFilterBy('url', url);
}

FiltersFactory.prototype.getAllFilters = function(model) {
    return this.list[model ||  this.model];
}


FiltersFactory.prototype.filter = function(inter) {
    var _this = this;
    this.fltr = {};
    _each(_this.list[_this.model], function(e, k) {
        if (!e.noCache && e.fn && typeof e.fn === 'function' && e.fn(inter)) {
            _this.fltr[e.short_name] = 1;
        }
    })
    return _this.fltr;
}


FiltersFactory.prototype.list = {
    artisan: [{
        short_name: 'a_all',
        long_name: 'Tous les Artisans',
        url: '',
        match: {},
        noCache: true,
    }, {
        short_name: 'a_man',
        long_name: 'A Manager',
        url: 'aManager',
        group: '$login.management',
        match: {
            'login.management': {
                $exists: true
            }
        },
    }, {
        short_name: 'a_sur',
        long_name: 'A Surveiller',
        url: 'aSurveiller',
        group: '$login.management',
        match: {
            'aSurveiller': true
        },
    }, {
        short_name: 'a_arc',
        long_name: 'archivés',
        url: 'archives',
        match: {
            status: 'ARC'
        },
    }, {
        short_name: 'a_pot',
        long_name: 'potentiel',
        url: 'potentiel',
        match: {
            status: 'POT'
        },
    }, {
        short_name: 'a_dos',
        long_name: 'DossierIncomplet',
        url: 'dossierIncomplet',
        match: {
            $or: [{
                'document.cni.file': true
            }, {
                'document.contrat.file': true
            }, {
                'document.kbis.file': true
            }]
        },
    }, {
        short_name: 'a_act',
        long_name: 'actifs',
        url: 'actif',
        match: {
            status: 'ACT'
        },
    }],
    devis: [{
        short_name: 'd_all',
        long_name: 'Tous les devis',
        url: '',
        match: {},
        noCache: true,
    }, {
        short_name: 'd_tall',
        long_name: "Devis d'aujourd'hui",
        url: 'ajd',
        match: function() {
            return {
                'date.ajout': {
                    $gt: today()
                }
            }
        },
    }, {
        short_name: 'd_tra',
        long_name: "Transferé",
        url: 'transfert',
        match: function() {
            return {
                'status': 'TRA',
            }
        },
    }, {
        short_name: 'd_ann',
        long_name: "Annulés",
        url: 'annules',
        match: {
            status: "ANN"
        },
    }, {
        short_name: 'd_aev',
        long_name: "A envoyer",
        url: 'aEnvoyer',
        match: function() {
            return {
                status: "AEV"
            }
        },
    }, {
        short_name: 'd_att',
        long_name: "En attente",
        url: 'enAttente',
        match: function() {
            return {
                status: "ATT"
            }
        },
    }],
    intervention: [{
        short_name: 'i_davr',
        long_name: 'Demarchages a verifié',
        url: 'davr',
        match: {
            status: 'ENC',
            'date.intervention': {
                $lt: new Date(Date.now() + ms.hours(1))
            },
            aDemarcher: true
        },
    }, {
        short_name: 'i_all',
        long_name: 'Toutes les inters',
        url: '',
        match: {},
        noCache: true,
    }, {
        short_name: 'i_tall',
        long_name: "Aujourd'hui",
        url: 'ajd',
        match: function() {
            return {
                'date.ajout': {
                    $gt: today()
                }
            }
        },
    }, {
        short_name: 'i_tenv',
        long_name: 'Envoyé',
        group: '$login.ajout',
        url: 'envoyeAjd',
        match: function() {
            return {
                'status': 'ENC',
                'date.ajout': {
                    $gt: today()
                }
            }
        },
    }, {
        short_name: 'i_avr',
        long_name: 'A vérifier',
        url: 'aVerifier',
        match: function() {
            return {
                status: 'ENC',
                'date.intervention': {
                    $lt: new Date(Date.now() + ms.hours(1))
                }
            }
        },
    }, {
        short_name: 'i_apr',
        long_name: 'A programmer',
        url: 'aProgrammer',
        match: {
            'status': 'APR',
        },
    }, {
        short_name: 'i_pay',
        long_name: 'Payés',
        url: 'paye',
        stats: false,
    }, {
        short_name: 'i_rgl',
        long_name: 'Réglé',
        url: 'regle',
        stats: false,
    }, {
        short_name: 'i_vrf',
        long_name: 'Verifié',
        url: 'verifie',
        match: function() {
            return {
                status: 'VRF',
            }
        },
        stats: true,
    }, {
        short_name: 'i_iar',
        long_name: 'Intervenant à régler',
        url: 'iar',
        match: function() {
            return {
                "compta.reglement.recu": true,
                "compta.paiement.effectue": false,
                "compta.paiement.ready": false,
                "compta.paiement.dette": false,
                "status": {
                    $ne: 'ANN'
                }
            }
        },
        stats: true,
    }, {
        short_name: 'i_sarl',
        long_name: 'Relance sous-traitant',
        url: 'relanceArtisan',
        match: function() {
            return {
                status: 'VRF',
                reglementSurPlace: true,
                'compta.reglement.recu': false,
                'date.intervention': {
                    $lt: new Date(Date.now() - ms.weeks(2)),
                }
            }
        },
        stats: true,
    }, {
        short_name: 'i_chq',
        long_name: 'Relance Cheques',
        url: 'relanceCheques',
        match: function() {
            return {
                status: 'VRF',
                modeReglement: 'CHQ',
                reglementSurPlace: true,
                'compta.reglement.recu': false,
                'compta.paiement.effectue': false,
                'date.intervention': {
                    $lt: new Date(Date.now() - ms.weeks(2)),
                }
            }
        },
        stats: true,
    }, {
        short_name: 'i_wtf1',
        long_name: 'Payé mais pas reglés',
        url: 'payePasRegle',
        match: function() {
            return {
                status: 'VRF',
                modeReglement: 'CHQ',
                reglementSurPlace: true,
                'compta.reglement.recu': false,
                'date.intervention': {
                    $lt: new Date(Date.now() - ms.weeks(2)),
                }
            }
        },
        stats: true,
    }, {
        short_name: 'i_carl',
        long_name: 'Client à relancer',
        url: 'relanceClient',
        match: function() {
            return {
                status: 'VRF',
                'compta.reglement.recu': false,
                reglementSurPlace: false,
            }
        },
    }, {
        short_name: 'i_fall',
        long_name: 'Toutes mes factures',
        url: 'factureHistorique',
        match: function() {
            return {
                status: 'VRF',
                reglementSurPlace: false,
            }
        },
    }, {
        short_name: 'i_fact',
        long_name: 'Facture à envoyer',
        url: 'factureaEnvoyer',
        match: function() {
            return {
                status: 'ENC',
                reglementSurPlace: false
            }
        },
    }, {
        short_name: 'i_sav',
        long_name: 'S.A.V En Cours',
        url: 'savEnCours',
        match: {
            'sav.status': 'ENC'
        },
    }, {
        short_name: 'i_lit',
        long_name: 'Tous les litiges',
        url: 'litiges',
        match: {
            'litige': {
                $exists: true
            }
        },
    }, {
        short_name: 'i_litEnc',
        long_name: 'Litiges non résolus',
        url: 'litigesEnCours',
        match: {
            'litige.open': true
        },
    }, {
        short_name: 'i_mar',
        long_name: 'MARKET',
        url: 'market',
        match: {
            aDemarcher: true,
            status: 'APR',
            'login.demarchage': {
                $exists: false
            }
        },
    }, {
        short_name: 'i_pan',
        long_name: 'PANIER',
        url: 'panier',
        group: '$login.demarchage',
        match: {
            aDemarcher: true,
            status: {
                $in: ['APR', 'ENC', 'AVR']
            },
            'login.demarchage': {
                $exists: true
            }
        },
    }, {
        short_name: 'i_hist',
        long_name: 'Historique',
        url: 'historique',
        group: '$login.demarchage',
        match: {
            aDemarcher: true,

        },
    }]
}

module.exports = FiltersFactory;
    var _each = require('lodash/collection/each');
    var _includes = require('lodash/collection/includes');
    var _round = require('lodash/math/round')

    var FlushList = function(interArray, prevChecked) {
        var _this = this;
        var list = [];
        _each(interArray, function(e) {
            var rtn = {}
            rtn.montant = {
                base: e.compta.paiement.base,
                total: e.compta.paiement.montant,
                legacy: _this.getPreviousMontant(e),
                balance: _round(e.compta.paiement.montant - _this.getPreviousMontant(e), 2),
                final: _round(e.compta.paiement.montant - _this.getPreviousMontant(e), 2),
            }
            if (e.compta.paiement.tva) {
                var tva = (e.compta.paiement.tva + 100) / 100
                rtn.montant.balance = _round(rtn.montant.balance * tva, 2)
                rtn.montant.legacy = _round(rtn.montant.legacy * tva, 2)
            }
            rtn.id = e.id
            rtn.description = e.description;
            rtn.date = e.compta.paiement.date;
            rtn.login = e.compta.paiement.login
            rtn.checked = _includes(prevChecked, rtn.id)
            rtn.mode = e.compta.paiement.mode
            rtn.numeroCheque = e.compta.paiement.numeroCheque
            rtn.type = rtn.montant.legacy !== 0 ? (rtn.montant.balance > 0 ? 'COMPLEMENT' : 'AVOIR') : 'AUTO-FACT'
            list.push(rtn)
        })
        this.__list = list
    }
    FlushList.prototype.getPreviousMontant = function(inter) {
        if (!inter.compta.paiement.historique.length)
            return 0
        return inter.compta.paiement.historique[inter.compta.paiement.historique.length - 1].payed
    }


    FlushList.prototype.getList = function() {
        return this.__list
    }

    FlushList.prototype.getTotal = function(dirtyReload) {
        var total = {
            base: 0,
            montant: 0,
            balance: 0,
            legacy: 0,
            final: 0
        };
        var list = _(this.getList()).sortBy('montant.balance').reverse().value();
        _each(list, function(rtn) {
            if (rtn.checked && (!dirtyReload || (dirtyReload && rtn.montant.balance >= 0))) {
                total.base = _round(total.base + rtn.montant.base);
                total.montant = _round(total.montant + rtn.montant.total, 2);
                total.legacy = _round(total.legacy + rtn.montant.legacy, 2);
                total.balance = _round(total.balance + rtn.montant.balance, 2);
                if (total.balance + rtn.montant.balance < 0) {
                    if (total.final == 0) {
                        rtn.montant.final = 0;
                    } else {
                        rtn.montant.final = _round(rtn.montant.balance - total.balance, 2);
                        if (rtn.montant.final < rtn.montant.balance) {
                            rtn.montant.final = rtn.montant.balance
                        }
                    }
                }
                total.final = _round(total.final + rtn.montant.final, 2);
            } else {
                rtn.montant.final = _round(rtn.montant.balance, 2)
            }
        })
        this.__list = _(list).sortBy('id').value();
        this.total = total;
        return total;
    }


    module.exports = FlushList;
 var _each = require('lodash/collection/each');
 var _get = require('lodash/object/get')
 var _clone = require('lodash/lang/clone')
 var _round = require('lodash/math/round')

 var Paiement = function(inter) {
     var _this = this
     if (!(this instanceof Paiement))
         return new Paiement(inter)
     if (inter) {
         _this.inter = function() {
             return inter;
         }

         var reglement = inter.compta.reglement ||  {}
         var paiement = inter.compta.paiement
         if (!inter.compta.paiement.pourcentage) {
             paiement.pourcentage = _clone(inter.sst.pourcentage)
         }
         reglement.montant = _get(inter, 'compta.reglement.montant', 0);
         reglement.avoir = _get(inter, 'compta.reglement.avoir', 0)
         _this.pourcentage = inter.compta.paiement.pourcentage;
         _this.fourniture = this.getFourniture(inter);
         _this.base = inter.compta.paiement.base
         _this.montantHT = _this.base - _this.fourniture.total
         _this.baseDeplacement = _this.prixDeplacement()
         _this.remunerationDeplacement = _this.applyCoeff(_this.baseDeplacement, _this.pourcentage.deplacement);
         _this.baseMaindOeuvre = _this.prixMaindOeuvre();
         _this.remunerationMaindOeuvre = _this.applyCoeff(_this.baseMaindOeuvre, _this.pourcentage.maindOeuvre);
         _this.venteFourniture = _this.base - (_this.baseDeplacement + _this.baseMaindOeuvre);
         _this.coutFourniture = _this.fourniture.total;
         _this.baseMargeFourniture = _this.venteFourniture - _this.coutFourniture;
         /*         if (_this.baseMargeFourniture < 0) {
                      _this.baseMaindOeuvre += _this.baseMargeFourniture;
                      _this.baseMargeFourniture = 0;
                  }*/
         _this.remunerationMargeFourniture = _this.applyCoeff(_this.baseMargeFourniture, _this.pourcentage.fourniture);
         _this.remboursementFourniture = _this.fourniture.artisan;
         _this.montantTotal = _round(_this.remunerationDeplacement + _this.remunerationMargeFourniture + _this.remunerationMaindOeuvre + _this.remboursementFourniture, 2);
         _this.montantTotalTVA = _round(_this.montantTotal * (paiement.tva / 100), 2);
         _this.montantTotalTTC = _round(_this.montantTotal + _this.montantTotalTVA, 2);
     }
 }




 Paiement.prototype = {
     inter: {},
     applyCoeff: function(number, Coeff) {
         return _round(number * (Coeff / 100), 2);
     },
     prixDeplacement: function() {
         if (this.montantHT <= 65) {
             return this.montantHT;
         } else {
             return 65;
         }
     },
     prixMaindOeuvre: function() {
         if (this.montantHT <= 65) {
             return 0;
         } else if (this.montant <= 65) {
             return this.montantHT - 85;
         } else {
             return 85;
         }
     },
     getFourniture: function(inter) {
         var _this = this;
         if (_get(inter, 'compta.paiement.fourniture.total')) {
             return inter.compta.paiement.fourniture;
         }
         var fourniture = {
             artisan: 0,
             edison: 0,
             total: 0
         };
         _each(inter.fourniture, function(e) {
             fourniture[e.fournisseur === 'ARTISAN' ? 'artisan' : 'edison'] += (e.pu * e.quantite);
             fourniture.total += e.pu * e.quantite, 2;
         })
         return fourniture;
     },
     getMontantTTC: function() {
         return this.applyCoeff(this.inter().compta.reglement.montant, 100 + this.inter().tva)
     }
 }
 module.exports = Paiement
var moment = require('moment')
var config = requireLocal('config/dataList.js');
var _ = require('lodash')
var htmlencode = require('htmlencode');
var ms = require('milliseconds')
var request = require('request');

var V1 = function(d, devis, legacy) {
    try {
        this.model = devis ? 'DEVIS' : 'INTERVENTION'
        this.data = _.clone(this.___data)
        var x = this.data
        if (!d.compta) {
            d = db.model('intervention')(d)
            d.status = 'DEVIS'
            devis = true;
        }
        this.legacy = legacy
        x.id = d.id;
        var dateAjout = moment(new Date(d.date.ajout))
        x.t_stamp = dateAjout.unix()
        dateAjout.add(1, 'h');
        x.date_ajout = dateAjout.format('DD/MM/YYYY');
        x.heure_ajout = dateAjout.format('HH:mm:ss')
        x.date_ajout_en = dateAjout.format('YYYYMMDD')
        if (d.date.intervention) {
            var dateIntervention = moment(new Date(d.date.intervention))
            x.t_stamp_intervention = dateIntervention.unix()
            dateIntervention.add(1, 'h');
            x.date_intervention = dateIntervention.format('DD/MM/YYYY')
            x.date_intervention_en = dateIntervention.format('YYYYMMDD')
            x.heure_intervention = dateIntervention.format('HH:mm:ss')
        }
        if (d.compta && d.compta.reglement.date) {
            x.date_paiement_client = moment(new Date(d.compta.reglement.date)).format('DD/MM/YYYY');
        }
        if (d.date.envoiFacture) {
            x.date_edition_facture = moment(new Date(d.date.envoiFacture)).format('YYYY-MM-DD')
        }
        if (d.login.envoiFacture) {
            x.facture_editee_par = edison.users.find(d.login.envoiFacture);
        }
        x.id_sms = d.sms ||  undefined;
        x.sms_status = d.sms_status;
        x.civilite = d.client.civilite;
        x.nom = d.client.nom;
        x.prenom = d.client.prenom;
        x.tel1 = d.client.telephone.tel1
        x.tel2 = d.client.telephone.tel2 || ""
        x.numero_origine = d.client.telephone.origine || ""
        x.email = d.client.email
        x.societe = Number(d.client.civilite === 'Soc.')
        x.numero = d.client.address.n
        x.adresse = d.client.address.r
        x.code_postal = d.client.address.cp
        x.ville = d.client.address.v
        x.lat = d.client.address.lt
        x.lng = d.client.address.lg
        var categorie = config.categories[d.categorie];
        x[_.deburr(categorie.long_name).toLowerCase()] = '1';
        x.categorie = _.deburr(categorie.long_name).toUpperCase();
        x.description = d.description;
        x.remarque_interne = _.pluck(d.comments, 'text').join('\n') ||  ""
        x.prix_ht_annonce = d.prixAnnonce;
        x.prix_ht_final = d.prixFinal;
        x.id_sst_selectionne = _.get(d, 'artisan.id', 0);
        x.ajoute_par = edison.users.find(d.login.ajout);
        //0 => pas de facture, 1 => facture a faire, 2 => facture effectué, 3 => facture payé (reglement recu)
        if (!d.reglementSurPlace) {
            x.reglement_sur_place = 0
            if (d.date.envoiFacture) {
                x.reglement_sur_place = 2;
            }
        } else {
            x.reglement_sur_place = 1;
        }
        if (d.compta && d.compta.reglement.recu) {
            x.reglement_sur_place = 3;
        }
        if (!devis) {

            x.mode_reglement = (!d.reglementSurPlace ? 'facture' : _.find(config.modeDeReglements, 'short_name', d.modeReglement).old_name);
            x.remarque = d.remarque
            if (d.facture) {
                x.nom_facture = d.facture.nom
                x.prenom_facture = d.facture.prenom
                x.tel_facture = d.facture.telephone
                x.mail_facture = d.facture.email
                x.numero_facture = d.facture.address.n
                x.adresse_facture = d.facture.address.r
                x.code_postal_facture = d.facture.address.cp
                x.ville_facture = d.facture.address.v
                x.type_client = _.findIndex(config.typePayeur, 'short_name', d.facture.payeur)
                x.relance_facture = d.facture.relance
            }
            if (d.relance) {
                x.relance = JSON.stringify(d.relance)
            }
            if (d.fourniture.length) {
                x.cout_fourniture = 0; //d.fourniture[0].pu;
                _.each(d.fourniture, function(e) {
                    x.cout_fourniture += (e.quantite * e.pu)
                })
                x.fournisseur = d.fourniture[0].fournisseur
                x.fourniture_sst = Number(d.fourniture[0].fournisseur !== "ARTISAN") + 1;
                //x.fourniture_edison = Number(d.fourniture[0].fournisseur != "")
                x.tva_facture = d.tva;
            }
        }
        x.taux_tva = d.tva ||  10
        x.etat_intervention = devis ? 'DEVIS' : config.etats[d.status].old_name;
        if (d.compta.paiement.dette) {
            x.etat_reglement = 'DETTE'
        } else if (d.compta.paiement.effectue) {
            x.etat_intervention = "INTERVENU";
            x.etat_reglement = 'PAIEMENT EFFECTUE'
        } else if (d.status === 'VRF') {
            x.etat_reglement = 'CHEQUE RECUPERE'
        }
        if (d.produits.length) {
            var devisTab = [];
            _.each(d.produits, function(e) {
                devisTab.push({
                    pu: e.pu,
                    quantite: e.quantite,
                    ref: e.ref,
                    desc: e.desc.split('\n').join('<br>')
                });
            });
            var sous_total = _.sum(devisTab, function(e) {
                return e.quantite * e.pu
            })
            x.devis = JSON.stringify({
                devisTab: devisTab,
                sous_total: _.round(sous_total, 2),
                total: _.round(sous_total * 0.01 * x.tva, 2),
                envoyer: d.historique.length,
                tva: x.taux_tva
            });
        } else {
            x.devis = "";
        }
        x.A_DEMARCHE = Number(d.aDemarcher);
    } catch (e) {
        __catch(e)
    }
}

V1.prototype.compare = function() {
    var noComp = ["proprietaire",
        "modifie_par",
        "departement",
        "notation_bud",
        "notation_symp",
        "notation_flex",
        "yrs_old",
        "annul",
        "comformite",
    ]
    var _this = this;
    _.each(this.data, function(e, k) {
        if (!_.includes(noComp, k) && e != _this.legacy[k]) {
            if (!(!e && !_this.legacy[k]))
                console.log(_.padRight(k, 20, " "), "---------> ", _.padRight("'" + e + "'", 30, ' '), "'" + _this.legacy[k] + "'")
        }
    })
}

V1.prototype.send = function(cb) {
    var _this = this;
    try {
        request.get({
            url: 'http://electricien13003.com/alvin/postData.php',
            qs: this.data
        }, function(err, resp, body) {
            if (!err && resp.statusCode === 200) {
                cb(null, body)
            } else {
                cb("err")
            }
            edison.event("SEND" + _this.model).id(_this.data.id).data({
                sended: _this.data,
                resp: body
            }).save()

        })
    } catch (e) {
        __catch(e);
    }
}

V1.prototype.___data = {
    "id": "",
    "t_stamp": "1439198596",
    "date_ajout": "10\/08\/2015",
    "date_paiement_client": null,
    "date_ajout_en": "20150810",
    "civilite": "M.",
    "nom": "BOUSQUIER",
    "prenom": "PHILIPPE",
    "societe": "0",
    "proprietaire": "1",
    "tel1": "0687703760",
    "tel2": "",
    "email": "",
    "numero": "171",
    "adresse": "AVENUE HENRI CHAPAYS",
    "code_postal": "38340",
    "ville": "VOREPPE",
    "zone": "", //
    "departement": null, //
    "lat": "45.2982",
    "lng": "5.63752",
    "origine": null, //
    "devis": "", //
    "intervention": "1",
    "electricite": "0",
    "plomberie": "0",
    "chauffage": "0",
    "climatisation": "0",
    "serrurerie": "0",
    "vitrerie": "0",
    "menuiserie": "0",
    "peinture": "0",
    "carrelage": "0",
    "maconnerie": "0",
    "couverture": "0",
    "renovation": "0",
    "sous_cat": "", //
    "categorie": "PLOMBERIE",
    "description": "",
    "remarque": "",
    "date_intervention": "",
    "date_intervention_en": "",
    "heure_intervention": "",
    "t_stamp_intervention": "",
    "prix_ht_annonce": "",
    "etat_intervention": "A PROGRAMMER", //---
    "etat_reglement": "", //---
    "rappel_paiement": "",
    "id_sst_selectionne": "0",
    "ajoute_par": "",
    "modifie_par": "",
    "reglement_sur_place": "1", //
    "cout_fourniture": "0",
    "fourniture_sst": "0",
    "fournisseur": "",
    "paiement_sst_direct": "0",
    "mode_reglement": "cheque",
    "remarque_interne": "",
    "cause_annulation": "",
    "id_annulation": null,
    "warned_operator": null,
    "confirm_intervention": "0",
    "mark_annulation": "0",
    "nom_facture": "",
    "prenom_facture": "",
    "tel_facture": "",
    "mail_facture": "",
    "numero_facture": "",
    "adresse_facture": "",
    "code_postal_facture": "",
    "ville_facture": "",
    "relance_facture": "",
    "relance_sst": "",
    "montant_ht_facture": null,
    "id_pro": null,
    "id_sms": null,
    "sms_status": "0",
    "bon_intervention": "0",
    "date_edition_facture": null,
    "facture_editee_par": null,
    "type_client": "2",
    "heure_ajout": "11:23:00",
    "tva_facture": null,
    "notation_bud": "3",
    "notation_symp": "3",
    "notation_flex": "3",
    "yrs_old": "2",
    "annul": "Non",
    "montant_cheque1": null,
    "montant_cheque2": null,
    "montant_cheque3": null,
    "montant_cheque4": null,
    "emetteur_cheque1": null,
    "emetteur_cheque2": null,
    "emetteur_cheque3": null,
    "emetteur_cheque4": null,
    "taux_tva": null,
    "prix_ht_final": null,
    "deplacement_ht": "65",
    "main_oeuvre_ht": "85",
    "vente_fourni_ht": "0",
    "cout_fourni_ht": "0",
    "numero_appel": "",
    "numero_origine": "",
    "A_DEMARCHE": "1",
    "sst_avance": "0",
    "comformite": "",
    "relance_48": "0",
    "verifier": "0"
}


module.exports = V1;
var moment = require('moment')
var config = requireLocal('config/dataList.js');
var _ = require('lodash')
var htmlencode = require('htmlencode');
var ms = require('milliseconds')
var request = require('request');



var V1 = function(d) {
    //try {

    this.data = _.clone(this.___data);
    var x = this.data;

    x.id = d.id;
    x.date_ajout = moment(d.date.ajout).format('L')
    x.nom_societe = d.nomSociete;
    x.forme_juridique = config.formeJuridique[d.formeJuridique].long_name

    x.plomberie = Number(_.includes(d.categories, "PL"));
    x.chauffage = Number(_.includes(d.categories, "CH"));
    x.electricite = Number(_.includes(d.categories, "EL"));
    x.serrurerie = Number(_.includes(d.categories, "SR"));
    x.vitrerie = Number(_.includes(d.categories, "VT"));
    x.climatisation = Number(_.includes(d.categories, "CL"));
    x.peinture = Number(_.includes(d.categories, "PT"));

    x.categorie = []
    _.each(d.categories, function(e) {
        x.categorie.push(config.categories[e].long_name)
    })
    x.categorie = _.deburr(x.categorie.join(', ')).toUpperCase()

    x.nom_representant = d.representant.nom;
    x.prenom_representant = d.representant.prenom;
    x.civilite = d.representant.civilite;


    x.numero = d.address.n
    x.adresse = d.address.r
    x.code_postal = d.address.cp
    x.ville = d.address.v
    x.lat = d.address.lt
    x.lng = d.address.lg
    x.tel1 = d.telephone.tel1;
    x.tel2 = d.telephone.tel2;

    x.email = d.email;

    x.archive = Number(d.status === 'ARC')

    var login = _.find(edison.users.data, 'login', d.login.ajout)
    x.ajoute_par = login && login.oldLogin ? login.oldLogin : d.login.ajout;


    x.pourcentage_main_d_oeuvre = d.pourcentage.maindOeuvre;
    x.pourcentage_fourniture = d.pourcentage.fourniture;
    x.pourcentage_deplacement = d.pourcentage.deplacement;
    x.zone_chalandise = d.zoneChalandise + 'km';

    // ==>FILES;
    _.each(d.document, function(e, k) {
        if (typeof e === 'object' && e.file) {
            x[k] = e.file;
            //console.log('-->', k,  e.file);
        }
    })

    if (d.historique.pack && d.historique.pack.length && d.historique.pack[0].facturier) {
        x.num_facturier = (d.historique.pack.length === 1 && d.historique.pack[0].text) ||  moment(d.historique.pack[d.historique.pack.length - 1].date).format('L')
    }

    if (d.historique.pack && d.historique.pack.length && d.historique.pack[0].deviseur) {
        x.num_deviseur = (d.historique.pack.length === 1 && d.historique.pack[0].text) ||  moment(d.historique.pack[d.historique.pack.length - 1].date).format('L')
    }


    if (d.historique.contrat && d.historique.contrat.length) {
        x.date_envoi_contrat = moment(d.historique.contrat[0].date).format('dddd DD MMMM YYYY');
        x.date_envoi_contrat = "Paris, le " + _.capitalize(x.date_envoi_contrat)
        if (!d.historique.contrat[0].signe) {
            x.date_envoi_contrat += ' - CONTRAT NON SIGNE';
        } else {
            x.date_envoi_contrat += ' - CONTRAT SIGNE';
        }
        //console.log('-->', x.num_contrat)
    }
    x.pas_fiable = Number(Boolean(d.info.pasFiable))
    x.travail_samedi = Number(Boolean(d.info.travailSamedi));

    x.BIC = d.BIC ||  "aucun BIC";
    x.IBAN = d.IBAN ||  "aucun IBAN";

    x.siret = d.siret;
    /*    } catch (e) {
            console.log('ERR', e)
            throw e
        }*/

}

V1.prototype.compare = function(legacy) {
    var noComp = [
        /*  "contrat_2014",
          "contrat",
          "kbis",
          "autofacturation",
          "cni",
          "assurance",
          "rib",
          "ursaff",
          "autres",*/
        "coms",
        "rappel_inter",
        "jours_intervention",
        "facturier_num_manuel"
    ]
    var _this = this;
    _.each(this.data, function(e, k) {
        if (!_.includes(noComp, k) && e != legacy[k]) {
            if (!(!e && !legacy[k]))
                console.log(_.padRight(k, 20, " "), "---------> ", _.padRight("'" + e + "'", 30, ' '), "'" + legacy[k] + "'")
        }
    })
}

V1.prototype.send = function(cb) {
    var _this = this;
    try {
        request.get({
            url: 'http://electricien13003.com/alvin/postDataArtisan.php',
            qs: this.data
        }, function(err, resp, body) {
            if (!err && resp.statusCode === 200) {
                console.log('sendArtisan', _this.data.id);
                cb(null, body)
            } else {
                //  console.log("ERR", body)
                cb("err")
            }
            edison.event("SEND_ARTISAN").id(_this.data.id).data({
                sended: this.data,
                resp: body
            }).save()
        })
    } catch (e) {
        __catch(e);
    }
}



V1.prototype.___data = {
    "id": "7",
    "travail_samedi": "1",
    "archive": "0",
    "date_ajout": "21/08/2013",
    "nom_societe": "COSTANTINO",
    "civilite": "M.",
    "nom_representant": "COSTANTINO",
    "prenom_representant": "ANTHONY",
    "forme_juridique": "AUTO-ENTREPRENEUR",
    "email": "PRE.PLOMBERIE@HOTMAIL.FR",
    "numero": "10",
    "adresse": "IMPASSE DES ALVERGNES",
    "code_postal": "13013",
    "ville": "MARSEILLE",
    "lat": "43.3375",
    "lng": "5.42737",
    "pourcentage_deplacement": "50",
    "pourcentage_main_d_oeuvre": "50",
    "pourcentage_fourniture": "50",
    "zone_chalandise": "50km",
    "jours_intervention": "1-2-3-4-5-6",
    "heures_intervention": "",
    "disponibilite": "",
    "mode_vac": "0",
    "contrat_2014": "",
    "contrat": "",
    "kbis": "",
    "autofacturation": "",
    "cni": "",
    "assurance": "",
    "rib": "",
    "ursaff": "",
    "autres": "",
    "siret": "753985985",
    "rappel": "",
    "num_facturier": "",
    "num_deviseur": "",
    "catalogue_electricite": "0",
    "catalogue_plomberie": "0",
    "catalogue_serrure": "0",
    "stock_cylindre": "0",
    "tel2": "",
    "tel1": "0640925713",
    "electricite": "0",
    "plomberie": "1",
    "chauffage": "1",
    "climatisation": "1",
    "serrurerie": "1",
    "vitrerie": "0",
    "menuiserie": "0",
    "peinture": "0",
    "carrelage": "0",
    "maconnerie": "0",
    "couverture": "0",
    "renovation": "0",
    "categorie": "PLOMBERIE, CHAUFFAGE, CLIMATISATION, SERRURERIE",
    "cout_fourniture": "0",
    "distance": "0",
    "date_envoi_contrat": "",
    "tarif_prix_h": "0",
    "tarif_deplacement": "0",
    "tarif_deplacement_hors_zone": "0",
    "tarif_prix_h_zone": "0",
    "tarif_deplacement_zone": "0",
    "login": "",
    "password": "",
    "new_account": "",
    "img_pro": "default.png",
    "json_pro": "",
    "json_notif": "0",
    "non_contrat": "0",
    "ajoute_par": "yohann",
    "IBAN": "aucun IBAN",
    "BIC": "aucun BIC",
    "pas_fiable": "0",
    "rappel_inter": "0"
}


module.exports = V1;
module.exports = {
    alvin: {
        pass: "AZKgNeVldZetmZh0Te5iF7Rb9Ry38N2Vph7ehGAs9wJUut4OggwVGHCx4Nt4G7BW",
        url: "http://electricien13003.com/alvin/"
    },
    mobyt: {
        login: "F09086",
        pass: "2n3jwunu"
    },
    postmark: "b2c424bc-af2b-4175-b76f-c863bb3915c3",
    dropbox: "vPCwuQ_iHHkAAAAAAAAEYXCJS5OETTlvzmXbhc1kjFOsMKO2futzgS-VM8p8S1un",
    salt: "3AlqPodMzLUTYUYqyv3Fqs2JF17aXFWEzA61V8ZNb5ylEvS67Y1sHvjHeZe7EtQ"
}
 var moment = require('moment')
 var async = require('async')
 var PDF = require('edsx-mail')
 var _ = require('lodash')
 var textTemplate = requireLocal('config/textTemplate');
 require('nodeify').extend();

 var RelanceClient = function(doc, type, email) {
    if (!(this instanceof RelanceClient)) {
        return new RelanceClient(doc, type, email)
    }
    var _this = this;
    _this.doc = doc;
    _this.type = type;
    _this.emailDest = email;

    this.doc.prixFinalTTC = _.round(this.doc.prixFinal * (1 + (this.doc.tva / 100)), 2).toFixed(2)
    _this.doc.datePlain = moment(_this.doc.date.intervention).format('DD/MM/YYYY');
    _this.doc.os = _.padLeft(_this.doc.id, 6, '0')
    _this.doc.type = 'facture'


 }

 RelanceClient.prototype.send = function(callback) {
    var async = require('async');
    if (this.type === "relance-client-1") {
        this.mailBody = _.template(textTemplate.mail.intervention.relance1())(this.doc);
        this.letterBody = _.template(textTemplate.lettre.intervention.relance1())(this.doc);
        this.mailTitle = _.template("Première relance pour facture n°{{id}} impayée")(this.doc);
        async.waterfall([
            this.createFacture.bind(this),
            this.sendMail.bind(this),
        ], callback);
    } else if (this.type === 'relance-client-2') {
        this.mailBody = _.template(textTemplate.mail.intervention.relance2())(this.doc);
        this.letterBody = _.template(textTemplate.lettre.intervention.relance2())(this.doc);
        this.mailTitle = _.template("Deuxieme relance pour facture n°{{id}} impayée")(this.doc);
        async.waterfall([
            this.createFacture.bind(this),
            this.sendMail.bind(this),
            this.writeTmpFile.bind(this),
            this.insertBlankPage.bind(this),
            this.printStack.bind(this)
        ], callback)
    } else if (this.type === 'relance-client-3') {
        this.mailBody = _.template(textTemplate.mail.intervention.relance3())(this.doc);
        this.letterBody = _.template(textTemplate.lettre.intervention.relance3())(this.doc);
        this.mailTitle = _.template("Troisième relance pour facture n°{{id}} impayée")(this.doc);

        async.waterfall([
            this.createFacture.bind(this),
            this.sendMail.bind(this),
            this.writeTmpFile.bind(this),
            this.insertBlankPage.bind(this),
            this.printStack.bind(this)
        ], callback)
    } else if (this.type === 'relance-client-4') {
        this.letterBody = _.template(textTemplate.lettre.intervention.relance4())(this.doc);

        async.waterfall([
            this.createInjonction.bind(this),
            this.printStack.bind(this)
        ], callback)

    } else if (this.type === 'relance-client-5') {
        async.waterfall([
            this.createAvisAvantPoursuites.bind(this),
            this.printStack.bind(this)
        ], callback)

    } else {
        callback(null);
    }
 }


 RelanceClient.prototype.createAvisAvantPoursuites = function(callback) {
    PDF('recouvrement', this.doc).buffer(callback)
 }


 RelanceClient.prototype.createInjonction = function(callback) {
    PDF('injonction', this.doc).buffer(callback)
 }


 RelanceClient.prototype.createFacture = function(callback) {
    PDF([{
        model: 'letter',
        options: {
            address: this.doc.facture.address,
            dest: this.doc.facture,
            text: this.letterBody,
            title: "",
            factureQrCode: true,
            id: this.doc.os,
            date:this.doc.date
        }
    }, {
        model: 'facture',
        options: this.doc
    }, {
        model: 'conditions',
        options: this.doc
    }]).toBuffer(callback)
 }

 RelanceClient.prototype.sendMail = function(buffer, callback) {
    console.log('sendMail');

    if (envDev) {
        return callback(null, buffer);
    }
    mail.send({
        From: "comptabilite@edison-services.fr",
        ReplyTo: "comptabilite@edison-services.fr",
        To: this.emailDest,
        Subject: this.mailTitle,
        HtmlBody: this.mailBody,
        Attachments: [{
            Content: buffer.toString('base64'),
            Name: "Facture n°" + this.doc.id + ".pdf",
            ContentType: 'application/pdf'
        }]
    }, function(resp) {
        callback(null, buffer)
    });
 }

 RelanceClient.prototype.writeTmpFile = function(buffer, callback) {
    console.log('writeTmpFile');

    var fs = require('fs')
    var uuid = require('uuid')
    var filename = '/tmp/' + uuid.v4() + '.pdf';
    fs.writeFile(filename, buffer, function(err) {
        callback(err, buffer, filename);
    })
 }

 RelanceClient.prototype.insertBlankPage = function(buffer, filename, callback) {
    console.log('insertBlankPage');

    if (envDev) {
        return callback(null, buffer)
    }
    var fs = require('fs')
    var scissors = require('scissors');
    var pageNumber = PDF('facture', this.doc).getHTML().split('</page>').length
    var p1 = scissors(filename).pages(1) // select or reorder individual pages 
    var p2 = scissors(filename).range(2, pageNumber + 1);
    var blank = scissors(process.cwd() + '/front/assets/pdf/blank.pdf').pages(1);
    var stream = scissors.join(p1, blank, p2).pdfStream()
    var finalBuffer = [];
    stream.on('data', function(data) {
        finalBuffer.push(data);
    }).on('end', function() {
        callback(null, Buffer.concat(finalBuffer))

    })
 }
 RelanceClient.prototype.printStack = function(buffer, callback) {
    console.log('printStack');

    document.stack(buffer, this.type + ' - ' + this.doc.id, "AUTO")
        .then(function(resp) {
            callback(null, callback)
        }, callback)
 }

 module.exports = RelanceClient;
 module.exports = [{
     login: 'abel_c',
     oldLogin: 'abel',
     portable: '0633138868',
     ligne: "0633138868",
     email: "abel@chalier.me",
     service: 'INFORMATIQUE',
     root: true,
     pseudo:'Alain',
     nom: 'abel',
     prenom: 'chalier',
     activated: true
 }, {
     login: 'benjamin_b',
     oldLogin: 'boukris_b',
     portable: '0782903875',
     email: 'contact@edison-services.fr',
     service: 'INTERVENTION',
     ligne:"0972441663",
     root: true,
     nom: 'boukris',
     prenom: 'sacha',
     pseudo: 'Arnaud',
     activated: true

 }, {
     login: 'harald_x',
     oldLogin: 'harald',
     service: 'INTERVENTION',
     root: false,
     nom: 'xxx',
     prenom: 'harald',
     pseudo: 'Fabien',
     activated: true
 }, {
     login: 'jeremie_r',
     oldLogin: 'jeremie',
     service: 'INTERVENTION',
     root: false,
     nom: 'roudier',
     prenom: 'jeremie',
     pseudo: 'éric',
     activated: true
 }, {
     login: 'clement_b',
     oldLogin: 'laurent',
     service: 'INTERVENTION',
     root: false,
     nom: 'clement',
     pseudo: 'Laurent',
     prenom: 'xxx',
     activated: true
 }, {
     login: 'gregorie_e',
     oldLogin: 'sebastien',
     service: 'INTERVENTION',
     root: false,
     nom: 'clement',
     pseudo: 'Laurent',
     prenom: 'xxx',
     activated: true
 }, {
     login: 'tayeb_g',
     oldLogin: 'tayeb',
     service: 'INTERVENTION',
     root: false,
     nom: 'guillot',
     prenom: 'taieb',
     pseudo: 'Eric',
     activated: true
 }, {
     login: 'eliran_t',
     oldLogin: 'eliran',
     service: 'INTERVENTION',
     root: true,
     nom: 'taieb',
     prenom: 'eliran',
     pseudo: 'damien',
     activated: true
 }, {
     login: 'thomas_x',
     oldLogin: 'thomas',
     service: 'INTERVENTION',
     root: false,
     nom: 'xxx',
     pseudo: 'thomas',
     prenom: 'thomas',
     activated: false
 }, {
     login: 'vincent_q',
     oldLogin: 'vincent',
     service: 'COMPTABILITE',
     root: true,
     email: 'comptabilite@edison-services.fr',
     nom: 'queudray',
     prenom: 'vincent',
     activated: true
 }, {
     login: 'yohann_r',
     oldLogin: 'yohann',
     service: 'PARTENARIAT',
     portable: '0637375945',
     root: true,
     nom: 'rhoum',
     email: 'yohann.rhoum@edison-services.fr',
     prenom: 'yohann',
     activated: true
 }]
angular.module('browserify', [])
    .factory('config', [function() {
        "use strict";
        var config = require("./dataList.js")
        return config;
    }])
    .factory('contextMenuData', [function() {
        return require('./contextMenuData.js')
    }])
    .factory('textTemplate', [function() {
        return require('./textTemplate.js')
    }])
    .factory('FiltersFactory', [function() {
        return require('./FiltersFactory');
    }])
    .factory('Paiement', [function() {
        return require('./Paiement');
    }])
    .factory('FlushList', [function() {
        return require('./FlushList');
    }])
    .factory('Description', [function() {
        return require('./Description');
    }])
    .factory('Combo', [function() {
        return require('./combo-produits');
    }])

module.exports = [{
    "title": "Devis débouchage camion haute pression",
    "text": "devis d'<u>assainissement</u> pour <u>le débouchage haute pression de votre canalisation.</u>",
    "ref": "DEVIS_DEBOUCHAGE_CHP",
    "__v": 0,
    "produits": [{
        "title": "DEBOUCHAGE CAMION HAUTE PRESSION",
        "desc": "DEBOUCHAGE CAMION HAUTE PRESSION\nCAMION HYDRO-CUREUR\nDEGRAISSAGE CANALISATION\nPRESSION  >  400 BAR\nRemarques : Nettoyage de conduites domestiques et de l’égout principal jusqu’à un Ø de 300 mm",
        "quantite": 1,
        "pu": 496.25,
        "ref": "DEB066"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D'OEUVRE",
        "title": "MAIN D'OEUVRE",
        "quantite": 1,
        "pu": 85
    }, {
        "ref": "EDI002",
        "desc": "DEPLACEMENT",
        "title": "DEPLACEMENT",
        "quantite": 1,
        "pu": 65
    }]
}, {
    "title": "Devis sany-broyeur",
    "ref": "DEVIS_SANY_B",
    "text": "devis de <u>plomberie</u> pour <u>l'installation d'un système de sani-broyeur</u>",
    "__v": 0,
    "produits": [{
        "title": "SANIBROYEUR PRO WC",
        "desc": "SANIBROYEUR PRO WCEN 12050-3 - Silence\nRégime moteur spécial : 2800 (tr/min)\nRefoulements 5m horizontal\nRefoulements 100m vertical\nAlimentation 220-240 / 50\nGarantie 2 ans constructeur * sous d’une utilisation conforme à la notice\n",
        "quantite": 1,
        "pu": 539.1,
        "ref": "SAN063",
        "showDesc": true
    }, {
        "ref": "EDI001",
        "desc": "MAIN D’OEUVRE",
        "title": "MAIN D’OEUVRE",
        "quantite": 1,
        "pu": 130
    }]
}, {
    "title": "Devis de tableau électrique 2 rangée - 13 modules",
    "ref": "DEVIS_TAB_ELEC_2_13",
    "text": "devis de mise en conformité électrique NF C 15-100, nous vous proposons le remplacement  de votre tableau <strong>2 rangées - 13 modules</strong>",
    "__v": 0,
    "produits": [{
        "title": "Remise en conformité électrique NF C15-100",
        "desc": "Remise en conformité électrique NF C15-100\nIdentification des circuits électriques\nSchéma électrique\n",
        "quantite": 1,
        "pu": 0,
        "ref": "REM089"
    }, {
        "title": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
        "desc": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
        "quantite": 1,
        "pu": 139.1,
        "ref": "TAB036"
    }, {
        "desc": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
        "title": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
        "quantite": 2,
        "pu": 166.25,
        "ref": "INT065"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 32 A",
        "title": "DISJONCTEUR DIFFERENTIEL 32 A",
        "quantite": 2,
        "pu": 32.65,
        "ref": "DIS017"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 20 A",
        "title": "DISJONCTEUR DIFFERENTIEL 20 A",
        "quantite": 4,
        "pu": 29.31,
        "ref": "DIS036"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 16 A",
        "title": "DISJONCTEUR DIFFERENTIEL 16 A",
        "quantite": 8,
        "pu": 28.17,
        "ref": "DIS012"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 10 A",
        "title": "DISJONCTEUR DIFFERENTIEL 10 A",
        "quantite": 8,
        "pu": 27.34,
        "ref": "DIS084"
    }, {
        "desc": "PEIGNE UNIPOLAIRE P+N",
        "title": "PEIGNE UNIPOLAIRE P+N",
        "quantite": 4,
        "pu": 12.93,
        "ref": "PEI090"
    }, {
        "desc": "CABLAGE EDF 10 mm²",
        "title": "CABLAGE EDF 10 mm²",
        "quantite": 4,
        "pu": 28.67,
        "ref": "CAB088"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D'OEUVRE",
        "title": "MAIN D'OEUVRE",
        "quantite": 1,
        "pu": 280
    }, {
        "desc": "Dépose de l'existant et mise en service inclus",
        "title": "Dépose de l'existant et mise en service inclus",
        "quantite": 1,
        "pu": 0,
        "ref": "DEP045"
    }]
}, {
    "title": "Devis chauffe-eau gaz ELM LEBLANC",
    "ref": "DEVIS_CHF_EAU_ELM",
    "text": "<u>devis de remplacement de votre chauffe-eau gaz</u>",
    "__v": 0,
    "produits": [{
        "title": "Installation d’un chauffe-eau gaz (eau chaude sanitaire)",
        "desc": "Installation d’un chauffe-eau gaz (eau chaude sanitaire)\nDépose complète de l’existant\nMise à la décharge de l’unité de chauffage existante\nMise en conformité des raccordements gaz\nInstallation et mise en service inclus\n",
        "quantite": 1,
        "pu": 0,
        "ref": "INS058"
    }, {
        "title": "CHAUFFE-EAU GAZ A TIRAGE NATUREL",
        "desc": "CHAUFFE-EAU GAZ A TIRAGE NATUREL\nMarque : ELM LEBLANC - ONDEA\nPuissance : 7 à 29,5 kW\nDébit : 8 à 17 litres / minute\nMode d’allumage par veilleuse\nDimensions (L x P x H ) : 425 x 334 x 655\nCapacité pour : Cuisine + Lavabos + Douche + Baignoire\nÉquipé du système S.P.O.T.T (sécurité gaz)\n",
        "quantite": 1,
        "pu": 938.52,
        "ref": "CHA035"
    }, {
        "desc": "KIT MÉLANGEUR POUR ONDEA",
        "title": "KIT MÉLANGEUR POUR ONDEA",
        "quantite": 1,
        "pu": 89.13,
        "ref": "KIT043"
    }, {
        "desc": "CACHE INFERIEUR LC 17",
        "title": "CACHE INFERIEUR LC 17",
        "quantite": 1,
        "pu": 63.21,
        "ref": "CAC033"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D’OEUVRE",
        "title": "MAIN D’OEUVRE",
        "quantite": 1,
        "pu": 330
    }]
}, {
    "title": "Devis débouchage camion vidange fosse septique",
    "ref": "DEVIS_DEBOUCHAGE_CVFS",
    "text": "devis d'<u>assainissement</u> pour <u>la vidange de votre fosse septique.</u>",
    "__v": 0,
    "produits": [{
        "desc": "VIDANGE FOSSE SEPTIQUE\nCONTENANCE DE LA CUVE = 1 M3PRIX / M3",
        "title": "CONTENANCE DE LA CUVE = 1 M3",
        "quantite": 1,
        "pu": 156.25,
        "ref": "CON045"
    }, {
        "desc": "TRAITEMENT DES DÉCHETS",
        "title": "TRAITEMENT DES DÉCHETS",
        "quantite": 1,
        "pu": 69.21,
        "ref": "TRA080"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D'OEUVRE",
        "title": "MAIN D'OEUVRE",
        "quantite": 1,
        "pu": 85
    }, {
        "ref": "EDI002",
        "desc": "DEPLACEMENT",
        "title": "DEPLACEMENT",
        "quantite": 1,
        "pu": 65
    }]
}, {
    "title": "Devis chaudière gaz mural ELM LEBLANC avec ECS",
    "ref": "DEVIS_CHD_GM_ELM",
    "text": "<u>devis de remplacement de votre chaudière gaz</u>",
    "__v": 0,
    "produits": [{
        "desc": "Installation d’une chaudière gaz (chauffage + eau chaude sanitaire)\nDépose complète de l’existant\nMise à la décharge de l’unité de chauffage existanteMise en conformité des raccordements gaz\nInstallation et mise en service inclus\n",
        "title": "Installation d’une chaudière gaz",
        "quantite": 1,
        "pu": 0,
        "ref": "INS078"
    }, {
        "desc": "CHAUDIERE GAZ A TIRAGE NATUREL",
        "title": "CHAUDIERE GAZ A TIRAGE NATURELPuissance : 9.5 à 24 kW\nDébit : 11.5  litres / minute\nDiamètre évacuation : 125 mm\nMode d’allumage par veilleuse\nDimensions (L x P x H ) : 400 x 385 x 865\nÉquipé du système S.P.O.T.T (sécurité gaz)",
        "quantite": 1,
        "pu": 1438.52,
        "ref": "CHA075"
    }, {
        "desc": "DOSSERET DE REMPLACEMENT CHAUDIÈRE",
        "title": "DOSSERET DE REMPLACEMENT CHAUDIÈRE",
        "quantite": 1,
        "pu": 189.13,
        "ref": "DOS068"
    }, {
        "desc": "SOUPAPE DE SÉCURITÉ 4BAR DN15",
        "title": "SOUPAPE DE SÉCURITÉ 4BAR DN15",
        "quantite": 1,
        "pu": 119.21,
        "ref": "SOU068"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D’OEUVRE",
        "title": "MAIN D’OEUVRE",
        "quantite": 1,
        "pu": 380
    }]
}, {
    "title": "Chauffe eau électrique 200 L HM Blindée",
    "text": "<u>devis de remplacement de votre chauffe-eau electrique</u>",
    "ref": "CHAUFFE_EA",
    "__v": 0,
    "produits": [{
        "desc": "Chauffe-eau électrique horizontale\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 2 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
        "title": "CHAUFFE EAU HM BLINDEE 200L",
        "ref": "CB200H",
        "pu": 696.25,
        "__v": 0,
        "random": 0,
        "quantite": 1
    }, {
        "ref": "BAL002",
        "title": "groupe de securité",
        "desc": "Groupe de securité",
        "pu": 69.97,
        "__v": 0,
        "random": 0,
        "quantite": 1
    }, {
        "ref": "BAL003",
        "title": "Raccordement hydraulique",
        "desc": "Raccordement hydraulique",
        "pu": 16.33,
        "__v": 0,
        "random": 0,
        "quantite": 2
    }, {
        "ref": "EDI001",
        "title": "Main d'œuvre",
        "desc": "Main d'œuvre",
        "pu": 195,
        "__v": 0,
        "random": 1,
        "quantite": 1
    }]
}, {
    "title": "Chauffe eau électrique 200 L VM Blindée",
    "text": "<u>devis de remplacement de votre chauffe-eau electrique</u>",
    "ref": "MONCOMBO",
    "__v": 0,
    "produits": [{
        "__v": 0,
        "title": "CHAUFFE EAU VM BLINDEE 200L",
        "ref": "CEB200",
        "desc": "Chauffe-eau électrique mural vertical\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 2 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
        "pu": 432.1,
        "random": 0,
        "quantite": 1
    }, {
        "ref": "BAL002",
        "title": "groupe de securité",
        "desc": "Groupe de securité",
        "pu": 69.97,
        "__v": 0,
        "random": 0,
        "quantite": 1
    }, {
        "ref": "BAL003",
        "title": "Raccordement hydraulique",
        "desc": "Raccordement hydraulique",
        "pu": 16.33,
        "__v": 0,
        "random": 1,
        "quantite": 2
    }, {
        "ref": "EDI001",
        "title": "Main d'œuvre",
        "desc": "Main d'œuvre",
        "pu": 195,
        "__v": 0,
        "random": 0,
        "quantite": 1
    }]
}, {
    "__v": 0,
    "title": "Chauffe eau électrique 200 L VM steatite",
    "text": "<u>devis de remplacement de votre chauffe-eau électrique steatite</u>",
    "ref": "CHAUFFE_EA",
    "produits": [{
        "quantite": 1,
        "random": 1,
        "pu": 593.21,
        "desc": "Chauffe-eau électrique mural vertical\nRésistance stéatite\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 5 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
        "title": "CHAUFFE EAU VM STEATITE 200L",
        "ref": "CES200",
        "__v": 0,
    }, {
        "quantite": 1,
        "random": 0,
        "__v": 0,
        "pu": 69.97,
        "desc": "Groupe de securité",
        "title": "groupe de securité",
        "ref": "BAL002",
    }, {
        "quantite": 2,
        "random": 1,
        "__v": 0,
        "pu": 16.33,
        "desc": "Raccordement hydraulique",
        "title": "Raccordement hydraulique",
        "ref": "BAL003",
    }, {
        "quantite": 1,
        "random": 1,
        "__v": 0,
        "pu": 195,
        "desc": "Main d'œuvre",
        "title": "Main d'œuvre",
        "ref": "EDI001",
    }]
}, {
    "title": "Devis de tableau électrique 1 rangée - 13 modules",
    "ref": "DEVIS_TAB_ELEC_1_13",
    "text": "devis de mise en conformité électrique NF C 15-100, nous vous proposons le remplacement  de votre tableau <strong>1 rangée - 13 modules</strong>",
    "__v": 0,
    "produits": [{
        "title": "Remise en conformité électrique NF C15-100",
        "desc": "Remise en conformité électrique NF C15-100\nIdentification des circuits électriques\nSchéma électrique\n",
        "pu": 0,
        "quantite": 1,
        "ref": "REM046"
    }, {
        "desc": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
        "title": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
        "quantite": 1,
        "pu": 89.1,
        "ref": "TAB066"
    }, {
        "desc": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
        "title": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
        "quantite": 1,
        "pu": 166.25,
        "ref": "INT034"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 32 A",
        "title": "DISJONCTEUR DIFFERENTIEL 32 A",
        "quantite": 1,
        "pu": 32.65,
        "ref": "DIS015"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 20 A",
        "title": "DISJONCTEUR DIFFERENTIEL 20 A",
        "quantite": 2,
        "pu": 29.31,
        "ref": "DIS032"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 16 A",
        "title": "DISJONCTEUR DIFFERENTIEL 16 A",
        "quantite": 4,
        "pu": 28.17,
        "ref": "DIS083"
    }, {
        "desc": "DISJONCTEUR DIFFERENTIEL 10 A",
        "title": "DISJONCTEUR DIFFERENTIEL 10 A",
        "quantite": 4,
        "pu": 27.34,
        "ref": "DIS016"
    }, {
        "desc": "PEIGNE UNIPOLAIRE P+N",
        "title": "PEIGNE UNIPOLAIRE P+N",
        "quantite": 2,
        "pu": 12.93,
        "ref": "PEI023"
    }, {
        "desc": "CABLAGE EDF 10 mm²",
        "title": "CABLAGE EDF 10 mm²",
        "quantite": 2,
        "pu": 28.67,
        "ref": "CAB032"
    }, {
        "ref": "EDI001",
        "desc": "MAIN D'OEUVRE\nDépose de l'existant et mise en service inclus",
        "title": "MAIN D'OEUVRE",
        "quantite": 1,
        "pu": 280
    }]
}, {
    "title": "Devis wc supendu",
    "text": "<u>devis du wc suspendu</u>",
    "ref": "DEVIS_WC_S",
    "__v": 0,
    "produits": [{
        "__v": 0,
        "desc": "PACK WC SUSPENDU AVEC ABATTANT À FERMETURE\nRALENTIE LOVELY RIMFREE BLANC RÉF 08399600000100\nALLIA",
        "pu": 571.5,
        "title": "PACK WC SUSPENDU AVEC ABATTANT À FERMETURE",
        "ref": "536295",
        "random": 0,
        "quantite": 1,
        "showDesc": true
    }, {
        "__v": 0,
        "desc": "BÂTI-SUPPORT AUTOPORTANT DUOFIX PLUS UP320 H :\n112 CM 111.333.00.5 GEBERIT",
        "title": "BÂTI-SUPPORT AUTOPORTANT DUOFIX",
        "ref": "659854",
        "pu": 329.77,
        "random": 1,
        "quantite": 1,
        "showDesc": true
    }, {
        "__v": 0,
        "desc": "PLAQUE BA12 POUR HABILLAGE CARRELAGE",
        "title": "PLAQUE BA12 POUR HABILLAGE CARRELAGE",
        "ref": "458956",
        "pu": 139.1,
        "random": 0,
        "quantite": 1,
        "showDesc": true
    }, {
        "desc": "PIPE ÉVACUATION FLEXIBLE POUR WC SUSPENDU",
        "pu": 113.21,
        "ref": "698545",
        "title": "PIPE ÉVACUATION FLEXIBLE POUR WC SUSPENDU",
        "__v": 0,
        "random": 0,
        "quantite": 1,
        "showDesc": true
    }, {
        "ref": "EDI001",
        "title": "Main d'œuvre",
        "desc": "Main d'œuvre",
        "pu": 380,
        "__v": 0,
        "random": 1,
        "quantite": 1,
        "showDesc": true
    }]
}]
module.exports = {
    artisan: [{
        title: 'Modifier la Fiche',
        action: "ouvrirFiche"
    }, {
        title: 'Ouvrir Recap',
        action: "ouvrirRecap",
        hide: function(artisan) {
            return artisan.status !== 'POT';
        }
    }, {
        title: "Archiver",
        action: 'archiver',
        hide: function(artisan) {
            return artisan.status === 'ARC';
        }
    }, {
        title: "dé-Archiver",
        action: 'deArchiver',
        hide: function(artisan) {
            return artisan.status !== 'ARC';
        }
    }, {
        title: "Envoyer Contrat",
        action: 'envoiContrat',
        hide: function(artisan) {
            return (artisan.document && artisan.document.cni && artisan.document.kbis && artisan.document.contrat);
        }
    }, {
        title: "Manager",
        action: 'manager',
    }, {
        title: "Rappel Contrat",
        action: 'rappelContrat',
        hide: function(artisan) {
            return !artisan.historique.contrat.length || (artisan.document && artisan.document.cni && artisan.document.kbis && artisan.document.contrat);
        }
    }, {
        title: "Facturier/deviseur",
        action: 'facturierDeviseur',
    }, {
        title: 'Appels',
        style: {
            fontWeight: 'bold'
        },
        subs: [{
            title: 'Telephone 1',
            action: 'callTel1',
            binding: 'telephone.tel1',
            hide: function(artisan) {
                return !artisan.telephone.tel1
            }
        }, {
            title: 'Telephone 2',
            action: 'callTel2',
            binding: 'telephone.tel2',
            hide: function(artisan) {
                return !artisan.telephone.tel2
            }
        }]
    }],
    devis: [{
        title: 'Modifier le devis',
        action: "ouvrirFiche",
        style: {
            fontWeight: 'bold'
        },
    }, {
        title: 'Appels',
        style: {
            fontWeight: 'bold'
        },
        subs: [{
            title: 'Client tel1',
            action: 'callTel1',
            binding: 'client.telephone.tel1',
            hide: function(inter) {
                return !inter.client.telephone.tel1
            }
        }, {
            title: 'Client tel2',
            action: 'callTel2',
            binding: 'client.telephone.tel2',
            hide: function(inter) {
                return !inter.client.telephone.tel2
            }
        }, {
            title: 'Client tel3',
            binding: 'client.telephone.tel3',
            action: 'callTel3',
            hide: function(inter) {
                return !inter.client.telephone.tel3
            }
        }]
    }, {
        title: "Prévisualiser",
        action: 'devisPreview',
    }, {
        title: "Envoyer",
        action: 'sendDevis',
        hide: function(inter) {
            return inter.status === "TRA" || (inter.historique && inter.historique.length != 0);
        }
    }, {
        title: "Relance 1",
        action: 'sendDevis',
        hide: function(inter) {
            return inter.status === "TRA" || (!inter.historique || inter.historique.length != 1);
        }
    }, {
        title: "Relance 2",
        action: 'sendDevis',
        hide: function(inter) {
            return inter.status === "TRA" || (!inter.historique || inter.historique.length < 2);
        }
    }, {
        title: "Transferer",
        action: 'transfert',
        hide: function(inter) {
            return inter.status === 'TRA';
        }
    }, {
        title: "Annuler",
        action: 'annulation',
        hide: function(inter) {
            return inter.status === 'ANN';
        }
    }],
    intervention: [{
        title: "Modifier l'intervention",
        action: "ouvrirFiche",
        style: {
            fontWeight: 'bold'
        }
    }, {
        title: 'Appels',
        style: {
            fontWeight: 'bold'
        },
        subs: [{
            title: 'Client tel1',
            action: 'callTel1',
            binding: 'client.telephone.tel1',
            hide: function(inter) {
                return !inter.client.telephone.tel1
            }
        }, {
            title: 'Client tel2',
            action: 'callTel2',
            binding: 'client.telephone.tel2',
            hide: function(inter) {
                return !inter.client.telephone.tel2
            }
        }, {
            title: 'Client tel3',
            action: 'callTel3',
            binding: 'client.telephone.tel3',
            hide: function(inter) {
                return !inter.client.telephone.tel3
            }
        }, {
            title: 'Sous-traitant tel1',
            action: 'callSst1',
            binding: 'sst.telephone.tel1',
            hide: function(inter) {
                return !inter.sst || !inter.sst.telephone.tel1
            }
        }, {
            title: 'Sous-traitant tel2',
            action: 'callSst2',
            binding: 'sst.telephone.tel2',
            hide: function(inter) {
                return !inter.sst || !inter.sst.telephone.tel2
            }
        }, {
            title: 'Payeur tel1',
            action: 'callPayeur1',
            binding: 'sst.facture.tel',
            hide: function(inter) {
                return !inter.facture || !inter.facture.tel
            }
        }, {
            title: 'Payeur tel2',
            action: 'callPayeur2',
            binding: 'sst.facture.tel2',
            hide: function(inter) {
                return !inter.facture || !inter.facture.tel2
            }
        }]
    }, {
        title: 'Recap sous-traitant',
        action: "ouvrirRecapSST",
        hide: function(inter) {
            return !inter.artisan || !inter.artisan.id
        }
    }, {
        title: 'Reglement Client',
        action: "validerReglement",
        hide: function(inter) {
            return !(app_session.root ||  app_session.service === 'COMPTABILITE') ||  (inter.status !== 'ENC' && inter.status !== 'VRF');
        }
    }, {
        title: 'Paiement SST',
        action: "validerPaiement",
        hide: function(inter) {
            return !((app_session.root ||  app_session.service === 'COMPTABILITE') && (inter.status === 'VRF' || inter.status === "ENC"));
        }
    }, {
        title: "SMS sous-traitant",
        action: 'smsArtisan',
        hide: function(inter) {
            return !inter.artisan || !inter.artisan.id
        }
    }, {
        title: "Envoyer",
        action: 'envoi',
        hide: function(inter) {
            return inter.status == "VRF" || (!inter.artisan || !inter.artisan.id)
        }
    }, {
        title: "Vérifier",
        action: 'verification',
        hide: function(inter) {
            return inter.status !== "AVR" && inter.status !== 'ENC'
        }
    }, {
        title: "Reactiver",
        action: 'reactivation',
        hide: function(inter) {
            return inter.status !== 'ANN'
        }
    }, {
        title: "Annuler",
        action: 'annulation',
        hide: function(inter) {
            return !inter.id || inter.status === 'ANN' || inter.status === 'VRF'
        }
    }, {
        title: "Recouvrement",
        action: 'recouvrement',
        hide: function(inter) {
            return inter.compta.reglement.recu || inter.status !== "VRF"
        }
    }, {
        title: "Je prend !",
        action: 'demarcher',
        hide: function(inter) {
            return !inter.aDemarcher;
        }
    }]
}
module.exports = {
    categories: {
        PL: {
            id_compta: 2,
            suffix: 'de',
            short_name: 'PL',
            long_name: 'Plomberie',
            order: 0,
            color: 'blue white-text'
        },
        CH: {
            id_compta: 3,
            suffix: 'de',
            short_name: 'CH',
            long_name: 'Chauffage',
            order: 1,
            color: 'red white-text'
        },
        EL: {
            id_compta: 1,
            suffix: "d'",
            short_name: 'EL',
            long_name: 'Électricité',
            order: 2,
            color: 'yellow  accent-4 black-text'
        },
        SR: {
            id_compta: 5,
            suffix: 'de',
            short_name: 'SR',
            long_name: 'Serrurerie',
            order: 3,
            color: 'brown white-text'
        },
        VT: {
            id_compta: 4,
            suffix: 'de',
            short_name: 'VT',
            long_name: 'Vitrerie',
            order: 4,
            color: 'green white-text'
        },
        AS: {
            id_compta: 7,
            suffix: 'de',
            short_name: 'AS',
            long_name: 'Assainissement',
            order: 5,
            color: 'orange white-text'
        },
        CL: {
            id_compta: 6,
            suffix: 'de',
            short_name: 'CL',
            long_name: 'Climatisation',
            order: 6,
            color: 'teal white-text'
        },
        PT: {
            id_compta: 9,
            suffix: 'de',
            short_name: 'PT',
            long_name: 'Peinture',
            order: 7,
            color: 'deep-orange white-text'
        }
    },
    paiementArtisan: [{}, {
        title: 'En Cours',
        color: 'orange',
        icon: 'ellipsis-h',
        id: 1
    }, {
        title: 'Payé',
        color: 'green',
        icon: 'check',
        id: 1
    }],
    reglementClient: [{
        title: '',
        id: ''
    }, {
        title: 'Réglé',
        id: 1,
        color: "green",
        icon: 'check'
    }, {
        id: 2,
        title: 'Sst Att. Urgent',
        color: 'red',
        icon: 'truck'
    }, {
        id: 3,
        title: 'Sst Att.',
        color: 'orange',
        icon: 'truck'
    }, {
        id: 4,
        title: 'Cli. Att. Urgent',
        color: 'red',
        icon: 'user'
    }, {
        id: 5,
        title: 'Cli. Att.',
        color: 'orange',
        icon: 'user'
    }],
    categoriesHash: function() {
        return [this.categories.PL,
            this.categories.CH,
            this.categories.EL,
            this.categories.SR,
            this.categories.VT,
            this.categories.AS,
            this.categories.CL,
            this.categories.PT
        ]
    },
    libellePaiement: {
        'AUTO-FACT': {
            long_name: 'auto-facture',
            short_name: 'STF'
        },
        'AVOIR': {
            long_name: 'avoir',
            short_name: 'STA'
        },
        'COMPLEMENT': {
            long_name: 'complement',
            short_name: 'STC'
        }
    },
    categoriesArray: function() {
        var x = [];
        for (var i in this.categories)
            x.push(this.categories[i]);
        return x;
    },
    etats: {
        ENC: {
            order: 0,
            short_name: 'ENC',
            long_name: 'En Cours',
            old_name: 'EN COURS',
            color: 'orange'
        },
        VRF: {
            order: 1,
            short_name: 'VRF',
            long_name: 'Vérifié',
            old_name: 'INTERVENU',
            color: 'green'
        },
        APR: {
            order: 2,
            short_name: 'APR',
            long_name: 'A Progr.',
            old_name: 'A PROGRAMMER',
            color: 'blue'
        },
        AVR: {
            order: 3,
            short_name: 'AVR',
            long_name: 'A Vérifier',
            old_name: 'EN COURS',
            color: 'brown darken-3'
        },
        ANN: {
            order: 4,
            short_name: 'ANN',
            long_name: 'Annuler',
            old_name: 'ANNULE',
            color: 'red'
        }
    },
    etatsHash: function() {
        return [this.etats.ENC,
            this.etats.VRF,
            this.etats.APR,
            this.etats.AVR,
            this.etats.ANN
        ]
    },
    colorEnvoisDevis: function(i) {
        if (i === 0)
            return 'white';
        if (i === 1)
            return 'grey';
        if (i === 2)
            return 'black'
        return 'red'
    },
    etatsDevis: {
        AEV: {
            short_name: 'ENC',
            long_name: 'A Envoyer',
            color: 'blue'
        },
        ANN: {
            short_name: 'ANN',
            long_name: 'Annuler',
            color: 'red'
        },
        TRA: {
            short_name: 'TRA',
            long_name: 'Transferé',
            color: 'green accent-4'
        },
        ATT: {
            short_name: 'ATT',
            long_name: 'En Attente',
            color: 'purple'
        }
    },
    fournisseur: [{
        short_name: 'ARTISAN',
        type: 'Fourniture Artisan'
    }, {
        short_name: 'CEDEO',
        type: 'Fourniture Edison'
    }, {
        short_name: 'BROSSETTE',
        type: 'Fourniture Edison'
    }, {
        short_name: 'REXEL',
        type: 'Fourniture Edison'
    }, {
        short_name: 'COAXEL',
        type: 'Fourniture Edison'
    }, {
        short_name: 'YESSS ELECTRIQUE',
        type: 'Fourniture Edison'
    }, {
        short_name: 'CGED',
        type: 'Fourniture Edison'
    }, {
        short_name: 'COSTA',
        type: 'Fourniture Edison'
    }, {
        short_name: 'FORUM DU BATIMENT',
        type: 'Fourniture Edison'
    }, {
        short_name: 'EDISON',
        type: 'Fourniture Edison'
    }],
    modePaiement: [{
        short_name: 'VIR',
        long_name: 'Virement'
    }, {
        short_name: 'CHQ',
        long_name: 'Chèque'
    }],
    modeDeReglements: [{
        short_name: 'CB',
        long_name: 'Carte Bancaire',
        old_name: 'cb'
    }, {
        short_name: 'CH',
        long_name: 'Chèque',
        old_name: 'cheque'
    }, {
        short_name: 'CA',
        long_name: 'Espèces',
        old_name: 'especes'
    }],
    tva: [{
        short_name: 10,
        value: 0.1,
        long_name: "TVA: 10.00%"
    }, {
        short_name: 20,
        value: 0.2,
        long_name: "TVA: 20.00%"
    }, {
        short_name: 0,
        value: 0.0,
        long_name: "TVA: 0.00%"
    }],
    tvaSST: [{
        short_name: 0,
        value: 0,
        long_name: "PAS DE TVA"
    }, {
        short_name: 20,
        value: 0.2,
        long_name: "TVA: 20%"
    }],
    typeClient: [
        "AUT",
        "SOC",
        "PRO",
        "LOC",
        "IMO",
        "CUR"
    ],
    typePayeur: [{
        short_name: 'SOC',
        long_name: 'Société'
    }, {
        short_name: 'PRO',
        long_name: 'Propriétaire'
    }, {
        short_name: 'IMO',
        long_name: 'Agence Immobilière'
    }, {
        short_name: 'CUR',
        long_name: 'Curatelle'
    }, {
        short_name: 'AUT',
        long_name: 'Autre'
    }, {
        short_name: 'GRN',
        long_name: 'Grands Comptes'
    }],
    typePayeurObj: {
        SOC: 'SOCIÉTÉ',
        PRO: 'PROPRIÉTAIRE',
        IMO: 'AGENCE IMMOBILIÈRE',
        CUR: 'CURATELLE',
        AUT: 'AUTRE',
        GRN: 'GRAND COMPTE'
    },
    compteFacturation: [{
        short_name: 'FRN_LSR',
        long_name: 'France Loisir',
        compte: 'FRN_LSR',
        nom: 'France Loisir',
        tel: '010101010101',
        address: {
            n: '1',
            r: 'rue test',
            v: 'PARIS',
            cp: "75012"
        },
        email: "test@test.fr"
    }],
    civilites: [{
        short_name: 'M.',
        long_name: 'Monsieur'
    }, {
        short_name: 'Mme.',
        long_name: 'Madame'
    }, {
        short_name: 'Soc.',
        long_name: 'Société'
    }],
    causeAnnulation: [{
        type: "client",
        short_name: "PB_RES",
        oldId: '2',
        long_name: "Le problème est résolu"
    }, {
        type: "client",
        oldId: '1',
        short_name: "PX_TP_CHR",
        long_name: "Le prix est trop cher"
    }, {
        type: "client",
        short_name: "CLI_REP_P",
        long_name: "Le client ne répond pas"
    }, {
        type: "client",
        short_name: "CLI_PAS_PAYE",
        long_name: "Le client n'a pas voulu payer le sous-traitant"
    }, {
        type: "client",
        short_name: "CLI_ANN_RDV",
        long_name: "Le client a annulé juste avant le rendez-vous"
    }, {
        type: "sous-traitant",
        short_name: "SST_P_DSP",
        oldId: '4',
        long_name: "Le sous-traitant n'est pas disponible"
    }, {
        type: "sous-traitant",
        oldId: '3',
        short_name: "SST_REP_PS",
        long_name: "Le sous-traitant ne répond pas"
    }, {
        type: "sous-traitant",
        short_name: "SST_SHT_PS",
        long_name: "Le ne souhaite pas faire l'intervention"
    }, {
        type: "sous-traitant",
        short_name: "SST_PS_APL",
        long_name: "Le sous-traitant n'a jamais appelé le client"
    }, {
        type: "sous-traitant",
        short_name: "RETARD_SST",
        long_name: "Retard du sous-traitant"
    }, {
        type: "sous-traitant",
        short_name: "SST_PS_CMPT",
        long_name: "Le sous-traitant n'est pas compétent pour cette intervention"
    }, {
        type: "partenariat",
        short_name: "PS_SST_DISPO",
        long_name: "Il n'y a pas de sous-traitant disponible dans la zone"
    }, {
        type: "partenariat",
        oldId: '5',
        short_name: "PS_SST",
        long_name: "Il n'y a pas de sous-traitant dans la zone"
    }, {
        type: "partenariat",
        short_name: "RVL_LIENS_SST",
        long_name: "Le sous-traitant a dévoilé les liens de sous-traitance au client"
    }, {
        type: "partenariat",
        short_name: "PS_BON",
        long_name: "Le sous-traitant démarché n'est pas bon"
    }, {
        type: 'Autre',
        short_name: 'AUTRE',
        long_name: 'Autre'
    }],
    getCauseAnnulation: function(short_name) {
        var _find = require('lodash/collection/find');
        return _find(this.causeAnnulation, function(e) {
            return e.short_name === short_name
        })
    },
    formeJuridique: {
        AUT: {
            type: "TVA 0%",
            short_name: "AUT",
            long_name: "AUTO-ENTREPRENEUR",
        },
        SARL: {
            type: "TVA 20%",
            short_name: "SARL",
            long_name: "SARL"
        },
        SAS: {
            type: "TVA 20%",
            short_name: "SAS",
            long_name: "SAS"
        },
        SASU: {
            type: "TVA 20%",
            short_name: "SASU",
            long_name: "SASU"
        },
        EURL: {
            type: "TVA 20%",
            short_name: "EURL",
            long_name: "EURL"
        },
        ART: {
            type: "TVA 20%",
            short_name: "ART",
            long_name: "ARTISAN"
        },
        IND: {
            type: "TVA 20%",
            short_name: "IND",
            long_name: "ENTREPRENEUR INDIVIDUEL"
        }
    },
    formeJuridiqueHash: function() {
        return [
            this.formeJuridique.AUT,
            this.formeJuridique.SARL,
            this.formeJuridique.SAS,
            this.formeJuridique.SASU,
            this.formeJuridique.EURL,
            this.formeJuridique.ART,
            this.formeJuridique.IND,
        ]
    },
    etatsArtisan: {
        ACT: {
            long_name: "Actif",
            short_name: "ACT",
            color: 'green'
        },
        ARC: {
            long_name: "Archivé",
            short_name: "ACT",
            color: 'red'
        },
        POT: {
            long_name: "Potentiel",
            short_name: "POT",
            color: 'blue'
        }
    },
    cardType: {
        VS: {
            long_name: "Visa",
            short_name: "VS",
        },
        AE: {
            long_name: "American Express",
            short_name: "AE",
        },
        MC: {
            long_name: "MasterCard",
            short_name: "MC",
        }
    },
    cardTypeArray: function() {
        return [this.cardType.VS, this.cardType.AE, this.cardType.MC];
    },
    artisanFiles: [
        'contrat_2014',
        'contrat',
        'kbis',
        'autofacturation',
        'cni',
        'assurance',
        'rib',
        'ursaff',
        'autres'
    ],
    artisanOrigine: {
        DEM: {
            order: 0,
            short_name: 'DEM',
            color: 'blue',
            long_name: "Demarché"
        },
        CAND: {
            order: 1,
            color: 'yellow black-text',
            short_name: 'CAND',
            long_name: "Candidat"
        }
    },
    artisanOrigineArray: function() {
        return [this.artisanOrigine.DEM, this.artisanOrigine.CAND];
    },
    typeAvoir: [{
        short_name: 'ERR_FACT',
        long_name: 'Erreur de facturation',
    }, {
        short_name: 'REM_COM',
        long_name: 'Remise Commercial'
    }, {
        short_name: 'TROP_PERCU',
        long_name: 'Trop Percu'
    }],
    avoir: function(short_name) {
        var _find = require('lodash/collection/find');
        return _find(this.typeAvoir, function(e) {
            return e.short_name === short_name
        })
    },
    savStatus: [{
        short_name: 'ENC',
        long_name: 'En Cours',
    }, {
        short_name: 'EFF',
        long_name: 'Effectué'
    }],
    artisanSubStatus: {
        NEW: {
            long_name: 'New',
            short_name: 'NEW',
            color: 'blue'
        },
        REG: {
            long_name: 'Régulier',
            short_name: 'REG',
            color: 'green'
        },
        HOT: {
            long_name: 'Hot',
            short_name: 'HOT',
            color: 'purple'
        },
        QUA: {
            long_name: "<Quarantaine>",
            short_name: "QUA",
            color: 'red'
        }
    }
}
var DateSelect = function(dateStart) {
    var _ = require('lodash')
    var _this = this;
    var d = new Date();
    _this.start = {
        m: !dateStart ? 9 : dateStart.getMonth() + 1,
        y: !dateStart ? 2013 : dateStart.getFullYear()
    }
    console.log('==>', start)
    _this.current = {
        m: d.getMonth() + 1,
        y: d.getFullYear()
    }

    var frenchMonths = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
    _this._list = [];
    _.times(_this.current.y - _this.start.y + 1, function(yr) {
        _.times(12, function(mth) {
            _this._list.push({
                m: mth + 1,
                y: _this.start.y + yr,
                t: frenchMonths[mth] + ' ' + (_this.start.y + yr),
                o: (_this.start.y + yr) + (mth + 1) * 0.01
            })
        })
    })
    _this._list.splice(_this.current.m - 12)
    return this._list;
}
module.exports = DateSelect;
module.exports = function(d) {
	return Math.round(((new Date(d)).getTime() / 10000) - 137000000)
}module.exports = [{
    "payeur": "SOC",
    "nom": "MONDIAL ASSISTANCE",
    "tel": "0123212321",
    "tel2": "",
    "email": "QSDQSD@DQSD.DE",
    "ref": "mondial_as",
    "__v": 0,
    "address": {
        "n": "12",
        "r": "RUE DU CHEVALIER DE LA BARRE",
        "cp": "75018",
        "v": "PARIS"
    }
}, {
    "nom": "EDISON SERVICES",
    "tel": "0618513199",
    "email": "CONTACT@EDISON-SERVICES.FR",
    "ref": "edison_ser",
    "__v": 0,
    "address": {
        "n": "75",
        "r": "RUE DES DAMES",
        "cp": "75017",
        "v": "PARIS"
    }
}, {
    "nom": "FRANCE LOISIRS",
    "prenom": "COMPTABILITE FOURNISSEUR",
    "email": "AGNES.GEORGIN@FRANCE-LOISIRS.COM",
    "tel": "0145686038",
    "ref": "france_loi",
    "__v": 0,
    "address": {
        "n": "123",
        "r": "RUE DE GRENELLE",
        "cp": "75007",
        "v": "PARIS"
    }
}, {
    "email": "FOURNISSEURS@BABILOU.COM",
    "tel": "0141496784",
    "nom": "EVANCIA SAS",
    "ref": "evancia_sa",
    "__v": 0,
    "address": {
        "n": "24",
        "r": "RUE DU MOULIN DES BRUYÈRES",
        "cp": "92400",
        "v": "COURBEVOIE"
    }
}, {
    "nom": "1001 CRÈCHES",
    "email": "FOURNISSEURS@BABILOU.COM",
    "tel": "0141490062",
    "ref": "1001_crech",
    "__v": 0,
    "address": {
        "n": "24",
        "r": "RUE DU MOULIN DES BRUYÈRES",
        "cp": "92400",
        "v": "COURBEVOIE"
    }
}, {
    "email": "CONTACT@BONAPART.FR",
    "nom": "CABINET BONAPART GESTION",
    "payeur": "SOC",
    "prenom": "STEVEN ZAKIN",
    "tel": "0171197565",
    "tel2": "0667086698",
    "ref": "cabinet_bo",
    "__v": 0,
    "address": {
        "n": "1",
        "r": "RUE CONTE",
        "cp": "75003",
        "v": "PARIS"
    }
}]
module.exports = [{
    "title": "BOUCHE VMC",
    "desc": "Bouche pour VMC\n- Bouche utilisée en VMC pavillonnaire(simple flux autoréglable ou double flux)ou VMP (ventilation mécanique ponctuelle).",
    "ref": "VMC002",
    "pu": 34.93
}, {
    "title": "GAINE CUISINE",
    "desc": "GAINE SPLE ALU GSA 125 3M\n- Utilisation en VMC habitat et tertiaire.\n- Température d'utilisation de -30 à +250°C.",
    "ref": "VMC003",
    "pu": 36.93
}, {
    "title": "GAINE AUTRES",
    "desc": "GAINE SPLE ALU GSA 80 3M\n- Utilisation en VMC habitat et tertiaire.\n- Température d'utilisation de -30 à +250°C.",
    "pu": 33.21,
    "ref": "VMC004",
}, {
    "title": "SANIBROYEUR PRO WC",
    "desc": "SANIBROYEUR PRO WC",
    "pu": 539.1,
    "ref": "SAN010",
}, {
    "desc": "DISJONCTEUR DIFFERENTIEL 32 A",
    "title": "DISJONCTEUR DIFFERENTIEL 32 A",
    "pu": 32.65,
    "ref": "DIS044",
}, {
    "desc": "VIDANGE FOSSE SEPTIQUE",
    "title": "VIDANGE FOSSE SEPTIQUE",
    "pu": 156.25,
    "ref": "CON016",
}, {
    "desc": "DISJONCTEUR DIFFERENTIEL 20 A",
    "title": "DISJONCTEUR DIFFERENTIEL 20 A",
    "pu": 29.31,
    "ref": "DIS017",
}, {
    "ref": "EDI001",
    "title": "Main d'œuvre",
    "desc": "Main d'œuvre",
    "pu": 65,
}, {
    "desc": "DISJONCTEUR DIFFERENTIEL 16 A",
    "title": "DISJONCTEUR DIFFERENTIEL 16 A",
    "pu": 28.17,
    "ref": "DIS095",
}, {
    "desc": "DISJONCTEUR DIFFERENTIEL 10 A",
    "title": "DISJONCTEUR DIFFERENTIEL 10 A",
    "pu": 27.34,
    "ref": "DIS061",
}, {
    "title": "SIMPLE VITRAGE LIVRAISON",
    "ref": "LIV001",
    "desc": "DÉPOSE / LIVRAISON et TRANSPORT",
    "pu": 35,
}, {
    "title": "DOUBLE VITRAGE LIVRAISON",
    "desc": "DÉPOSE / LIVRAISON et TRANSPORT",
    "ref": "LIV002",
    "pu": 55,
}, {
    "title": "MAIN D'OEUVRE VITRERIE",
    "ref": "VIT001",
    "pu": 130,
    "desc": "MAIN D'OEUVRE\nDEPLACEMENTS",
}, {
    "title": "CYLINDRE PROFIL EURO",
    "ref": "CYL001",
    "desc": "CYLINDRE PROFIL EUROPÉEN\n30 X 40\nFOURNIS AVEC 3 CLES",
    "pu": 96.25,
}, {
    "desc": "CYLINDRE PROFIL EUROPÉEN DE SÛRETÉ\n30 X 40\nFOURNIS AVEC CLÉS\nCARTE DE PROPRIÉTÉ\nREPRODUCTION INTERDITE",
    "title": "CYLINDRE PROFIL EURO SECURITE",
    "ref": "CYL002",
    "pu": 169.1,
}, {
    "title": "LAVABOS",
    "desc": "VICTORIA LAVABO 60 BLC",
    "ref": "LAV001",
    "pu": 139.1
}, {
    "title": "COLONNE LAVABOS",
    "desc": "VICTORIA COLONNE BLC",
    "pu": 96.25,
    "ref": "LAV002",
}, {
    "ref": "EDI002",
    "title": "Déplacement",
    "desc": "Déplacement",
    "pu": 65,
}, {
    "title": "SERRURE 1 POINT APPLIQUE",
    "desc": "SERRURE 1 POINT APPLIQUE\nCYLINDRE PROFIL EUROPEEN\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLES",
    "pu": 139.1,
    "ref": "SER001",
}, {
    "title": "SERRURE 3 POINTS APPLIQUE",
    "ref": "SER004",
    "desc": "SERRURE 3 POINTS APPLIQUE\nCYLINDRE PROFIL EUROPEEN\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLÉS",
    "pu": 246.25,
}, {
    "desc": "Ensemble mécanisme WC 3/6L ECO\nDouble volume\nJusqu'à -50% d'économie d'eau\nModèle adaptable",
    "title": "MECANISME CHASSE WC 3/6L",
    "ref": "MEC001",
    "pu": 96.25
}, {
    "desc": "PACK WC SUSPENDU AVEC ABATTANT À FERMETURE\nRALENTIE LOVELY RIMFREE BLANC RÉF 08399600000100\nALLIA",
    "pu": 571.5,
    "title": "PACK WC SUSPENDU AVEC ABATTANT À FERMETURE",
    "ref": "536295"
}, {
    "desc": "BÂTI-SUPPORT AUTOPORTANT DUOFIX PLUS UP320 H :\n112 CM 111.333.00.5 GEBERIT",
    "title": "BÂTI-SUPPORT AUTOPORTANT DUOFIX",
    "ref": "659854",
    "pu": 329.77
}, {
    "desc": "PLAQUE BA12 POUR HABILLAGE CARRELAGE",
    "title": "PLAQUE BA12 POUR HABILLAGE CARRELAGE",
    "ref": "458956",
    "pu": 139.1
}, {
    "desc": "PEIGNE UNIPOLAIRE P+N",
    "title": "PEIGNE UNIPOLAIRE P+N",
    "pu": 12.93,
    "ref": "PEI062",
}, {
    "desc": "CABLAGE EDF 10 mm²",
    "title": "CABLAGE EDF 10 mm²",
    "pu": 28.67,
    "ref": "CAB046",
}, {
    "desc": "Dépose de l'existant et mise en service inclus",
    "title": "Dépose de l'existant et mise en service inclus",
    "pu": 0,
    "ref": "DEP017",
}, {
    "desc": "CACHE INFERIEUR LC 17",
    "title": "CACHE INFERIEUR LC 17",
    "pu": 63.21,
    "ref": "CAC079",
}, {
    "desc": "Installation d’une chaudière gaz",
    "title": "Installation d’une chaudière gaz",
    "pu": 0,
    "ref": "INS027",
}, {
    "desc": "DOSSERET DE REMPLACEMENT CHAUDIÈRE",
    "title": "DOSSERET DE REMPLACEMENT CHAUDIÈRE",
    "pu": 189.13,
    "ref": "DOS040",
}, {
    "ref": "BAL004",
    "title": "Trépied Ballon",
    "desc": "Trépied Ballon",
    "pu": 93.21,
}, {
    "desc": "PIPE ÉVACUATION FLEXIBLE POUR WC SUSPENDU",
    "pu": 113.21,
    "ref": "698545",
    "title": "PIPE ÉVACUATION FLEXIBLE POUR WC SUSPENDU",
}, {
    "desc": "SOUPAPE DE SÉCURITÉ 4BAR DN15",
    "title": "SOUPAPE DE SÉCURITÉ 4BAR DN15",
    "pu": 119.21,
    "ref": "SOU054",
}, {
    "title": "Remise en conformité électrique NF C15-100",
    "desc": "Remise en conformité électrique NF C15-100",
    "pu": 0,
    "ref": "REM078",
}, {
    "ref": "VIT002",
    "title": "Remplacement Vitrage",
    "desc": "Remplacement Vitragess",
    "pu": 297.13,
}, {
    "ref": "CAM001",
    "title": "Camion D'assainisement",
    "desc": "Camion D'assainisement",
    "pu": 696.25,
}, {
    "desc": "TRAITEMENT DES DÉCHETS",
    "title": "TRAITEMENT DES DÉCHETS",
    "pu": 69.21,
    "ref": "TRA088",
}, {
    "desc": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
    "title": "INTERUPTEUR DIFFERENTIEL 30 mA - 40A",
    "pu": 166.25,
    "ref": "INT012",
}, {
    "desc": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
    "title": "TABLEAU ELECTRIQUE 1 RANGEE - 13 MODULES",
    "pu": 89.1,
    "ref": "TAB093",
}, {
    "desc": "APPL D E 120GT 2T 12V\nGâche pour serrure applique verticale\n- Modèle en aluminium à double empênage.\n- Tension 12 volts.",
    "title": "GACHE ELECTRIQUE",
    "pu": 155.4,
    "ref": "000418"
}, {
    "desc": "Transformateur - Chrono code: 396431\n- 12 ou 24V AC.\n- Puissance de sortie 1,25 A.",
    "title": "TRANSFO 12V",
    "pu": 94.11,
    "ref": "396431"
}, {
    "title": "CHAUDIERE GAZ A TIRAGE NATUREL",
    "desc": "CHAUDIERE GAZ A TIRAGE NATUREL\nPUISSANCE : 9.5 À 24 KW\nDÉBIT : 11.5  LITRES / MINUTE\nDIAMÈTRE ÉVACUATION : 125 MM\nMODE D’ALLUMAGE PAR VEILLEUSE\nDIMENSIONS (L X P X H ) : 400 X 385 X 865\nÉQUIPÉ DU SYSTÈME S.P.O.T.T (SÉCURITÉ GAZ)",
    "pu": 1438.52,
    "ref": "CHA047",
}, {
    "title": "CHAUFFE EAU VM BLINDEE 200L",
    "ref": "CEB200",
    "desc": "Chauffe-eau électrique mural vertical\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 2 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
    "pu": 432.1
}, {
    "ref": "CES200",
    "title": "CHAUFFE EAU VM STEATITE 200L",
    "desc": "Chauffe-eau électrique mural vertical\nRésistance stéatite\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 5 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
    "pu": 593.21
}, {
    "ref": "ZEN200",
    "title": "CHAUFFE EAU VM ZENEO 200L",
    "desc": "Chauffe-eau électrique mural vertical\nRésistance stéatite\nPuissance : 2200 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 5 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
    "pu": 696.25
}, {
    "desc": "Chauffe-eau électrique horizontale\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 2 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
    "title": "CHAUFFE EAU HM BLINDEE 200L",
    "ref": "CB200H",
    "pu": 696.25,
}, {
    "title": "CHAUFFE EAU HM STEATITE 200L",
    "ref": "CS200H",
    "pu": 739.1,
    "desc": "Chauffe-eau électrique horizontale\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 5 ans\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\nESSAIS ET MISE EN SERVICE INCLUS",
}, {
    "desc": "CYLINDRE PROFIL EUROPÉEN DE HAUTE SÛRETÉ\nCANON ANTI-EFFRACTION / ANTI-PERÇAGE\n30 X 40\nFOURNIS AVEC CLÉS\nCARTE DE PROPRIÉTÉ\nREPRODUCTION INTERDITE",
    "title": "CYLINDRE PROFIL EURO DE HAUTE SURETE",
    "pu": 269.1,
    "ref": "CYL003",
}, {
    "ref": "SER003",
    "title": "SERRURE 1 POINT APPLIQU DE HAUTE SURETE",
    "desc": "SERRURE 1 POINT APPLIQUE DE SÛRETÉ\nCYLINDRE PROFIL EUROPEEN DE HAUTE SURETE\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLÉS BLINDE\nCARTE DE PROPRIÉTÉ / REPRODUCTION INTERDITE",
    "pu": 296.25,
}, {
    "ref": "SER005",
    "desc": "SERRURE 3 POINTS APPLIQUE DE SÛRETÉ\nCYLINDRE PROFIL EUROPEEN\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLÉS\nCARTE DE PROPRIÉTÉ / REPRODUCTION INTERDITE",
    "title": "SERRURE 3 POINTS APPLIQUE DE SURETE",
    "pu": 396.25,
}, {
    "ref": "SER002",
    "title": "SERRURE 1 POINT APPLIQUE SECURITE",
    "desc": "SERRURE 1 POINT APPLIQUE DE SÛRETÉ\nCYLINDRE PROFIL EUROPEEN\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLÉS\nCARTE DE PROPRIÉTÉ / REPRODUCTION INTERDITE",
    "pu": 226.25,
}, {
    "desc": "SERRURE 3 POINTS APPLIQUE DE SÛRETÉ\nCYLINDRE PROFIL EUROPEEN DE HAUTE SURETE\nHORIZONTAL / VERTICAL A FOUILLOT OU A TIRAGE\nFOURNIS AVEC CLÉS BLINDE\nCARTE DE PROPRIÉTÉ / REPRODUCTION INTERDITE",
    "ref": "SER006",
    "title": "SERRURE 3 POINTS APPLIQUE DE HAUTE SECURITE",
    "pu": 596.2,
}, {
    "ref": "SVI001",
    "title": "SIMPLE VITRAGE",
    "desc": "REMPLACEMENT D'UN VITRAGE SUITE A BRIS DE GLACE :\n\nPORTE FENÊTRE\nSIMPLE VITRAGE\nVITRAGE CLAIR\nHaut 2000 mm X Larg 1000 mm\nCHÂSSIS PVC / ALU / BOIS\n\nCOMMANDE SPÉCIALE SUR MESURE \nADAPTATION ET FIXATION SUR PLACE \nREMPLACEMENT A L'IDENTIQUE",
    "pu": 197.13,
}, {
    "ref": "DVI001",
    "title": "DOUBLE VITRAGE",
    "desc": "PORTE FENÊTRE\nDOUBLE VITRAGE\nVITRAGE CLAIR\nHaut 2000 mm X Larg 1000 mm\nCHÂSSIS PVC / ALU / BOIS\n\nCOMMANDE SPÉCIALE SUR MESURE \nADAPTATION ET FIXATION SUR PLACE \nREMPLACEMENT A L'IDENTIQUE",
    "pu": 297.13,
}, {
    "title": "FLEXIBLE FILAIRE POUR DIGICODE",
    "desc": "Flexible - Chrono code: 569833\n- Embouts en ABS avec prédécoupe.\n- Ressort en acier inox.\n- Longueur 500 mm diamètre 12 mm intérieur.",
    "ref": "569833",
    "pu": 39.54
}, {
    "title": "FERME PORTE",
    "desc": "Ferme-porte à pignon et crémaillère.\n- Avec force réglable en continue de 2 à 6.\n- Réagit en proportion de la violence d’ouverture \n- Freinage à l’ouverture réglable et débrayable.",
    "ref": "DOR001",
    "pu": 277.38,
}, {
    "desc": "Clavier à 30 codes de 3 à 8 termes.\n- 13 codes commandant le relais n°1 et n°2. \n- 1 code de mise “on/off” d’alarme (relais n°3).1 code de “contrainte” commandant les relais n°1 et n°2.1 code de programmation.\n- Programmation des codes par le clavier.",
    "ref": "481448",
    "title": "DIGICODE",
    "pu": 338.94
}, {
    "desc": "Groupe de sécurité anti-calcaire 3/4.Robinet à sphère.\nClapet démontable\nRaccordement eau froide et chauffe eau : 20/27.Echappement 26/34.7 bars.\nEntonnoir siphon",
    "title": "GROUPE DE SECURITE",
    "ref": "GRS001",
    "pu": 69.13
}, {
    "desc": "Cylindre 787 Z - Chrono code: 098953\n- Cylindre de très haute sécurité / double cylindre anti-effraction\n- Cylindre monobloc à panneton.\n- Livré avec clés et carte de reproduction.\nREPRODUCTION INTERDITE",
    "title": "FICHET 787 Z",
    "ref": "FIC787",
    "pu": 762.42
}, {
    "desc": "Radial NT+\n- Cylindre de haute sécurité européen à clé réversible Radial NT+. \n- Goupilles multidirectionnelles en acier traité et embase acier, bouclier anti-perçage en tungstène et insert en acier traité donnant une grande résistance à l’effraction par perçage.\n- Livré avec 4 clés en 32.5 x 32.5 et en 32.5 x 42.5 mm\n- Carte de propriété et panneton standard décalé et nickelé en standard. \nREPRODUCTION INTERDITE",
    "title": "RADIAL NT",
    "ref": "RADNT+",
    "pu": 304.71
}, {
    "desc": "Trident Vigie Picard\n- Serrure en applique de haute sécurité à tirage et tringles apparentes.\n- Coffre rectangulaire avec 1 demi tour réversible pour devenir poussant et 2 pênes dormants ronds.\n- Evolutive, possibilité de lui adjoindre des verrous intermédiaires et de blocages et gâche répétition à cylindre mort.\n- Livré avec 3 clés et carte de propriété.\nREPRODUCTION INTERDITE",
    "title": "VIGIE PICARD",
    "ref": "PICA01",
    "pu": 876.54
}, {
    "desc": "Super sûreté\n- Coffre en acier plié laqué vieil or.\n- Pênes en acier et fonctionnement du demi-tour à la clé.\n- Cylindre cuirassé diamètre 30 mm et pastille en acier carbonitruré.\n- Livré avec 3 clés à bille ou sans bille et carte de reproduction.",
    "title": "BRICARD BLOC SUPER SURETE",
    "ref": "BRIC01",
    "pu": 607.52
}, {
    "title": "BRICARD CYLINDRE SUPER SURETE",
    "desc": "Jeu de cylindres à bille Supersûreté\n- Jeu de cylindres pour remplacement des serrures Bricard.\n- Diamètre 30 mm avec clé inox.\n- Avec protège pompe extérieur solidaire de la serrure en laiton.\n- Livré avec 3 clés forgés avec bille en bout de clé et carte de propriété.\nREPRODUCTION INTERDITE",
    "pu": 474.3,
    "ref": "BRIC02"
}, {
    "desc": "VMC pavillonnaire pour les logements du T1 AU T7.\n- 4 piquages régulés D80mm pour sanitaires.\n- 1 piquage D125mm pour la cuisine.\n- Silencieux, LW cuisine 30dB(a).\n- Moteur 2 vitesses.\n- Livré avec cordelette de suspension.",
    "title": "VMC 4 SANITAIRES + 1 CUISINES",
    "pu": 269.86,
    "ref": "VMC001"
}, {
    "desc": "Eurosmart\nMitigeur monocommande évier.\n- Monotrou sur plage.\n- Limiteur de débit ajustable.\n- Bec tube pivotant.\n- Mousseur.\n- Flexible de raccordement souple",
    "title": "MITIGEUR EVIER",
    "pu": 296.25,
    "ref": "MIT001"
}]
var getPrecision = function(address) {
    var precision = [];

    address.batiment && precision.push('bat. ' + address.batiment)
    address.etage && precision.push('étage ' + address.etage)
    address.code && precision.push('code ' + address.code)

    if (precision.length) {
        return '(' + precision.join(' - ') + ')';
    }
    return '';
}

module.exports = {
    sms: {
        intervention: {
            rappelNoCalls: function(id) {
                return "OS " + id + "\nAttention ! Le client attend votre appel pour confirmer le rendez-vous. Merci prendre contact avec lui immédiatement.\n Edison Services"

            },
            rappelArtisan: function() {
                return "OS {{e.id}}\n" +
                    "Bonjour M. {{e.sst.representant.nom}},\n" +
                    "nous vous rapellons que vous avez une intervention à effectuer chez {{e.client.civilite}} {{e.client.nom}} ({{e.client.address.cp}})" +
                    "aujourd'hui à {{datePlain}}\n" +
                    "Edison Services\n"

            },
            demande: function(user, config, _moment) {
                _moment = (_moment || moment);
                this.mmt = _moment(this.date.intervention);
                this.format = this.mmt.isSame(_moment(), 'day') ? "[aujourd'hui à ]HH[h]mm" : "[le ]DD[/]MM[ à ]HH[h]mm"
                this.datePlain = this.mmt.format(this.format)
                this.user = user;
                this.user.pseudo = this.user.pseudo ||  "Arnaud";
                this.ligneDirect = user.ligne ? (user.ligne.match(/.{2}|.{1,2}/g).join('.')) :  "09.72.44.16.63";
                this.categorieClean = config.categories[this.categorie].suffix + " " + config.categories[this.categorie].long_name.toLowerCase()
                return "Bonjour M. {{sst.representant.nom}} , nous cherchons a vous joindre pour une intervention {{categorieClean}}" +
                    " à faire {{datePlain}}, situé à {{client.address.cp}}, {{client.address.v}}.\n" +
                    " Pourriez-vous vous rendre disponible ?\n" +
                    "Merci de nous contacter au plus vite au 09.72.42.30.00.\n" +
                    "Merci d'avance pour votre réponse.\n" +
                    "{{user.pseudo}}\n" +
                    "Ligne Directe: {{ligneDirect}}\n" +
                    "Edison Services\n"
            },
            envoi: function(user) {
                var options = {
                    precision: getPrecision(this.client.address),
                    datePlain: moment(this.date.intervention).format("[le] DD[/]MM[ à ]HH[h]mm"),
                    login: user.pseudo || "Arnaud",
                    ligne: (user.ligne ||  "0972423000").match(/.{2}/g).join('.'),
                    remarques: this.remarqueSms ? (' (' + this.remarque + ')') : '',
                    prix: this.prixAnnonce ? this.prixAnnonce + "€ HT. " : "Pas de prix annoncé. ",
                    telClient: this.client.telephone.tel1.match(/.{2}/g).join('.')
                }
                if (this.newOs) {
                    sms = "OS {{inter.id}}\n" +
                        "Cher partenaire, merci d'interveni\n" +
                        "{{options.datePlain}}\n" +
                        "{{inter.client.civilite}} {{inter.client.prenom}} {{inter.client.nom}}\n" +
                        "{{inter.client.address.n}} {{inter.client.address.r}} {{inter.client.address.cp}}, {{inter.client.address.v}} {{options.precision}}\n" +
                        "Pour la raison suivante:\n" +
                        "{{inter.description}}{{options.remarques}}\n" +
                        "Prix: à partir de {{inter.prixAnnonce}}€ H.T\n" +
                        "Veuillez joindre le client au:\n" +
                        "09.701.702.01 (OS {{inter.id}})\n" +
                        "\n" +
                        "{{options.login}}\n" +
                        "{{options.ligne}} \n"
                } else {
                    var sms = "OS {{inter.id}}\n" +
                        "Intervention chez {{inter.client.civilite}} {{inter.client.prenom}} {{inter.client.nom}} au " +
                        "{{inter.client.address.n}} {{inter.client.address.r}} {{inter.client.address.cp}}, {{inter.client.address.v}} {{options.precision}}\n" +
                        "{{options.datePlain}}.\n" +
                        "Pour la raison suivante: {{inter.description}}{{options.remarques}}.\n" +
                        "{{options.prix}}\n" +
                        "Merci de prendre rdv avec le client au {{options.telClient}}" +
                        "\n" +
                        "Ligne directe: {{options.login}}\n" +
                        "{{options.ligne}} \n" +
                        "Edison Services."
                }
                return _.template(sms)({
                    inter: this,
                    options: options
                })
            },
            annulation: "L'intervention {{id}} chez {{client.civilite}} {{client.nom}} à {{client.address.v}} le {{datePlain}} a été annulé. \nMerci de ne pas intervenir. \nEdison Services",
        }
    },

    lettre: {
        intervention: {
            relance4: function() { /* LETTRE */
                return "<p style='margin-top: 0px;'> Affaire de recouvrement suivie par: Mr DELVAUX<br>" +
                    "Réf dossier: {{os}}<br>" +
                    "Pièce - jointe: Injonction de payer au tribunal de commerce de Paris<br>" +
                    "En copie: Monsieur le Greffier du tribunal de commerce de Paris </p>" +

                    "<div class='spacer'></div>" +
                    "<strong> LETTRE RECOMMANDEE AVEC AR </strong>" +
                    "<div class='spacer'></div>" +
                    "<strong> OBJET: Mise en demeure - Dossier d'injonction du tribunal de commerce de Paris </strong>" +
                    "<div class='spacer'></div>" +

                    "<p>A l'attention de <strong> {{facture.nom}} {{facture.prenom}} </strong>, </p>" +
                    "<p>Nous constatons avec regret qu'en dépit des trois derniers courriers de relances, vous n'avez toujours pas procédé au solde de votre facture n° {{os}}. <p>" +
                    "<p>!En conséquence, nous vous informons que nous engageons une action judiciaire à votre encontre.</p>" +
                    "<p>Ainsi, nous vous mettons en demeure par le présente lettre recommandée de nous régler la somme de {{prixFinalTTC}} euros dans un délais de huit jours à compté de la réception de ce recommandé.</p>" +
                    "<p> Nous vous rappelons que le présent courrier fait courir les intérêts légaux et conventionnels. </p>" +
                    "<p> A défaut de réception dans les délais, votre dossier sera automatiquement transmis à notre service juridique.</p>" +
                    "<p> Cordialement, </p>" +
                    "<p style='text-align:right'>" +
                    "<b> <u> Service recouvrement </u> </b><br>" +
                    "Tél: 09.72.50.20.22" +
                    "</p>"
            },
            relance3: function() { /* LETTRE */
                return "<p> Affaire de recouvrement suivie par: Mr BARRIERE <br> Ligne direct: 09.72.50.20.22 <br> Réf dossier: {{os}} </p>" +
                    "<strong> LETTRE RECOMMANDEE AVEC AR </strong>" +
                    "<div class='spacer'></div>" +
                    "<strong> OBJET: Troisième relance pour facture impayée avant mise en demeure </strong>" +
                    "<p> A l'attention de <b> {{facture.nom}} {{facture.prenom}} </b>, <br>" +

                    "<p> Nous constatons que malgré nos précédentes lettres de rappel, vous n'avez toujours pas procédé au règlement de la facture <b> n° {{os}} </b>. <br> Votre compte reste débiteur à ce jour des sommes suivantes: <p>" +
                    "<table style='border-collapse: collapse;' cellspacing='0' cellpadding='8'>" +
                    "    <tr style='background: rgb(106, 168, 79); !important;'>" +
                    "        <th style='border: 1px solid black;font-size:13px;width: 70px;'> Date </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Numéro </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> Montant </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Lieu de l'intervention </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{datePlain}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{os}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{client.address.cp}} {{client.address.v}} </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;' colspan='2'> <b> TOTAL T.T.C</b> </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'></th>" +
                    "    </tr>" +
                    "</table>" +


                    "<p> Nous considérons aujourd'hui que vous faites opposition au règlement de la somme due. </p>" +
                    "<p> A défaut de réception de la totalité des <strong>{{prixFinalTTC}} €</strong>, sous huitaine, votre dossier sera transmis à notre service contentieux. </p>" +
                    "<p> Celui-ci entamera les démarches judiciaires pour en obtenir le règlement majoré des frais de recouvrement et de ceux relatifs à l'article 700 du NCPC. </p>" +


                    "<p>A l'organisme qui gère notre recouvrement:</p>" +
                    "<p strong center> EDISON SERVICES FRANCE<br>" +
                    "Service recouvrement<br>" +
                    "75 rue des dames, 75017 Paris<br>" +
                    "Tél. 09.72.50.20.22 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</p>" +

                    "<p> Nous vous prions d'agréer, Madame, Monsieur, nos salutations distinguées. </p>" +
                    "<p>Cordialement.</p>" +
                    "<p style='text-align:right'>" +
                    "<b> <u> Service recouvrement </u> </b><br>" +
                    "Tél: 09.72.50.20.22 </p>"
            },
            relance2: function() { /* LETTRE */
                return "<p> Réf: {{os}} <br> Pièce jointe: Facture n°{{os}} </p>" +
                    "<div class='spacer'></div>" +
                    "<strong> OBJET: Deuxième relance pour facture impayée </strong>" +
                    "<p>Madame, Monsieur, </p>" +

                    "<p> Sauf erreur ou omission de notre part, nous constatons que votre compte client présente à ce jour un solde débiteur. <br> Ce montant correspond à nos factures suivantes restées impayées: <p>" +

                    "<table style='border-collapse: collapse;' cellspacing='0' cellpadding='8'>" +
                    "    <tr style='background: rgb(106, 168, 79); !important;'>" +
                    "        <th style='border: 1px solid black;font-size:13px;width: 70px;'> Date </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Numéro </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> Montant </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Lieu de l'intervention </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{datePlain}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{os}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{client.address.cp}} {{client.address.v}} </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;' colspan='2'> <b> TOTAL T.T.C</b> </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'></th>" +
                    "    </tr>" +
                    "</table>" +


                    "<p> L'échéance étant dépassée, nous vous demandons de bien vouloir régulariser cette situation par retour de courrier. </p>" +

                    "<p>A l'organisme qui gère notre comptabilité:</p>" +
                    "<p strong center> EDISON SERVICES FRANCE<br>" +
                    "Service comptabilité<br>" +
                    "75 rue des dames, 75017 Paris<br>" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</p>" +
                    "<p>" +
                    "Pour un règlement par virement :<br>" +
                    "RIB: 30004 01557 00010041423 30<br>" +
                    "IBAN: FR76 3000 4015 5700 0100 4142 330<br>" +
                    "BIC: BNPAFRPPPRG" +
                    "</p>" +
                    "<p> Merci d'indiquer la référence de la facture ({{os}}) dans le règlement. </p>" +
                    "<p> Nous vous prions d'agréer, Madame, Monsieur, nos salutations distinguées. </p>" +
                    "<p>Cordialement.</p>" +
                    "<p style='text-align:right'>" +
                    "<b> <u> Service comptabilité </u> </b><br>" +
                    "Tél: 09.72.51.08.01" +
                    "</p>"
            },
            relance1: function() { /* LETTRE */
                return "<strong> OBJET: Première relance pour facture n°{{os}} impayée </strong>" +
                    "<p>Madame, Monsieur, <br>" +
                    "Suite a l'intervention que nous avons réalisée en date du {{datePlain}}, <p>" +
                    "<p>A ce jour, nous <b> <u> sommes toujours dans l'attente d'un règlement de cette facture </u> </b>. <br>" +
                    "Nous vous prions de bien vouloir transmettre le règlement par chèque à l'ordre de:</p>" +
                    "<p strong center> EDISON SERVICES FRANCE</p>" +
                    "<p>A l'organisme qui gère notre comptabilité:</p>" +
                    "<p strong center> EDISON SERVICES<br>" +
                    "Service comptabilité<br>" +
                    "75 rue des dames, 75017 Paris<br>" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</p>" +
                    "<p>" +
                    "<p>Pour un règlement par virement :</p>" +
                    "RIB: 30004 01557 00010041423 30<br>" +
                    "IBAN: FR76 3000 4015 5700 0100 4142 330<br>" +
                    "BIC: BNPAFRPPPRG" +
                    "</p>" +
                    "<p>Merci d'indiquer la réference de la facture (<strong>{{id}}</strong>) dans le réglement. </p>" +
                    "<ul>" +
                    "<li>Ci-joint la facture</li>" +
                    "</ul>" +
                    "<p style='text-align:right'>" +
                    "<b> <u> Service comptabilité </u> </b><br>" +
                    "Tél: 09.72.51.08.01" +
                    "</p>"
            },
            envoiFacture: function() { /* LETTRE */
                return "<p>Madame, Monsieur,</p>" +
                    "<p>Suite à notre intervention le {{datePlain}} dans vos locaux:\n" +
                    "<p strong center>{{client.civilite}} {{client.nom}} {{client.prenom}}\n" +
                    "{{client.address.n}} {{client.address.r}}, {{client.address.cp}} {{client.address.v}}\n" +
                    "Tél. : {{client.telephone.tel1}}</p>" +
                    "Pour les raisons suivantes: </p>" +
                    "<p strong center>{{description}}</p>" +
                    "<p>Nous vous confirmons que l'intervention à été réalisée par nos soins.\n" +
                    "Vous trouverez ci joint la facture à regler.\n" +
                    "Nous vous prions de bien vouloir transmettre le règlement par chèque à l'ordre de:</p>" +
                    "<p strong center> S.A.R.L EDISON SERVICES</p>" +
                    "<p>A l'organisme qui gère notre comptabilité:</p>" +
                    "<p strong center> EDISON SERVICES FRANCE\n" +
                    "Service comptabilité\n" +
                    "75 rue des dames, 75017 Paris\n" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</p>" +
                    "<p>" +
                    "Pour un règlement par virement :</p>" +
                    "<p>RIB: 30004 01557 00010041423 30\n" +
                    "IBAN: FR76 3000 4015 5700 0100 4142 330\n" +
                    "BIC: BNPAFRPPPRG" +
                    "</p>" +
                    "<p>" +
                    "Par ailleurs, si quelque raison s'opposait au règlement de la facture, nous vous remercions de nous le \nfaire savoir dans les plus brefs délais.</p>" +
                    "<p>Restant à votre entière disposition, nous vous prions de croire, Madame, Monsieur l'expression de nos sincères salutations distinguées.</p>" +
                    "<p>Merci d'indiquer la réference de la facture (<strong>{{id}}</strong>) dans le réglement. </p>" +
                    "<ul>" +
                    "<li>Ci-joint la facture</li>" +
                    "</ul>" +
                    "<p>Cordialement.</p>"
            }
        },
        artisan: {
            rappelDocuments: function() {
                return "<strong> OBJET: En attente de vos documents administratifs </strong>" +
                    "<p> Monsieur, </p>" +
                    "<p> Depuis plusieurs mois <b><u>vous intervenez régulièrement</u></b> auprès de nos clients." +
                    "<p> A chaque attestation de paiement reçu, nous vous avons transmis un <b><u>contrat de déclaration de sous-traitance</u></b> à remplir et à nous faire parvenir accompagné des documents administratifs obligatoires. </p>" +
                    "<p> Cependant, à ce jour nous sommes toujours dans l'attente de ces documents obligatoires. </p>" +
                    "<p> En effet, depuis la loi de fincance de 1er janvier 2014 concernant la sous-traitance dans le secteur du bâtiment, nous avons l'obligation de déclarer l'ensemble de nos sous-traitants intervenants chez nos clients. </p>" +
                    "<p> Merci de nous transmettre vos documents administratifs suivants: </p>" +
                    "<p>" +
                    (!this.document.kbis.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; KBIS ou immatriculation <br>" : '') +
                    (!this.document.contrat.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; Contrat de partenariat reçu par mail <br>" : '') +
                    (!this.document.cni.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; Photocopie Recto/Verso de la pièce d'identité du gérant <br>" : '') +
                    (!this.document.assurance.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; Attestation d'assurance <br>" : '') +
                    (!this.document.rib.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; RIB <br>" : '') +
                    (!this.document.ursaff.ok ? "&emsp;&emsp; ☐ &emsp;&emsp; Attestation URSAFF" : '') +
                    "</p>" +
                    "<p> Veuillez envoyer vos documents à cette adresse: </p>" +
                    "<p strong center> EDISON SERVICES FRANCE<br>" +
                    "Service partenariat - Yohann Rhoum <br>" +
                    "75 rue des dames, 75017 Paris<br>" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</p>" +

                    "<p> Nous vous prions d'agréer, monsieur, nos salutations distinguées. </p>" +
                    "<header style='margin-top: 85px;'>" +
                    "<b> Monsieur QUEUDRAY </b>" +
                    "<b> Responsable Comptable</b>" +
                    "</header>"
            },
            envoiFacturier: function() {
                return "<style> .logo { width: 7cm; margin-top: 50px; } header { margin-top: -90px; } header p { margin-bottom: 5px!important} p { line-height: 19px; margin-bottom: 20px;}</style>" +

                    "<p style='font-size: 10px; position: absolute; width: 6cm; text-align: center; top: 95px; left: 13.3cm;'>{{nomSociete}} - {{id}}</p>" +
                    "<p> Cher Monsieur {{representant.nom}} </p>" +

                    "<p> Bienvenue au sein du réseau partenaire EDISON SERVICES. </p>" +
                    "<p> Nous mettons à votre disposition un facturier et un deviseur qui vous permettra d'intervenir chez nos clients. </p>" +
                    "<p> Vous trouverez également ci-joint un manuel d'utilisation qui vous aideras à compléter les factures, devis, et attestation de T.V.A simplifié. </p>" +
                    "<p> Merci de prendre le temps de lire cette brochure attentivement. </p>" +
                    "<p> Ces documents resterons à votre disposition durant la durée de notre partenariat, mais restent la propriété intellectuelle de la société EDISON SERVICES et devront nous être renvoyé en cas de fin de partenariat. </p>" +
                    "<p> Vous en souhaitant bonne réception. </p>" +
                    "<p> <i>Bienvenue dans l'équipe EDISON SERVICES.</i> </p>" +

                    "<header style='margin-top: 35px; width: 40%; margin-left: 11cm;'>" +
                    "<b> Service Partenariat </b> <br>" +
                    "<p style='font-size: 13px; line-height: 20px;'> Monsieur RHOUM </p>" +
                    "<img style='width: 4.5cm;' src='data:image/png;base64,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'/>" +
                    "</header>"



            }
        }
    },
    mail: {
        intervention: {
            paiement: "Monsieur, <br>" +
                "Suite à votre intervention auprès de notre client, vous trouverez ci-joint l'autofacturation correspondant.<br>" +
                "Celle-ci s'accompagne automatiquement d'un virement sur votre compte bancaire.<br>" +
                "Si votre paiement n'apparaît pas sur votre compte dans les 4 jours ouvrés, merci de contacter notre service comptabilité.<br>" +
                "En cas d'erreur sur l'auto-facture, répondez à ce mail en expliquant les raisons de votre désaccord, la modification sera immédiatement effectuée par nos services.<br>" +
                "<br><i>Attention<br> depuis le 1er Janvier 2014, compte tenu de la Loi de Finances 2014, les sous-traitants n'auront ni à déclarer ni à payer la TVA due au titre de ces opérations.<br>" +
                "C'est le donneur d'ordre (SARL Edison Services) assujetti qui devra declarer la TVA sur ses déclarations de chiffre d'affaires.</i>" +
                "<br><br>Service Comptabilité Fournisseur<br>" +
                "09.72.45.27.09",
            relance3: function() { /* MAIL */
                return "<style> table { border-collapse: collapse;}\n table, td, th {border: 1px solid black;font-size:13px;}</style>" +
                    "<p> A l'attention de <b> {{facture.nom}} {{facture.prenom}} </b>, </p>" +

                    "<p> Nous constatons que malgré nos précédentes lettres de rappel, vous n'avez toujours pas procédé au règlement de la facture <b> n° {{os}} </b>. <br> Votre compte reste débiteur à ce jour des sommes suivantes: <p>" +

                    "<table style='border-collapse: collapse;' cellspacing='0' cellpadding='8'>" +
                    "    <tr style='background: rgb(106, 168, 79); !important;'>" +
                    "        <th style='border: 1px solid black;font-size:13px;width: 70px;'> Date </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Numéro </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> Montant </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Lieu de l'intervention </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{datePlain}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{os}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{client.address.cp}} {{client.address.v}} </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;' colspan='2'> <b> TOTAL T.T.C</b> </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'></th>" +
                    "    </tr>" +
                    "</table>" +

                    "<p> Nous considérons aujourd'hui que vous faites opposition au règlement de la somme due. </p>" +
                    "<p> A défaut de réception de la totalité des <strong>{{prixFinalTTC}} €</strong>, sous huitaine, votre dossier sera transmis à notre service contentieux. </p>" +
                    "<p> Celui-ci entamera les démarches judiciaires pour en obtenir le règlement majoré des frais de recouvrement et de ceux relatifs à l'article 700 du NCPC. </p>" +

                    "<p>A l'organisme qui gère notre recouvrement:</p>" +
                    "<p><strong>" +
                    "   EDISON SERVICES FRANCE<br>" +
                    "   Service recouvrement<br>" +
                    "   75 rue des dames, 75017 Paris<br>" +
                    "   Tél. 09.72.50.20.22 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)" +
                    "</strong></p>" +
                    "<p>Cordialement.</p>"
            },
            relance2: function() { /* MAIL */
                return "<style> table { border-collapse: collapse;}\n table, td, th {border: 1px solid black;font-size:13px;}</style>" +
                    "<p>Madame, Monsieur, <br>" +
                    "<p> Sauf erreur ou omission de notre part, nous constatons que votre compte client présente à ce jour un solde débiteur. <br> Ce montant correspond à nos factures suivantes restées impayées: <p>" +
                    "<table style='border-collapse: collapse;' cellspacing='0' cellpadding='8'>" +
                    "    <tr style='background: rgb(106, 168, 79); !important;'>" +
                    "        <th style='border: 1px solid black;font-size:13px;width: 70px;'> Date </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Numéro </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> Montant </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:left'> Lieu de l'intervention </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{datePlain}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{os}} </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> {{client.address.cp}} {{client.address.v}} </th>" +
                    "    </tr>" +
                    "    <tr>" +
                    "        <th style='border: 1px solid black;font-size:13px;' colspan='2'> <b> TOTAL T.T.C</b> </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;text-align:right'> {{prixFinalTTC}} € </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'></th>" +
                    "    </tr>" +
                    "</table>" +

                    "<p> L'échéance étant dépassée, nous vous demandons de bien vouloir régulariser cette situation par retour de courrier. </p>" +
                    "<p>A l'organisme qui gère notre comptabilité:</p>" +
                    "<p><strong>" +
                    "   EDISON SERVICES FRANCE<br>" +
                    "   Service comptabilité<br>" +
                    "   75 rue des dames, 75017 Paris<br>" +
                    "   Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)" +
                    "</strong></p>" +
                    "<p>" +
                    "<p>Pour un règlement par virement :</p>" +
                    "RIB: 30004 01557 00010041423 30<br>" +
                    "IBAN: FR76 3000 4015 5700 0100 4142 330<br>" +
                    "BIC: BNPAFRPPPRG" +
                    "</p>" +
                    "<p> Merci d'indiquer la référence de la facture ({{os}}) dans le règlement. </p>" +
                    "<p>Cordialement.</p>"
            },
            relance1: function() { /* MAIL */
                return "<p>Madame, Monsieur,<br>" +
                    "Suite à l'intervention que nous avons réalisé en date du {{datePlain}}</p>" +
                    "<p>A ce jour, <u><b>nous sommes toujours dans l'attente du règlement de cette facture</b></u><br>" +
                    "Nous vous prions de bien vouloir transmettre le règlement par chèque à l'ordre de:</p>" +
                    "<p><strong> EDISON SERVICES FRANCE</strong></p>" +
                    "<p>A l'organisme qui gère notre comptabilité:</p>" +
                    "<p><strong> EDISON SERVICES<br>" +
                    "Service comptabilité<br>" +
                    "75 rue des dames, 75017 Paris<br>" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)</strong></p>" +
                    "<p>" +
                    "<p>Pour un règlement par virement :</p>" +
                    "<br>" +
                    "RIB: 30004 01557 00010041423 30<br>" +
                    "IBAN: FR76 3000 4015 5700 0100 4142 330<br>" +
                    "BIC: BNPAFRPPPRG" +
                    "</p>" +
                    "<p>Merci d'indiquer la réference de la facture (<strong>{{os}}</strong>) dans le réglement. </p>" +
                    "<ul>" +
                    "<li>Ci-joint la facture</li>" +
                    "</ul>" +
                    "<p>Cordialement.</p>"
            },
            factureAcquitte: function() {
                return "Bonjour,\n" +
                    "Vous trouverez ci-joint la facture acquitté de l'intervention n°{{id}}\n" +
                    "Cordialement\n" +
                    "\n" +
                    "Service Comptabilité - Edison Services\n" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)\n" +
                    "Fax. 09.72.39.33.46\n";
            },
            envoiFacture: function(datePlain) {

                return "Bonjour\n" +
                    "Suite à votre demande d'intervention le " + datePlain + " chez:\n" +
                    "<strong>\n" +
                    "{{client.nom}} {{client.prenom}}\n" +
                    "{{client.address.n}} {{client.address.r}}\n" +
                    "{{client.address.cp}} {{client.address.v}}\n" +
                    "</strong>" +
                    "\n" +
                    "Veuillez trouvez ci-joint notre facture d'intervention\n" +
                    "Merci de transmettre le règlement directement à notre organisme de facturation.\n" +
                    "\n" +
                    "D'avance merci pour votre rapidité\n" +
                    "Cordialement,\n" +
                    "\n" +
                    "Service Comptabilité - Edison Services\n" +
                    "Tél. 09.72.51.08.01 (Ouvert de 09h00 à 12h30 / 14h00 à 16h30)\n" +
                    "Fax. 09.72.39.33.46\n";
            },
            os: function(user) {
                return "A l'attention de l’entreprise {{sst.nomSociete}}\n" +
                    "\n" +
                    "Monsieur <strong>{{sst.representant.nom}}</strong>,\n" +
                    "Suite à notre conversation téléphonique,\n" +
                    "Nous vous prions de bien vouloir intervenir pour une intervention de {{categoriePlain}} auprès de notre client :\n" +
                    "\n" +
                    "<strong>" +
                    "OS n°{{id}}\n" +
                    "{{client.nom}} {{client.prenom}}\n" +
                    "Tél. {{newOs ? '09.701.702.01' : client.telephone.tel1}}\n" +
                    "{{client.address.n}} {{client.address.r}}\n" +
                    "{{client.address.cp}} {{client.address.v}}\n" +
                    "</strong>" +
                    '\n' +
                    "L' intervention a été prévu pour le : <strong>{{datePlain}}</strong> \n" +
                    '\n' +
                    "Vous devez dès réception de cet ordre de service, prendre contact <strong><u>immédiatement</u></strong> avec le client afin de confirmer la date et l'horaire de l’intervention.\n" +
                    "\n" +
                    "Les coordonnées et la description de l'intervention sont détaillées dans l'ordre de service que vous trouverez en pièce jointe. \n" +
                    "<center>" +
                    "<% if (typeof devisOrigine !== 'undefined' && !fileSupp) {%> \n<strong>Vous trouverez également le devis accepté et signé par notre client</strong> <%}%>" +
                    "<% if (typeof devisOrigine === 'undefined' && fileSupp) {%> \n<strong>Vous trouverez également {{textfileSupp}} à votre disposition</strong> <%}%>" +
                    "<% if (typeof devisOrigine !== 'undefined' && fileSupp) {%> \n<strong>Vous trouverez également le devis accepté et signé par notre client, et {{textfileSupp}}</strong> <%}%>" +
                    "</center>" +
                    "\n" +
                    "<strong>" +
                    "Vous trouverez ci-joint :\n" +
                    "</strong>" +
                    " • Ordre de service d’intervention n°{{id}}\n" +
                    " • Un devis et une facture vierge à remplir obligatoirement sur place\n" +
                    " • Manuel à suivre pour la réalisation des devis et factures\n" +
                    " • Une description étape par étape de notre mode de fonctionnement\n" +
                    "<strong>" +
                    "<% if (typeof devisOrigine !== 'undefined') {%> • Le devis n°{{devisOrigine}} accepté\n <%}%>" +
                    "<% if (fileSupp) {%> • {{textfileSupp}} <%}%>\n" +
                    "</strong>" +
                    "\n" +
                    "<strong>Pour tous renseignements supplémentaires, vous pouvez joindre " + (user.pseudo ||  "Arnaud") +
                    " au " +
                    (user.ligne ? (user.ligne.match(/.{2}|.{1,2}/g).join('.')) :  "09.72.42.30.00") + "</strong>\n" +
                    "\n" +
                    "L’équipe <strong>Edison Services</strong>\n"
            },
            attenteReglement: function() {
                return "A l'attention de l'entreprise {{inter.sst.nomSociete}},<br>" +
                    "<br>" +
                    "Monsieur {{inter.sst.representant.nom}},<br>" +
                    "En date du {{options.datePlain}}, vous avez réalisé une intervention (<strong>Réf : {{inter.id}}</strong>) auprès de notre client :<br>" +
                    "<br>" +
                    "<strong>" +
                    "{{inter.client.nom}} {{inter.client.prenom}}<br>" +
                    "{{inter.client.address.n}} {{inter.client.address.r}}<br>" +
                    "{{inter.client.address.cp}} {{inter.client.address.v}}<br>" +
                    "</strong>" +
                    "<br>" +
                    "Pour les raisons suivantes :<br>" +
                    "<strong>{{inter.description}}</strong><br>" +
                    "<br>" +
                    "Nous vous prions de bien vouloir nous transmettre au plus vite les éléments suivant :<br>" +
                    "- La facture d'intervention n°{{inter.id}} ou l'ordre de service correspondant<br>" +
                    "- Le règlement de notre client<br>" +
                    "<br>" +
                    "Veuillez transmettre l'ensemble de ces documents par voie postale à :<br>" +
                    "<br>" +
                    "<strong><center>" +
                    "EDISON SERVICES<br>" +
                    "Comptabilité Fournisseur<br>" +
                    "75 rue des Dames, 75017 PARIS<br>" +
                    "</center></strong>" +
                    "<br>" +
                    "Dans le cas où l'intervention n'aurait pas été réalisée par vos soins, merci de prendre contact au plus vite avec le service comptabilité<br>" +
                    "<br>" +
                    "<strong>Tél. 09.72.45.27.09</strong> (ouvert de 09h00 à 12h30 / 14h00 à 16h30)<br>" +
                    "<br>" +
                    "Remarques :<br>" +
                    "- Si vous êtes détenteur du matériel installé, veuillez nous transmettre le montant H.T du coût de votre matériel (avec remise) pour nous permettre d'effectuer votre remboursement.<br>" +
                    "- Si vous avez pris du matériel auprès de l'un de nos fournisseurs, veuillez nous transmettre le bon de retrait correspondant.<br>" +
                    "<br>" +
                    "Dès réception de ces documents par nos services, votre règlement vous sera transmis sous <strong>7 jours.</strong><br>" +
                    "<br>" +
                    "Cordialement,<br>" +
                    "<br>" +
                    "<p style='text-align:right'><strong><u>Service comptabilité fournisseur</u></strong><br>" +
                    "Vincent QUEUDRAY<br>" +
                    "Tél.09.72.45.27.09</p>"
            },
            relanceArtisan: function() {
                return "A l'attention de l'entreprise <strong>{{sst.nomSociete}}</strong>,<br>" +
                    "<br>" +
                    "Monsieur <strong>{{sst.representant.nom}}</strong>,<br>" +
                    "Au cours de cette semaine vous avez réalisez plusieurs interventions auprès de nos clients.<br>" +
                    "Vous trouvez ci-dessous la liste des interventions actuellement en attente à notre service comptabilité :<br>" +

                    "<table style='border-collapse: collapse;' cellspacing='0' cellpadding='8'>" +
                    "    <tr style='background: rgb(106, 168, 79); !important;'>" +
                    "        <th style='border: 1px solid black;font-size:13px;width: 70px;'> Date </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> Numéro OS </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> Client </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> Lieu de l'intervention </th>" +
                    "        <th style='border: 1px solid black;font-size:13px;'> Montant H.T </th>" +
                    "    </tr>" +
                    "<% _.forEach(inters, function(e) { %>" +
                    "           <tr>" +
                    "               <td style='border: 1px solid black;font-size:13px;'> {{moment(e.date.intervention).format('L')}} </td>" +
                    "               <td style='border: 1px solid black;font-size:13px;'> {{e.id}}</td>" +
                    "               <td style='border: 1px solid black;font-size:13px;'> {{e.client.civilite}} {{e.client.nom}}</td>" +
                    "               <td style='border: 1px solid black;font-size:13px;'> {{e.client.address.n}} {{e.client.address.r}}, {{e.client.address.cp}} - {{e.client.address.v}}</td>" +
                    "               <td style='border: 1px solid black;font-size:13px;'> {{e.prixFinal}} €</td>" +
                    "           </tr>" +
                    "<% }); %>" +
                    "</table>" +

                    "Nous vous prions de bien vouloir nous transmettre au plus vite les éléments suivant :<br>" +
                    "- La facture d'intervention ou l'ordre de service correspondant<br>" +
                    "- Le règlement de notre client<br>" +
                    "<br>" +
                    "Veuillez transmettre l'ensemble de ces documents par voie postale à :<br>" +
                    "<br>" +
                    "<center><strong>" +
                    "EDISON SERVICES<br>" +
                    "Comptabilité Fournisseur<br>" +
                    "75 rue des Dames, 75017 PARIS<br>" +
                    "</center></strong>" +
                    "<br>" +
                    "Dans le cas où l'intervention n'aurait pas été réalisée par vos soins, merci de prendre contact au plus vite avec le service comptabilité<br>" +
                    "<br>" +
                    "<strong>Tél. 09.72.45.27.09 </strong>(ouvert de 09h00 à 12h30 / 14h00 à 16h30)<br>" +
                    "<br>" +
                    "Remarques :<br>" +
                    "- Si vous êtes détenteur du matériel installé, veuillez nous transmettre le montant H.T du coût de votre matériel (avec remise) pour nous permettre d'effectuer votre remboursement.<br>" +
                    "- Si vous avez pris du matériel auprès de l'un de nos fournisseurs, veuillez nous transmettre le bon de retrait correspondant.<br>" +
                    "<br>" +
                    "Dès réception de ces documents par nos services, votre règlement vous sera transmis sous <strong>7 jours.</strong><br>" +
                    "<br>" +
                    "Cordialement,<br>" +
                    "<p style='text-align:right'>" +
                    "<u><strong>Service comptabilité fournisseur</strong></u><br>" +
                    "Vincent QUEUDRAY<br>" +
                    "Tél.09.72.45.27.09<br></p>"
            }
        },
        devis: {
            envoi: function(user, _config, __, _moment) {
                var lodash = __ || _
                var mmt = _moment || moment
                var config = _config ||  require('./dataList.js')
                var categorieClean = config.categories[this.categorie].suffix + " " + config.categories[this.categorie].long_name.toLowerCase()
                var pseudo = user.pseudo
                var intro;
                if (this.client.civilite === "Soc.") {
                    intro = lodash.template("À l'intention du responsable de la société {{client.nom}},\n\n")(this);
                } else {
                    intro = lodash.template("{{client.civilite}} {{client.nom}},\n\n")(this);
                }
                var start = "Suite à notre conversation téléphonique de tout à l'heure, ";
                var end = "Avez-vous reçu le devis ?\n\n" +
                    "Je n'ai pas eu de retour de votre part, devons nous planifier une intervention ?\n\n" +
                    "Merci de revenir vers moi pour me tenir au courant de la suite que vous donnerez à ce devis.\n\n" +
                    "Je reste à votre disposition pour toutes les demandes de renseignement\n\n";
                if (this.combo && this.comboText) {
                    var text = "Suite à notre dernier échange téléphonique concernant la réalisation d'un " + this.comboText + ".\n" +
                        "\n" +
                        "Vous trouverez ci-joint <strong>le devis n°" + this.id + " </strong>qui correspond à ce que nous avons vu ensemble.\n" +
                        "\n" +
                        "Je vous rappel que les délais d'interventions dépendent également de votre rapidement de réponse.\n" +
                        "Sachez également que votre installation sera éligible à notre assurance RC PRO et notre assurance décennale.\n" +
                        "Lors de l'acceptation, je vous prie de me renvoyer signé, accompagné de la mention : \n" +
                        "\n" +
                        "<strong> « BON POUR ACCORD » </strong>\n" +
                        "\n" +
                        "Je reste à votre entière disposition pour tous les renseignements ou les remarques que vous pourriez avoir concernant ce devis (technique, délais, prix).\n"

                } else if (this.historique && this.historique.length === 1) {
                    var cont;
                    if (this.categorie == 'VT')
                        cont = "je vous ai envoyé le devis que vous m'avez demandé pour le remplacement de votre vitrage, vous deviez le transmettre directement à votre compagnie d'assurance.\n\n";
                    else if (this.categorie == 'AS')
                        cont = "je vous ai transmis comme convenue le devis de remplacement de votre ballon d'eau chaude sanitaire.\n\n";
                    else
                        cont = "je vous ai transmis comme convenue le devis " + categorieClean + " que vous avez souhaité.\n\n";
                    var text = start + cont + end;

                } else if (this.historique && this.historique.length > 1) {
                    var text = "je vous ai transmis un devis " + categorieClean + " en date du " + mmt(this.historique[0].date).format('L') + ".\n\n" + end;
                } else if (this.categorie == 'VT') {
                    var text = "Suite à notre échange téléphonique concernant le remplacement de votre vitrage," +
                        "vous trouverez ci-joint le devis n°" + this.id + " correspondant à ce que nous avons vu ensemble.\n\n" +
                        "Merci de bien vouloir transmettre ce devis de remplacement de vitrage directement à votre compagnie d’assurance, afin d'obtenir leurs accords (si nécessaire).\n" +
                        "Merci de nous renvoyer le devis signé accompagné de la mention « BON POUR ACCORD » par mail.\n\n" +
                        "Nous interviendrons dans les plus brefs délais.\n\n" +
                        "Je reste à votre entière disposition pour toutes les demandes de renseignement et les remarques que vous pourriez avoir.\n\n";
                } else if (lodash.find(this.produits, function(e) {
                        return lodash.startsWith(e.ref, "BAL");
                    })) {
                    var text = "Suite à notre échange téléphonique concernant le remplacement de votre ballon d'eau chaude sanitaire," +
                        "vous trouverez ci-joint le devis n°" + this.id + ".\n\n" +
                        "Je reste à votre entière disposition pour tous renseignements complémentaires ou remarques que vous pourriez avoir (technique/prix).\n\n" +
                        "Sachez également, que votre installation sera éligible à notre assurance RC PRO et notre assurance décennale.\n" +
                        "Dès votre accord, nous interviendrons rapidement.\n\n" +
                        "Meilleures salutations,\n\n";
                } else {
                    var text = "Suite à notre dernier échange concernant la réalisation d'un devis " + categorieClean + ", \n" +
                        "vous trouverez ci-joint le devis n°" + this.id + " correspondant à ce que nous avons vu ensemble. \n\n" +
                        "Sachez également, que votre installation sera éligible à notre assurance RC PRO et notre assurance décennale.\n\n" +
                        "Lors de l'acceptation, je vous prie de me renvoyer le devis signé, accompagné de la mention:\n\n" +
                        "<strong> « BON POUR ACCORD » </strong>\n\n" +
                        "Je reste à votre entière disposition pour tous les renseignements ou les remarques que vous pourriez avoir concernant ce devis (technique, délais, prix). \n\n" +
                        "Merci de me tenir au courant de la suite que vous donnerez à ce devis. \n\n";

                }
                var outro = "Cordialement, \n\n" +
                    (user.pseudo ||  "Arnaud,") + '\n' +
                    "<strong>Ligne Directe : " + (user.ligne ? (user.ligne.match(/.{2}|.{1,2}/g).join('.')) :  "09.72.42.30.00") + "</strong>\n" +
                    "<strong>Ligne Atelier : " + "09.72.42.30.00" + "</strong>\n";

                return intro + text + outro;
            }
        },
        artisan: {
            envoiContrat: function(user) {
                return "Monsieur {{representant.nom}},\n" +
                    "\n" +
                    "Comme expliqué lors de notre conversation téléphonique, nous sommes une entreprise générale du bâtiment situé dans la région d'île de France.\n" +
                    "\n" +
                    "Notre entreprise intervient de manière régulière dans plusieurs villes en France pour des interventions de dépannage spécialisé dans le second œuvre (plomberie sanitaire, génie climatique, serrurerie, vitrerie et l'électricité générale).\n" +
                    "\n" +
                    "Nos clients sont des particuliers, des réseaux d'entreprises, des commerces, des administrateurs de bien et des agences immobilières.\n" +
                    "\n" +
                    "Je suis actuellement à la <u><b>recherche d'un partenaire</b></u> pouvant intervenir auprès de nos clients dans votre région pour des prestations de dépannage.\n" +
                    "Vous trouverez ci-joint une brochure expliquant notre fonctionnement pour une éventuelle collaboration.\n" +
                    "Je vous transmets également un contrat de partenariat permettant d'établir les conditions de travail entre nos deux entreprises.\n" +
                    "\n" +
                    "Pour chaque intervention, vous recevez au préalable un ordre de service par mail et par téléphone,<u><b> l'ordre de service n'est validé que sous votre accord.</b></u>\n" +
                    "\n" +
                    "Une fois chez notre client, vous restez totalement autonome sur le montant à facturer et si nécessaire vous pouvez ajuster le montant de la prestation tout en ayant préalablement prévenu notre client.\n" +
                    "\n" +
                    "Lors des interventions, vous représentez notre entreprise c'est pourquoi vous disposez des documents fournis à tous nos partenaires en France.\n" +
                    "\n" +
                    "<u><b>Vous avez à votre disposition :</u></b>\n" +
                    "\n" +
                    "• Un bloc facturier au nom de Edison Services\n" +
                    "• Un bloc devis au nom de Edison Services\n" +
                    "• Un catalogue de prix de vente du matériel\n" +
                    "• Un accès à tous nos fournisseurs\n" +
                    "\n" +
                    "Si vous souhaitez rejoindre notre réseau, vous trouverez les documents à nous transmettre :\n" +
                    "\n" +
                    "• Le contrat de partenariat signé\n" +
                    "• Immatriculation ou KBIS\n" +
                    "• Pièce d'identité du responsable de l'entreprise\n" +
                    "• Attestation d'assurance (si disponible)\n" +
                    "\n" +
                    "Je tiens à vous rappelez que cette future collaboration ne vous oblige jamais à intervenir pour nous. Il s'agit simplement de rajouter à votre quotidien des interventions en plus.\n" +
                    "\n" +
                    "Cependant, j'attire votre attention sur le fait que nous recherchons des personnes de confiances, maîtrisant parfaitement l'aspect technique du travail à effectuer tout en sachant être à l'aise avec la clientèle.\n" +
                    "\n" +
                    "Je reste à votre entière disposition pour toutes les questions ou les remarques que vous pourriez avoir.\n" +
                    "\n" +
                    "En vous remerciant d'avance pour l'attention que vous porterez à ma demande et aux documents transmis.\n" +
                    "\n" +
                    "Dans l'attente d'un retour de votre part.\n" +
                    "\n" +
                    "PS : Si vous souhaitez faire un test avant de travailler régulièrement avec notre entreprise et dans le but de comprendre le fonctionnement global de notre structure, n'hésitez pas à nous le faire savoir.\n" +
                    "\n" +
                    "Cordialement\n" +
                    "\n" +
                    "<b>Yohann RHOUM</b>\n" +
                    "Service partenariat\n" +
                    "Port : 06.37.37.59.45 Fax : 09.72.39.33.46\n" +
                    "yohann.rhoum@edison-services.fr\n" +
                    "\n" +
                    "<b>Edison Services</b>\n" +
                    "Dépannage - Entretien - Installation - Rénovation\n" +
                    "Siège social : 75, rue des dames - 75017 Paris\n" +
                    "contact@edison-services.fr - www.edison-services.fr"
            },
            rappelContrat: function(user) {
                return "Bonjour Monsieur {{representant.nom}}\n" +
                    "\n" +
                    "Suite à notre conversation téléphonique du {{datePlain}} concernant la signature d'un contrat de partenariat entre nos deux entreprises.\n" +
                    "\n" +
                    "Vous trouverez donc ci-joint la déclaration de sous-traitance à remplir.\n" +
                    "\n" +
                    "Merci de joindre également à cette déclaration les éléments suivants :\n" +
                    "\n" +
                    "• Extrait KBIS ou INSEE\n" +
                    "• Photocopie R/V de la pièce d'identité du gérant\n" +
                    "\n" +
                    "Vous pouvez nous transmettre ces pièces administratives par mail à :\n" +
                    "\n" +
                    "yohann.rhoum@edison-services.fr\n" +
                    "\n" +
                    "\n" +
                    "Ou par voie postal :\n" +
                    "\n" +
                    "<u><b>" +
                    "Edison Services\n" +
                    "Service Partenariat\n" +
                    "75 rue des dames - 75017 PARIS\n" +
                    "</b></u>" +
                    "\n" +
                    "\n" +
                    "Dès réception de ces documents et validation par nos services, vous recevrez par voie postal:\n" +
                    "\n" +
                    "• Un bloc facture Edison Services\n" +
                    "• Un bloc devis Edison Services\n" +
                    "• Un catalogue de prix de vente du matériel\n" +
                    "• Un accès à tous nos fournisseurs\n" +
                    "Je reste à votre entière disposition pour toutes les questions ou les remarques que vous pourriez avoir.\n" +
                    "\n" +
                    "Dans l'attente d'une réponse favorable de votre part,\n" +
                    "\n" +
                    "Cordialement\n" +
                    "\n" +
                    "<b>Yohann RHOUM</b>\n" +
                    "Service Partenariat\n" +
                    "Port : 06.37.37.59.45 Fax : 09.72.39.33.46\n" +
                    "yohann.rhoum@edison-services.fr\n" +
                    "\n" +
                    "<b>Edison Services</b>\n" +
                    "Dépannage - Entretien - Installation - Rénovation\n" +
                    "Siège social : 75 rue des Dames, 75017, Paris\n" +
                    "contact@edison-services.fr - www.edison-services.fr\n"
            },
            dossierComplet: function() {
                return "Monsieur <b>{{representant.nom}}</b>,\n" +
                    "\n" +
                    "Nous avons le plaisir de vous annoncer que vous êtes dès à présent <b>membre du réseau partenaire Edison Services.</b>\n" +
                    "\n" +
                    "Le service partenariat a validé votre dossier.\n" +
                    "\n" +
                    "Vous allez recevoir très prochainement les pièces administratives vous permettant d'intervenir directement auprès de nos clients.\n" +
                    "\n" +
                    "Ces documents seront transmis par voie postale à cette adresse :\n" +
                    "<p strong center>" +
                    "Monsieur {{representant.nom}},\n" +
                    "{{address.n}} {{address.r}}\n" +
                    "{{address.cp}} {{address.v}}</b>\n" +
                    "</p>" +
                    "Nous pouvons désormais vous proposez d'intervenir auprès de nos clients dans les domaines suivants :\n" +
                    "<p strong center>électricité - plomberie - chauffage - climatisation - serrurerie</p>" +
                    "Vous trouverez ci-joint, votre fiche d'identification récapitulative.\n" +
                    "\n" +
                    "Le service intervention de notre société devrait faire appel à vous dans les plus brefs délais.\n" +
                    "Cordialement,\n" +
                    "\n" +
                    "Yohann RHOUM\n" +
                    "Service partenariat\n" +
                    "Port : 06.45.57.87.66 Fax : 09.72.39.33.46\n" +
                    "yohann.rhoum@edison-services.fr\n" +
                    "\n" +
                    "Edison Services\n" +
                    "Dépannage - Entretien - Installation - Rénovation\n" +
                    "Siège social : 75, rue des dames - 75010 Paris\n" +
                    "contact@edison-services.fr - www.edison-services.fr\n"
            }
        },
    }
}
global.requireLocal = function(pth) {
	return require(process.cwd() + '/' + pth)
}

var request = require('request');
process.env.MONGOLAB_URI = "mongodb://heroku_app33756489:hrkm1jfvok3i2hsopg9t99jvvd@ds041981-a0.mongolab.com:41981/heroku_app33756489"

var db = require(process.cwd() + '/server/edison_components/db.js')()
var v1 = require(process.cwd() + '/server/edison_components/V1.js')
var _ = require('lodash');
var moment = require('moment')
var async = require('async')

var mapfn = function(e) {
	e.id = parseInt(e.id)
	e.pu = parseFloat(e.pu)
	e.quantite = parseInt(e.quantite)
	return e;
}

var getTotal = function(prods) {
	var total = 0;
	_.each(prods, function(e) {
		total += (e.pu * e.quantite);
	})
	return _.round(total, 2);
}

v1.get("SELECT l.id_intervention AS id, l.quantite, o.puht AS pu, o.reference AS ref,o.designation AS description  FROM ligne_facture AS l LEFT JOIN objetfacture AS o ON (l.id_objet_facture=o.id) where l.id_intervention>33",
	function(err, resp) {
		//console.log("==>", err, resp && resp.length)
		resp = _.map(resp, mapfn);
		resp = _.groupBy(resp, 'id')
		async.eachLimit(resp, 75, function(e, cb) {
			//console.log(e)
			//console.log("\n\n\n\n\n\n\n")
			var tmp = _.values(e);
			db.model('intervention').findOne({
				id: tmp[0].id
			}).select('-_id prixFinal status compta.paiement.effectue id produits').then(function(resp) {
				
				if (resp && resp.prixFinal === getTotal(resp.produits) && resp.produits[0] && resp.produits[0].ref === 'EDX121') {
					console.log('==>', resp.id)
				}

				/*if (resp &&  !_.get(resp, 'compta.paiement.effectue')) {

					var total = getTotal(resp.produits);
					if (total != resp.prixFinal) {

						console.log(resp.id, resp.status, _.get(resp, 'compta.paiement.effectue'), _.padRight(resp.prixFinal, 10, ' '), total);
					}
				} else {
					console.log('NULL', tmp[0].id)
				}*/
				cb(null);
			})
		}, process.exit.bind(process))
	})
var fs = require('fs');
var _ = require('lodash');

var backup = fs.readFileSync("/Users/abelchalier/Dropbox/BACKUP/2015-10-21/intervention.json", 'utf-8');
var ids = [31864, 27667, 33598, 26258, 26548, 33000, 32937, 31798, 31749, 31592, 30286, 27187, 26743, 23404];
backup = JSON.parse(backup);
_.each(backup, function(e) {
	if (_.includes(ids, e.id)) {
		console.log('==>', e.id, e.produits, e.prixFinal)
		console.log()
		console.log()
		console.log()
		console.log()
		console.log()
		console.log()
	}

'use strict';
var gulp = require('gulp');

// Include Our Plugins
var concat = require('gulp-concat');
var rename = require('gulp-rename');
var notify = require('gulp-notify');
var sourcemaps = require('gulp-sourcemaps');
var minifyCSS = require('gulp-minify-css');

var watchify = require('watchify');
var browserify = require('browserify');
var source = require('vinyl-source-stream');
var buffer = require('vinyl-buffer');
var gutil = require('gulp-util');
var _ = require('lodash')
var glob = require("glob")
var jshint = require('gulp-jshint');
// Concatenate & Minify JS
var jslibs;
var jssrc;
gulp.task('scripts', function() {
    jssrc = ['front/angular/*.js', 'front/angular/*/*.js', 'front/angular/*/*/*.js'];
    return gulp.src(jssrc)
        // .pipe(jshint('.jshintrc'))
        //.pipe(jshint.reporter('jshint-stylish'))
        .pipe(sourcemaps.init())
        .pipe(concat('all.js'))
        .pipe(sourcemaps.write('.'))
        .pipe(gulp.dest('front/assets/dist'));
});

gulp.task('jsLibs', function() {
    jslibs = [

        'bower_components/jquery/dist/jquery.min.js',
        'bower_components/slimScroll/jquery.slimScroll.min.js',
        'bower_components/angular/angular.min.js',
        'bower_components/angular-route/angular-route.min.js',
        'bower_components/angular-resource/angular-resource.min.js',
        'bower_components/angular-animate/angular-animate.min.js',
        'bower_components/angular-aria/angular-aria.min.js',
        'bower_components/angular-slimscroll/angular-slimscroll.js',
        'bower_components/angular-material/angular-material.js',
        'bower_components/socket.io/socket.io.js',
        'bower_components/angular-socket-io/socket.min.js',
        'bower_components/ngmap/build/scripts/ng-map.js',
        'bower_components/ng-file-upload/ng-file-upload.min.js',
        'bower_components/pickadate/lib/compressed/picker.js',
        'bower_components/lodash/lodash.min.js',
        'bower_components/angular-xeditable/dist/js/xeditable.min.js',
        'bower_components/pickadate/lib/compressed/picker.date.js',
        'bower_components/pickadate/lib/compressed/picker.time.js',
        'bower_components/pickadate/lib/compressed/translations/fr_FR.js',
        'bower_components/ng-pickadate/ng-pickadate.js',
        'bower_components/velocity/velocity.js',
        'bower_components/lumx/dist/lumx.js',
        'bower_components/ng-table/dist/ng-table.js',
        'bower_components/moment/min/moment.min.js',
        'bower_components/moment/locale/fr.js',
        'bower_components/d3/d3.min.js',
        'bower_components/dimple/dist/dimple.latest.min.js',
        'bower_components/mousetrap/mousetrap.min.js',
        'bower_components/chartist/dist/chartist.min.js',
        'bower_components/Chart.js/Chart.min.js',
        'bower_components/angular-chart.js/dist/angular-chart.min.js'
//        'bower_components/angular-material-icons/angular-material-icons.js',

    ]
    return gulp.src(jslibs)
        //.pipe(minify({mangle:false}))
        // .pipe(jshint('.jshintrc'))
        //.pipe(jshint.reporter('jshint-stylish'))
        .pipe(sourcemaps.init())
        .pipe(concat('libs.js'))
        .pipe(sourcemaps.write('.'))
        .pipe(gulp.dest('front/assets/dist'));
});



var customOpts = {
    entries: glob.sync('config/[^_]*.js'),
    debug: true
};
var opts = _.assign({}, watchify.args, customOpts);
var b = watchify(browserify(opts));

var bundle = function() { // so you can run `gulp js` to build the file
    return b.bundle()
        // log errors if they happen
        .on('error', gutil.log.bind(gutil, 'Browserify Error'))
        .pipe(source('.'))
        // optional, remove if you don't need to buffer file contents
        .pipe(buffer())
        // optional, remove if you dont want sourcemaps
        .pipe(sourcemaps.init({
            loadMaps: true

        })) // loads map from browserify file
        // Add transformation tasks to the pipeline here.
        .pipe(sourcemaps.write('../bundle')) // writes .map file
        .pipe(gulp.dest('./front/assets/dist/bundle.js'));

}

gulp.task('bundle', bundle);

b.on('update', bundle); // on any dep update, runs the bundler
b.on('log', gutil.log); // output build logs to terminal




gulp.task('styles', function() {
    var libs = [
        'front/assets/css/material-color.css',
        'front/assets/css/pixel-admin.min.css',
        'front/assets/css/widget.css',
        'front/assets/css/themes.min.css',
        'front/assets/css/loaders.css',
        'front/assets/css/style.css',
        'front/assets/css/pages.min.css',

        'bower_components/chartist/dist/chartist.min.css',
        'bower_components/font-awesome/css/font-awesome.min.css',
        'bower_components/font-awesome-animation/dist/font-awesome-animation.min.css',
        'bower_components/bootstrap/dist/css/bootstrap.css',
        'bower_components/ng-table/dist/ng-table.css',
        'bower_components/angular-xeditable/dist/css/xeditable.css',
        'bower_components/angular-material/angular-material.css',
        'bower_components/pickadate/lib/compressed/themes/classic.css',
        'bower_components/pickadate/lib/compressed/themes/classic.date.css',
        'bower_components/pickadate/lib/compressed/themes/classic.time.css',
        'bower_components/lumx/dist/lumx.css',
        'bower_components/mdi/css/materialdesignicons.css',
        'bower_components/angular-chart.js/dist/angular-chart.min.css'
    ]
    return gulp.src(libs)
        //.pipe(minify({mangle:false}))
        // .pipe(jshint('.jshintrc'))
        //.pipe(jshint.reporter('jshint-stylish'))
        .pipe(sourcemaps.init())
        .pipe(concat('styles.css'))
        .pipe(sourcemaps.write('.'))
        .pipe(gulp.dest('front/assets/dist'));
});



// Watch Files For Changes
gulp.task('watch', function() {
    gulp.watch(jssrc, ['scripts']);
    gulp.watch(jslibs, ['jsLibs']);
    gulp.watch(['front/assets/css/*.css', 'front/bower_components/*/*.css', 'front/bower_components/*/*/*.css'], ['styles'])
});

// Default Task
gulp.task('default', ['scripts', 'styles', 'bundle', 'jsLibs', 'watch']);
var walk = require('walk');
var path = require('path');
var fs = require('fs');
var _ = require('lodash');
var files = [];

// Walker options
var walker = walk.walk('./server/models', {
	followLinks: false
});

walker.on('file', function(root, stat, next) {
	// Add this file to the list of files
	files.push(root + '/' + stat.name);
	next();
});

walker.on('end', function() {
	_.each(files, function(e) {
		if (!_.endsWith(e, 'js'))
			return 0;
		var dir = path.dirname(e)
		var base = path.basename(e)
		var model = dir.split('/')[3]
		var mv = require('mv');
		console.log('MV', dir + '/' + base, dir + '/' + model + '.' + base)

		mv(dir + '/' + base, dir + '/' + model + '.' + base, function(err) {
			console.log(err);
			// done. it tried fs.rename first, and then falls back to 
			// piping the source file to the dest file and then unlinking 
			// the source file. 
		});
	})
});
{
  "name": "EDSN",
  "version": "0.0.0",
  "authors": [
    "Abel <abel@chalier.me>"
  ],
  "license": "MIT",
  "ignore": [
    "**/.*",
    "node_modules",
    "bower_components",
    "test",
    "tests"
  ],
  "dependencies": {
    "angular": "~1.4.7",
    "angular-animate": "~1.4.7",
    "angular-aria": "~1.4.7",
    "angular-hotkeys": "~0.2.2",
    "angular-material": "~0.10.1",
    "angular-material-icons": "~0.5.0",
    "angular-resource": "~1.4.7",
    "angular-route": "~1.4.7",
    "angular-slimscroll": "~1.1.3",
    "angular-socket-io": "~0.7.0",
    "angular-xeditable": "~0.1.9",
    "bootstrap": "~3.3.5",
    "d3": "~3.5.6",
    "dimple": "~2.1.4",
    "font-awesome": "~4.4.0",
    "font-awesome-animation": "~0.0.6",
    "jquery": "~2.1.4",
    "lodash": "~3.10.0",
    "lumx": "~0.3.74",
    "mdi": "~1.1.70",
    "moment": "~2.10.3",
    "mousetrap": "~1.5.3",
    "ng-file-upload": "~5.0.9",
    "ng-pickadate": "~0.2.0",
    "ng-table": "~0.8.3",
    "ngmap": "~1.7.11",
    "slimScroll": "~1.3.6",
    "socket.io": "~1.3.5",
    "velocity": "~1.2.2",
    "ng-stats": "~2.5.2",
    "chartist": "~0.9.4",
    "angular-chart.js": "~0.8.5",
    "Chart.js": "~1.0.2"
  }
}
{
  "verbose": false,
  "watch":["node_modules/edsx-mail/*.js", "server/routes.js", "config/*.js", "server/edison_components/*", "server/models/*", "server/app.js", "server/worker.js", "server/core/*"]
}{
  "name": "EDSN",
  "version": "0.3.0",
  "engines": {
    "node": "4.1.2"
  },
  "scripts": {
    "start": "node server/app.js"
  },
  "private": true,
  "dependencies": {
    "async": "^1.4.2",
    "bluebird": "^2.10.2",
    "body-parser": "^1.13.3",
    "browserify": "^11.2.0",
    "compression": "^1.6.0",
    "connect-redis-sessions": "^1.2.0",
    "cookie-parser": "~1.3.3",
    "creditcard": "^0.1.2",
    "cron-emitter": "^0.2.2",
    "cron-parser": "^1.0.0",
    "crypto-js": "^3.1.5",
    "deep-diff": "^0.3.3",
    "dropbox": "^0.10.3",
    "edsx-mail": "^2.1.55",
    "ejs": "^2.3.4",
    "express": "^4.13.3",
    "express-csv": "^0.6.0",
    "ftp-client": "^0.2.2",
    "ftp-get": "^0.3.1",
    "ftp-stream": "0.0.3",
    "geocoder": "^0.2.2",
    "gspeech-api": "^1.0.0",
    "html-entities": "^1.1.3",
    "htmlencode": "0.0.4",
    "is-json": "^1.2.5",
    "jsftp": "^1.5.2",
    "json_encode": "^0.1.0",
    "kue": "^0.9.6",
    "lodash": "^3.10.1",
    "md5": "^2.0.0",
    "milliseconds": "^1.0.3",
    "mime": "^1.3.4",
    "moment": "^2.10.6",
    "moment-iterator": "^1.0.8",
    "moment-timezone": "^0.4.0",
    "mongoose": "^4.2.2",
    "mp3-parser": "^0.2.5",
    "multer": "^0.1.8",
    "ng-stats": "^2.5.2",
    "node-todoist": "^0.3.2",
    "nodeify": "^1.0.0",
    "ovh": "^1.1.3",
    "pdf-merge": "0.0.2",
    "postmark": "^1.2.1",
    "pretty-bytes": "^2.0.1",
    "pretty-error": "^1.1.2",
    "redis": "^1.0.0",
    "regexp-accents": "^1.0.0",
    "request": "^2.65.0",
    "request-promise": "^0.4.3",
    "resemblance": "^1.0.0",
    "sanitize-html": "^1.11.1",
    "scissors": "^0.1.0",
    "simple-encryptor": "^1.0.3",
    "socket.io": "^1.3.7",
    "stream-to-buffer": "^0.1.0",
    "uuid": "^2.0.1",
    "waitress": "^0.1.5"
  },
  "devDependencies": {
    "browserify": "^11.1.0",
    "date-periodjs": "^0.1.0",
    "glob": "^5.0.14",
    "gulp": "^3.9.0",
    "gulp-concat": "^2.5.2",
    "gulp-jshint": "^1.11.0",
    "gulp-minify": "0.0.5",
    "gulp-minify-css": "^1.2.1",
    "gulp-ng-annotate": "^1.1.0",
    "gulp-notify": "^2.2.0",
    "gulp-rename": "^1.2.2",
    "gulp-sourcemaps": "^1.5.2",
    "gulp-uglify": "^1.4.2",
    "gulp-util": "^3.0.7",
    "jshint": "^2.8.0",
    "minimist": "^1.1.3",
    "moment-range": "^2.0.3",
    "vinyl-buffer": "^1.0.0",
    "vinyl-source-stream": "^1.1.0",
    "watchify": "^3.4.0"
  }
}
'use strict'
var express = require('express');

express.response.pdf = function(obj, headers, status) {
    this.header('Content-Type', 'application/pdf');
    return this.send(obj, headers, status);
};

express.response.table = function(obj, headers, status) {
    var row = _.map(obj, function(e) {
        return '<td>' + e.join('</td><td>') + '</td>';
    })
    var css = '<style> table, td, th {padding: 1px 10px;border: 1px solid black;}</style>'
    this.send(css + '<table><tr>' + row.join('</tr><tr>') + '</tr></table');
}

express.response.sage = function(obj, headers, status) {
    var _this = this;
    this.contentType('text/csv');
    this.setHeader('Content-disposition', 'attachment; filename=' + "Ecritures.txt");
    var rtn = "";
    _.each(obj, function(e) {
        _this.write(e.join(';') + "\r\n");
    })
    return this.end();
};


express.response.jsonStr = function(obj, headers, status) {
    this.header('Content-Type', 'application/json');
    return this.send(obj, headers, status);
};

console.log('-->', process.version)

var app = express();
var http = require('http').Server(app);
var port = (process.env.PORT || 8080);
var path = require('path');
var _ = require('lodash')
var fs = require('fs')
global.io = require('socket.io')(http);
require('./shared.js')(express);
global.jobs = edison.worker.initJobQueue();

global.isWorker = false;


new edison.timer();

app.all('/api/call/:call_id', edison.axialis.info)
app.get('/api/client/:id/svi/contact', edison.axialis.contact)
app.get('/api/client/:id/svi/callback', edison.axialis.callback)

app.get('/favicon.ico', function(req, res) {
    res.sendFile(process.cwd() + '/front/assets/img/favicon.ico')
})


app.get('/api/loltest', function(req, res) {
    res.send('ok')
})

app.use(require("multer")({
    inMemory: true,
    onFileUploadStart: function(file, req, res) {
        return true;
    }
}));

app.use(express.static(path.join(process.cwd(), 'front', 'bower_components')));
app.use(express.static(path.join(process.cwd(), 'front', 'assets')));
app.use(express.static(path.join(process.cwd(), 'front', 'angular')));
app.set('view engine', 'ejs');
app.use(require('cookie-parser')());
app.use(require('body-parser').json({
    limit: '50mb'
}));
app.use(require('body-parser').urlencoded({
    extended: true,
    limit: '50mb'

}));
app.use(require('compression')());
app.use(require('connect-redis-sessions')({
    client: redis,
    app: "EDISON".envify(),
    ttl: 999999999
}))




app.get('/logout', function(req, res) {
    if (req.session && req.session.id)  {
        edison.event('LOGOUT').login(req.session.login).save()
        req.session.destroy();
    }
    res.redirect('/')
});



app.post('/login', function(req, res) {
    db.model('user').validateCredentials(req, res)
        .then(function(user) {
            req.session.upgrade(user.login, function() {
                req.session.login = user.login
                req.session.ligne = user.ligne
                req.session.nom = user.nom;
                req.session.prenom = user.prenom;
                req.session.portable = user.portable;
                req.session.service = user.service;
                req.session.email = user.email;
                req.session.root = user.root;
                req.session.pseudo = user.pseudo;
                return res.redirect(req.body.url || '/');
            });
        }, function(err) {
            return res.redirect((req.body.url || '/') + '#failure');
        })
});


app.get("/ping", function(req, res)  {
    res.json(Date.now());
})

var getEmbeddedScript = function(req) {
    return '<script>' +
        ';window.app_session = ' + JSON.stringify(req.session) +
        ';window.app_env = ' + JSON.stringify(process.env.APP_ENV) +
        ';window.app_users = ' + JSON.stringify(edison.users.list()) +
        '</script>';
}

app.use(function(req, res, next) {
    if (_.includes(req.url, '.'))
        return next();
    if (req.session && !req.session.id && (!req.query.x)) {
        if (_.startsWith(req.url, '/api/')) {
            return res.status(401).send("Unauthorized");
        } else {
            return res.sendFile(process.cwd() + '/front/views/login.html');
        }
    } else {

        if (!_.startsWith(req.url, '/api/')) {
            fs.readFile(process.cwd() + "/front/views/index.html", 'utf8', function(err, data) {
                if (err) {
                    return res.status(500).send('error #00412')
                }
                return res.send(data + getEmbeddedScript(req));
            });
        } else {
            return next();

        }
    }
});



require('./routes.js')(app);

// catch 404 and forward to error handler
app.use(function(req, res, next) {
    var err = new Error('Not Found');
    err.status = 404;
    next(err);
});


//if (!env_prod) {
app.use(function(err, req, res, next) {
    __catch(err)
    res.status(err.status || 500);
    res.status(500).json([err, err.stack]);
});
//}

process.on('uncaughtException', __catch);


http.listen(port, function() {
    console.log('listening on *:' + port);
    return !envDev && edison.event('REBOOT').save()
});

module.exports = app;
var fs = require('fs');
var _ = require('lodash');
module.exports = {
	loadJson: function(file) {
		var ret = {};
		var deps = JSON.parse(fs.readFileSync(file, 'utf8')).dependencies;
		for (var mods in deps) {
			ret[_.camelCase(mods)] = require(mods);
		};
	 	return (ret);	
	},
	loadDir: function(dir) {
		var ret = {};
		var files = fs.readdirSync(dir);
		for (var i in files) {
		    if (files[i].slice(-3) === ".js")
		        ret[_.camelCase(files[i].slice(0, -3))] = require(dir+'/'+files[i]);
		}
		return (ret);
	}

}

module.exports = function(app) {
    var success = function(result) {
        if (this.headersSent === false)
            return this.status(200).send(result);
    }

    var die = function(err) {
        if (this.headersSent === false) {
            console.log(err.stack || JSON.stringify(err, undefined, 1))
            this.status(400).send(JSON.stringify(err, undefined, 1));
        }
    }


    app.get('/api/:fn', function(req, res) {
        if (typeof edison.methods[req.params.fn] === 'function') {
            return (edison.methods[req.params.fn](req, res))
        } else {
            res.sendStatus(404);
        }
    })


    app.post('/api/sms/send', function(req, res) {
        sms.send({
            to: envProd ? req.body.to : '0633138868',
            text: req.body.text,
        })
        res.send('ok')
    })

    app.get('/api/stats/telepro', edison.statsTelepro.get.bind(edison.statsTelepro));
    app.get('/api/stats/day', edison.statsDay);

    app.get('/api/search/:text', edison.search)
    app.get('/api/v1/get', function(req, res) {
        edison.v1.get(req.query.q, function(err, resp) {
            console.log(err, resp);
            if (err) return res.status(500).json(err);
            res.json(resp)
        })
    })


    var uniqueModel = function(model, method, req, res) {
        return new Promise(function(resolve, reject) {
            var idIsNumber = model.schema.paths._id.instance === 'Number'
            var id = idIsNumber ? (parseInt(req.params.id) || 0) : req.params.id;
            var promise = Promise.resolve(id)

            if (model[method].findBefore === true) {
                promise = model.findOne({
                    _id: id
                });
            }
            if (model[method].populateArtisan === true) {
                promise = promise.populate('sst');
            }

            promise.then(function(data) {
                if (!data)
                    reject("Document Not Found");
                var promise = model[method].fn(data, req, res);
                if (promise && promise.then && typeof promise.then === 'function')
                    promise.then(resolve, reject)
            }, reject)

        })
    }


    app.all('/api/:model/:id/:method', function(req, res, next) {
        var model = db.model(req.params.model);
        var method = req.params.method;
        if (!model)
            return next();
        if (typeof model[method] === "undefined")
            return next();
        if (model[method].unique === true && model[method].method === req.method) {
            uniqueModel(model, method, req, res).then(success.bind(res), die.bind(res)).catch(__catch)
        } else {
            next();
        }
    });


    app.all('/api/:model/:method', function(req, res, next) {
        var model = db.model(req.params.model);
        var method = req.params.method;
        if (!model ||  typeof model[method] !== "function" || model[method].length !== 2) {
            return next();
        }
        var prm = model[method](req, res);
        if (prm && typeof prm.then === 'function') {
            return prm.then(success.bind(res), die.bind(res))
        }
    });

    app.get('/api/:model/:id', function(req, res, next) {
        var model = db.model(req.params.model);
        var method = req.params.method;
        var id = req.params.id;
        if (!model || !id)
            return next();
        id = id.match(/^[0-9]+$/i) ? parseInt(id) : id;
        model.view(id, req, res).then(success.bind(res), die.bind(res));
    });

    app.post('/api/:model', function(req, res, next) {
        var model = db.model(req.params.model);
        if (typeof model.__save !== "function") {
            return next();
        }
        model.__save(req, res).then(success.bind(res), die.bind(res))
    });

    app.post('/api/:model/:id', function(req, res, next) {
        var model = db.model(req.params.model);
        if (typeof model.__update !== "function") {
            return next();
        }
        model.__update(req.params.id, req, res).then(success.bind(res), die.bind(res))
    });



    app.get('/api/map/:method', function(req, res) {
        if (!edison.map[req.params.method]) {
            return res.status(400).send("Unknown Method");
        }
        edison.map[req.params.method](req.query, res)
    });


    app.all("*", function(req, res) {
        res.status(404).send('X Not Found');
    });

};
module.exports = function() {

    require('pretty-error').start();

    global.requireLocal = function(pth) {
        return require(process.cwd() + '/' + pth)
    }

    global.__catch = function(e) {
        var prettyError = require('pretty-error');
        console.log((new prettyError().render(e)));
    }

    require('nodeify').extend();
    var key = requireLocal('config/_keys');
    var dep = require(process.cwd() + '/server/loadDependencies');
    global.edison = dep.loadDir(process.cwd() + "/server/edison_components");
    global.envProd = process.env.APP_ENV === "PRODUCTION";
    global.envDev = process.env.APP_ENV === "DEVELOPMENT";
    global.envStaging = process.env.APP_ENV === "STAGING";
    global.redis = edison.redis();
    global.db = edison.db();
    global.sms = new edison.ovh();
    global.mail = new edison.mail;
    global.document = new edison.dropbox();
    edison.extendPrototypes();
    edison.users = new edison.users();
}
// === BEGIN: KUE SETUP ===

var kue = require('kue');
var url = require('url');
require('./shared.js')();

global.isWorker = false;


try {
    var key = requireLocal('config/_keys');
    
    global.sms = new edison.ovh();
    global.isWorker = true;

    if (envProd ||  envStaging) {
        var redisUrl = url.parse(process.env.REDISCLOUD_URL);
    }
    redis.delWildcard("kue".envify() + '*', function() {

        var jobs = kue.createQueue({
            prefix: 'kue'.envify(),
            redis: envProd || envStaging ? {
                port: redisUrl.port,
                host: redisUrl.hostname,
                auth: redisUrl.auth.split(":")[1],
            } : undefined,
            disableSearch: true
        });

        jobs.process('db', function(job, done) {
            var terminated = false
            global.currenWorkerJob = job;
            console.log(job.data.model, job.data.method)
            db.model(job.data.model)[job.data.method](job.data.req).then(function(result)  {
                terminated = true;
                done(null, result);
            }, function(err) {
                console.log(err.stack)
                console.log("job error", JSON.stringify(err, undefined, 1));
                return done(err ||  "error");
            })
        });


        jobs.process('db_id', function(job, done) {
            db.model(job.data.model)[job.data.method].fn(job.data.data, job.data.req).then(function(result)  {
                done(null, result);
            }, function(err) {
                console.log("job error", err);
                console.log(err.stack)
                return done(err ||  "error");
            }).catch(__catch)
        });

    })

} catch (e) {
    __catch(e)
}
var _ = require('lodash')
var async = require('async')
module.exports = function(core) {
    return function(req, res) {

        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: core.name,
                method: 'iterator',
                req: _.pick(req, 'query', 'session')
            })
        }
        return new Promise(function(resolve, reject) {
            var q = req.query.id ? {
                id: req.query.id
            } : {}
            core.model().find(q, {}).then(function(resp) {
                var i = 0;
                async.eachLimit(resp, 10, function(e, cb) {
                    if (i++ % 100 === 0) {
                        console.log(Math.round(i * 100 / resp.length) + '%')
                    }
                    var conditions = {
                            _id: e.id
                        },
                        update = {
                            $set: {
                                //      sms:"lol"
                                cache: core.minify(e)
                            }
                        },
                        options = {
                            multi: true
                        };

                    core.model().update(conditions, update, options, cb);
                    e = null;
                    conditions = null;
                    updates = null
                }, function(err) {
                    if (err) {
                        return reject(err);
                    }
                    resolve('ok')
                })
            }, reject).catch(__catch);
        })
    }
}
    var _ = require('lodash');

    module.exports = function(core) {


        var Dump = function(req, res) {
            if (req.query.id) {
                return singleDump(req.query.id, req.query.login || req.session.login, req.query.convert)
            } else if (!isWorker) {
                console.log('dump worker')
                return edison.worker.createJob({
                    name: 'db',
                    model: core.name,
                    method: 'dump',
                    req: _.pick(req, 'query', 'session')
                })
            } else {
                return multiDump(req.query.limit ||  0)
            }
        }


        var multiDump = function(limit) {
            return new Promise(function(resolve, reject) {
                core.model().remove({}, function() {
                    var request = require("request");
                    console.time('request')
                    request(core.multiDumpUrl(limit), function(err, rest, body) {
                        var async = require('async')
                        console.timeEnd('request')
                        var data = JSON.parse(body);
                        var i = 0;
                        console.time('dump')
                        async.eachLimit(data, 50, function(e, callback) {
                            if (++i % 100 == 0)
                                console.log(_.round(i / data.length * 100, 2), "%")
                            core.model()(core.toV2(e)).save(function(err, resp) {
                                if (err) console.log('=>', e.id, err);
                                callback(null);
                            });
                        }, function(err, resp) {
                            console.timeEnd('dump')
                            if (err) {
                                return resolve(err);
                            }
                            core.model().fullReload().then(resolve, reject)
                        })
                    });
                });


            });
        }

        var singleDump = function(id, login, convert) {
            console.log('dumpOne', id)
            return new Promise(function(resolve, reject) {
                var V1 = requireLocal('config/_convert_V1');
                var request = require("request");
                _.delay(function() {
                    request.get(core.singleDumpUrl(id), function(err, resp, body) {
                        if (err || resp.statusCode !== 200 || !body || body == 'null') {
                            console.log('rejected', id)
                            return reject('nope')
                        }
                        var v1 = JSON.parse(body)
                        var v2 = core.toV2(v1)
                        if (!convert)
                            v2.date.dump = Date.now();
                        edison.event('DUMP_' + core.NAME).login(edison.users.search(login)).id(id).data({
                            v1: v1,
                            v2: v2
                        }).save()
                        core.model().findById(parseInt(id), function(err, doc) {
                            if (doc) {
                                doc = _.assign(doc, v2);
                            } else {
                                doc = core.model()(v2);
                            }
                            doc.save().then(resolve, reject);
                        })
                    });
                }, login === "CMD" || 1000)
            })
        }
        return Dump;
    }
module.exports = function(core) {
    return function(res, req) {
        var _ = require('lodash')
        console.time('reloadFilters');
        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: core.name,
                method: 'fullReload',
                req: _.pick(req, 'query', 'session')
            })
        }
        return new Promise(function(resolve, reject) {
            core.model().reloadFilters(function(err) {
                if (err)
                    reject(err);
                console.timeEnd('reloadFilters');
                console.time('cacheListReload')
                core.model().cacheListReload().then(function() {
                    console.timeEnd('cacheListReload')
                    console.time('teleproStats');
                    edison.statsTelepro.reload().then(function() {
                        console.timeEnd('teleproStats');
                        resolve('ok')
                    }, reject)
                }, reject)
            })
        })
    }
}
    module.exports = function(core) {
        return function(req, res) {
            new Promise(function(resolve, reject) {
                redis.get(core.redisCacheListName.envify(), function(err, reply) {
                    if (!reply || err) {
                        reject('no cache list')
                    }
                    res.jsonStr(reply)
                })
            })
        }
    }
module.exports = function(modelName, schema) {
    var core = requireLocal(['server', 'models', modelName, modelName + '.core.js'].join('/'));
    schema.statics.dump = require('./core.dump')(core);

    /* on save update cachelist + filter (=cacheActualise) */
    schema.statics.uniqueCacheReload = require('./core.unique-cache-reload')(core);
    schema.statics.throttleCacheReload = require('./core.throttle-cache-reload')(core);


    /* reload list of cache:{t:12, ...} for display  (getCache)*/
    schema.statics.cacheListReload = require('./core.reload-cache-list')(core);
    /* getter  (list)*/
    schema.statics.getCacheList = require('./core.get-cache-list')(core);


    /* cache.fltr update mongo (=fltrify)*/
    schema.statics.reloadFilters = require('./core.reload-filters')(core);
    schema.statics.reloadAllFilters = function(req, res) {
        return require('./core.reload-filters')(core)({}, function(err, resp) {
            res.json([err, resp])
        });
    }




    /* full reload on dump end*/
    schema.statics.fullReload = require('./core.full-reload')(core);

    schema.statics.temporarySaving = require('./core.temporary-saving')(core);


    schema.statics.view = require('./core.view')(core);

    schema.statics.__update = require('./core.update')(core);

    schema.statics.__save = require('./core.save')(core);

    schema.statics.iterator = require('./core.document-iterator')(core);


    schema.statics.Core = core;


}
var _ = require('lodash')

module.exports = function(core) {
    return function(req, res) {
        return new Promise(function(resolve, reject) {
            core.model().find({}, {
                cache: true,
            }).sort({
                id: -1
            }).then(function(resp) {
                var cache = JSON.stringify(_.pluck(resp, 'cache'));
                resp = null;
                redis.set(core.redisCacheListName.envify(), cache, function() {
                    resolve(cache)
                });
            }, reject).catch(__catch);
        })
    }
}
module.exports = function(core) {
    var _ = require('lodash')
    return function(query, cb, a, b) {
        var updateFactory = function(obj) {
            return function(cb) {
                core.model().update(obj.query, obj.update, {
                    multi: true
                }).exec(cb)
            }
        }

        try {
            if (!query) {
                query = {}
            } else if (typeof query === 'function') {
                cb = query;
                query = {}
            }
            var fltrs = FiltersFactory(core.name).getAllFilters();

            var updates = {};
            _.each(fltrs, function(e) {
                if (e.stats !== false && e.match) {
                    var match = typeof e.match === 'function' ? e.match() : e.match;
                    var field = 'cache.f.' + e.short_name;
                    var tmp = {
                        query: _.merge(_.clone(query), match  ||  {}),
                        update: {
                            $set: {}
                        }
                    }
                    tmp.update.$set[field] = 1;
                    tmp.query['$or'] = [{}, {}]
                    tmp.query['$or'][0][field] = 0;
                    tmp.query['$or'][1][field] = {
                        $exists: false
                    };
                    updates[e.short_name] = updateFactory(tmp)
                }
            });
            core.model().update(query, {
                $set: {
                    'cache.f': {}
                }
            }, {
                multi: true
            }).exec(function(err, resp) {
                var async = require('async')
                async.parallel(updates, function(err, result) {
                    if (typeof cb === 'function')
                        cb(err, result)
                });
            })

        } catch (e) {
            __catch(e)
        }
    }
}
 module.exports = function(core) {
     var _ = require('lodash')

     function mongoError(reject) {
         return function(err) {
             var str = String(err)
             str = str.replaceAll('Path', 'Le champ')
             str = str.replaceAll('is required', 'est requis')
             str = str.replaceAll('ValidationError', 'Erreur')
             reject(str);
         }
     }

     return function(req, res) {
         return new Promise(function(resolve, reject) {
             data = req.body;
             console.log('1')
             core.model().getNextID(function(nextID) {
                 data.login = {
                     ajout: req.session.login
                 }
                 data.id = nextID;
                 data._id = nextID;
                 console.log('2')
                 var inter = core.model()(data);
                 console.log('3')

                 if (_.isFunction(core.preSave))
                     core.preSave(data, req.session);
                 console.log('4')
                 inter.save().then(function(doc) {
                     console.log('5')
                     edison.event('NEW_' + core.NAME).login(req.session.login).id(data.id).data(data).save();
                     console.log('6')
                     if (_.isFunction(core.postSave))
                         core.postSave(doc, data, req.session);
                     console.log('7')
                     resolve(doc);
                 }, mongoError(reject));
             });
         })
     }
 }
module.exports = function(core) {

    return function(req, res) {
        if (req.body.tmpID) {
            var key = core.redisTemporarySaving(req.body.tmpID).envify();
            redis.setex(key, 600, JSON.stringify(req.body), function() {
                res.send('ok')
            });
        } else if (req.query.id) {
            var key = core.redisTemporarySaving(req.query.id).envify()
            redis.get(key, function(err, resp) {
                if (!err && resp) {
                    res.json(JSON.parse(resp))
                } else {
                    res.json(core.defaultDoc(parseInt(req.query.id) || Date.now()))
                }
            });
        } else {
            res.status(400).send('bad request')
        }
    }
}
    module.exports = function(core) {
        var _ = require('lodash');

        return function(id_list) {
            return new Promise(function(resolve, reject) {
                var async = require('async');
                async.series({
                    reloadFilter: function(cb) {
                        core.model().reloadFilters({
                            _id: {
                                $in: id_list
                            }
                        }, cb)
                    },
                    cacheList: function(cb) {
                        redis.get(core.redisCacheListName.envify(), cb);
                    },
                    data: function(cb) {
                        core.model().find({
                            _id: {
                                $in: id_list
                            }
                        }, {
                            cache: true
                        }, cb)
                    },

                }, function(err, resp) {
                    if (err) {
                        reject(err);
                    }
                    try {
                        if (resp.cacheList && resp.data) {
                            var cache = JSON.parse(resp.cacheList);
                            for (var i = 0; i < cache.length && id_list.length; i++) {
                                var pos = id_list.indexOf(cache[i].id)
                                if (pos >= 0) {
                                    cache[i] = resp.data[pos].cache;
                                    id_list.splice(pos, 1);
                                }
                            };
                            if (id_list.length) {
                                var z = _.filter(resp.data, function(e) {
                                    return _.includes(id_list, e._id);
                                })
                                _.each(z, function(x) {
                                    cache.unshift(x.cache)
                                })
                            }
                        }
                        redis.set(core.redisCacheListName.envify(), JSON.stringify(cache), function(err) {
                            resolve(_.map(resp.data, 'cache'));
                        });
                    } catch (e) {
                        __catch(e);
                    }
                })
            }).catch(__catch)
        }
    }
    module.exports = function(core) {
        var _ = require('lodash');

        _.mixin({
            debounceArgs: function(fn, timeout, options) {
                var __dbArgs = []
                var __dbFn = _.debounce(function() {
                    fn.call(undefined, __dbArgs);
                    __dbArgs = []
                }, timeout, options);
                return function() {
                    __dbArgs.push(_.values(arguments));
                    __dbFn();
                }
            },
            throttleArgs: function(fn, timeout, options) {
                var _thArgs = []
                var _thFn = _.throttle(function() {
                    fn.call(undefined, _thArgs);
                    _thArgs = []
                }, timeout, options);
                return function() {
                    _thArgs.push(_.values(arguments));
                    _thFn();
                }
            },
        })



        return _.throttleArgs(function(docs) {

            if (!isWorker) {
                console.time('throttleCacheReload')
                return edison.worker.createJob({
                    name: 'db',
                    model: core.name,
                    method: 'throttleCacheReload',
                    req: _(docs).flatten().map('id').uniq().value()
                }).then(function(resp) {
                    io.sockets.emit(core.listChange, {
                        data: resp,
                        ts: _.now()
                    });
                    edison.statsTelepro.reload();
                })
            }

        }, 5000, {
            leading: true
        })
    }
module.exports = function(core) {
    var _ = require('lodash');

    function mongoError(reject) {
        return function(err) {
            var str = String(err)
            str = str.replaceAll('Path', 'Le champ')
            str = str.replaceAll('is required', 'est requis')
            str = str.replaceAll('ValidationError', 'Erreur')
            reject(str);
        }
    }


    return function(id, req, res) {
        return new Promise(function(resolve, reject) {
            var data = req.body
            core.model().findOne({
                id: data.id
            }).then(function(doc) {
                if (!doc)
                    return reject("ERROR => unkown " + core.name + " '" + id + "'");

                if (_.isFunction(core.preUpdate))
                    core.preUpdate(doc, data, req.session);

                for (k in data) {
                    if (!(_.contains(['id', '_id', '__v'], k))) {
                        doc[k] = data[k];
                    }
                }

                doc.save().then(function(resp) {
                    try {
                        if (_.isFunction(core.postUpdate)) {
                            core.postUpdate(resp, data, req.session);
                        }
                        edison.event('UPDATE_INTERVENTION').id(id).data({
                            old: data,
                            nw: doc
                        }).save()
                        return resolve(resp);
                    } catch (e) {
                        console.log(e.stack)
                    }
                }, mongoError(reject))
            }, mongoError(reject))
        })
    }
}
var _ = require('lodash');

module.exports = function(core) {
    /* 'client categorie tva -_id' */
    return function(id, req, res) {
        var _this = this;
        id = parseInt(id);
        if (id == 0 || isNaN(id))
            return Promise.reject(id + "id no a valid ID")
        return new Promise(function(resolve, reject) {

            var prm = core.model().findOne({
                id: id
            });
            if (req.query.populate) {
                var pops = req.query.populate.removeAll(' ').split(',')
                _.each(pops, function(e) {
                    prm = prm.populate(e);
                })
            }
            if (req.query.select) {
                prm = prm.select(req.query.select);
            }
            prm.then(resolve, reject);

        })
    }
}
module.exports = {
    set: function(query, cb) {
    	cb = cb || function(){}
        var key = requireLocal('config/_keys');
        var request = require('request');
        request.get({
            url: 'http://electricien13003.com/alvin/query.php',
            qs: {
                q: query,
                key: key.alvin.pass
            }
        }, function(err, resp, body) {
            if (resp && resp.statusCode === 200) {
                cb(null, parseInt(body));
            } else {
                cb(body || 'ERR')
            }
        })
    },
    get: function(query, cb) {
    	cb = cb || function(){}
        var key = requireLocal('config/_keys');
        var request = require('request');
        request.get({
            url: 'http://electricien13003.com/alvin/query.php',
            qs: {
                q: query,
                key: key.alvin.pass
            }
        }, function(err, resp, body) {
            if (resp && resp.statusCode === 200) {
                cb(null, JSON.parse(body));
            } else {
                cb(body || 'ERR')
            }
        })
    }
}
var _ = require('lodash');

var request = function(query) {
    var response = _.pick(query, 'status_code', 'description', 'redirect_to');
    this.json(response);
    db.model('axialis')(query).save();
    if (response.status_code === 200 && query.id_intervention) {
        var q = {
            id: query.id_intervention,
            appels: {
                $not: {
                    $elemMatch: {
                        call_id: query.call_id
                    }
                }
            }
        }
        db.model('intervention').findOne(q).populate('sst').then(function(resp) {
            if (resp) {
                resp.appels = resp.appels || [];
                resp.appels.push(query);
                resp.save(function(err, resp) {
                    if (query._type === 'CALLBACK') {
                        var template = "le client {{id}} ({{client.civilite}} {{client.nom}}) rappel le {{artisan.nomSociete}}"
                    } else {
                        var template = "{{artisan.nomSociete}} appel le client {{id}} ({{client.civilite}} {{client.nom}})"
                    }
                    edison.event('INTER_CALL_' + query._type)
                        .id(resp.id)
                        .broadcast(resp.login.ajout)
                        .self()
                        .icon('phone')
                        .color('green')
                        .message(_.template("{{artisan.nomSociete}} appel le client {{id}} ({{client.civilite}} {{client.nom}})")(resp))
                        .send()
                        .save()
                });
                setTimeout(function() {
                    edison.event('INTER_CALL_RECORDING')
                        .id(resp.id)
                        .broadcast(resp.login.ajout)
                        .self()
                        .icon('phone')
                        .color('green')
                        .message(_.template("La conversation téléphonique du client {{id}} ({{client.civilite}} {{client.nom}}) a été upload")(resp))
                        .send()
                        .save()
                }, 25 * 60 * 1000);
            }
        })
    }
}

module.exports = {
    info: function(req, res) {
        if (req.query.api_key !== 'F8v0x13ftadh89rm0e9x18b62ZqgEl47') {
            return res.sendStatus(401)
        }
        db.model('intervention').update({
            "appels.call_id": req.query.call_id
        }, {
            $set: {
                "appels.$.duration": req.query.duree_about,
                "appels.$.status": req.query.status,
            }
        }, function(err, resp) {
            console.log("===>INFO RESP", err, resp)
        })

        res.send('ok')
    },
    callback: function(req, res) {
        var _ = require('lodash');
        var q = req.query;
        if (req.query.api_key !== 'F8v0x13ftadh89rm0e9x18b62ZqgEl47') {
            return res.sendStatus(401)
        }

        if (!req.query.call_origin) {
            return res.json({
                status_code: 401,
                description: 'Invalid Request'
            });
        }

        req.query.call_origin = req.query.call_origin.replace('0033', '0');
        db.model('intervention').findOne({
            $or: [{
                'client.telephone.tel1': req.query.call_origin
            }, {
                'client.telephone.tel2': req.query.call_origin
            }, {
                'client.telephone.tel3': req.query.call_origin
            }],
            status: 'ENC'
        }).populate('sst').sort('-id').then(function(resp) {
            if (!resp) {
                return request.bind(res)({
                    call_id: req.query.call_id,
                    origin: req.query.call_origin,
                    _type: 'CALLBACK',
                    status_code: 402,
                    description: 'partenaire inconnu'
                });
            }
            request.bind(res)({
                call_id: req.query.call_id,
                origin: req.query.call_origin,
                _type: 'CALLBACK',
                status_code: 200,
                description: 'OK',
                id_sst: resp.sst.id,
                id_intervention: resp.id,
                redirect_to: resp.sst.telephone.tel1
            });
        })
    },
    contact: function(req, res) {
        var _ = require('lodash');
        var q = req.query;


        if (req.query.api_key !== 'F8v0x13ftadh89rm0e9x18b62ZqgEl47') {
            return res.sendStatus(401)
        }
        if (!req.params.id.match(/^\d+$/)) {
            return request.bind(res)({
                call_id: req.query.call_id,
                origin: q.call_origin,
                _type: 'CONTACT',
                status_code: 401,
                description: "Client inconnu"
            });
        }
        q.call_origin = q.call_origin && q.call_origin.replace('330', '0')


        db.model('artisan').findOne({
            $or: [{
                'telephone.tel1': q.call_origin
            }, {
                'telephone.tel2': q.call_origin
            }, {
                'id': parseInt(q.sst_id || 0)
            }]
        }).sort('-id').then(function(doc) {
            if (!doc) {
                return request.bind(res)({
                    call_id: req.query.call_id,
                    origin: q.call_origin,
                    _type: 'CONTACT',
                    status_code: 401,
                    description: "telephone d'origine inconnu + pas de sst_id"
                });
            }
            if (req.params.id == '0' ||  req.params.id == '29549') {
                return request.bind(res)({
                    call_id: req.query.call_id,
                    origin: q.call_origin,
                    _type: 'CONTACT',
                    id_sst: doc.id,
                    status_code: 401,
                    description: "client inconnu"
                });
            }
            promise = db.model('intervention').findOne({
                id: parseInt(req.params.id),
                status: 'ENC',
            }).then(function(intervention) {
                if (!intervention || !intervention.artisan  || intervention.artisan.id !== doc.id) {
                    return request.bind(res)({
                        call_id: req.query.call_id,
                        origin: q.call_origin,
                        id_sst: doc.id,
                        _type: 'CONTACT',
                        status_code: 403,
                        description: "le intervenant n'a pas les droits"
                    });
                } else {
                    return request.bind(res)({
                        call_id: req.query.call_id,
                        origin: q.call_origin,
                        id_sst: doc.id,
                        _type: 'CONTACT',
                        status_code: 200,
                        description: "OK",
                        id_intervention: intervention.id,
                        redirect_to: intervention.client.telephone.tel1.replace('0', '33')
                    });
                }
            })
        })
    }
}
module.exports = function() {
    var mongoose = require("mongoose");
    var fs = require('fs');
    var path = require('path');
    var _ = require('lodash');

    mongoose.connect(process.env.MONGOLAB_URI || 'mongodb://localhost/EDISON');

    function getDirectories(srcpath) {
        return fs.readdirSync(srcpath).filter(function(file) {
            return fs.statSync(path.join(srcpath, file)).isDirectory();
        });
    }
    var basePath = process.cwd() + '/server/models/'
    getDirectories(basePath).forEach(function(model) {
        var folder = basePath + model;
        var schema = require(folder + '/' + model + '.schema')(mongoose);

        require(folder + '/' + model + '.validator')(schema);

        fs.readdirSync(folder + '/methods').forEach(function(method) {
            if (_.endsWith(method, '.js') && !_.startsWith(method, '-')) {
                require(folder + '/methods/' + method)(schema)
            } else {
                //console.log(method)
            }
        });
        if (model === 'intervention' || model === 'devis' || model === 'artisan') {
            requireLocal('server/core/core.index.js')(model, schema)
        }
        var model = mongoose.model(model, schema);

    })

    mongoose.utils = {
        round: function(field) {
            return {
                $divide: [{
                        $subtract: [{
                            $multiply: [field, 100]
                        }, {
                            $mod: [{
                                $multiply: [field, 100]
                            }, 1]
                        }]
                    },
                    100
                ]
            }
        },
        cond: function(field, value, rA, rB) {
            return {
                $cond: [{
                    $eq: [field, value]
                }, (rA || 1), (rB || 0)]
            }
        },
        sumCond: function(field, value, rA, rB) {
            return {
                $sum: {
                    $cond: [{
                        $eq: [field, value]
                    }, (rA || 1), (rB || 0)]
                }
            }
        },
        isDefined: function() {
            return {
                $exists: true
            }
        },
        between: function(a, b) {
            return {
                $gt: a,
                $lt: b
            }
        }
    }
    return mongoose;

}
var uuid = require('uuid');
var key = requireLocal('config/_keys');
var _ = require('lodash')
var Dropbox = function() {
    var DropboxAPI = require("dropbox")
    this.client = new DropboxAPI.Client({
        token: key.dropbox
    });
}
Dropbox.prototype.getFilename = function(p) {
    return '/V2/' + p.model + '/' + p.link + '/' + p._id + '.' + p.extension;
};

Dropbox.prototype.get = function(filePath, cb) {
    this.client.readFile(filePath, {
        buffer: true
    }, cb)

}



Dropbox.prototype.download = function(file_id) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        db.model('document').findOne({
            _id: file_id
        }).then(function(doc) {
            if (!doc)
                return reject("Document not found");
            _this.client.readFile(doc.filename, {
                buffer: doc.isBinary
            }, function(error, data) {
                if (error)
                    return reject(error);
                var rtn = doc.toObject();
                rtn.data = data;
                return resolve(rtn);
            });
        }, reject)
    })
}

Dropbox.prototype.list = function(dir) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        _this.client.readdir(dir, function(error, entries) {
            if (error) {
                return reject(error);
            }
            resolve(entries)
        });
    })
}

Dropbox.prototype.move = function(from, to) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        _this.client.move(from, to, function(err, stats) {
            if (err)
                reject(err);
            resolve(stats);
        })

    })
}

Dropbox.prototype.copy = function(from, to) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        _this.client.copy(from, to, function(err, stats) {
            if (err)
                reject(err);
            resolve(stats);
        })

    })
}

Dropbox.prototype.stack = function(buffer, filename, login) {
    var moment = require('moment');
    var folder = envProd ? '/PrintQueue/' : '/PrintQueueDev/'
    return this.upload({
        filename: folder + [moment().format('L').replace(/\D/g, '-'), filename, login].join(' - ') + '.pdf',
        data: buffer
    })
}

Dropbox.prototype.upload = function(params) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        params._id = uuid.v4();
        params.filename = params.filename || _this.getFilename(params);
        _this.client.writeFile(params.filename, params.data, function(error, stat) {
            if (error)
                return reject(error);
            return resolve(params);
        });
    })

}
module.exports = Dropbox;
var _ = require('lodash')

var Event = function(type) {
    if (!(this instanceof Event)) {
        return new Event(type);
    }
    this.doc = {
        login: 'auto',
        date: new Date,
        type: type ||  'UNKNOWN',
    }
}

Event.prototype.login = function(login) {
    this.doc.login = login;
    return this;
}

Event.prototype.service = function(service) {
    this.doc.service = service;
    return this;
}

Event.prototype.type = function(type) {
    this.doc.type = type;
    return this;
}

Event.prototype.id = function(id) {
    this.doc.id = parseInt(id);
    return this;
}

Event.prototype.data = function(data) {
    this.doc.data = data;
    return this;
}

Event.prototype.icon = function(icon) {
    this.doc.icon = icon;
    return this;
}

Event.prototype.date = function(date) {
    this.doc.date = date;
    return this;
}
Event.prototype.save = function(cb) {
    db.model('event')(this.doc).save(cb)
    if (typeof io !== 'undefined') {
        io.sockets.emit('event');
    }
    return this
}

Event.prototype.broadcast = function(dest) {
    this.brDest = dest
    return this
}

Event.prototype.color = function(color) {
    this.brColor = color
    return this
}
Event.prototype.message = function(message) {
    this.brMessage = message
    this.doc.message = message
    return this
}

Event.prototype.self = function() {
    this.self = true;
    return this
}

Event.prototype.send = function() {
    var _this = this;
    if (typeof io !== 'undefined') {
        io.sockets.emit('notification', {
            message: _this.brMessage,
            dest: _this.brDest,
            self: _this.self,
            service: _this.doc.service ||  null,
            color: _this.brColor || 'blue',
            origin: _this.doc.login,
            icon: _this.doc.icon ||  'android'
        })
    } else {
        console.log('SOCKET UNAVAILABLE')
    }
    return this;
}


/*var z = new Event()
console.log('--<', z)*/

//var x = Event().login('chalie_a').type('ID_DESC').data({lol:'toto'}).save()
module.exports = Event;
module.exports = function() {

    String.prototype.envify = function(str) {
        return [process.env.APP_ENV, this].join('_')
    }

    String.prototype.lsplit = function() {
        return this.match(new RegExp('.{1,' + ((arguments.length == 1) ? (isFinite(String(arguments[0]).trim()) ? arguments[0] : false) : 1) + '}', 'g'));
    }

    String.prototype.replaceAll = function(target, replacement) {
        return this.split(target).join(replacement);
    }
    String.prototype.removeAll = function(target) {
        return this.split(target).join('');
    }
    Number.prototype.round = function(number) {
        number = number || 2;
        var pow = Math.pow(10, number);
        return Math.round(this * pow) / pow;
    }
    Number.prototype.safeAdd = function(number) {
            console.log(this, number, (this + number).round())
            return (this + number).round()
        }
        /*
            Object.prototype.normalize = function() {
                
            }*/

    Object.defineProperty(Object.prototype, 'clone', {
        value: function() {
            return JSON.parse(JSON.stringify(this));
        },
        writable: true,
        configurable: true,
        enumerable: false
    });
    Array.prototype.swap = function(x, y) {
        var b = this[x];
        this[x] = this[y];
        this[y] = b;
        return this;
    }

}
var qs = require('querystring'),
    request = require('request'),
    crypto = require('crypto'),
    url = require('url'),
    waitress = require('waitress'),
    util = require('util'),
    config;

// define constants
var PLACES_RANKBY_DEFAULT = 'prominence';
var PLACES_RANKBY_DISTANCE = 'distance';

// this is deprecated
exports.setProxy = function(uri) {
  config('proxy', uri);
};

var _config = {
  'google-client-id': null,
  'stagger-time': 200,
  'encode-polylines': true,
  'secure': false,
  'proxy': null,
  set 'google-private-key'(privateKey) {
    if (privateKey){
      // Google private keys are URL friendly base64, needs to be replaced with base64 valid characters
      this.googlePrivateKey = privateKey.replace(/-/g,'+').replace(/_/g,'/');
      this.googlePrivateKey = new Buffer(this.googlePrivateKey, 'base64');
    } else {
      this.googlePrivateKey = null;
    }
  },
  get 'google-private-key'() {
    return this.googlePrivateKey || null;
  }
};


exports.config = config = function(key, value) {
  if (arguments.length === 1) {
    if (typeof key === 'object' && key !== null) {
      var settings = key;
      for (var key in settings) {
        config(key, settings[key]);
      }
    } else {
      return _config[key];
    }
  } else {
    _config[key] = value;
  }
};

// http://code.google.com/apis/maps/documentation/places/
exports.places = function(latlng, radius, key, callback, sensor, types, lang, name, rankby, pagetoken) {

  var args = {
    location: latlng,
    key: key
  };

  rankby = rankby || PLACES_RANKBY_DEFAULT;
  if (rankby !== PLACES_RANKBY_DEFAULT && rankby !== PLACES_RANKBY_DISTANCE) {
    rankby = PLACES_RANKBY_DEFAULT;
  }
  args.rankby = rankby;

  // radius can be passed in the request only if the rankby parameter is not 'distance'
  // Ranking results by distance will set a fixed search radius of 50km
  if (typeof radius !== "undefined" && radius !== null && rankby !== PLACES_RANKBY_DISTANCE) {
    args.radius = radius;
  }

  if (typeof types !== "undefined" && types !== null) {
    args.types = types;
  }

  if (typeof lang !== "undefined" && lang !== null) {
    args.lang = lang;
  }

  if (typeof name !== "undefined" && name !== null) {
    args.name = name;
  }

  if (typeof pagetoken !== "undefined" && pagetoken !== null) {
    args.pagetoken = pagetoken;
  }

  args.sensor = sensor || 'false';

  return makeRequest('/maps/api/place/search/json', args, true, returnObjectFromJSON(callback));
};

exports.placeDetails = function(referenceId, key, callback, sensor, lang) {
  var args = {
    reference: referenceId,
    key: key
  };
  if (lang) args.lang = lang;
  args.sensor = sensor || 'false';

  var path = '/maps/api/place/details/json';
  return makeRequest(path, args, true, returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/geocoding/
exports.geocode = function(address, callback, sensor, bounds, region, language) {
  var args = {
    'address': address
  };
  if (bounds) args.bounds = bounds;
  if (region) args.region = region;
  if (language) args.language = language;
  args.sensor = sensor || 'false';

  var path = '/maps/api/geocode/json';

  return makeRequest(path, args, config('secure'), returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/geocoding/#ReverseGeocoding
exports.reverseGeocode = function(latlng, callback, sensor, language ) {
  var args = {
    'latlng': latlng
  };
  if (language) args.language = language;
  args.sensor = sensor || 'false';

  var path = '/maps/api/geocode/json';

  return makeRequest(path, args, config('secure'), returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/distancematrix/
exports.distance = function(origins, destinations, callback, sensor, mode, alternatives, avoid, units, language) {
  var args = {
    'origins': origins,
    'destinations': destinations
  };
  if (mode) args.mode = mode.toLowerCase();
  if (avoid) args.avoid = avoid;
  if (units) args.units = units;
  if (language) args.language = language;
  args.sensor = sensor || 'false';

  var path = '/maps/api/distancematrix/json';
  return makeRequest(path, args, config('secure'), returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/directions/
// departureTime and arrivalTime must be passed as UNIX timestamp => Math.floor((new Date()).getTime()/1000)
exports.directions = function(origin, destination, callback, sensor, mode, waypoints, alternatives, avoid, units, language, departureTime, arrivalTime, region) {

  var args = {
    'origin': origin,
    'destination': destination
  };

  if (mode) args.mode = mode.toLowerCase();

  // for mode transit you MUST pass either departur or arrival time
  if (mode === 'transit' && ((typeof departureTime === "undefined" || departureTime === null) && (typeof arrivalTime === "undefined" || arrivalTime === null))) {
    var error = new Error('If you set the mode to "transit" you must also specify either a departure_time or an arrival_time');
    if (typeof callback === 'function') {
      return callback(error);
    }
    else {
      throw error;
    }
  }

  if (typeof departureTime !== "undefined" && departureTime !== null) {
    if (mode === 'transit' || mode === 'driving') {

      args.departure_time = departureTime

      if (typeof arrivalTime !== "undefined" && arrivalTime !== null) {
        args.arrival_time = arrivalTime
      }
    }
  }

  if (waypoints) args.waypoints = waypoints;
  if (alternatives) args.alternatives = alternatives;
  if (avoid) args.avoid = avoid;
  if (units) args.units = units;
  if (language) args.language = language;
  if (region) args.region = region;
  args.sensor = sensor || 'false';

  var path = '/maps/api/directions/json';

  return makeRequest(path, args, config('secure'), returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/elevation/
// http://code.google.com/apis/maps/documentation/elevation/#Locations
exports.elevationFromLocations = function(locations, callback, sensor) {
  if (config('encode-polylines')){
    locations = 'enc:' + createEncodedPolyline(locations);
  }
  var args = {
    'locations': locations
  };
  args.sensor = sensor || 'false';

  var path = '/maps/api/elevation/json';

  return makeRequest(path, args, config('secure'), returnObjectFromJSON(callback));
};

// http://code.google.com/apis/maps/documentation/elevation/#Paths
exports.elevationFromPath = function(path, samples, callback, sensor) {
  if (config('encode-polylines')){
    path = 'enc:' + createEncodedPolyline(path);
  }
  var args = {
    'path': path,
    'samples': samples
  };
  args.sensor = sensor || 'false';
  var reqPath = '/maps/api/elevation/json';

  var maxlen = 1500;
  var count = (path.length < maxlen ? 1 : Math.ceil(path.length/maxlen));

  if (count === 1) {
    makeRequest(reqPath, args, config('secure'), returnObjectFromJSON(callback));
  } else {
    var done = waitress(count, function(err, results) {
      results = results.sort(function(a, b) {
        return a.n - b.n;
      }).map(function(v) {
        return v.results;
      });
      var status = "OK";
      var aggregated = [];
      results.forEach(function(result) {
        aggregated = aggregated.concat(result.results);
        if (result.status !== "OK") {
          status = result.status;
        }
      });
      results = {
        results: aggregated,
        status: status
      };
      callback(null, results);
    });

    path = path.split("|");
    var pieceSize = Math.ceil(path.length / count);
    var n = 0;
    while (path.length) {
      var smallerPath = path.splice(0, pieceSize);
      // google will throttle us if we launch all the
      // requests together, so we have to stagger them.
      (function(n, path, samples) {
        path = path.join("|");
        var cb = function(err, results) {
          if (err) return done(err);
          done(null, { n: n, results: results });
        };
        setTimeout(function() {
          exports.elevationFromPath(path, samples, cb, sensor);
        }, Math.floor(Math.random() * config('stagger-time')));
      })(++n, smallerPath, smallerPath.length);
    }
  }
};

// http://code.google.com/apis/maps/documentation/staticmaps
exports.staticMap = function(center, zoom, size, scale, callback, sensor, maptype, markers, styles, paths) {
  var args = {
    'center': center,
    'zoom': zoom,
    'size': size
  };
  var i, k;
  if (scale) args.scale = scale;
  if (maptype) args.maptype = maptype;
  if (markers) {
    args.markers = [];
    for (i = 0; i < markers.length; i++) {
      var marker = '';
      if (markers[i].size)     marker += '|size:'   + markers[i].size;
      if (markers[i].color)    marker += '|color:'  + markers[i].color;
      if (markers[i].label)    marker += '|label:'  + markers[i].label;
      if (markers[i].icon)     marker += '|icon:'   + markers[i].icon;
      if (markers[i].shadow)   marker += '|shadow:' + markers[i].shadow;
      if (markers[i].location) marker += '|'      + markers[i].location;
      args.markers[i] = marker;
    }
  }
  if (styles) {
    args.style = [];
    for (i = 0; i < styles.length; i++) {
      var new_style = '';
      if (styles[i].feature) new_style += '|feature:' + styles[i].feature;
      if (styles[i].element) new_style += '|element:' + styles[i].element;

      var rules = styles[i].rules;

      if (rules) {
        for (k in rules) {
          var rule = rules[k];
          new_style += '|' + k + ':' + rule;
        }
      }
      args.style[i] = new_style;
    }
  }
  if (paths) {
    args.path = [];
    for (i = 0; i < paths.length; i++) {
      var new_path = '';
      if (paths[i].weight)    new_path += '|weight:' + paths[i].weight;
      if (paths[i].color)     new_path += '|color:' + paths[i].color;
      if (paths[i].fillcolor) new_path += '|fillcolor:' + paths[i].fillcolor;

      var points = paths[i].points;

      if (points) {
        if (config('encode-polylines')){
          new_path += '|enc:' + createEncodedPolyline(points);
        } else {
          for (k = 0; k < points.length; k++) {
            new_path += '|' + points[k];
          }
        }
      }
      args.path[i] = new_path.replace(/^\|/, '');
    }
  }
  args.sensor = sensor || 'false';

  var path = '/maps/api/staticmap';
  return makeRequest(path, args, config('secure'), callback, 'binary');
};

// http://code.google.com/apis/maps/documentation/streetview
exports.streetView = function(size, location, callback, sensor, heading, fov, pitch) {
  var args = {
    'size': size,
    'location': location
  };
  if (heading) {
    heading = parseInt(heading, 10);
    if (heading >= 0 && heading <= 360) {
      args.heading = heading;
    }
  }
  if (fov) {
    fov = parseInt(fov, 10);
    if (fov >= 0 && fov <= 120) {
      args.fov = fov;
    }
  }
  if (pitch) {
    pitch = parseInt(pitch, 10);
    if (pitch >= -90 && pitch <= 90) {
      args.pitch = pitch;
    }
  }

  args.sensor = sensor || 'false';
  var path = '/maps/api/streetview';

  return makeRequest(path, args, config('secure'), callback, 'binary');
};

//  Helper function to check and convert an array of points, be it strings/numbers/etc
//    into the format used by Google Maps for representing lists of latitude/longitude pairs
exports.checkAndConvertArrayOfPoints = function(input) {
  switch (typeof input) {
    case 'object':
      if (input instanceof Array) {
        var output = [];
        for (var i = 0; i < input.length; i++) {
          output.push(exports.checkAndConvertPoint(input[i]));
        }
        return output.join('|');
      }
      break;
    case 'string':
      return input;
  }
  throw(new Error("Unrecognized input: checkAndConvertArrayOfPoints accepts Arrays and Strings"));
};

//  Helper function to check and convert an points, be it strings/arrays of numbers/etc
//    into the format used by Google Maps for representing latitude/longitude pairs
exports.checkAndConvertPoint = function(input) {
  switch (typeof input) {
    case 'object':
      if (input instanceof Array) {
        return input[0].toString() + ',' + input[1].toString();
      }
      break;
    case 'string':
      return input;
  }
  throw(new Error("Unrecognized input: checkAndConvertPoint accepts Arrays of Numbers and Strings"));
};

//  Wraps the callback function to convert the output to a javascript object
var returnObjectFromJSON = function(callback) {
  if (typeof callback === 'function') {
    return function(err, jsonString) {

      if (err){
        callback(err);
        return;
      }

      try {
        callback(err, JSON.parse(jsonString));
      } catch (e) {
        callback(e);
      }
    };
  }
  return false;
};

// Algorithm pull from Google's definition of an encoded polyline
//
// https://developers.google.com/maps/documentation/utilities/polylinealgorithm

function createEncodedPolyline(points) {
  // Dear maintainer:
  //
  // Once you are done trying to 'optimize' this routine,
  // and have realized what a terrible mistake that was,
  // please increment the following counter as a warning
  // to the next guy:
  //
  // total_hours_wasted_here = 11
  //
  var i, dlat, dlng;
  var plat = 0;
  var plng = 0;
  var encoded_points = "";
  if(typeof points === 'string'){
    points = points.split('|');
  }

  for(i = 0; i < points.length; i++) {
    var point = points[i].split(',');
    var lat = point[0];
    var lng = point[1];
    var late5 = Math.round(lat * 1e5);
    var lnge5 = Math.round(lng * 1e5);
    dlat = late5 - plat;
    dlng = lnge5 - plng;
    plat = late5;
    plng = lnge5;
    encoded_points += encodeSignedNumber(dlat) + encodeSignedNumber(dlng);
  }
  return encoded_points;
}

exports.createEncodedPolyline = createEncodedPolyline;


function encodeNumber(num) {
  var encodeString = "";
  var nextValue, finalValue;
  while (num >= 0x20) {
    nextValue = (0x20 | (num & 0x1f)) + 63;
    encodeString += (String.fromCharCode(nextValue));
    num >>= 5;
  }
  finalValue = num + 63;
  encodeString += (String.fromCharCode(finalValue));
  return encodeString;
}

function encodeSignedNumber(num) {
  var sgn_num = num << 1;
  if (num < 0) {
    sgn_num = ~(sgn_num);
  }
  return(encodeNumber(sgn_num));
}

function buildUrl(path, args) {
  if (config('google-client-id') && config('google-private-key')) {
    args.client = config('google-client-id');

    var query = qs.stringify(args).split('');
    for (var i = 0; i < query.length; ++i) {
      // request will escape these which breaks the signature
      if (query[i] === "'") query[i] = escape(query[i]);
    }
    query = query.join('');

    path = path + "?" + query;

    // Create signer object passing in the key, telling it the key is in base64 format
    var signer = crypto.createHmac('sha1', config('google-private-key'));

    // Get the signature, telling it to return the sig in base64 format
    var signature = signer.update(path).digest('base64');
    signature = signature.replace(/\+/g,'-').replace(/\//g,'_');
    path += "&signature=" + signature;
    return path;
  } else {
    return path + "?" + qs.stringify(args);
  }
}

// Makes the request to Google Maps API.
// If secure is true, uses https. Otherwise http is used.
var makeRequest = function(path, args, secure, callback, encoding) {
  var maxlen = 2048;
  var consoleKey = config('console-key');

  if (consoleKey){
    // google requires https when including an apiKey
    secure = true;
    args.key = consoleKey;
  }

  path = buildUrl(path, args);

  if (path.length > maxlen) {
    error = new Error("Request too long for google to handle (" + maxlen + " characters).");
    if (typeof callback === 'function') {
      return callback(error);
    }
    throw error;
  }

  var options = {
    uri: (secure ? 'https' : 'http') + '://maps.googleapis.com' + path
  };

  if (encoding) options.encoding = encoding;
  if (config('proxy')) options.proxy = config('proxy');
  if (typeof callback === 'function') {
    request(options, function (error, res, data) {
      if (error) {
        return callback(error);
      }
      if (res.statusCode === 200) {
        return callback(null, data);
      }
      error = new Error(data);
      error.code = res.statusCode;
      return callback(error, data);
    });
  }

  return options.uri;
};

// vim: set expandtab sw=2:
var ejs = require('ejs');
var fs = require("fs");
var bPromise = require('bluebird');
var _ = require('lodash');
//var nPromise = require('nodeify').Promise;
require('nodeify').extend(bPromise);

var Mail = function(params) {

    var postmark = require("postmark");
    var key = requireLocal('config/_keys');

    this.client = new postmark.Client(key.postmark);
}


Mail.prototype.send = function(options, callback) {
    var _this = this;
    return new bPromise(function(resolve, reject) {
        if (!envProd) {
            options.To = 'abel.chalier@gmail.com'
        } else {
            options.Bcc = 'noreply.edison+' + process.env.APP_ENV + '@gmail.com'
        }
        _this.client.sendEmail(options, function(err, success) {
            console.log(options.To, options.Bcc)
            if (err)
                return reject(err);
            return resolve(success)
        })
    }).nodeify(callback);

};
module.exports = Mail;
module.exports = {

  getDirectionPath: function(query, callback) {
    if (!query.origin || !query.destination) {
      return callback(null, []);
    }
    edison.googleMap.directions(query.origin, query.destination, function(err, result) {

      if (!err && result && result.routes && result.routes[0] && result.routes[0].legs && result.routes[0].legs[0]) {

        var steps = result.routes[0].legs[0].steps;
        var rtn = steps.map(function(e) {
          return (e.start_location.lat + ', ' + e.start_location.lng);
        });
        callback(null, rtn)
      } else {
        callback(err ||  result);
      }
    });
  },
  getDistance: function(req, res) {
    var query = req.query
    var _ = require('lodash')
    edison.googleMap.directions(query.origin, query.destination, function(err, result) {
      res.json({
        distance: _.get(result, 'routes[0].legs[0].distance.text', 0),
        duration: _.get(result, 'routes[0].legs[0].duration.text', 0)
      });
    });
  },

  getStaticDirections: function(req, res) {
    var query = req.query;
    var directions = this.getDirectionPath(query, function(err, points) {

      if (err) {
        return res.status(400).send(err);
      }
      markers = [{
        //'icon': 'http://edsx.herokuapp.com//img/gmap/markers/red.png',
        'location': query.origin
      }, {
        //'icon': 'http://edsx.herokuapp.com//img/gmap/markers/blue.png',
        'location': query.destination,
        'color': 'blue',
      }]

      paths = [{
        'color': '0x0000ff',
        'weight': '5',
        'points': points
      }]

      if (!query.height) {
        var coeff = 1 / (query.width / 1000);
        var height = parseInt(400 * coeff);
        var width = parseInt(query.width * coeff);
      } else {
        var height = parseInt(query.height);
        var width = parseInt(query.width);
      }


      var zoom = query.zoom || 9;
      if (!query.origin) {
        markers = [];
        query.origin = "Montlucon, france";
        zoom = 5
      }
      var map = edison.googleMap.staticMap(query.origin, zoom, width + 'x' + height, query.precision || 4,
        function(err, data) {
          res.writeHead(200, {
            'Content-Type': 'image/png'
          });
          res.end(data, 'binary');
        }, false, 'roadmap', markers, null, paths);
    });
  }
}
module.exports = {
    whoAmI: function(req, res) {
        var rtn = req.session.d;
        rtn.TabContainer = undefined;
        res.json(rtn);
    },
    setSessionData: function(req, res) {
        try {
            JSON.parse(req.query.TabContainer);
            req.session.TabContainer = req.query.TabContainer;
            res.sendStatus(200);
        } catch (e) {
            res.send(400, "Invalid JSON tabcontainer");
        }
    },
    getSessionData: function(req, res) {
        return res.sendStatus(500);
        if (req.session.TabContainer && req.session.TabContainer.length > 2) {
            res.json(JSON.parse(req.session.TabContainer))
        } else {
            res.status(410).send("Session has no TabContainer");
        }
    },
    ping: function(req, res) {
        res.send("ok");
    },
    mapGetDistance: function(req, res) {
        return edison.map.getDistance(req, res);
    },
    mapGetStatic: function(req, res) {
        return edison.map.getStaticDirections(req, res);
    },
    memory: function(req, res) {
        var prettyBytes = require('pretty-bytes');
        var _ = require('lodash')
        var u = process.memoryUsage();
        u = _.map(u, prettyBytes);
        console.log(u)
        res.send(u)
    },
    bfm: function(req, res) {
        var moment = require('moment');
        var _ = require('lodash');
        db.model('event')
            .find({
                date: {
                    $gt: moment({
                        hour: 0
                    }).toDate()
                }
            })
            .sort('field -date')
            .exists('message')
            .select('date message -_id')
            .limit(10)
            .then(res.json.bind(res))
    }
}
var MD5 = require('md5')
var _ = require("lodash");
var requestp = require("request-promise")
var Mobyt = function(user, pass) {

    this.user = user;
    this.pass = pass;

}

Mobyt.prototype.getTicket = function(params) {
    return MD5(_.reduce(params, function(total, p) {
        return total += p;
    }))
}

Mobyt.prototype.getStatus = function(params) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        var id;

        var requestStatus = function(doc) {
            var f = {
                user: _this.user,
                pass: _this.pass,
                id: doc.id,
                type: "notify",
                schema: 1
            }
            f.ticket = _this.getTicket([f.user, f.id, f.type, f.schema, MD5(f.pass)]);
            requestp.post({
                url: 'http://multilevel.mobyt.fr/sms/batch-status.php',
                form: f
            }).then(function(result) {
                var log = result.split(',');
                if (log.length === 9) {
                    resolve(parseInt(log[7]));
                } else {
                    reject(log);
                }
            })
        }

        if (typeof params === 'object')
            id = params.id
        else
            id = params;
        db.model('sms').findOne({
            id: id
        }).then(requestStatus, reject)
    })
}


Mobyt.prototype.send = function(params) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        if (!params.text || !params.to) {
            return reject("Invalid Parameters");
        }
        var f = {
            user: _this.user,
            pass: _this.pass,
            data: params.text + "\nSTOP 36608",
            rcpt: params.to.length == 10 ? params.to.replace('0', '+33') : params.to,
            sender: 'Edison Srv.',
            qty: 'n',
            operation: 'MULTITEXT',
            domaine: "http://multilevel.mobyt.fr",
            return_id: "1",
        };
        f.ticket = _this.getTicket([f.user, f.rcpt, f.sender, f.data, f.qty, MD5(f.pass)])
        requestp.post({
                url: 'http://multilevel.mobyt.fr/sms/send.php',
                form: f
            })
            .then(function(response) {
                console.log('===>', response)
                if (response.startsWith('OK')) {
                    params.id = response.substr(3);
                    resolve(params);
                } else {
                    reject(response);
                }
            }, function(err) {
                console.log('===>', err)

                reject(err);
            });
    });

};

module.exports = Mobyt;
var MD5 = require('md5')
var _ = require("lodash");
var requestp = require("request-promise")
var OVH = function() {

    this.service = require('ovh')({
        appKey: 'UTdTvZ5KCBp2TOXf',
        appSecret: 'VQAjm5IKFHYY5knjORqhUnsWNCCtswJy',
        consumerKey: 'GBa7hS3IFsxErDzvdq6jxGegUIeMcFoL'
    });

}

OVH.prototype.send = function(params) {
    var _this = this;
    return new Promise(function(resolve, reject) {
        if (!params.text || !params.to) {
            return reject("Invalid Parameters");
        }
        _this.service.request('GET', '/sms', function(err, serviceName) {

            if (err) {
                return reject(err);
            } else {
                var dest = (params.to.length == 10 ? params.to.replace('0', '0033') : params.to);
                _this.service.request('POST', '/sms/' + serviceName + '/jobs', {
                    message: params.text,
                    senderForResponse: true,
                    receivers: [dest]
                }, function(errsend, result) {
                    if (!err)  {
                        mail.send({
                            From: "contact@edison-services.fr",
                            To: "noreply.edison+sms@gmail.com",
                            Subject: "New SMS Send to " + params.to,
                            HtmlBody: params.text.replaceAll('\n', '<br>'),
                        })
                    }
                    console.log(errsend, result);
                    return resolve('ok')
                });
            }
        });

    });
};


OVH.prototype.jobs = function() {
    console.log('NTM')
    var _this = this;
    return new Promise(function(resolve, reject) {

        _this.service.request('GET', '/sms', function(err, serviceName) {
            console.log(err, serviceName)
            if (err) {
                return reject(err);
            } else {
                _this.service.request('GET', '/sms/' + serviceName + '/jobs/' + '42911188', {}, function(errsend, result) {
                    console.log(errsend, result);
                    return resolve('ok')
                });
            }
        });

    });

};
/*var x = new OVH;
x.jobs().then(function() {

})*/

module.exports = OVH;
var PdfCreator = function(params) {
    if (!(this instanceof PdfCreator)) {
        return new PdfCreator(params);
    }
    var _this = this;
    return new Promise(function(resolve, reject) {
        _this.renderTemplate(params.template, params.args)
            .then(function(renderedTemplate) {
                if (params.html) {
                    resolve(renderedTemplate);
                } else if (params.buffer) {
                    _this.createBuffer(renderedTemplate).then(resolve, reject)
                } else {
                    _this.createFile(renderedTemplate, params.fileName).then(resolve, reject)
                }
            }, reject)
    });
}

PdfCreator.prototype.renderTemplate = function(templateName, args) {
    var fs = require('fs');
    var ejs = require('ejs');
    var fileName = process.cwd() + '/server/pdf/' + templateName + '.html';

    return new Promise(function(resolve, reject) {
        fs.readFile(fileName, 'utf8', function(err, template) {
            if (err) return reject(err);
            try {
                var tmp = ejs.render(template, args)
                resolve(tmp);
            } catch (e) {
                console.log(e);
                reject("error while generating pdf")
            }
        });
    })
}

PdfCreator.prototype.createFile = function(htmlString, fileName)  {
    var pdf = require('html-pdf');

    return new Promise(function(resolve, reject) {
        pdf.create(htmlString).toFile(fileName, function(err, result) {
            if (err) reject(err);
            resolve(result);
        });
    });
}

PdfCreator.prototype.createBuffer = function(htmlString)  {
    var pdf = require('html-pdf');

    return new Promise(function(resolve, reject) {
        pdf.create(htmlString).toBuffer(function(err, buffer) {
            if (err) reject(err);
            resolve(buffer);
        });
    });
}

module.exports = PdfCreator;
module.exports = function() {
    var async = require('async');
    var redis = require("redis");
    redis.RedisClient.prototype.delWildcard = function(key, callback) {
        var redis = this

        redis.keys(key, function(err, rows) {
            async.each(rows, function(row, callbackDelete) {
                redis.del(row, callbackDelete)
            }, callback)
        });
    }


    var redisClient;
    try {

        if (envProd || envStaging) {
            var url = require('url');
            var redisURL = url.parse(process.env.REDISCLOUD_URL);
            redisClient = redis.createClient(redisURL.port, redisURL.hostname, {
                no_ready_check: true
            });

            redisClient.auth(redisURL.auth.split(":")[1]);

        } else {
            redisClient = redis.createClient();
        }


        redisClient.on("error", function(err) {
            console.log("Redis Error " + err);
        });

    } catch (e) {
        __catch(e);
    }
    return redisClient;
}
module.exports = function(req, res) {
    var rtn = [];
    var async = require('async');
    var moment = require('moment-timezone')
    var _ = require('lodash');
    var regexpAccents = require('regexp-accents');
    _.templateSettings.interpolate = /{{([\s\S]+?)}}/g;
    var query = req.params.text;

    var createFilter = function(options) {
        return function(cb) {
            if (options.regexp && !query.match(options.regexp)) {
                return cb(null, [])
            }
            db.model(options.model || 'intervention')
                .find(options.query ||  {})
                .sort('-id')
                .limit(req.query.limit)
                .then(function(resp) {
                    var mapFunc = options.mapFunc || function(e) {
                        e.mmt = moment.tz(e.date.intervention, 'Europe/Paris').format("DD/MM")
                            //console.log(options.pre ||  '#')
                        _.set(e, 'artisan.nomSociete', _.get(e, 'artisan.nomSociete', 'A Programmer'))
                        e.artisan.nomSociete = e.artisan.nomSociete ||  'A Programmer'
                        return {
                            link: ['', (options.model ||  'intervention'), e.id].join('/') + (options.link ||  ''),
                            description: (options.pre ||  '#') + _.template(options.template || "{{id}} - {{mmt}} - {{client.civilite}} {{client.nom}} -  {{client.address.cp}} {{client.address.v}}  - {{artisan.nomSociete}} - {{status}} - {{prixAnnonce}} €")(e)
                        }
                    };
                    var rtn = resp.map(mapFunc);
                    cb(null, rtn)
                }, cb);
        }
    }

    var rgx = {
        $regex: regexpAccents(query, true)
    };

    var filters = {
        interventionNom: createFilter({
            query: {
                'client.nom': rgx
            }
        }),
        interventionId: createFilter({
            query: {
                id: parseInt(query)
            },
            regexp: new RegExp('^[0-9]+$')
        }),
        interventionTelephone: createFilter({
            query: {
                $or: [{
                    'client.telephone.tel1': rgx
                }, {
                    'client.telephone.tel2': rgx
                }, {
                    'client.telephone.tel3': rgx
                }]
            },
            regexp: new RegExp('^[0-9]+$'),
            mapFunc: function(inter) {
                var t = inter.client.telephone;
                inter.mmt = moment.tz(inter.date.intervention, 'Europe/Paris').format("DD/MM")
                inter.telMatch = t.tel1.startsWith(query) ? t.tel1 : t.tel2.startsWith(query) ? t.tel2 : t.tel3;
                return {
                    link: '/intervention/' + inter.id,
                    description: _.template("{{id}} - {{mmt}} - ({{telMatch}}) - {{client.civilite}} {{client.nom}} -  {{client.address.cp}} {{client.address.v}} {{prixAnnonce}} €")(inter)
                }
            }
        }),
        interventionCodePostal: createFilter({
            query: {
                'client.address.cp': rgx
            },
            regexp: new RegExp('^[0-9]+$'),
            template: "{{id}} - {{mmt}} - ({{client.address.cp}}) - {{client.civilite}} {{client.nom}} - {{client.address.v}} {{prixAnnonce}} €"
        }),
        interventionVille: createFilter({
            query: {
                'client.address.v': rgx
            },
            regexp: new RegExp('^[^0-9]+$'),
            template: "{{id}} - {{mmt}} - ({{client.address.v}}) - {{client.civilite}} {{client.nom}} - {{client.address.cp}} {{prixAnnonce}} €"

        }),
        artisanId: createFilter({
            model: 'artisan',
            pre: '@',
            link: '/recap',
            query: {
                id: parseInt(query)
            },
            template: "{{id}} ({{nomSociete}}) - {{representant.nom}} - {{address.cp}}",
            regexp: new RegExp('^[0-9]+$')
        }),
        artisanNom: createFilter({
            pre: '@',
            model: 'artisan',
            link: '/recap',
            query: {
                $or: [{
                    'representant.nom': rgx
                }, {
                    'nomSociete': rgx
                }]
            },
            template: "{{id}} ({{nomSociete}}) - {{representant.nom}} - {{address.cp}}"

        }),
        artisanVille: createFilter({
            pre: '@',
            model: 'artisan',
            link: '/recap',
            query: {
                'address.v': rgx
            },
            template: "{{id}} ({{address.v}}) - {{nomSociete}} - {{address.cp}}"

        }),
        artisanCP: createFilter({
            pre: '@',
            model: 'artisan',
            link: '/recap',
            query: {
                'address.cp': rgx
            },
            template: "{{id}} ({{address.cp}}) - {{nomSociete}} - {{address.v}}"

        }),
        artisanTelephone: createFilter({
            pre: '@',
            model: 'artisan',
            link: '/recap',
            query: {
                $or: [{
                    'telephone.tel1': rgx
                }, {
                    'telephone.tel2': rgx
                }]
            },
            regexp: new RegExp('^[0-9]+$'),
            mapFunc: function(artisan) {
                var t = artisan.telephone;
                artisan.telMatch = t.tel1.startsWith(query) ? t.tel1 : t.tel2.startsWith(query) ? t.tel2 : t.tel3;
                return {
                    link: '/artisan/' + artisan.id + '/recap',
                    description: _.template("@{{id}} ({{address.telMatch}}) - {{nomSociete}} - {{address.cp}} {{address.v}} ")(artisan)
                }
            }
        }),
        devisNom: createFilter({
            model: 'devis',
            pre: "Dev.",
            query: {
                'client.nom': rgx
            }
        }),
        devisId: createFilter({
            model: 'devis',
            pre: "Dev.",
            query: {
                id: parseInt(query)
            },
            regexp: new RegExp('^[0-9]+$')
        }),
        devisTelephone: createFilter({
            model: 'devis',
            pre: "Dev.",
            query: {
                $or: [{
                    'client.telephone.tel1': rgx
                }, {
                    'client.telephone.tel2': rgx
                }, {
                    'client.telephone.tel3': rgx
                }]
            },
            regexp: new RegExp('^[0-9]+$'),
            mapFunc: function(inter) {
                var t = inter.client.telephone;
                inter.telMatch = t.tel1.startsWith(query) ? t.tel1 : t.tel2.startsWith(query) ? t.tel2 : t.tel3;
                return {
                    link: '/devis/' + inter.id,
                    description: _.template("#{{id}} ({{telMatch}}) - {{client.civilite}} {{client.nom}} -  {{client.address.cp}} {{client.address.v}}")(inter)
                }
            }
        }),
        devisCodePostal: createFilter({
            model: 'devis',
            pre: "Dev.",
            query: {
                'client.address.cp': rgx
            },
            regexp: new RegExp('^[0-9]+$'),
            template: "{{id}} ({{client.address.cp}}) - {{client.civilite}} {{client.nom}} - {{client.address.v}}"
        }),
        devisVille: createFilter({
            query: {
                'client.address.v': rgx
            },
            regexp: new RegExp('^[^0-9]+$'),
            template: "{{id}} ({{client.address.v}}) - {{client.civilite}} {{client.nom}} - {{client.address.cp}}"

        }),
    }

    async.parallel(filters, function(err, result) {
        //console.log('-->', err, '<--', result);
        var rtn = [];
        _.each(result, function(e, k) {
            _.each(e, function(r) {
                r.match = k;
                rtn.push(r)
            })
        })
        res.json(rtn)
    })
}
module.exports = function(req, res) {

    var moment = require('moment');
    var async = require('async');
    var _ = require('lodash');
    var day = moment().hour(4).toDate()
    console.log(day)

    var promiseFactory = function(match) {

        return function(cb) {
            match['date.ajout'] =
                db.model('intervention')
                .aggregate()
                .match(match)
                .group({
                    _id: "$login.ajout",
                    count: {
                        $sum: 1
                    },
                    montant: {
                        $sum: '$prixAnnonce'
                    }
                })
                .exec(function(err, resp) {
                    if (err) {
                        return cb(err)
                    }
                    cb(null, resp)
                });
        }
    }




    var P = {
        enc: promiseFactory({
            'date.ajout': {
                $gt: day
            },
            status: 'ENC'
        }),
        all: promiseFactory({
            'date.ajout': {
                $gt: day
            },
        }),
        apr: promiseFactory({
            'date.ajout': {
                $gt: day
            },
            status: 'APR'
        })
    }
    async.parallel(P, function(err, resp) {

        var xfind = function(name, login) {
            var fnd = _.find(resp[name], '_id', login)
            return fnd ? {
                montant: _.round(fnd.montant, 2),
                count: _.round(fnd.count, 2)
            } : {
                count: 0,
                montant: 0
            }
        }

        var rtn = {};
        db.model('user').find({
                service: 'INTERVENTION',
                activated: true
            })
            .then(function(users) {
                //  console.log(users)
                _.each(users, function(usr) {
                    rtn[usr.login] = {}
                    _.each(P, function(x, fltr) {
                        rtn[usr.login][fltr] = xfind(fltr, usr.login)
                    })
                })
                res.json(rtn);
            })
    })


}
var users = requireLocal('config/_users');
var ms = require('milliseconds');
var async = require('async')
var _ = require("lodash")
var FiltersFactory = requireLocal('config/FiltersFactory');

var statusDistinctFactory = function(model, customMatch, customGroup) {
    var match = customMatch || {};
    return function(cb) {
        db.model(model ||  'intervention')
            .aggregate()
            .match(match)
            .group({
                _id: {
                    telepro: customGroup || '$login.ajout'
                },
                mnt: {
                    $sum: "$prixAnnonce"
                },
                total: {
                    $sum: 1
                }
            })
            .project({
                _id: 1,
                name: '$_id.st',
                login: '$_id.telepro',
                total: 1,
                montant: db.utils.round("$mnt")
            }).exec(cb);
    }
}


var cleanStatus = function(intersStatus) {
    intersStatus = _.indexBy(intersStatus, 'name')
    intersStatus = _.mapValues(intersStatus, function(e) {
        delete e._id
        delete e.login
        delete e.name
        return e;
    })
    return intersStatus;
}

var cleanUp = function(name, telepro, result) {
    telepro[name] = _.get(result, name + '.' + telepro.login + '[0]', {
        montant: 0,
        total: 0
    });
    if (telepro[name] !== {}) {
        delete telepro[name]._id;
        delete telepro[name].login;
    };
    return telepro[name];

}

var mergeFilters = function(allFilters, model) {
    var filters = FiltersFactory(model).getAllFilters();
    _.each(filters, function(e) {
        if (e.stats !== false && e.match) {
            var match = typeof e.match === 'function' ? e.match() : e.match;
            allFilters[e.short_name] = statusDistinctFactory(model, match, e.group);
        }
    });
}



module.exports = {
    reload: _.throttle(function() {
        return new Promise(function(resolve, reject) {

            try {
                var allFilters = {};
                mergeFilters(allFilters, 'intervention')
                mergeFilters(allFilters, 'devis')
                mergeFilters(allFilters, 'artisan')
                console.time('allFilters')
                async.parallel(allFilters, function(err, result) {
                    console.timeEnd('allFilters')
                    if (err)
                        reject(err)
                    result = _.mapValues(result, function(e) {
                        return _.groupBy(e, 'login')
                    })
                    var rtn = [];
                    var sum = {}
                    users.forEach(function(user) {
                        var telepro = {
                            login: user.login,
                        }
                        _.each(result, function(fltr, key) {
                            cleanUp(key, telepro, result);
                        })
                        if (telepro._id) {
                            delete telepro._id;
                        }
                        rtn.push(telepro);
                    });
                    redis.set('statsTelepro'.envify(), JSON.stringify(rtn), function() {
                        if (typeof io !== 'undefined') {
                            io.sockets.emit('filterStatsReload', rtn);
                        }
                        return resolve(rtn);
                    });

                });
            } catch (e) {
                __catch(e)
            }
        });
    }, 5000),
    get: function(req, res) {
        var _this = this;
        redis.get('statsTelepro'.envify(), function(err, reply) {
            if (!err && reply && !req.query.cache) {
                return res.jsonStr(reply)
            } else {
                return _this.reload().then(res.json.bind(res))
            }
        })
    }
}var Timer = module.exports = function() {
    var CronEmitter = require("cron-emitter").CronEmitter;

    var hour = function(h) {
        var moment = require('moment-timezone')
        return moment.tz('Europe/Paris').hour(h).format('[0] H [* * *]')
    }

    this.emitter = new CronEmitter();

    //    this.emitter.add("*/10 * * * *", "every 10 minutes");
    //    this.emitter.add("*/120 * * * *", "every hour");
    //    this.emitter.add("*/5 * * * *", "every 5 minutes");
    // this.emitter.add("*/2 * * * *", "every minute");
    this.emitter.add(hour(20), "everyday at 20")
    this.emitter.add(hour(7), "everyday at 7")
    this.emitter.add(hour(14), "everyday at 14")
    this.emitter.add(hour(3), "3pm");
    this.emitter.add(hour(4), "4pm");
    this.emitter.add("*/60 * * * *", "hour")
    this.emitter.add("*/20 * * * *", "20 minutes")

    /*    this.emitter.on("every 10 minutes", function() {
            edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'cacheReload'
            })
        });*/

    this.emitter.on("everyday at 20", function() {
        if (envProd) {
            db.model('intervention').relanceAuto();
        }
    });

    this.emitter.on("everyday at 7", function() {
        if (envProd) {
            db.model('devis').relanceAuto7h()
        }
    });


    this.emitter.on("everyday at 14", function() {
        if (envProd) {
            db.model('devis').relanceAuto14h()
        }
    });


    this.emitter.on("hour", function() {
        if (envProd) {
            db.model('intervention').rappelDateIntervention()
        }
    });

    this.emitter.on("hour", function() {
        db.model('intervention').fullReload().then(function() {
            console.log('inter ok')
        })
        db.model('devis').fullReload().then(function() {
            console.log('devis ok')
        })
    })
    this.emitter.on("20 minutes", function() {

        var req = {
            query: {}
        }
        if (envProd) {
            db.model('document').check(req).then(function() {
                db.model('document').archiveScan(req).then(function() {
                    db.model('document').order(req).then(function() {
                        console.log('DocumentFullCheck [DONE]')
                    })
                })
            })
        }

    })
    this.emitter.on("3pm", function() {
        redis.delWildcard("rs*")
    })
    this.emitter.on("4pm", function() {
        if (envProd) {
            db.model('intervention').backup(function() {
                console.log('backup [DONE]')
            })
        }
    })

    /*    this.emitter.on("every 5 minutes", function() {
            edison.worker.createJob({
                name: 'db',
                model: 'sms',
                method: 'refreshStatus'
            })
        })
        this.emitter.on("every hour", function() {
            edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'workerDump',
                arg: 25000
            }).then(function() {
                edison.worker.createJob({
                    name: 'db',
                    model: 'devis',
                    method: 'workerDump',
                    arg: 25000
                })
            })
        })*/
    var test = function() {
            var parser = require('cron-parser');
            try {
                var interval = parser.parseExpression(hour(7));
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
                console.log('Date: ', interval.next().toString()); // Sat Dec 29 2012 00:44:00 GMT+0200 (EET) 
            } catch (err) {
                console.log('Error: ' + err.message);
            }

        }
        //  test();


}
var Users = function() {
    var _this = this;
    db.model('user').find().select('-password').then(function(resp) {
        _this.data = resp;
    })
}
Users.prototype.data = null;
Users.prototype.list = function() {
    return this.data
}


Users.prototype.get = function(login) {
    var _ = require('lodash')
    return _.find(this.data, 'login', login)
}

Users.prototype.search = function(oldLogin) {
    var _ = require('lodash')
    if (!this.data) {
        return 'auto_x';
    }
    var rtn = _.find(this.data, function(e) {
        return e.oldLogin === oldLogin;
    })
    if (!rtn) {
        return oldLogin;
    } else {
        return rtn.login
    }
}

Users.prototype.service = function(service) {
    var _ = require('lodash')

    return _(this.data).filter({
        activated: true,
        service: service
    }).pluck('login').value()
}

Users.prototype.find = function(login) {
    var _ = require('lodash')
    if (!this.data) {
        return 'auto_x';
    }
    var rtn = _.find(this.data, function(e) {
        return e.login === login;
    })
    if (!rtn) {
        return login;
    } else {
        return rtn.oldLogin
    }
}

module.exports = Users;
module.exports = {
    initJobQueue: function() {
        var kue = require("kue");
        var url = require("url");
        if (envProd || envStaging) {
            var redisURL = url.parse(process.env.REDISCLOUD_URL);
            var redisOptions = {
                port: redisURL.port,
                host: redisURL.hostname,
                auth: redisURL.auth.split(":")[1],
            }
        }
        return kue.createQueue({
            prefix: 'kue'.envify(),
            redis: redisOptions ||  undefined,
            disableSearch: false
        })
    },
    createJob: function(options) {
        return new Promise(function(resolve, reject) {
            var job = jobs.create(options.name, options);
            job.on('complete', resolve).on('failed', reject).on('progress', function(progress, data) {
                io.sockets.emit(options.model + "_" + options.name + '_' + options.method, progress);
            });
            job.removeOnComplete(true).ttl(600000).save()
        })
    }
}
module.exports = function(db) {

    return new db.Schema({
        t: {
            type: String,
            index: true
        },
        e:{
            type:String,
            index:'text'
        }
    });

}
module.exports = function(model) {

}
    var _ = require('lodash');
    module.exports = {
        name: 'artisan',
        Name: 'Artisan',
        NAME: 'ARTISAN',
        redisCacheListName: 'ARTISAN_CACHE_LIST',
        listChange: 'ARTISAN_CACHE_LIST_CHANGE'
    }

    module.exports.redisTemporarySaving = function(id) {
        return 'ARTISAN_TMP_SAVING___' + id;
    }
    module.exports.model = function() {
        return db.model('artisan');
    }

    module.exports.singleDumpUrl = function(id) {
        var key = requireLocal('config/_keys');
        // TODO
        return key.alvin.url + "/dumpArtisan.php?key=" + key.alvin.pass + '&id=' + id
    }

    module.exports.multiDumpUrl = function(limit) {
        var key = requireLocal('config/_keys');
        return key.alvin.url + "/dumpArtisan.php?key=" + key.alvin.pass + "&limit=" + (limit || 0)
    }


    module.exports.defaultDoc = function(timestamp) {
        return {
            origin: 'DEM',
            telephone: {},
            pourcentage: {
                deplacement: 50,
                maindOeuvre: 30,
                fourniture: 30
            },
            zoneChalandise: 30,
            address: {},
            categories: [],
            representant: {
                civilite: 'M.'
            },
        }
    }


    module.exports.minify = function(e) {
        var config = requireLocal('config/dataList')
        var d = requireLocal('config/dates.js')
        var ms = require('milliseconds')

        return {
            da: d(e.date.ajout),
            t: e.login.ajout,
            mn: e.login.management,
            c: e.categories,
            id: e._id,
            n: e.nomSociete,
            tl: e.telephone.tel1,
            r: e.representant.civilite + " " + e.representant.nom,
            p: e.representant.prenom,
            s: e.status,
            ss: e.subStatus,
            cp: e.address.cp,
            v: e.address.v,
            x: e.telephone.tel1,
            cnd: e.origin === 'CAND' ? 1 : undefined,
        };
    }



    module.exports.preUpdate = function(prev, curr, session) {
        //    prev.historique = [];
        //  curr.historique = [];
    }

















    module.exports.toV2 = function(d) {

        var config = requireLocal('config/dataList');
        try {



            var rtn = {
                _id: d.id,
                id: d.id,
                nomSociete: d.nom_societe,
                categories: [],
                email: d.email || "test@test.me",
                login: {
                    ajout: edison.users.search(d.ajoute_par),
                    management: edison.users.search(d.ajoute_par)
                },
                date: {
                    ajout: d.date_ajout ? ((d.date_ajout + 60 * 12) * 1000) : Date.now()
                },
                telephone: {
                    tel1: d.tel1,
                    tel2: d.tel2,
                },
                representant: {
                    nom: d.nom_representant,
                    prenom: d.prenom_representant,
                    civilite: d.civilite ||  "M."
                },
                pourcentage: {
                    deplacement: d.pourcentage_deplacement || 30,
                    maindOeuvre: d.pourcentage_main_d_oeuvre || 30,
                    fourniture: d.pourcentage_fourniture || 30
                },
                zoneChalandise: d.zone_chalandise ? d.zone_chalandise.slice(0, -2) : 30,
                address: {
                    n: d.numero || "1",
                    r: d.adresse,
                    v: d.ville,
                    cp: d.code_postal,
                    lt: d.lat,
                    lg: d.lng,
                },
                origin: d.candidat_sst === void(0) || d.candidat_sst === "0" ? "DEM" : "CAND",
                historique: {},
                siret: d.siret || undefined,
                loc: [parseFloat(d.lat), parseFloat(d.lng)],
            };

            if (d.num_facturier || d.num_deviseur) {
                rtn.historique.pack = [{
                    text: d.num_facturier,
                    login: 'yohann_r',
                    deviseur: d.num_deviseur,
                    facturier: d.num_facturier,
                }]
            }
            if (d.date_envoi_contrat && d.date_envoi_contrat.length >= 8) {
                var months = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "aout", "septembre", "octobre", "novembre", "décembre"]
                var x = d.date_envoi_contrat.split(' ');
                rtn.historique.contrat = [{
                    date: new Date(parseInt(x[5]), months.indexOf(x[4]), parseInt(x[3]), 12),
                    text: d.date_envoi_contrat,
                    login: 'yohann_r',
                    signe: x[8] !== 'NON'
                }]
            }

            rtn.info = {
                travailSamedi: d.travail_samedi,
                pasFiable: d.pas_fiable
            }

            if (d.BIC && d.BIC !== "aucun  BIC") {
                rtn.BIC = d.BIC
            }
            if (d.IBAN && d.IBAN !== "aucun IBAN") {
                rtn.IBAN = d.IBAN
            }
            var fj = _.find(config.formeJuridiqueHash(), function(e) {
                return e.long_name.toUpperCase() === d.forme_juridique;
                //       console.log(e.long_name.toUpperCase(), d.forme_juridique)
            })
            rtn.formeJuridique = fj ? fj.short_name : 'AUT'
            if (d.archive === '1') {
                rtn.status = "ARC"
            }
            _.each(config.categories, function(e, k) {
                var cat = _.deburr(e.long_name).toLowerCase();
                if (d[cat] && d[cat] == 1) {
                    rtn.categories.push(e.short_name);
                }
            })
            var path = require("path")
            rtn.document = {};
            _.each(config.artisanFiles, function(file) {
                if (d[file]) {
                    rtn.document[file] = {
                        extension: path.extname(d[file]),
                        file: d[file],
                        date: rtn.date.ajout,
                        login: 'yohann_r',
                        ok: true
                    }
                }
            })
            rtn.comments = [];
            _.each(d.coms, function(e) {
                rtn.comments.push({
                    login: e.ajoute_par,
                    date: new Date(parseInt(e.t_stamp * 1000)),
                    text: e.comment
                })
            })
        } catch (e) {
            __catch(e)
        }
        return _.omit(rtn, _.isUndefined);
    }
module.exports = function(db) {

    return new db.Schema({
        _id: Number,
        id: {
            type: Number,
            index: true

        },
        origin: String,
        status: {
            type: String,
            default: 'POT'
        },
        subStatus: String,
        date: {
            dump: Date,
            ajout: {
                type: Date,
                default: Date.now
            }
        },
        newOs: Boolean,
        login: {
            management: String,
            ajout: String,
        },
        origine: String, //CND/PRP
        nomSociete: {
            type: String,
            required: true,
        },
        formeJuridique: {
            type: String,
            required: true
        },
        representant: {
            civilite: String,
            nom: {
                type: String,
                required: true
            },
            prenom: String,
        },
        address: {
            n: {
                type: String,
                required: true
            },
            r: {
                type: String,
                required: true
            },
            v: {
                type: String,
                required: true
            },
            cp: {
                type: String,
                required: true
            },
            etage: String,
            code: String,
            lt: Number,
            lg: Number,
        },
        pourcentage: {
            deplacement: {
                type: Number,
                required: true
            },
            maindOeuvre: {
                type: Number,
                required: true
            },
            fourniture: {
                type: Number,
                required: true
            },
        },
        zoneChalandise: {
            type: Number,
            required: true
        },
        loc: {
            type: [Number],
            index: '2dsphere'
        },
        quarantained: Boolean,
        absence: [{
            start: Date,
            end: Date,
            login: String,
            date: Date
        }],
        categories: [],
        email: {
            type: String,
            required: true
        },
        telephone: {
            tel1: {
                type: String,
                required: true
            },
            tel2: String
        },
        document: {
            contrat: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            kbis: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            cni: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            autre: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            assurance: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            rib: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
            ursaff: {
                file: String,
                ok: Boolean,
                extension: String,
                date: Date,
                login: String
            },
        },
        comments: [{
            login: String,
            text: String,
            date: Date
        }],
        aSurveiller: Boolean,
        historique: {
            pack: [{
                date: {
                    type: Date,
                    default: Date.now
                },
                facturier: Boolean,
                deviseur: Boolean,
                text: String,
                login: String,
            }],
            contrat: [{
                date: {
                    type: Date,
                    default: Date.now
                },
                text: String,
                login: String,
                signe: Boolean
            }],
        },
        signalements: [{
            date: Date,
            login: String,
            type: String,
        }],
        info: {
            travailSamedi: Boolean,
            pasFiable: Boolean
        },
        BIC: String,
        IBAN: String,
        nbrIntervention: Number,
        siret: String,
        cache: {}
    });
}
module.exports = function(schema) {
    var V1 = requireLocal('config/_convert_artisan_V1.js');
    var moment = require('moment');

    var getSubStatus = function(sst) {
        var _ = require('lodash');
        var d = sst.document;
        if (sst.quarantained) {
            return 'QUA';
        }
        if (sst.status === "POT" && _.get(d.contrat, 'ok') && _.get(d.cni, 'ok') && _.get(d.kbis, 'ok')) {
            return 'HOT';
        }
        if ((sst.nbrIntervention < 5 && sst.nbrIntervention > 0) && moment().add(-30, "days").isBefore(sst.date.ajout)) {
            return "NEW";
        }
        if (sst.nbrIntervention > 15) {
            return "REG";
        }
    }


    schema.pre('save', function(next) {
        console.log('SAVE')
        var _this = this;
        _this.loc = [_this.address.lt, _this.address.lg]
        if (_this.status !== 'ARC') {

            var async = require('async');
            async.parallel({
                nbrIntervention: function(cb) {
                    db.model("intervention").count({
                        'artisan.id': _this.id
                    }).count(cb)
                },
                quarantained: function(cb) {
                    db.model('signalement').count({
                        sst_id: _this.id,
                        level: '2',
                        ok: false
                    }).count(cb)
                }
            }, function(err, result) {
                _this.quarantained = result.quarantained;
                _this.nbrIntervention = result.nbrIntervention;
                _this.status = result.nbrIntervention ? "ACT" : "POT";
                _this.subStatus = getSubStatus(_this);
                _this.cache = db.model('artisan').Core.minify(_this);
                next();
            })

        } else {
            _this.subStatus = null;
            _this.cache = db.model('artisan').Core.minify(_this);
            next();
        }
    });
    schema.post('save', function(doc) {
        if (!isWorker) {
            db.model('artisan').uniqueCacheReload(doc)
                //    console.log(envProd, doc.date.dump, Date.now(), moment().subtract(5000).isAfter(doc.date.dump))
            if (envProd && (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump))) {
                var v1 = new V1(doc);
                v1.send(function(resp) {
                    console.log(resp)
                });
            }
        }
    })
}
module.exports = function(db) {

    return new db.Schema({
        id_call: String,
        id_sst: Number,
        id_intervention: Number,
        status_code: Number,
        status:String,
        duration:Number,
        redirect_to: String,
        date: {
            type: Date,
            default: Date.now
        },
        _type: String, //CONTACT/CALLBACK
    });

}

module.exports = function(schema) {


/*    schema.pre('save', function(next) {
    	var _ = require('lodash');
        var _this = this;
        this.pseudo = _.startCase(this.pseudo);
        next();
    });
*/
}
module.exports = function(db) {

    return new db.Schema({
        title: {
            type: String,
            required: true
        },
        ref: {
            type: String,
            required: true
        },
        produits: {
            type: Array,
            required: true
        },
        text: {
            type: String,
            required: true
        }
    });

}
module.exports = function(schema) {

}
module.exports = function(db) {

    return new db.Schema({
        relance: String,
        compte: String,
        ref: String,
        payeur: String,
        nom: String,
        prenom: String,
        tel: String,
        tel2: String,
        email: String,
        address: {
            n: String,
            r: String,
            v: String,
            cp: String,
        },
    });

}
module.exports = function(schema) {

}
    var _ = require('lodash');
    module.exports = {
        name: 'devis',
        Name: 'Devis',
        NAME: 'DEVIS',
        redisCacheListName: 'DEVIS_CACHE_LIST',
        listChange: 'DEVIS_CACHE_LIST_CHANGE'
    }

    module.exports.redisTemporarySaving = function(id) {
        return 'DEVIS_TMP_SAVING___' + id;
    }
    module.exports.model = function() {
        return db.model('devis');
    }

    module.exports.singleDumpUrl = function(id) {
        var key = requireLocal('config/_keys');
        return key.alvin.url + "/dumpIntervention.php?devis=true&id=" + id + "&key=" + key.alvin.pass;
    }

    module.exports.multiDumpUrl = function(limit) {
        var key = requireLocal('config/_keys');
        return key.alvin.url + "/dumpDevis.php?devis=true&limit=" + limit + "&key=" + key.alvin.pass
    }


    module.exports.defaultDoc = function(timestamp) {
        var ms = require('milliseconds')
        return {
            isDevis: true,
            produits: [],
            tva: 10,
            client: {
                civilite: 'M.'
            },
            date: {
                ajout: Date.now(),
            },
            historique: []
        }
    }


    module.exports.minify = function(e) {
        var config = requireLocal('config/dataList')
        var d = requireLocal('config/dates.js')
        var ms = require('milliseconds')
        var _ = require('lodash')
        var rtn = {
            da: d(e.date.ajout),
            t: e.login.ajout,
            c: e.categorie,
            cx: config.categories[e.categorie || 'PL'].long_name,
            id: e._id,
            n: e.client.civilite + " " + e.client.nom + ' ' + e.client.prenom,
            s: e.status,
            sx: config.etatsDevis[e.status].long_name,
            cp: e.client.address.cp,
            ad: e.client.address.v,
            ev: e.historique.length,
            pa: e.prixAnnonce,
        };
        return _.omit(rtn, _.isUndefined);

    }



    module.exports.preUpdate = function(prev, curr, session) {
        prev.historique = [];
        curr.historique = [];
    }

















    module.exports.toV2 = function(d) {

        var config = requireLocal('config/dataList');
        var sanitizeHtml = require('sanitize-html');
        var Entities = require('html-entities').XmlEntities;
        var entities = new Entities();

        var ms = require('milliseconds')

        var addProp = function(obj, prop, name) {
            if (prop) {
                obj[name] = prop;
            }
        }

        var toDate = function(str) {
            return new Date(parseInt(str) * 1000);
        }

        try {

            /* DATES */
            var date = {};

            addProp(date, toDate(d.t_stamp), 'ajout');

            /* CLIENT */
            var client = {
                civilite: d.civilite,
                prenom: d.prenom,
                nom: d.nom,
                email: d.email,
                address:  {
                    n: d.numero || "0",
                    r: d.adresse,
                    v: d.ville,
                    cp: d.code_postal,
                    lt: d.lat,
                    lg: d.lng
                },
                location: [parseFloat(d.lat), parseFloat(d.lng)],
            };

            client.telephone = {};
            if (d.tel1 && d.tel1.length)
                client.telephone.tel1 = d.tel1.replace(/[^0-9]/g, '');
            else
                client.telephone.tel1 = '0101010101'
            if (d.tel2)
                client.telephone.tel2 = d.tel2.replace(/[^0-9]/g, '');
            client.telephone.appel = d.numero_appel ||  undefined
                /* COMMENTS */
            var user = edison.users.search(d.ajoute_par);
            var rtn = {
                tva: 20,
                id: d.id,
                _id: d.id,
                login: {
                    ajout: user
                },
                date: date,
                client: client
            }

            var devis = JSON.parse(d.devis.split('<br>').join(""));
            rtn.historique = [];
            _.times(parseInt(devis.envoyer), function() {
                    rtn.historique.push({
                        login: user,
                        date: rtn.date.ajout,
                    })
                })
                //db.model('event').collection.insert(historique)
            if (d.etat_intervention === "ANN" ||
                (d.etat_intervention === "DEV" && date.ajout.getTime() < Date.now() - ms.weeks(1))) {
                rtn.status = "ANN";
            } else if (d.etat_intervention === "DEV") {
                rtn.status = "ATT"
            } else {
                rtn.status = 'TRA'
                rtn.transfertId = rtn.id;
            }
            rtn.produits = devis.devisTab;
            rtn.tva = devis.tva || 20;
            rtn.produits.map(function(p) {
                p.desc = sanitizeHtml(entities.decode(p.desc))
                p.ref = sanitizeHtml(entities.decode(p.ref || 'EDI141'))
                p.pu = p.pu || 0
                p.quantite = p.quantite || 0
                p.pu = typeof p.pu === 'number' ? p.pu : (parseFloat(p.pu.replace(/[^\d.-]/g, '')) || 0)
                p.ref = p.ref.replace(' ', '');
                if (p.ref.startsWith("CAM"))
                    p.ref = "CAM001";
                if (p.ref.startsWith("EDI003") ||  p.ref.startsWith("FRN"))
                    p.ref = "FRN001";
                var origin = _.find(edison.produits, function(e) {
                    return e.ref === p.ref;
                });
                if (origin) {
                    p.title = origin.title;
                } else {
                    p.title = p.desc.toUpperCase().split(' ').slice(0, 3).join(' ')
                }
                return p
            });

            /* FACTURE */
            rtn.reglementSurPlace = !d.fact;

            /* INFO */
            rtn.categorie = d.categorie;
            rtn.sms = d.id_sms;
        } catch (e) {
            __catch(e)
        }
        return rtn;
    }
module.exports = function(db) {

    return new db.Schema({
        _id: Number,
        id: Number,
        isDevis: {
            type: Boolean,
            default: true
        },
        status: {
            type: String,
            index: true,
            default: 'AEV' // ANN ATT AEV TRA
        },
        causeAnnulation: String,
        login: {
            annulation: String,
            ajout: String,
            transfert: String
        },
        date: {
            dump: Date,
            annulation: String,
            ajout: {
                type: Date,
                default: Date.now
            },
            transfert: Date
        },
        prixAnnonce: Number,
        historique: [{
            date: {
                type: Date,
                default: Date.now,
            },
            login: String,
            mail: {}
        }],
        client: { //
            civilite: {
                type: String,
                required: true
            },
            prenom: String,
            nom: {
                type: String,
                required: true
            },
            email: String,
            telephone: {
                tel1: {
                    type: String,
                    required: true
                },
                tel2: String,
                tel3: String
            },
            address: {
                n: {
                    type: String,
                    required: true
                },
                r: {
                    type: String,
                    required: true
                },
                v: {
                    type: String,
                    required: true
                },
                cp: {
                    type: String,
                    required: true
                },
                etage: String,
                code: String,
                lt: Number,
                lg: Number,
            },
            location: [],
        },
        transfertId: {
            type: Number,
            ref: 'intervention'
        },
        combo: String,
        comboText: String,
        categorie: String,
        produits: [{
            pu: Number,
            quantite: Number,
            title: String,
            ref: String,
            desc: String
        }],
        tva: {
            type: Number,
            default: 20
        },
        cache: {}
    }, {
        versionKey: false
    });
}
module.exports = function(schema) {
    var _ = require('lodash')
    var moment = require('moment')
    var V1 = requireLocal('config/_convert_V1');
    var upper = function(str) {
        return str ? str.toUpperCase() : str;
    }

    var upperCaseEverything = function(options) {
        var _this = this;
        var obj = options || this.options;
        _.each(obj, function(e, k) {
            if (typeof e === 'string') {
                obj[k] = e.toUpperCase();
            }
        })

    }

    var validatorPreSave = function(next) {
        var _this = this;
        try {
            upperCaseEverything(this.client.address)
            _this.prixAnnonce = _.sum(_this.produits, function(e) {
                return e.pu * e.quantite;
            });
            _this.cache = db.model('devis').Core.minify(_this);
            if (isWorker) {
                return next();
            }
        } catch (e) {
            __catch(e)
        }
        next();

    }

    var validatorPostSave = function(doc) {
        if (!doc.client.address.lt) {
            db.model('intervention').geolocateAddress(doc);
        }
        if (!isWorker) {
            db.model('devis').uniqueCacheReload(doc)
            console.log(envProd, (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump)))
            if (envProd && (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump))) {
                var v1 = new V1(doc);
                v1.send(function(resp) {
                    console.log(resp)
                });
            }
        }

    }


    schema.pre('save', function(next) {
        validatorPreSave.bind(this)(next)
    });


    schema.post('save', validatorPostSave)

    schema.post('findOneAndUpdate', validatorPostSave)


    /*
        schema.pre('save', function(next) {
            this.prixAnnonce = _reduce(this.produits, function(result, n, key) {
                if (key === 1)
                    result = result.pu
                return result + n.pu;
            });
            this.cache = db.model('intervention').Core.minify(_this);
            this.client.nom = upper(this.client.nom)
            this.client.prenom = upper(this.client.prenom)
            this.client.email = upper(this.client.email)
            this.client.address.n = upper(this.client.address.n)
            this.client.address.r = upper(this.client.address.r)
            this.client.address.v = upper(this.client.address.v)
            next();
        });


        schema.post('save', function(doc) {
            if (!isWorker) {
                console.log("DEVIS", envProd, (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump)))
                if (envProd && (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump))) {
                    console.log('v1 translate' + doc.id);
                    var v1 = new V1(doc, true);
                    v1.send(function(resp) {
                        console.log('=====-->', resp)
                    });
                }
            }
        })
    */
}
module.exports = function(db) {

    return new db.Schema({
        date: {
            type: Date,
            default: Date.now
        },
        name: String,
        model: String,
        type: String,
        _id: String,
        link: Number,
        extension: String,
        deleted: {
            type: Boolean,
            default: false
        },
        virtual: Boolean,
        login: {
            type: String,
            default: 'Inconnu'
        }
    })
}
module.exports = function(model) {

}
module.exports = function(db) {
    return new db.Schema({
        //date

        date: {
            type: Date,
            default: Date.now
        },
        login: String,
        data: {

        },
        message: String,
        
        id: db.Schema.Types.Mixed,
        //type
        type: String,
    });

}
module.exports = function(model) {

}
    var _ = require('lodash');
    module.exports = {
        name: 'intervention',
        Name: 'Intervention',
        NAME: 'INTERVENTION',
        redisCacheListName: 'INTERVENTION_CACHE_LIST',
        listChange: 'INTERVENTION_CACHE_LIST_CHANGE'
    }

    module.exports.redisTemporarySaving = function(id) {
        return 'INTERVENTION_TMP_SAVING___' + id;
    }
    module.exports.model = function() {
        return db.model('intervention');
    }

    module.exports.singleDumpUrl = function(id) {
        var key = requireLocal('config/_keys');
        return key.alvin.url + "dumpIntervention.php?devis=false&id=" + id + "&key=" + key.alvin.pass
    }

    module.exports.multiDumpUrl = function(limit) {
        var key = requireLocal('config/_keys');
        return key.alvin.url + "dumpIntervention.php?limit=" + limit + "&key=" + key.alvin.pass
    }


    module.exports.postUpdate = function(prev, curr, session) {

    }

    module.exports.postSave = function(prev, curr, session) {
        try {

            if (envProd && curr.artisan && curr.artisan.id) {
                var moment = require('moment')
                var textTemplate = requireLocal('config/textTemplate');
                var config = requireLocal('config/dataList');
                var text = _.template(textTemplate.sms.intervention.demande.bind(curr)(session, config, moment))(curr)
                sms.send({
                    link: curr.sst.id,
                    origin: curr.id,
                    text: text,
                    to: envProd ? curr.sst.telephone.tel1 : '0633138868',
                })
            }

            if (curr.devisOrigine) {
                db.model('devis').findOne({
                        id: curr.devisOrigine
                    })
                    .then(function(devis) {
                        if (!devis)
                            return false;
                        devis.status = "TRA";
                        devis.transfertId = curr.id;
                        devis.save()
                    })
            }

        } catch (e) {
            __catch(e)
        }


        /*   if (curr.artisan.id) {
               db.model('artisan').findOne({
                   id: curr.artisan.id
               }).then(function(sst) {
                   if (!sst) {
                       return false;
                   }
                   curr.sst = JSON.parse(JSON.stringify(sst));
                   var moment = require('moment')
                   var textTemplate = requireLocal('config/textTemplate');
                   var config = requireLocal('config/dataList');
                   var text = _.template(textTemplate.sms.intervention.demande.bind(curr)(session, config, moment))(curr)
                   sms.send({
                       link: curr.sst.id,
                       origin: curr.id,
                       text: text,
                       to: envProd ? curr.sst.telephone.tel1 : '0633138868',
                   })
               })
           }*/
    }

    module.exports.preUpdate = function(prev, curr, session) {
        if (curr.artisan && curr.artisan.id && curr.artisan.id !== prev.artisan.id) {
            prev.status = 'APR';
        }
        if (curr.compta.reglement.recu && !prev.compta.reglement.recu) {
            curr.compta.reglement.historique.push({
                login: session.login,
                montant: curr.compta.reglement.avoir.montant,
            })
            if (!curr.compta.reglement.date) {
                curr.compta.reglement.date = Date.now()
                curr.compta.reglement.login = session.login
            }

        }
        if (curr.compta.paiement.ready && !prev.compta.paiement.ready) {
            curr.compta.paiement.login = session.login
            curr.compta.paiement.date = Date.now()
        }

        if (curr.sav && curr.sav.status === 'ENC' && prev.sav.status !== 'ENC') {

            edison.event('INTER_SAV')
                .login(session.login)
                .id(curr.id)
                .broadcast(curr.login.ajout)
                .color('blue')
                .message(_.template("Un S.A.V à été ouvert sur votre intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) ")(curr))
                .send()
                .save()

        }

        if (curr.litige && curr.litige.open === true && prev.litige.open === void(0)) {

            curr.litige.opened = new Date();
            curr.litige.openedBy = session.login;

            edison.event('INTER_LITIGE')
                .login(session.login)
                .id(curr.id)
                .broadcast(curr.login.ajout)
                .color('red')
                .message(_.template("Un litige à été ouvert par {{litige.openedBy}} sur votre intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) ")(curr))
                .send()
                .save()

        }
        if (curr.litige && curr.litige.open === false && prev.litige.open === true) {
            curr.litige.closed = new Date();
            curr.litige.closedBy = session.login;
        }

        if (curr.artisan && curr.artisan.id && curr.artisan.id !== prev.artisan.id) {
            curr.status = 'APR';
            if (envProd) {
                db.model('artisan').findOne({
                    id: curr.artisan.id
                }).then(function(sst) {
                    if (!sst) {
                        return false;
                    }
                    curr.sst = JSON.parse(JSON.stringify(sst));
                    var moment = require('moment')
                    var textTemplate = requireLocal('config/textTemplate');
                    var config = requireLocal('config/dataList');
                    var text = _.template(textTemplate.sms.intervention.demande.bind(curr)(session, config, moment))(curr)
                    sms.send({
                        link: curr.sst.id,
                        origin: curr.id,
                        text: text,
                        to: envProd ? curr.sst.telephone.tel1 : '0633138868',
                    })
                })
            }
        }



    }

    module.exports.defaultDoc = function(timestamp) {
        var ms = require('milliseconds')
        return {
            prixAnnonce: 0,
            coutFourniture: 0,
            comments: [],
            produits: [],
            tva: 10,
            remarque: 'PAS DE REMARQUES',
            modeReglement: 'CH',
            client: {
                civilite: 'M.',
                telephone: {},
                address: {}
            },
            facture: {

            },
            litige: {

            },
            compta: {
                paiement: {

                },
                reglement: {

                }
            },
            reglementSurPlace: true,
            date: {
                ajout: new Date(timestamp),
                intervention: new Date(timestamp + ms.hours(2))
            }
        }
    }


    module.exports.minify = function(e) {
        var config = requireLocal('config/dataList')
        var d = requireLocal('config/dates.js')
        var ms = require('milliseconds')
        var _ = require("lodash")

        var getPaiementArtisan = function(e) {
            if (e.compta.paiement.effectue) {
                return 2;
            } else if (e.compta.paiement.ready) {
                return 1;
            } else {
                return undefined
            }
        }

        try {
            if (e.status === "ENC" && Date.now() > (new Date(e.date.intervention)).getTime() + ms.hours(1)) {
                e._status = 'AVR';
            } else {
                e._status = e.status
            }

            var rtn = {
                t: e.login.ajout,
                id: e.id,
                f: !e.reglementSurPlace ? 1 : undefined,
                ai: e.artisan.id,
                l: !e.compta.reglement.recu && e.recouvrement.level || undefined,
                s: config.etats[e._status].order,
                c: config.categories[e.categorie].order,
                n: e.client.civilite + ' ' + e.client.nom + ' ' + e.client.prenom,
                a: e.artisan.nomSociete,
                pa: e.prixFinal || e.prixAnnonce,
                da: d(e.date.ajout),
                di: d(e.date.intervention),
                rc: e.compta.reglement.recu ? 1 : 0,
                ps: getPaiementArtisan(e),
                ad: e.client.address.cp + ', ' + e.client.address.v,
                dm: e.login.demarchage || undefined,
            };
            if (e.aDemarcher && !e.sst) {
                rtn.d = e.enDemarchage ? 2 : 1;
            }
        } catch (e) {
            __catch(e)
        }
        return _.omit(rtn, _.isUndefined);
    }































    module.exports.toV2 = function(d) {
        var ms = require('milliseconds')
        var config = requireLocal('config/dataList');
        var sanitizeHtml = require('sanitize-html');
        var Entities = require('html-entities').XmlEntities;
        var entities = new Entities();



        var addProp = function(obj, prop, name) {
            if (prop) {
                obj[name] = prop;
            }
        }

        var toDate = function(str, randomize) {
            var rand = randomize ? _.random(ms.hours(7), ms.hours(19)) : 0;
            var d = new Date(parseInt(str) * 1000 + rand);
            return d
        }


        /* DATES */
        var date = {};

        addProp(date, toDate(d.t_stamp), 'ajout');
        addProp(date, toDate(d.t_stamp_intervention), 'intervention');

        if (d.date_edition_facture) {
            addProp(date, toDate(d.date_edition_facture, true), 'verification')
            addProp(date, toDate(d.date_edition_facture, true), 'envoiFacture')
        }
        /* CLIENT */
        var client = {
            civilite: d.civilite,
            prenom: d.prenom,
            nom: d.nom,
            email: d.email,
            address:  {
                n: d.numero || "0",
                r: d.adresse,
                v: d.ville,
                cp: d.code_postal,
                lt: d.lat,
                lg: d.lng
            },
            location: [parseFloat(d.lat), parseFloat(d.lng)],
        };

        client.telephone = {};
        if (d.tel1)
            client.telephone.tel1 = d.tel1.replace(/[^0-9]/g, '');
        else {
            client.telephone.tel1 = '0633138868'
        }
        if (d.tel2)
            client.telephone.tel2 = d.tel2.replace(/[^0-9]/g, '');
        client.telephone.origine = d.numero_origine
            /* COMMENTS */
        var user = edison.users.search(d.ajoute_par)
        var comments = [];
        if (d.remarque_interne) {
            comments.push({
                login: user,
                date: toDate(d.t_stamp),
                text: d.remarque_interne
            });
        }

        if (d.etat_reglement == "CHEQUE RECUPERE" ||  d.date_edition_facture) {
            d.etat_intervention = "VRF"
        }


        var rtn = {
            tva: d.tva_facture  || (d.civilite === 'Soc.' ? 20 : 10),
            aDemarcher: d.A_DEMARCHE,
            id: d.id,
            _id: d.id,
            fourniture: [],
            login: {
                ajout: user,
            },
            comments: comments,
            status: d.etat_intervention,
            date: date,
            client: client,
            sms: d.id_sms || null,
            smsStatus: d.status_sms || 0,
        }

        var isJson = require('is-json');

        if (d.relance && isJson(d.relance)) {
            rtn.relance = JSON.parse(d.relance);
        }

        if (d.devis && d.id > 13740) {
            rtn.devisOrigine = d.id;
            var devis = JSON.parse(d.devis.split('<br>').join(""));
            rtn.produits = devis.devisTab;
            rtn.tva = parseInt(devis.tva) || 10;
            rtn.produits.map(function(p) {
                p.quantite = typeof p.quantite === 'string' ? p.quantite.replace(/[^\d.-]/g, '') : p.quantite
                p.desc = sanitizeHtml(entities.decode(p.desc))
                p.ref = sanitizeHtml(entities.decode(p.ref || 'EDI042'))
                p.pu = typeof p.pu === 'number' ? p.pu : (parseFloat(p.pu.replace(/[^\d.-]/g, '')) || 0)
                p.ref = p.ref.replace(' ', '');
                if (p.ref.startsWith("CAM"))
                    p.ref = "CAM001";
                if (p.ref.startsWith("EDI003") ||  p.ref.startsWith("FRN"))
                    p.ref = "FRN001";
                var origin = _.find(edison.produits, function(e) {
                    return e.ref === p.ref;
                });
                if (origin) {
                    p.title = origin.title;
                } else {
                    p.title = p.desc.toUpperCase().split(' ').slice(0, 3).join(' ')
                    if (!p.ref || p.ref == 'AUT001')
                        p.ref = p.desc.toUpperCase().slice(0, 3) + '0' + _.random(9, 99)
                }
                return p
            });
        }
        rtn.fourniture = [];


        rtn.categorie = d.categorie;
        rtn.description = d.description || "PAS DE DESCRIPTION";
        rtn.remarque = d.remarque || "PAS DE REMARQUES";

        rtn.modeReglement = d.mode_reglement;


        if (rtn.status === 'INT' || rtn.status === 'ENC') {
            rtn.date.envoi = rtn.date.ajout;
            rtn.login.envoi = rtn.login.ajout
        }
        if (rtn.status === "INT") {
            rtn.login.verification = rtn.login.ajout
            if (!rtn.reglementSurPlace) {
                rtn.login.envoiFacture = edison.users.search(d.facture_editee_par || rtn.login.ajout)
                rtn.login.verification = rtn.login.envoiFacture
            }
            rtn.date.verification = rtn.date.intervention || rtn.date.ajout;
            rtn.status = 'VRF'

        }

        rtn.prixAnnonce = d.prix_ht_annonce;
   //     console.log('==>', d.comptaPrixFinal, d.prix_ht_final, d.montant_ht_facture)
        rtn.prixFinal = d.comptaPrixFinal || d.prix_ht_final || d.montant_ht_facture || undefined;
        if (!rtn.prixFinal && rtn.status === 'VRF') {
            rtn.prixFinal = rtn.prixAnnonce || 0;
        }

        rtn.reglementSurPlace = !d.fact;
        if (d.id_annulation) {
            var tmp = _.find(config.causeAnnulation, function(e) {
                return e.oldId === d.id_annulation
            })
            rtn.causeAnnulation = tmp ? tmp.short_name : undefined
        }

        if (d.nom_societe) {
            rtn.artisan = {
                id: d.id_sst_selectionne,
                nomSociete: d.nom_societe
            }
            rtn.sst = d.id_sst_selectionne;
        }

        if (d.nom_facture) {
            rtn.facture = {
                payeur: config.typeClient[parseInt(d.type_client) || 0],
                email: d.mail_facture,
                nom: d.nom_facture,
                prenom: d.prenom_facture,
                tel: d.tel_facture,
                address: {
                    n: d.numero_facture || "0",
                    r: d.adresse_facture,
                    v: d.ville_facture,
                    cp: d.code_postal_facture
                },
            }
        }

        if (rtn.status == "ANN") {
            rtn.login.annulation = rtn.login.ajout
            rtn.date.annulation = rtn.date.ajout
        }




        var fournitureArtisan = parseFloat(d.comptaFournitureArtisan)
        var fournitureEdison = parseFloat(d.comptaTotalFourniture) - fournitureArtisan
        if (fournitureArtisan) {
            rtn.fourniture.push({
                bl: "0",
                title: "Inconnu",
                fournisseur: "ARTISAN",
                pu: fournitureArtisan,
                quantite: 1
            })
        }
        if (fournitureEdison) {
            if (!d.fournisseur || d.fournisseur == "ARTISAN")
                d.fournisseur = "EDISON";
            rtn.fourniture.push({
                bl: "0",
                title: "Inconnu",
                fournisseur: d.fournisseur,
                pu: fournitureEdison,
                quantite: 1
            })
        }
        if (!fournitureArtisan && !fournitureEdison && d.cout_fourniture > 0) {
            rtn.fourniture.push({
                bl: "0",
                title: "Inconnu",
                fournisseur: d.fournisseur,
                pu: parseFloat(d.cout_fourniture),
                quantite: 1
            });
        }





        rtn.compta = {
            paiement: {
                dette: d.etat_reglement === "DETTE"
            }
        }
        if (d.comptaPrixFinal) {
            rtn.compta = {
                paiement: {
                    date: toDate(d.date_paiement_sst),
                    tva: d.comptaTVA || 0,
                    mode: d.pVirement == "0" ? "CHQ" : "VIR",
                    base: d.comptaPrixFinal,
                    montant: d.comptaMontantFinal,
                    ready: false /*rtn.id > 25000*/ ,
                    effectue: true /*rtn.id <= 25000*/ ,
                    pourcentage: {
                        deplacement: d.pDeplacement,
                        maindOeuvre: d.pMaindOeuvre,
                        fourniture: d.pFourniture
                    },
                    historique: /* rtn.id > 25000 ? [] :*/ [{
                        tva: d.comptaTVA || 0,
                        dateFlush: toDate(d.date_paiement_sst),
                        dateAjout: toDate(d.date_paiement_sst),
                        base: d.comptaPrixFinal,
                        final: d.comptaMontantFinal,
                        montant: d.comptaMontantFinal,
                        fourniture: {
                            artisan: fournitureArtisan,
                            edison: fournitureEdison,
                            total: fournitureArtisan + fournitureEdison
                        },
                        payed: d.comptaMontantFinal,
                        mode: (d.pVirement == "0" ? "CHQ" : "VIR"),
                        pourcentage: {
                            deplacement: d.pDeplacement,
                            maindOeuvre: d.pMaindOeuvre,
                            fourniture: d.pFourniture
                        },
                        numeroCheque: d.comptaNumeroCheque ||  undefined,
                    }]
                },
            }
        }
        if (d.date_paiement_client) {
            rtn.compta.reglement = {
                date: toDate(d.date_paiement_client),
                recu: true,
                montant: rtn.prixFinal,
                historique: [{
                    date: toDate(d.date_paiement_client),
                    montant: rtn.prixFinal,
                }]
            }
        }
        if (!rtn.reglementSurPlace && (!rtn.produits || !rtn.produits.length)) {
            rtn.produits = [{
                ref: 'EDX121',
                title: rtn.description,
                desc: rtn.description,
                pu: rtn.prixFinal ||  rtn.prixAnnonce || 0,
                quantite: 1
            }]
        }

        return rtn;
    }
module.exports = function(db) {

    var schema = new db.Schema({
        _id: Number,
        id: {
            type: Number,
            index: true
        },
        status: {
            type: String,
            index: true,
            default: 'APR'
        },
        subStatus: String,
        causeAnnulation: String,
        login: {
            ajout: String,
            envoi: String,
            envoiFacture: String,
            annulation: String,
            verification: String,
            paiementCLI: String,
            paiementSST: String,
            demarchage: String,
        },
        date: {
            envoi: Date,
            ajout: {
                type: Date,
                default: Date.now
            },
            envoiFacture: Date,
            intervention: Date,
            verification: Date,
            annulation: Date,
            paiementCLI: Date,
            paiementSST: Date,
            demarchage: Date,
            dump: Date,
        },
        comments: [{
            login: String,
            text: String,
            date: Date
        }],
        historique: [],
        client: { //
            civilite: {
                type: String,
                required: true
            },
            prenom: {
                type: String,
                default: ""
            },
            nom: {
                type: String,
                required: true
            },
            email: String,
            telephone: {
                tel1: {
                    type: String,
                    required: true
                },
                tel2: String,
                tel3: String,
                origine: String,
                appel: String,
            },
            address: {
                n: {
                    type: String,
                    required: true
                },
                r: {
                    type: String,
                    required: true
                },
                v: {
                    type: String,
                    required: true
                },
                cp: {
                    type: String,
                    required: true
                },
                etage: String,
                code: String,
                batiment: String,
                lt: Number,
                lg: Number,
            },
            location: [],
        },
        facture: {

            compte: String,
            payeur: String,
            nom: String,
            prenom: String,
            tel: String,
            tel2: String,
            email: String,
            address: {
                n: String,
                r: String,
                v: String,
                cp: String,
            },
        },
        sav: {
            status: String,
            description: String,
            sst: Number,
        },
        sst: {
            type: Number,
            ref: 'artisan'
        },
        litige: {
            openedBy: String,
            closedBy: String,
            opened: Date,
            closed: Date,
            description: String,
            open: Boolean
        },
        litiges: [{
            status: String,
            description: String,
            login: String,
            date: Date,
            regle: Boolean
        }],
        litigesEnCours: {
            type: Boolean,
            default: true
        },
        savEnCours: {
            type: Boolean,
            default: true
        },
        categorie: {
            type: String,
            required: true
        },
        artisan: {
            id: {
                type: Number,
                ref: 'artisan'
            },
            nomSociete: String
        },
        description: {
            type: String,
            required: true
        },
        descriptionTags: [
            String
        ],
        remarqueSms: Boolean,
        remarque: {
            type: String,
            default: 'PAS DE REMARQUES'
        },
        produits: [{
            pu: Number,
            quantite: Number,
            title: String,
            ref: String,
            desc: String
        }],
        cb: {
            hash: String,
            preview: String,
            /* never clear*/
            cardType: String,
            number: String,
            expMonth: Number,
            expYear: Number,
            cvc: Number,
        },
        fourniture: [{
            bl: String,
            pu: Number,
            quantite: Number,
            title: String,
            fournisseur: String
        }],
        combo: String,
        modeReglement: {
            type: String,
            default: 'CHQ'
        },
        prixAnnonce: {
            type: Number,
            default: 0
        },
        prixFinal: {
            type: Number,
            default: 0
        },
        acompte: Number,
        reglementSurPlace: {
            type: Boolean,
            default: true
        },
        aDemarcher: {
            type: Boolean,
            default: false
        },
        enDemarchage: {
            type: Boolean,
            default: false
        },
        demarchePar: String,
        devisOrigine: {
            type: Number,
            ref: 'devis'
        },
        fournisseur: String,
        coutFourniture: {
            type: Number,
            default: 0
        },
        tva: {
            type: Number,
            default: 20
        },
        compta: {
            reglement: {
                date: Date,
                login: {
                    type: String,
                    default: 'vincent_q'
                },
                recu: {
                    type: Boolean,
                    default: false
                },
                montant: {
                    type: Number,
                    default: 0
                },
                avoir: {
                    _type: String,
                    montant: Number,
                    effectue: {
                        type: Boolean,
                        default: false
                    },
                    date: Date
                },
                historique: [{
                    _type: {
                        type: String,
                        default: 'ENCAISSEMENT'
                    },
                    _typeAvoir: String,
                    montant: Number,
                    login: {
                        type: String,
                        default: 'vincent_q'
                    },
                    date: {
                        type: Date,
                        default: Date.now
                    },
                }]
            },
            paiement: {
                mode: String,
                tva: {
                    type: Number,
                    default: 0
                },
                base: Number,
                montant: Number,
                pourcentage: {
                    deplacement: Number,
                    maindOeuvre: Number,
                    fourniture: Number
                },
                dette: {
                    type: Boolean,
                    default: false
                },
                effectue: {
                    index: true,
                    type: Boolean,
                    default: false
                },
                ready: {
                    index: true,
                    type: Boolean,
                    default: false
                },
                date: Date,
                login: {
                    type: String,
                    default: 'vincent_q'
                },
                historique: [{
                    tva:  {
                        type: Number,
                        default: 0
                    },
                    fourniture: {
                        artisan: Number,
                        edison: Number,
                    },
                    dateAjout: Date,
                    dateFlush: Date,
                    loginAjout: {
                        type: String,
                        default: 'vincent_q'
                    },
                    loginFlush: {
                        type: String,
                        default: 'vincent_q'
                    },
                    _type: {
                        type: String,
                        default: 'AUTO-FACT'
                    },
                    pourcentage: {
                        deplacement: {
                            type: Number,
                            default: 50
                        },
                        maindOeuvre: {
                            type: Number,
                            default: 30
                        },
                        fourniture: {
                            type: Number,
                            default: 30
                        }
                    },
                    mode: String,
                    base: Number,
                    montant: Number,
                    payed: Number,
                    'final': Number,
                    numeroCheque: String
                }]
            },
            info: {
                factureNC: Boolean, // facture de l'intervention (si reglemenet est sur place)
                tvaNC: Boolean, // attestation de tva (si tva=10%)
                devisNC: Boolean, // devis (> 150)
                fournitureNC: Boolean,

            },
        },
        recouvrement: {
            level: {
                type: Number,
                default: 0
            }
        },
        newOs: {
            type: Boolean,
            default: false,
        },
        appels: [{
            call_id: String,
            date: {
                type: Date,
                default: Date.now
            },
            status: String,
            duration: Number,
            _type: String, //CONTACT/CALLBACK
        }],
        relance: {
            r1: Date,
            r2: Date,
            r3: Date,
        },
        sms: {
            ref: 'sms',
            type: String
        },
        smsStatus: Number,
        file: [{
            name: String,
            mimeType: String,
            origin: String, //SCAN, UPLOAD, AUTO

        }],
        cache: {

        }
    }, {
        versionKey: false
    });
    return schema
}
module.exports = function(schema) {
    var creditcard = require('creditcard');
    var key = requireLocal('config/_keys');
    var V1 = requireLocal('config/_convert_V1');
    var encryptor = require('simple-encryptor')(key.salt);
    var _ = require('lodash')
    var moment = require('moment');
    /* M.|Me|Soc. */
    /*    schema.path('client.civilite').validate(function(value) {
            return /M\.|Mme|Soc\./i.test(value);
        }, 'Civilité inconnu.');*/


    /* CARTE BANCAIRE | CHEQUE | CASH */
    /*    schema.path('modeReglement').validate(function(value) {
            return /CB|CH|CA/i.test(value);
        }, 'Mode de reglement inconnu.');
    */


    /*CARRELAGE|MENUISERIE|MACONNERIE|PEINTURE|PLOMBERIE|SERRURERIE|CLIMATISATION|CHAUFFAGE|VITRERIE|ELECTRICITE|ASSAINISSEMENT*/
    /*  schema.path('categorie').validate(function(value) {
          return /CR|MN|MC|PT|PL|SR|CL|CH|VT|EL|AS/i.test(value);
      }, 'Categorie inconnue.');*/

    var UP = function(obj) {
        if (obj) {
            _.each(obj, function(e, k) {
                if (typeof e === 'string')
                    obj[k] = obj[k].toUpperCase();
            })
        }
    }



    var validatorPreSave = function(next) {
        var _this = this;

        try {
            UP(this.facture.address)
            UP(this.facture)
            UP(this.client.address)
            _this.coutFourniture = _.reduce(_this.fourniture, function(total, e) {
                return total += (e.quantite * e.pu)
            }, 0)
            _this.sst = _this.artisan.id
            _this.enDemarchage = _this.login.demarchage;
            _this.cache = db.model('intervention').Core.minify(_this);
            if (isWorker) {
                return next();
            }
            if (_this.cb.number) {
                if (!creditcard.validate(_this.cb.number))
                    return next(new Error('Numero de carte invalide'))
                _this.cb = {
                    hash: encryptor.encrypt(JSON.stringify(_this.cb)),
                    preview: "**** ".repeat(3) + _this.cb.number.slice(-4)
                }
            }
        } catch (e) {
            __catch(e)
        }
        next();

    }

    var validatorPostSave = function(doc) {
        if (!doc.client.address.lt) {
            db.model('intervention').geolocateAddress(doc);
        }
        if (!isWorker) {
            if (doc.artisan.id) {
                db.model('artisan').findOne({
                    id: doc.artisan.id
                }).then(function(sst) {
                    if (sst) {
                        sst.date.dump = Date.now();
                        sst.save().then();
                    }
                })
            }
            db.model('intervention').uniqueCacheReload(doc)
            if (envProd && (!doc.date.dump || moment().subtract(5000).isAfter(doc.date.dump))) {
                var v1 = new V1(doc);
                v1.send(function(resp) {
                    console.log(resp)
                });
            }
        }

    }

    schema.pre('save', function(next) {
        validatorPreSave.bind(this)(next)
    });


    schema.post('save', validatorPostSave)

    schema.post('findOneAndUpdate', validatorPostSave)
}
module.exports = function(db) {

    return new db.Schema({
        pu: {
            type: Number,
            required: true
        },
        title: {
            type: String,
            required: true
        },
        desc: {
            type: String,
            required: true
        },
        ref: {
            type: String,
            required: true
        }
    });

}
module.exports = function(schema) {

}
module.exports = function(db) {

    return new db.Schema({
        _type: String,
        subType: String,
        level: String,
        service: String,
        nom: String,
    });
}
module.exports = function(schema) {


/*    schema.pre('save', function(next) {
    	var _ = require('lodash');
        var _this = this;
        this.pseudo = _.startCase(this.pseudo);
        next();
    });
*/
}
module.exports = function(db) {

    return new db.Schema({
        login: {
            ajout: String,
            done: String
        },
        date: {
            ajout: Date,
            done: Date
        },
        inter_id: {
            type: Number,
            ref: 'intervention'
        },
        sst_id: {
            type: Number,
            ref: 'artisan'
        },
        sst_nom: String,
        _type: String,
        subType: String,
        level: String,
        service: String,
        nom: String,
        ok: {
            type: Boolean,
            default: false
        }
    });
}
module.exports = function(schema) {


/*    schema.pre('save', function(next) {
    	var _ = require('lodash');
        var _this = this;
        this.pseudo = _.startCase(this.pseudo);
        next();
    });
*/
}
module.exports = function(db) {

    return new db.Schema({
        date: {
            type: Date,
            default: Date.now
        },
        text: {
            type: String,
            required: true
        },
        from: {
            type: String,
            required: true
        },
        to: {
            type: String,
            required: true
        },
        checked: {
            type: Boolean,
            default: false
        },
        done: Date
    });
}
module.exports = function(model) {

}
module.exports = function(db) {

    return new db.Schema({
        nom: String,
        prenom: String,
        portable: String,
        email: String,
        nom: String,
        prenom: String,
        pseudo: String,
        login: {
            type: String,
            required: true
        },
        oldLogin: String,
        id: Number,
        _id: String,
        service: String,
        ligne: String,
        root: Boolean,
        password: String,
        passInit: {
            type: Boolean,
            default: false
        },
        activated: {
            type: Boolean,
            default: false
        }
    });

}
module.exports = function(schema) {


/*    schema.pre('save', function(next) {
    	var _ = require('lodash');
        var _this = this;
        this.pseudo = _.startCase(this.pseudo);
        next();
    });
*/
}
module.exports = function(schema) {
    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            require('fs').readFile('config/arcep.json', 'utf8', function(err, data) {
                if (err) {
                    return console.log(err);
                }
                db.model('arcep').remove({}, function() {
                    var tab = JSON.parse(data);
                    tab.forEach(function(e) {
                        var model = db.model('arcep');
                        var x = new model(e);
                        x.save();
                    })
                    resolve("ok");
                })
            })
        })
    }
}
module.exports = function(schema) {
    schema.statics.search = {
        unique: true,
        findBefore: false,
        method: 'GET',
        fn: function(tel, req, res) {
            var reg = '^' + tel.substr(0, 6) + "";
            return new Promise(function(resolve, reject) {
                db.model("arcep").find({
                    e: {
                        $regex: reg
                    }
                }).then(function(doc) {
                    //console.log("==>", doc)
                    if (!doc || !doc.length)
                        return resolve([]);
                    return resolve(doc)
                }, reject)
            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.absence = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                console.log(req.body);
                artisan.absence = ({
                    start: req.body.start,
                    end: req.body.end,
                    login: req.session.login,
                    date: Date.now()
                })
                artisan.save().then(resolve, reject)
            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.comment = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                console.log(artisan.save)
                artisan.comments.push({
                    text: req.body.text,
                    login: req.session.login,
                    date: Date.now()
                })
                artisan.save().then(resolve, reject)
            })
        }
    }
}
    var _ = require('lodash')
    module.exports = function(schema) {

        schema.statics.compteTiers = {
            unique: true,
            findBefore: false,
            method: 'GET',
            fn: function(id, req, res) {
                return new Promise(function(resolve, reject) {
                    console.log(id)
                    db.model('intervention').aggregate()
                        .match({
                            'artisan.id': parseInt(id),
                            //'compta.paiement.effectue': true
                        })
                        .unwind("compta.paiement.historique")
                        .project({
                            'compta': true,
                            'artisan': true,
                        })
                        .exec(function(err, docs) {
                            var x = _.groupBy(docs, 'compta.paiement.historique.dateFlush')
                            x = _(x).map(function(e, k) {
                                return {
                                    date: k,
                                    timestamp: (new Date(k)).getTime(),
                                    list: e,
                                    total: _.round(_.sum(e, 'compta.paiement.historique.final'), 2)
                                }
                            }).value()
                            console.log(x)
                            resolve(x)
                        })

                })
            }
        }
    }
module.exports = function(schema) {
    var PDF = require('edsx-mail')
    var _ = require('lodash')
    schema.statics.contrat = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(artisan, req, res) {
            artisan = JSON.parse(JSON.stringify(artisan));
            if (req.query.signe) {
                artisan.signe = true;
            }
            if (req.query.html) {
                res.send(PDF('contract', artisan).getHTML())
            } else {
                PDF('contract', artisan).buffer(function(err, resp) {
                    res.pdf(resp);
                })
            }
        }
    }

    schema.statics.sendContrat = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(artisan, req, res) {

            return new Promise(function(resolve, reject) {
                console.log('oksend')

                if (!isWorker) {
                    return edison.worker.createJob({
                        name: 'db_id',
                        model: 'artisan',
                        method: 'sendContrat',
                        data: artisan,
                        req: _.pick(req, 'query', 'session', 'body')
                    }).then(function() {
                        console.log('sended')

                        artisan.historique.contrat.push({
                            login: req.session.login,
                            signe: req.body.signe,
                            date: Date.now()
                        })
                        artisan.save().then(resolve, reject);
                    })
                }
                artisan.signe = req.body.signe;
                var communication = {
                    mailDest: envProd ? artisan.email : (req.session.email ||  'intervention@edison-services.fr'),
                    mailReply: (req.session.email ||  'intervention@edison-services.fr')
                }
                PDF('contract', artisan).buffer(function(err, buffer) {
                    console.log('gotbuffer')
                    mail.send({
                        From: "intervention@edison-services.fr",
                        ReplyTo: communication.mailReply,
                        To: communication.mailDest,
                        Subject: req.body.rappel ? "En attente de vos documents" : "Proposition de partenariat",
                        HtmlBody: req.body.text.replaceAll('\n', '<br>'),
                        Attachments: [{
                            Content: buffer.toString('base64'),
                            Name: 'Declaration de sous-traitance.pdf',
                            ContentType: 'application/pdf'
                        }]
                    }).then(resolve, reject)
                })
            })

        }
    }
}
module.exports = function(schema) {
    schema.statics.extendedStats = {
        unique: true,
        findBefore: false,
        method: "GET",
        fn: function(artisan, res, req) {
            var moment = require('moment');
            var _ = require('lodash');
            return new Promise(function(resolve, reject) {
                var last12Months = moment().subtract(11, 'month').date(1).toDate();
                db.model('intervention').aggregate([{
                        $match: {
                            'date.ajout': {
                                $gte: last12Months,
                            },
                            status: {
                                $in: ["ANN", "ENC", "VRF"],
                            },
                            'artisan.id': parseInt(artisan)
                        }
                    }, {
                        $group: {
                            _id: {
                                status: '$status',
                                month: {
                                    $month: '$date.intervention'
                                },
                                year: {
                                    $year: '$date.intervention'
                                },

                            },

                            total: {
                                $sum: 1
                            },

                        }
                    }])
                    .exec(function(err, resp) {
                        var monthStart = last12Months.getMonth();
                        var yearStart = last12Months.getFullYear();
                        var rtn = [];
                        _.times(12, function(n) {
                            var month = (monthStart + n) % 12;
                            month++
                            var year = monthStart + n > 12 ? yearStart + 1 : yearStart;
                            var res = _.filter(resp, {
                                _id: {
                                    year: year,
                                    month: month
                                }
                            })
                            if (!res.length) {
                                res = {
                                    dt: month + (year * 100),
                                    date: [_.padLeft(month, 2, '0'), year % 2000].join('/'),
                                    total: 0,
                                    status: ["ANN", "ENC", "VRF"][n % 3]
                                }
                                rtn.push(res);
                            } else {

                                _.each(res, function(e) {
                                    rtn.push({
                                        dt: month + (year * 100),
                                        date: [_.padLeft(month, 2, '0'), year % 2000].join('/'),
                                        total: e.total,
                                        status: e._id.status
                                    })
                                })
                            }
                        })
                        resolve(rtn)
                    });
            })
        }
    }
}
module.exports = function(schema) {
    var _ = require('lodash')
    var PDF = require('edsx-mail')

    schema.statics.facturier = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(artisan, req, res) {
            var textTemplate = requireLocal('config/textTemplate.js');
            var params = {
                sst: artisan,
                text: _.template(textTemplate.lettre.artisan.envoiFacturier())(artisan),
                title: ""
            }
            if (req.query.html) {
                res.send(PDF('sst-letter', params).getHTML())
            } else {
                PDF('sst-letter', params).buffer(function(err, resp) {
                    res.pdf(resp);
                })
            }

        }
    }


    schema.statics.sendFacturier = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                var opt = _.pick(req.body, 'facturier', 'deviseur');
                opt.login = req.session.login;
                opt.date = Date.now();
                artisan.historique.pack.push(opt)
                artisan.save().then(resolve, reject)
            })
        }
    }

}
module.exports = function(schema) {
    var _ = require('lodash')
    var normalize = function(type, dateKey) {
        return function(e) {
            e.type = type;
            e._date = new Date(_.get(e, dateKey ||  'date'));
        }
    }

    schema.statics.fullHistory = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                db.model('signalement').find({
                    sst_id: artisan.id
                }).lean().then(function(signalements) {
                    var comments = _.each(artisan.toObject().comments, normalize('comment'))
                    var pack = _.each(artisan.toObject().historique.pack, normalize('pack'))
                    var contrat = _.each(artisan.toObject().historique.contrat, normalize('contrat'))
                    var signs = _.each(signalements, normalize('signalement', 'date.ajout'));

                    var rtn = [];
                    rtn = rtn.concat(comments).concat(pack).concat(contrat).concat(signs);
                    rtn = _.sortBy(rtn, '_date').reverse()
                    resolve(rtn)
                })
            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.getNextID = function(cb) {
        db.model('artisan').findOne({}).sort("-id")
            .exec(function(err, latestDoc) {
                cb(latestDoc.id + 1);
            })
    }
}
module.exports = function(schema) {

    schema.statics.getFiles = {
        unique: true,
        findBefore: false,
        method: 'GET',
        fn: function(id, req, res) {
            return new Promise(function(resolve, reject) {
                id = parseInt(id);
                if (isNaN(id))
                    return reject("Invalid id")
                document.list('/V2_PRODUCTION/artisan/' + id).then(resolve, function() {
                    resolve([]);
                });

            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.lastInters = {
        unique: true,
        findBefore: false,
        method: 'GET',
        fn: function(id, req, res) {
            return new Promise(function(resolve, reject) {
                db.model('intervention')
                    .find({
                        'artisan.id': id
                    })
                    .select('id -_id _v login date client prixAnnonce categorie status')
                    .sort('-id')
                    .limit(100)
                    .then(function(doc) {
                        var rtn = [];
                        doc.forEach(function(e) {
                            rtn.push(db.model('intervention').translate(e));
                        })
                        res.json(rtn)
                    })
            });
        }
    }
}
module.exports = function(schema) {
    var mime = require("mime")
    schema.statics.openDocument = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                var file = artisan.document[req.query.file];
                if (!file)
                    return reject("Le document est introuvable");

                document.get('/V2/artisan/' + artisan.id + '/' + req.query.file + file.extension, function(err, resp) {
                    if (err)
                        return reject("Erreur");
                    var contentType = mime.lookup(file.extension);
                  /*  if (this.extension == '.pdf' || this.mimeType.startsWith('image')) {

                    }*/
                    res.contentType(contentType);
                    res.send(resp);
                    console.log(err, resp)
                })
            });
        }
    }
}
module.exports = function(schema) {

    var __filter = function(doc, i) {
        var d = doc.obj;
        return d.status !== 'ARC' && (!this.categorie || d.categories.indexOf(this.categorie) !== -1);
    }

    var isAbsent = function(abs) {
        var moment = require('moment')
        if (!abs || !abs.length) {
            return false;
        }
        return moment().isAfter(abs[abs.length - 1].start) && moment().isBefore(abs[abs.length - 1].end)
    }

    var __map = function(doc, i) {
        var d = doc.obj;
        return {
            id: d.id,
            nomSociete: d.nomSociete,
            distance: doc.dis.round(1),
            categories: d.categories,
            ajout: d.date.ajout,
            status: d.status,
            subStatus: d.subStatus,
            quarantained: d.quarantained,
            zoneChalandise: d.zoneChalandise,
            absent: isAbsent(d.absence),
            address: {
                lt: d.address.lt,
                lg: d.address.lg,
            },
        }
    }


    schema.statics.rankArtisans = function(options) {
        var self = this;
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            db.model('artisan').geoNear({
                type: "Point",
                coordinates: [parseFloat(options.lat), parseFloat(options.lng)]
            }, {
                distanceMultiplier: 0.001,
                maxDistance: (parseFloat(options.maxDistance) || 100) / 0.001
            }).then(function(docs) {
                try {
                    resolve(_.chain(docs).filter(__filter.bind(options)).map(__map).take(options.limit || 50).value())

                } catch (e) {
                    __catch(e);
                }
            }, reject)
        })
    }
    schema.statics.rank = function(req, res) {

        return this.rankArtisans(req.query)
    }

}
module.exports = function(schema) {
    var moment = require('moment')
    var async = require('async')
    var PDF = require('edsx-mail')
    var _ = require('lodash')
    var textTemplate = requireLocal('config/textTemplate');
    var RelanceClient = requireLocal('config/_relances-client');
    require('nodeify').extend();


    schema.statics.relanceAuto = function(req, res) {



        return new Promise(function(resolve, reject) {
            var from = moment().startOf('week').toDate();
            var to = moment().endOf('week').toDate();

            db.model('intervention').find({
                status: 'VRF',
                'reglementSurPlace': true,
                'compta.reglement.recu': false,
                'date.intervention': db.utils.between(from, to)
            }).populate('sst').exec(function(err, resp) {
                var rtn = _.groupBy(resp, 'sst.id')
                async.each(_.values(rtn), function(e, cb) {
                    var template = _.template(textTemplate.mail.intervention.relanceArtisan())({
                        options: {},
                        inters: e,
                        sst: e[0].sst,
                        moment: moment
                    })
                    mail.send({
                        From: "comptabilite@edison-services.fr",
                        ReplyTo: "comptabilite@edison-services.fr",
                        To: "mzavot+" +  e[0].sst.nomSociete + "@gmail.com",
                        Subject: "Rappel des interventions en attente de règlement",
                        HtmlBody: template,
                    }, cb);
                }, resolve)
            })
        }).catch(__catch)

    }

}
module.exports = function(schema) {
    var async = require('async');
    var _ = require('lodash');
    var moment = require('moment')

    schema.statics.statsMonths = {
        unique: true,
        findBefore: false,
        method: "GET",
        fn: function(id, req, res) {
            return new Promise(function(resolve, reject) {

                var baseDate = moment().add('-11', 'months').startOf('month').toDate()

                db.model('intervention')
                    .aggregate()
                    .match({
                        'artisan.id': id,
                        'date.ajout': {
                            $gt: baseDate
                        }
                    })
                    .group({
                        _id: {
                            m: {
                                $month: '$date.ajout'
                            },
                            y: {
                                $year: '$date.ajout'
                            }
                        },

                        'annule': {
                            $sum: {
                                $cond: [{
                                    $eq: ['$status', 'ANN']
                                }, 1, 0]
                            }
                        },
                        'paye': {
                            $sum: {
                                $cond: [{
                                    $eq: ['$compta.paiement.effectue', true]
                                }, 1, 0]
                            }
                        }
                    })
                    .exec(function(err, resp) {
                        var momentIterator = require('moment-iterator');
                        var rtn = []
                        var range = momentIterator(baseDate).each('month', function(dt) {
                            rtn.push({
                                month: dt.month() + 1,
                                year: dt.year(),
                                annule: 0,
                                paye: 0
                            })
                        })
                        rtn.map(function(e) {
                            var fnd = _.find(resp, '_id.m', e.month, '_id.y', e.year);
                            if (fnd) {
                                return _.merge(e, _.omit(fnd, '_id'));
                            }
                            return fnd;
                        })
                        resolve(rtn);
                    })

            })
        }
    };
}
module.exports = function(schema) {
    var async = require('async');
    var _ = require('lodash');
    var moment = require('moment')
    schema.statics.stats = {
        unique: true,
        findBefore: true,
        method: "GET",
        fn: function(artisan, req, res) {
            return new Promise(function(resolve, reject) {
                var sumCount = function(query) {
                    query['artisan.id'] = artisan.id;
                    var q = db.model('intervention').aggregate([{
                        $match: query
                    }, {
                        $group: {
                            _id: {
                                // week: '$date.intervention'
                            },
                            mnt: {
                                $sum: "$prixAnnonce"
                            },
                            fnl: {
                                $sum: "$prixAnnonce"
                            },
                            px: {
                                $sum: "$compta.paiement.montant"
                            },
                            total: {
                                $sum: 1
                            }
                        }
                    }, {
                        $project: {
                            _id: 0,
                            total: 1,
                            paye: db.utils.round("$px"),
                            'final': db.utils.round("$fnl"),
                            montant: db.utils.round("$mnt")
                        }
                    }])
                    return q.exec.bind(q);
                }

                var lastMonth = new Date(Date.now() - (28 * 24 * 60 * 60 * 1000));
                async.parallel({
                        total: sumCount({}),
                        annule: sumCount({
                            status: 'ANN'
                        }),
                        paye: sumCount({
                            status: 'VRF',
                            'compta.paiement.effectue': true
                        }),
                        envoye: sumCount({
                            status: 'ENC'
                        }),
                        impayeUrgent: sumCount({
                            status: 'VRF',
                            reglementSurPlace: true,
                            'date.intervention': {
                                $lte: lastMonth
                            },
                            'compta.reglement.recu': false,
                        }),
                        aVerifier: sumCount({
                            status: 'ENC',
                            'date.intervention': {
                                $lte: new Date()
                            },
                        }),
                        impaye: sumCount({
                            status: 'VRF',
                            reglementSurPlace: true,
                            'compta.reglement.recu': false,
                        }),
                        paye: sumCount({
                            'compta.reglement.recu': true,
                        }),
                        _lastInter: function(cb) {
                            db.model('intervention').findOne({
                                'artisan.id': artisan.id
                            }).sort('-id').select('date.ajout').then(function(resp) {
                                if (!resp)
                                    return cb(null, 0)
                                cb(null, {
                                    id: resp._id,
                                    date: resp.date.ajout,
                                    relative: moment(resp.date.ajout).fromNow()
                                })
                            })
                        }
                    },
                    function(err, results) {
                        if (err)
                            return reject(err);
                        var rtn = (_.mapValues(results, function(e, k) {
                            if (k.indexOf('_') == 0) {
                                return e
                            }
                            return e.length ? e[0] : {
                                total: 0,
                                montant: 0,
                                paye: 0,
                                final: 0
                            };
                        }));
                        //        console.log(rtn)
                        resolve(rtn)
                    });

            })
        }
    };
}
module.exports = function(schema) {
    schema.statics.upload = {
        unique: true,
        findBefore: true,
        method: "POST",
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {
                if (!req.files || !req.files.file || !req.files.file.buffer || !req.files.file.extension) {
                    return reject("Invalid File");
                }
                if (req.files.file.size > 5000000)
                    return reject("File is too big");
                var fileName = ["/V2_PRODUCTION/artisan", inter.id, [req.body.name, req.files.file.extension].join('.')].join('/')
                console.log('-->', fileName);
                document.upload({
                    filename: fileName,
                    data: req.files.file.buffer,
                }).then(function(resp) {
                    resolve('ok');
                }, reject);

            });

        }
    }

}
module.exports = function(schema) {

    schema.statics.vcf = function(req, res) {
        var fs = require('fs')
        var config = requireLocal('config/dataList')
        var _ = require('lodash')
        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'artisan',
                method: 'vcf',
                req: _.pick(req, 'query', 'session')
            }).then(function(resp) {
                res.setHeader('Content-disposition', 'attachment; filename=' + "exportArtisansV2.vcf");
                res.setHeader('Content-type', "text/vcard");
                res.write(resp);
                res.end();
            })
        }
        return new Promise(function(resolve, reject) {

            redis.get('vcfArtisans'.envify(), function(err, reply) {
                if (!err && reply && !req.query.cache) {
                    console.log('cache');
                    return resolve(reply)
                }
                db.model('artisan').find({
                    status: {
                        $ne: 'ARC'
                    }
                }).sort('-id').select('id nomSociete address telephone').limit(req.query.limit ||  3000).then(function(docs) {
                    console.log('->', docs.length)
                    var rtn = "";
                    _.each(docs, function(e) {
                        rtn += "BEGIN:VCARD\n";
                        rtn += "VERSION:3.0\n" +
                            _.template("N: {{id}} {{nomSociete}} - {{address.cp}} {{address.v}}\n")(e) +
                            _.template("N: {{id}} {{nomSociete}} - {{address.cp}} {{address.v}}\n")(e) +
                            "TEL;WORK;VOICE: " + e.telephone.tel1 + "\n";

                        if (e.telephone.tel2) {
                            rtn += "TEL;WORK;VOICE: " + e.telephone.tel2 + "\n";
                        }
                        if (e.telephone.tel3) {
                            rtn += "TEL;WORK;VOICE: " + e.telephone.tel3 + "\n";
                        }
                        rtn += "END:VCARD\n";

                    })
                    resolve(rtn);
                    redis.setex('vcfArtisans'.envify(), 600, rtn);
                })
            })

        })
    }
}
module.exports = function(schema) {
    schema.statics.xlist = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('axialis').find(req.query).select('-__v').sort('-date').then(resolve, reject)
        });

    };

    schema.statics.get = {
        unique: true,
        findBefore: false,
        method: 'GET',
        fn: function(call_id, req, res) {
            /* var ftp = require('ftp-get')
             console.log('here')
             ftp.get("ftp://edison:%2F%408.r2DmXcZwvdKs@ftp.axialys.net/17261081.mp3", function(err, resp) {
                 res.contentType("audio/mpeg");
                 res.setHeader('Content-disposition', 'attachment; filename=lol.mp3');
                 res.write(new Buffer(resp, "binary"));
                 res.end()
             })*/
            return new Promise(function(resolve, reject) {

                var JSFtp = require("jsftp");
                var mp3 = require('mp3-parser');
                var streamToBuffer = require('stream-to-buffer')
                var ftp = new JSFtp({
                    host: "ftp.axialys.net",
                    user: "edison", // defaults to "anonymous" 
                    pass: "/@8.r2DmXcZwvdKs" // defaults to "@anonymous" 
                });
                try {

                    ftp.get(call_id + ".mp3", function(err, socket) {
                        var str = "";
                        if (err) {
                            return ftp.get(call_id + ".wav", function(err, socket2) {

                                if (err) {
                                    return resolve('')
                                }
                                streamToBuffer(socket2, function(err, buffer2) {

                                    var gspeech = require('gspeech-api');
                                    var fs = require('fs');
                                    var uuid = require('uuid');
                                    var id = uuid.v4();
                                    fs.writeFileSync("/tmp/" + id + '.wav', buffer2)
/*                                    console.log('before transcript')
                                    gspeech.recognize("/tmp/" + id + '.wav', function(err, data) {
                                    console.log('after transcript')
                                        if (err)
                                            console.error(err);
                                        console.log("Final transcript is:\n" + data.transcript);
                                    });
*/                                    res.contentType("audio/wav");
                                    res.send(buffer2);
                                })
                                socket.resume();
                            })
                        }
                        streamToBuffer(socket, function(err, buffer) {
                            res.contentType("audio/mpeg");
                            res.send(buffer);
                        })
                        socket.resume();
                    });
                } catch (e) {
                    reject('pas de fichier')
                }

                /* ftp.ls(".", function(err, res) {
                     console.log(err, res)
                     res.forEach(function(file) {
                         console.log(file.name);
                     });
                 });*/
            })
        }
    }
}
module.exports = function(schema) {
    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            var async = require('async')
            var comboList = requireLocal('config/combo-produits');
            _.each(comboList, function(combo) {
                _.each(combo.produits, function(e) {
                    if (!e.ref) {
                        e.ref = _.deburr(e.title).toUpperCase().slice(0, 3) + "0" + String(_.random(10, 100))
                    }
                })
            })
            db.model('combo').remove({}, function() {
                db.model('combo').create(comboList, function(err, resp) {
                    resolve('ok')
                });
            })
        })
    }
}
module.exports = function(schema) {
    schema.statics.__save = function(req, res) {
        var _ = require('lodash')
        var async = require('async')
        var comboList = req.body;
        return new Promise(function(resolve, reject) {
            //console.log(comboList)
            _.each(comboList, function(combo) {
                if (!combo.title) {
                    return reject('Veuillez rentrer un titre') && false;
                }
                if (!combo.text) {
                    return reject('Veuillez rentrer un text pour le mail') && false;
                }
                if (!combo.ref) {
                    combo.ref = _.snakeCase(combo.title).toUpperCase().slice(0, 10);
                }
                _.each(combo.produits, function(e) {
                    if (!e.ref) {
                        e.ref = _.deburr(e.title).toUpperCase().slice(0, 3) + "0" + String(_.random(10, 100))
                        return reject("La référence '" + e.ref + "' est invalide") && false;
                    }
                    if (!e.pu && e.pu !== 0) {
                        return reject("Veuillez rentrer un prix pour '" + e.ref + "'") && false;
                    }
                })
            })
            db.model('combo').remove({}, function() {
                db.model('combo').create(comboList).then(resolve, reject)
            })
        })
    }
}
module.exports = function(schema) {

    schema.statics.view = function(prod, req, res) {
        return new Promise(function(resolve, reject) {
            db.model('combo').findById(prod).then(function(resp) {
                if (!resp)
                    return reject('unknown product')
                resolve(resp)
            }, reject)
        })
    }

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('combo').find().then(resolve, reject)
        })
    }
};
module.exports = function(schema) {
    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            var async = require('async')
            var prodList = requireLocal('config/default-comptes');
            db.model('compte').remove({}, function() {
                db.model('compte').create(prodList, function(err, resp) {
                    console.log(err, resp);
                    resolve('ok')
                });
            })
        })
    }
}
module.exports = function(schema) {
    schema.statics.__save = function(req, res) {
        var _ = require('lodash')
        var async = require('async')
        var compteList = req.body;
        return new Promise(function(resolve, reject) {
            _.each(compteList, function(e) {
                if (!e.email ||  !e.nom || !e.address.r || !e.address.v ||  !e.address.cp || !e.address.n) {
                    return reject('Les coordonées de facturations de ' + e.nom + ' sont incompletes')
                }
                e.nom = e.nom.toUpperCase();
                e.email = e.email.toUpperCase();
                e.address.r = e.address.r.toUpperCase();
                e.address.v = e.address.v.toUpperCase();
                e.ref = _.snakeCase(e.nom).slice(0, 10);
            })
            db.model('compte').remove({}, function() {
                db.model('compte').create(compteList).then(resolve, reject)
            })
        })
    }
}
module.exports = function(schema) {

    schema.statics.view = function(prod, req, res) {
        return new Promise(function(resolve, reject) {
            db.model('compte').findById(prod).then(function(resp) {
                if (!resp)
                    return reject('unknown compte')
                resolve(resp)
            }, reject)
        })
    }

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('compte').find().then(resolve, reject)
        })
    }
};
module.exports = function(schema) {

    schema.statics.annulation = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(devis, req, res) {
            return new Promise(function(resolve, reject) {
                devis.date.annulation = new Date;
                devis.login.annulation = req.session.login;
                devis.status = "ANN";
              //  devis.causeAnnulation = req.body.causeAnnulation;
                edison.event('DEVIS_ANNULATION').login(req.session.login).id(devis.id).save();

                devis.save().then(resolve, reject)
            })
        }
    }
}
module.exports = function(schema) {
    var _ = require('lodash')
    var moment = require('moment-timezone')
    var PDF = require('edsx-mail')

    schema.statics.envoi = {

        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(devis, req, res) {

            var getDevisPdfObj = function(doc) {
                console.log("devisSend")
                doc.facture = doc.client;
                doc.facture.tel = doc.client.telephone.tel1;
                doc.datePlain = moment.tz(doc.date.ajout, 'Europe/Paris').format('LL');
                doc.user = req.session;
                doc.acquitte = false;
                doc.type = "devis"
                return PDF([{
                    model: 'facture',
                    options: doc
                }, {
                    model: 'conditions',
                    options: doc
                }], 500)
            }


            return new Promise(function(resolve, reject) {

                if (!envProd) {
                    return resolve('ok')
                }

                if (!devis && !devis.produits || !devis.produits.length)
                    return reject('Le devis est vide')
                        /*                if (envDev) {
                                            devis.historique.push({
                                                login: req.session.login,
                                                date: new Date,
                                            })
                                            devis.status = 'ATT';
                                            return devis.save().then(resolve, reject)
                                        }*/
                if (!isWorker) {
                    return edison.worker.createJob({
                        name: 'db_id',
                        model: 'devis',
                        method: 'envoi',
                        data: devis,
                        req: _.pick(req, 'body', 'session')
                    }).then(function() {
                        devis.historique.push({
                            login: req.session.login,
                            date: new Date,
                        })
                        devis.status = 'ATT';
                        edison.event('DEVIS_ENVOI').login(req.session.login).id(devis.id).save();
                        devis.save().then(resolve, reject)
                    }, reject)
                }



                try {
                    var pdf = getDevisPdfObj(devis);

                } catch (e) {
                    reject(e)
                }
                pdf.toBuffer(function(err, buffer) {
                    console.log('getBuffer');
                    try {
                        var communication = {
                            mailDest: envProd ? devis.client.email : ('contact@edison-services.fr'),
                            mailReply: (req.session.email ||  'contact@edison-services.fr')
                        }
                    } catch (e) {
                        console.log(e.stack);
                    }
                    if (devis.historique.length == 0) {
                        var txt = "DEVIS n°" + devis.id;
                    } else if (devis.historique.length === 1) {
                        var txt = "Suite au devis n°" + devis.id;
                    } else if (devis.historique.length >= 2) {
                        var txt = "Relance concernant le devis n°" + devis.id;
                    }

                    console.log(communication);
                    mail.send({
                        From: "contact@edison-services.fr",
                        ReplyTo: communication.mailReply,
                        To: communication.mailDest,
                        Subject: txt,
                        HtmlBody: req.body.text.replaceAll('\n', '<br>'),
                        Attachments: [{
                            Content: buffer.toString('base64'),
                            Name: "Devis n°" + devis.id + '.pdf',
                            ContentType: 'application/pdf'
                        }]
                    }).then(resolve, reject)
                })

            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.getNextID = function(cb) {
        db.model('intervention').findOne({}).sort("-id")
            .exec(function(err, latestDoc) {
                db.model('devis').findOne({}).sort("-id")
                    .exec(function(err2, latestDoc2) {
                        cb((latestDoc.id > latestDoc2.id ?  latestDoc.id : latestDoc2.id) + 1);
                    })
            })
    }
}
module.exports = function(schema) {
    var _ = require('lodash');
    schema.virtual('envois').get(function() {
        return _.get(this, 'historique.length', 0);
    });

}
module.exports = function(schema) {
    var _ = require('lodash')
    var moment = require('moment-timezone')

    var send = function(e, callback) {
        var textTemplate = requireLocal('config/textTemplate');
        var config = requireLocal('config/dataList');
        var usr = _.find(edison.users.data, 'login', "benjamin_b");
        var realUsr = _.find(edison.users.data, 'login', e.login.ajout)
        var options = {
                session: realUsr || usr,
                body: {
                    text: textTemplate.mail.devis.envoi.bind(e)(realUsr || usr, config, _, moment)
                }
            }
            //  console.log(options)
        db.model('devis').envoi.fn(e, options)
            .then(_.partial(callback, null), callback)
    }

    schema.statics.relanceAuto7h = function(req, res) {
        var async = require('async')
        var todayAt7 = moment.tz('Europe/Paris').hours(7).toDate()
        var yesterdayAt12h30 = moment.tz('Europe/Paris').add(-1, 'days').hours(12).minutes(30).toDate()
        var twoDaysAgo = moment.tz('Europe/Paris').add(-2, 'days').toDate();
        var oneDaysAgo = moment.tz('Europe/Paris').add(-1, 'days').toDate();
        db.model('devis').find({
            status: 'ATT',
            /*historique: {
                $size: 1
            },
            'historique.0.date': {
                $gt: yesterdayAt12h30
            }*/
        }).then(function(resp) {
            sms.send({
                to: '0633138868',
                text: 'devis rappel ' + JSON.stringify(_.pluck(resp, 'id')) 
            })
            async.eachLimit(resp, 1, send)
        })

        db.model('devis').find({
            status: 'ATT',
            historique: {
                $size: 2
            },
            'historique.1.date': {
                $lt: oneDaysAgo,
                $gte: twoDaysAgo
            }
        }).then(function(resp) {
            sms.send({
                to: '0633138868',
                text: 'devis rappel ' + JSON.stringify(_.pluck(resp, 'id')) 
            })
            async.eachLimit(resp, 1, send);
        })
    }


    schema.statics.relanceAuto14h = function(req, res) {
        var moment = require('moment')
        var async = require('async')

        var todayAt7 = moment.tz('Europe/Paris').hours(7).toDate()
        db.model('devis').find({
            status: 'ATT',
            historique: {
                $size: 1
            },
            'historique.0.date': {
                $gt: todayAt7
            }
        }).then(function(resp) {
            sms.send({
                to: '0633138868',
                text: 'devis rappel ' + JSON.stringify(_.pluck(resp, 'id')) 
            })
            async.eachLimit(resp, 1, send)
        })
    }

}
module.exports = function(schema) {

    schema.statics.checkArchived = function(req, res) {
        edison.v1.get('SELECT COUNT(*) FROM scanner WHERE archived=1', function(err, resp) {
            res.json([err, resp])
        });
    }

    schema.statics.archiveScan = function(req, res) {
        var _ = require('lodash');
        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'document',
                method: 'archiveScan',
                req: _.pick(req, 'query', 'session')
            })
        }

        return new Promise(function(resolve, reject) {
            var request = require('request');
            var requestP = require('request-promise');
            var async = require('async');
            var moment = require('moment');
                /*  edison.v1.set("update ecritures set t_stasmp='" + _.random(10, 100) + "' WHERE 1=1",function(err, resp) {
                      console.log(err, resp)
                  });*/
            var i = 0;
            var limit = req.query.limit || 100;
            var archiveFile = function(file, cb) {
                console.log(String(i++) + '/' + String(limit))
                document.move('/SCAN/' + file.name, '/SCAN_ARCHIVES/' + file.name)
                    .then(function(resp) {
                        console.log('MV', file.name)
                        edison.v1.set("UPDATE scanner SET archived='1' WHERE id='" + file.id + "'", function() {
                            console.log('SAVED', file.name)
                            cb(null)
                        })
                    }, function(err) {
                        console.log('ERR', file.name, err)
                        if (_.includes(String(err), '404')) {
                            document.move('/SCAN_ARCHIVES/' + file.name, '/SCAN/' + file.name).then(function(resp) {
                                console.log('YEPYEPYEP')
                                cb(null)
                            }, function() {
                                console.log('SECERR')
                                cb(null);
                            })
                        }
                    });
            }


            var i = 0;
            edison.v1.get("SELECT * FROM scanner WHERE checked='1' AND archived='0' AND moved='1' LIMIT " + limit, function(err, resp) {
                    limit = resp.length;
                    async.eachLimit(resp, 3, archiveFile, function(err, resp) {
                        console.log(err, resp)
                        resolve('ok')
                    })
                })
        }).catch(__catch)
    }
}
   module.exports = function(schema) {
       var _ = require('lodash')
       var moment = require('moment')
       var request = require('request')
       var async = require('async')



       schema.statics.backup = function(req, res) {
           return new Promise(function(resolve, reject) {

               var backup = [{
                   "id": 1,
                   "start": 1412783586849,
                   "id_inter": 8554
               }, {
                   "id": 2,
                   "start": 1412783617581,
                   "id_inter": 8554
               }, {
                   "id": 10,
                   "start": 1412837326252,
                   "id_inter": 8874
               }, {
                   "id": 11,
                   "start": 1412837406876,
                   "id_inter": 8874
               }, {
                   "id": 12,
                   "start": 1412837972980,
                   "id_inter": 9814
               }, {
                   "id": 13,
                   "start": 1412838316838,
                   "id_inter": 9176
               }, {
                   "id": 30,
                   "start": 1412842045426,
                   "id_inter": 8588
               }, {
                   "id": 31,
                   "start": 1412842222242,
                   "id_inter": 10319
               }, {
                   "id": 32,
                   "start": 1412842648850,
                   "id_inter": 10328
               }, {
                   "id": 33,
                   "start": 1412842785274,
                   "id_inter": 10374
               }, {
                   "id": 34,
                   "start": 1412842909194,
                   "id_inter": 10400
               }, {
                   "id": 35,
                   "start": 1412843105258,
                   "id_inter": 10172
               }, {
                   "id": 36,
                   "start": 1412843266859,
                   "id_inter": 9629
               }, {
                   "id": 39,
                   "start": 1412844712812,
                   "id_inter": 9830
               }, {
                   "id": 40,
                   "start": 1412845005604,
                   "id_inter": 9873
               }, {
                   "id": 41,
                   "start": 1412845208277,
                   "id_inter": 10301
               }, {
                   "id": 42,
                   "start": 1412845686733,
                   "id_inter": 9227
               }, {
                   "id": 43,
                   "start": 1412846313261,
                   "id_inter": 9667
               }, {
                   "id": 44,
                   "start": 1412846366965,
                   "id_inter": 9667
               }, {
                   "id": 45,
                   "start": 1412847262414,
                   "id_inter": 9569
               }, {
                   "id": 46,
                   "start": 1412847454031,
                   "id_inter": 9879
               }, {
                   "id": 47,
                   "start": 1412848274496,
                   "id_inter": 9817
               }, {
                   "id": 48,
                   "start": 1412848522184,
                   "id_inter": 9885
               }, {
                   "id": 50,
                   "start": 1412848966329,
                   "id_inter": 9781
               }, {
                   "id": 51,
                   "start": 1412848993049,
                   "id_inter": 9781
               }, {
                   "id": 60,
                   "start": 1412851754947,
                   "id_inter": 8476
               }, {
                   "id": 67,
                   "start": 1412855038567,
                   "id_inter": 7191
               }, {
                   "id": 68,
                   "start": 1412855804527,
                   "id_inter": 10329
               }, {
                   "id": 80,
                   "start": 1412868066803,
                   "id_inter": 8554
               }, {
                   "id": 82,
                   "start": 1412868185327,
                   "id_inter": 9842
               }, {
                   "id": 97,
                   "start": 1412924145770,
                   "id_inter": 10043
               }, {
                   "id": 98,
                   "start": 1412924335154,
                   "id_inter": 8681
               }, {
                   "id": 99,
                   "start": 1412925341877,
                   "id_inter": 10193
               }, {
                   "id": 100,
                   "start": 1412925490940,
                   "id_inter": 10193
               }, {
                   "id": 101,
                   "start": 1412925827252,
                   "id_inter": 10150
               }, {
                   "id": 102,
                   "start": 1412950522112,
                   "id_inter": 10084
               }, {
                   "id": 103,
                   "start": 1412950639416,
                   "id_inter": 10084
               }, {
                   "id": 104,
                   "start": 1412950820624,
                   "id_inter": 10084
               }, {
                   "id": 109,
                   "start": 1413202788389,
                   "id_inter": 4377
               }, {
                   "id": 116,
                   "start": 1413204337721,
                   "id_inter": 4543
               }, {
                   "id": 117,
                   "start": 1413204430376,
                   "id_inter": 4392
               }, {
                   "id": 185,
                   "start": 1413273080000,
                   "id_inter": 9665
               }, {
                   "id": 236,
                   "start": 1413295252175,
                   "id_inter": 10149
               }, {
                   "id": 271,
                   "start": 1413372061251,
                   "id_inter": 10062
               }, {
                   "id": 287,
                   "start": 1413443036657,
                   "id_inter": 3628
               }, {
                   "id": 288,
                   "start": 1413443055438,
                   "id_inter": 3628
               }, {
                   "id": 309,
                   "start": 1413444520773,
                   "id_inter": 5250
               }, {
                   "id": 315,
                   "start": 1413445448716,
                   "id_inter": 4597
               }, {
                   "id": 318,
                   "start": 1413445610244,
                   "id_inter": 4720
               }, {
                   "id": 320,
                   "start": 1413445706748,
                   "id_inter": 4652
               }, {
                   "id": 321,
                   "start": 1413445806498,
                   "id_inter": 2376
               }, {
                   "id": 329,
                   "start": 1413446316461,
                   "id_inter": 4787
               }, {
                   "id": 343,
                   "start": 1413447666250,
                   "id_inter": 4654
               }, {
                   "id": 348,
                   "start": 1413448186495,
                   "id_inter": 4860
               }, {
                   "id": 351,
                   "start": 1413448400583,
                   "id_inter": 4930
               }, {
                   "id": 393,
                   "start": 1413454194528,
                   "id_inter": 3261
               }, {
                   "id": 400,
                   "start": 1413454797133,
                   "id_inter": 3693
               }, {
                   "id": 426,
                   "start": 1413459666412,
                   "id_inter": 4208
               }, {
                   "id": 431,
                   "start": 1413460181681,
                   "id_inter": 4881
               }, {
                   "id": 583,
                   "start": 1413978173973,
                   "id_inter": 10337
               }, {
                   "id": 625,
                   "start": 1413993972477,
                   "id_inter": 10477
               }, {
                   "id": 642,
                   "start": 1413999447446,
                   "id_inter": 10086
               }, {
                   "id": 644,
                   "start": 1414044307056,
                   "id_inter": 9886
               }, {
                   "id": 652,
                   "start": 1414050887691,
                   "id_inter": 10335
               }, {
                   "id": 655,
                   "start": 1414055705276,
                   "id_inter": 8862
               }, {
                   "id": 689,
                   "start": 1414141080870,
                   "id_inter": 10341
               }, {
                   "id": 690,
                   "start": 1414141086998,
                   "id_inter": 10341
               }, {
                   "id": 707,
                   "start": 1414404508738,
                   "id_inter": 10134
               }, {
                   "id": 715,
                   "start": 1414419405029,
                   "id_inter": 4917
               }, {
                   "id": 719,
                   "start": 1414419634813,
                   "id_inter": 5411
               }, {
                   "id": 722,
                   "start": 1414419774902,
                   "id_inter": 5518
               }, {
                   "id": 730,
                   "start": 1414420329945,
                   "id_inter": 5558
               }, {
                   "id": 734,
                   "start": 1414420483831,
                   "id_inter": 5725
               }, {
                   "id": 738,
                   "start": 1414421639294,
                   "id_inter": 5811
               }, {
                   "id": 817,
                   "start": 1414483081522,
                   "id_inter": 4717
               }, {
                   "id": 863,
                   "start": 1414486769004,
                   "id_inter": 5084
               }, {
                   "id": 886,
                   "start": 1414491601910,
                   "id_inter": 3222
               }, {
                   "id": 922,
                   "start": 1414591231160,
                   "id_inter": 10366
               }, {
                   "id": 928,
                   "start": 1414652028016,
                   "id_inter": 10779
               }, {
                   "id": 991,
                   "start": 1414741982908,
                   "id_inter": 10837
               }, {
                   "id": 1014,
                   "start": 1415180109989,
                   "id_inter": 4817
               }, {
                   "id": 1019,
                   "start": 1415191144290,
                   "id_inter": 10373
               }, {
                   "id": 1020,
                   "start": 1415194712115,
                   "id_inter": 10792
               }, {
                   "id": 1034,
                   "start": 1415262450833,
                   "id_inter": 10912
               }, {
                   "id": 1035,
                   "start": 1415262473353,
                   "id_inter": 10912
               }, {
                   "id": 1036,
                   "start": 1415262792610,
                   "id_inter": 10912
               }, {
                   "id": 1084,
                   "start": 1415788257293,
                   "id_inter": 10437
               }, {
                   "id": 1123,
                   "start": 1415874698682,
                   "id_inter": 11402
               }, {
                   "id": 1152,
                   "start": 1415946689405,
                   "id_inter": 11198
               }, {
                   "id": 1180,
                   "start": 1415964121760,
                   "id_inter": 11332
               }, {
                   "id": 1195,
                   "start": 1415968690373,
                   "id_inter": 8392
               }, {
                   "id": 1256,
                   "start": 1416487855028,
                   "id_inter": 11293
               }, {
                   "id": 1287,
                   "start": 1416550651773,
                   "id_inter": 11518
               }, {
                   "id": 1364,
                   "start": 1417076615204,
                   "id_inter": 11798
               }, {
                   "id": 1423,
                   "start": 1417178576022,
                   "id_inter": 11321
               }, {
                   "id": 1560,
                   "start": 1418279406416,
                   "id_inter": 10988
               }, {
                   "id": 1600,
                   "start": 1418298269239,
                   "id_inter": 12439
               }, {
                   "id": 1632,
                   "start": 1418364787338,
                   "id_inter": 11953
               }, {
                   "id": 1713,
                   "start": 1418910189399,
                   "id_inter": 12308
               }, {
                   "id": 1735,
                   "start": 1418969533383,
                   "id_inter": 12547
               }, {
                   "id": 1789,
                   "start": 1418992269359,
                   "id_inter": 12093
               }, {
                   "id": 1811,
                   "start": 1419258660008,
                   "id_inter": 12107
               }, {
                   "id": 1845,
                   "start": 1419846262555,
                   "id_inter": 13197
               }, {
                   "id": 1846,
                   "start": 1419846267683,
                   "id_inter": 13197
               }, {
                   "id": 1884,
                   "start": 1419861639471,
                   "id_inter": 12704
               }, {
                   "id": 1908,
                   "start": 1419935039012,
                   "id_inter": 12855
               }, {
                   "id": 1909,
                   "start": 1419935046996,
                   "id_inter": 12855
               }, {
                   "id": 1995,
                   "start": 1420024067725,
                   "id_inter": 13097
               }, {
                   "id": 2075,
                   "start": 1420724170255,
                   "id_inter": 13413
               }, {
                   "id": 2148,
                   "start": 1420800060354,
                   "id_inter": 13574
               }, {
                   "id": 2149,
                   "start": 1420800069218,
                   "id_inter": 13574
               }, {
                   "id": 2214,
                   "start": 1421312023490,
                   "id_inter": 12825
               }, {
                   "id": 2410,
                   "start": 1421650406647,
                   "id_inter": 13698
               }, {
                   "id": 2419,
                   "start": 1421747272022,
                   "id_inter": 11938
               }, {
                   "id": 2627,
                   "start": 1422530236642,
                   "id_inter": 14313
               }, {
                   "id": 2669,
                   "start": 1422610495559,
                   "id_inter": 12719
               }, {
                   "id": 2670,
                   "start": 1422610513990,
                   "id_inter": 12719
               }, {
                   "id": 2671,
                   "start": 1422610519871,
                   "id_inter": 12719
               }, {
                   "id": 2790,
                   "start": 1423145947501,
                   "id_inter": 11774
               }, {
                   "id": 2974,
                   "start": 1423759249815,
                   "id_inter": 15090
               }, {
                   "id": 2976,
                   "start": 1423809132309,
                   "id_inter": 14150
               }, {
                   "id": 2977,
                   "start": 1423809153178,
                   "id_inter": 14150
               }, {
                   "id": 3129,
                   "start": 1424358461443,
                   "id_inter": 15375
               }, {
                   "id": 3163,
                   "start": 1424412671808,
                   "id_inter": 15363
               }, {
                   "id": 3195,
                   "start": 1424443538110,
                   "id_inter": 14406
               }, {
                   "id": 3342,
                   "start": 1424965368743,
                   "id_inter": 15814
               }, {
                   "id": 3354,
                   "start": 1425021607788,
                   "id_inter": 15418
               }, {
                   "id": 3395,
                   "start": 1425052894187,
                   "id_inter": 3006
               }, {
                   "id": 3409,
                   "start": 1425371840693,
                   "id_inter": 16076
               }, {
                   "id": 3410,
                   "start": 1425371847468,
                   "id_inter": 16076
               }, {
                   "id": 3411,
                   "start": 1425371848660,
                   "id_inter": 16076
               }, {
                   "id": 3412,
                   "start": 1425371848844,
                   "id_inter": 16076
               }, {
                   "id": 3449,
                   "start": 1425545753611,
                   "id_inter": 14848
               }, {
                   "id": 3506,
                   "start": 1425566853000,
                   "id_inter": 15362
               }, {
                   "id": 3517,
                   "start": 1425638007587,
                   "id_inter": 16073
               }, {
                   "id": 3525,
                   "start": 1425648158427,
                   "id_inter": 16110
               }, {
                   "id": 3566,
                   "start": 1426072514399,
                   "id_inter": 12368
               }, {
                   "id": 3567,
                   "start": 1426072617251,
                   "id_inter": 12368
               }, {
                   "id": 3568,
                   "start": 1426072718167,
                   "id_inter": 31
               }, {
                   "id": 3569,
                   "start": 1426072765598,
                   "id_inter": 31
               }, {
                   "id": 3570,
                   "start": 1426072802005,
                   "id_inter": 31
               }, {
                   "id": 3571,
                   "start": 1426072909737,
                   "id_inter": 31
               }, {
                   "id": 3572,
                   "start": 1426072988095,
                   "id_inter": 31
               }, {
                   "id": 3573,
                   "start": 1426073016462,
                   "id_inter": 31
               }, {
                   "id": 3574,
                   "start": 1426074047850,
                   "id_inter": 31
               }, {
                   "id": 3575,
                   "start": 1426076890126,
                   "id_inter": 7
               }, {
                   "id": 3617,
                   "start": 1426151984123,
                   "id_inter": 31
               }, {
                   "id": 4156,
                   "start": 1426747431620,
                   "id_inter": 16727
               }, {
                   "id": 4190,
                   "start": 1426755726000,
                   "id_inter": 15830
               }, {
                   "id": 4260,
                   "start": 1426832649114,
                   "id_inter": 16393
               }, {
                   "id": 4278,
                   "start": 1426836598511,
                   "id_inter": 16236
               }, {
                   "id": 4323,
                   "start": 1427095845484,
                   "id_inter": 9198
               }, {
                   "id": 4624,
                   "start": 1427274355280,
                   "id_inter": 7086
               }, {
                   "id": 4625,
                   "start": 1427274358750,
                   "id_inter": 7086
               }, {
                   "id": 4626,
                   "start": 1427274372255,
                   "id_inter": 7086
               }, {
                   "id": 4627,
                   "start": 1427274374342,
                   "id_inter": 7086
               }, {
                   "id": 4628,
                   "start": 1427274375030,
                   "id_inter": 7086
               }, {
                   "id": 4629,
                   "start": 1427274375702,
                   "id_inter": 7086
               }, {
                   "id": 4630,
                   "start": 1427274376358,
                   "id_inter": 7086
               }, {
                   "id": 4631,
                   "start": 1427274395093,
                   "id_inter": 7086
               }, {
                   "id": 4632,
                   "start": 1427274396181,
                   "id_inter": 7086
               }, {
                   "id": 4633,
                   "start": 1427274397085,
                   "id_inter": 7086
               }, {
                   "id": 4634,
                   "start": 1427274398012,
                   "id_inter": 7086
               }, {
                   "id": 4635,
                   "start": 1427274398548,
                   "id_inter": 7086
               }, {
                   "id": 4636,
                   "start": 1427274398756,
                   "id_inter": 7086
               }, {
                   "id": 4637,
                   "start": 1427274398940,
                   "id_inter": 7086
               }, {
                   "id": 4638,
                   "start": 1427274399132,
                   "id_inter": 7086
               }, {
                   "id": 4639,
                   "start": 1427274399324,
                   "id_inter": 7086
               }, {
                   "id": 4640,
                   "start": 1427274399516,
                   "id_inter": 7086
               }, {
                   "id": 4641,
                   "start": 1427274399692,
                   "id_inter": 7086
               }, {
                   "id": 4642,
                   "start": 1427274399876,
                   "id_inter": 7086
               }, {
                   "id": 4643,
                   "start": 1427274400076,
                   "id_inter": 7086
               }, {
                   "id": 4644,
                   "start": 1427274400684,
                   "id_inter": 7086
               }, {
                   "id": 4645,
                   "start": 1427274400884,
                   "id_inter": 7086
               }, {
                   "id": 4646,
                   "start": 1427274401084,
                   "id_inter": 7086
               }, {
                   "id": 4647,
                   "start": 1427274401276,
                   "id_inter": 7086
               }, {
                   "id": 4648,
                   "start": 1427274401484,
                   "id_inter": 7086
               }, {
                   "id": 4649,
                   "start": 1427274401668,
                   "id_inter": 7086
               }, {
                   "id": 4650,
                   "start": 1427274401868,
                   "id_inter": 7086
               }, {
                   "id": 4651,
                   "start": 1427274433339,
                   "id_inter": 7086
               }, {
                   "id": 4652,
                   "start": 1427274436483,
                   "id_inter": 7086
               }, {
                   "id": 4653,
                   "start": 1427274437131,
                   "id_inter": 7086
               }, {
                   "id": 4654,
                   "start": 1427274449476,
                   "id_inter": 7086
               }, {
                   "id": 4655,
                   "start": 1427274450195,
                   "id_inter": 7086
               }, {
                   "id": 4656,
                   "start": 1427274450811,
                   "id_inter": 7086
               }, {
                   "id": 4657,
                   "start": 1427274451379,
                   "id_inter": 7086
               }, {
                   "id": 4658,
                   "start": 1427274451890,
                   "id_inter": 7086
               }, {
                   "id": 4659,
                   "start": 1427274452098,
                   "id_inter": 7086
               }, {
                   "id": 4660,
                   "start": 1427274452290,
                   "id_inter": 7086
               }, {
                   "id": 4661,
                   "start": 1427274452483,
                   "id_inter": 7086
               }, {
                   "id": 4662,
                   "start": 1427274452674,
                   "id_inter": 7086
               }, {
                   "id": 4663,
                   "start": 1427274452866,
                   "id_inter": 7086
               }, {
                   "id": 4664,
                   "start": 1427274453058,
                   "id_inter": 7086
               }, {
                   "id": 4835,
                   "start": 1427375528613,
                   "id_inter": 16999
               }, {
                   "id": 4954,
                   "start": 1427707589671,
                   "id_inter": 17326
               }, {
                   "id": 4959,
                   "start": 1427966429102,
                   "id_inter": 17160
               }, {
                   "id": 4970,
                   "start": 1427970409605,
                   "id_inter": 16030
               }, {
                   "id": 4975,
                   "start": 1427972695443,
                   "id_inter": 16974
               }, {
                   "id": 5008,
                   "start": 1427985034609,
                   "id_inter": 17236
               }, {
                   "id": 5020,
                   "start": 1427989714991,
                   "id_inter": 17091
               }, {
                   "id": 5022,
                   "start": 1427990005431,
                   "id_inter": 16859
               }, {
                   "id": 5023,
                   "start": 1427991696759,
                   "id_inter": 16336
               }, {
                   "id": 5025,
                   "start": 1427991975375,
                   "id_inter": 17360
               }, {
                   "id": 5030,
                   "start": 1428042556890,
                   "id_inter": 16780
               }, {
                   "id": 5036,
                   "start": 1428046578071,
                   "id_inter": 17021
               }, {
                   "id": 5046,
                   "start": 1428053200758,
                   "id_inter": 17452
               }, {
                   "id": 5051,
                   "start": 1428055539109,
                   "id_inter": 17389
               }, {
                   "id": 5052,
                   "start": 1428055627277,
                   "id_inter": 17107
               }, {
                   "id": 5061,
                   "start": 1428060148533,
                   "id_inter": 17445
               }, {
                   "id": 5066,
                   "start": 1428062412932,
                   "id_inter": 17177
               }, {
                   "id": 5073,
                   "start": 1428065116827,
                   "id_inter": 17532
               }, {
                   "id": 5080,
                   "start": 1428069889593,
                   "id_inter": 16824
               }, {
                   "id": 5082,
                   "start": 1428070723337,
                   "id_inter": 17255
               }, {
                   "id": 5084,
                   "start": 1428075645592,
                   "id_inter": 13022
               }, {
                   "id": 5085,
                   "start": 1428075652664,
                   "id_inter": 13022
               }, {
                   "id": 5086,
                   "start": 1428075656408,
                   "id_inter": 13022
               }, {
                   "id": 5091,
                   "start": 1428076487768,
                   "id_inter": 14596
               }, {
                   "id": 5111,
                   "start": 1428478661646,
                   "id_inter": 16622
               }, {
                   "id": 5126,
                   "start": 1428492825977,
                   "id_inter": 13514
               }, {
                   "id": 5233,
                   "start": 1428661090708,
                   "id_inter": 17591
               }, {
                   "id": 5280,
                   "start": 1428678065548,
                   "id_inter": 17347
               }, {
                   "id": 5293,
                   "start": 1428913450578,
                   "id_inter": 17734
               }, {
                   "id": 5296,
                   "start": 1428917202650,
                   "id_inter": 17918
               }, {
                   "id": 5356,
                   "start": 1429175324203,
                   "id_inter": 15089
               }, {
                   "id": 5485,
                   "start": 1429260323666,
                   "id_inter": 16100
               }, {
                   "id": 5531,
                   "start": 1429531515300,
                   "id_inter": 18568
               }, {
                   "id": 5532,
                   "start": 1429531622582,
                   "id_inter": 18568
               }, {
                   "id": 5605,
                   "start": 1429788143000,
                   "id_inter": 18658
               }, {
                   "id": 5666,
                   "start": 1429850502041,
                   "id_inter": 17299
               }, {
                   "id": 5747,
                   "start": 1429886258970,
                   "id_inter": 19152
               }, {
                   "id": 6051,
                   "start": 1431064222769,
                   "id_inter": 19467
               }, {
                   "id": 6174,
                   "start": 1431431742161,
                   "id_inter": 17379
               }, {
                   "id": 6198,
                   "start": 1431525783300,
                   "id_inter": 19068
               }, {
                   "id": 6277,
                   "start": 1431695668000,
                   "id_inter": 19209
               }, {
                   "id": 6306,
                   "start": 1431957365997,
                   "id_inter": 18085
               }, {
                   "id": 6307,
                   "start": 1431957368114,
                   "id_inter": 18085
               }, {
                   "id": 6308,
                   "start": 1431957369048,
                   "id_inter": 18085
               }, {
                   "id": 6309,
                   "start": 1431957370403,
                   "id_inter": 18085
               }, {
                   "id": 6759,
                   "start": 1433228618827,
                   "id_inter": 20785
               }, {
                   "id": 6822,
                   "start": 1433316586730,
                   "id_inter": 20773
               }, {
                   "id": 6824,
                   "start": 1433319530735,
                   "id_inter": 19482
               }, {
                   "id": 7040,
                   "start": 1433510682246,
                   "id_inter": 20983
               }, {
                   "id": 7063,
                   "start": 1433832371152,
                   "id_inter": 21456
               }, {
                   "id": 7313,
                   "start": 1434955939943,
                   "id_inter": 21354
               }, {
                   "id": 7386,
                   "start": 1434968867000,
                   "id_inter": 21989
               }, {
                   "id": 7619,
                   "start": 1435074170426,
                   "id_inter": 21578
               }, {
                   "id": 7663,
                   "start": 1435075821956,
                   "id_inter": 22321
               }, {
                   "id": 7664,
                   "start": 1435075830748,
                   "id_inter": 22321
               }, {
                   "id": 7875,
                   "start": 1435306889114,
                   "id_inter": 21640
               }, {
                   "id": 7897,
                   "start": 1435316921071,
                   "id_inter": 19530
               }, {
                   "id": 7913,
                   "start": 1435324171638,
                   "id_inter": 22542
               }, {
                   "id": 7955,
                   "start": 1435329647989,
                   "id_inter": 22221
               }, {
                   "id": 7956,
                   "start": 1435329657761,
                   "id_inter": 22221
               }, {
                   "id": 7957,
                   "start": 1435329694107,
                   "id_inter": 22221
               }, {
                   "id": 7980,
                   "start": 1435648584047,
                   "id_inter": 20326
               }, {
                   "id": 7982,
                   "start": 1435732176621,
                   "id_inter": 22062
               }, {
                   "id": 7998,
                   "start": 1435738747812,
                   "id_inter": 22883
               }, {
                   "id": 8110,
                   "start": 1435845426898,
                   "id_inter": 22286
               }, {
                   "id": 8254,
                   "start": 1436184191691,
                   "id_inter": 22912
               }, {
                   "id": 8280,
                   "start": 1436279381524,
                   "id_inter": 23721
               }, {
                   "id": 8336,
                   "start": 1436368090052,
                   "id_inter": 22935
               }, {
                   "id": 8367,
                   "start": 1436428092920,
                   "id_inter": 22723
               }, {
                   "id": 8525,
                   "start": 1436445240058,
                   "id_inter": 22108
               }, {
                   "id": 8569,
                   "start": 1436528368944,
                   "id_inter": 23376
               }, {
                   "id": 8571,
                   "start": 1436528423643,
                   "id_inter": 23376
               }, {
                   "id": 8663,
                   "start": 1436942562604,
                   "id_inter": 19467
               }, {
                   "id": 8818,
                   "start": 1437133700435,
                   "id_inter": 23624
               }, {
                   "id": 8889,
                   "start": 1437472963348,
                   "id_inter": 24177
               }, {
                   "id": 9394,
                   "start": 1438245597872,
                   "id_inter": 22362
               }, {
                   "id": 9409,
                   "start": 1438326154593,
                   "id_inter": 23337
               }, {
                   "id": 9480,
                   "start": 1438700038672,
                   "id_inter": 24988
               }, {
                   "id": 9685,
                   "start": 1438868534278,
                   "id_inter": 24609
               }, {
                   "id": 9712,
                   "start": 1439476120225,
                   "id_inter": 10111
               }, {
                   "id": 9774,
                   "start": 1439802934000,
                   "id_inter": 25391
               }, {
                   "id": 9929,
                   "start": 1440050828063,
                   "id_inter": 24546
               }, {
                   "id": 10038,
                   "start": 1440154796393,
                   "id_inter": 26587
               }, {
                   "id": 10139,
                   "start": 1440166240579,
                   "id_inter": 25402
               }, {
                   "id": 10222,
                   "start": 1440417424841,
                   "id_inter": 24841
               }, {
                   "id": 10316,
                   "start": 1440659130593,
                   "id_inter": 26620
               }, {
                   "id": 10411,
                   "start": 1440680821278,
                   "id_inter": 24557
               }, {
                   "id": 10492,
                   "start": 1440742349913,
                   "id_inter": 25212
               }, {
                   "id": 10752,
                   "start": 1441286645971,
                   "id_inter": 26374
               }, {
                   "id": 10952,
                   "start": 1441692257988,
                   "id_inter": 28252
               }, {
                   "id": 10975,
                   "start": 1441865212216,
                   "id_inter": 24769
               }, {
                   "id": 11108,
                   "start": 1441952865718,
                   "id_inter": 25543
               }, {
                   "id": 11175,
                   "start": 1442238213133,
                   "id_inter": 25881
               }, {
                   "id": 11176,
                   "start": 1442242457746,
                   "id_inter": 13518
               }, {
                   "id": 11179,
                   "start": 1442301358750,
                   "id_inter": 20729
               }, {
                   "id": 11181,
                   "start": 1442302598088,
                   "id_inter": 28796
               }]

               var rtn = ""
               _.each(backup, function(e) {
                   var insert = _.template("INSERT INTO scanner (id, start, id_inter) VALUES ('{{id}}', '{{start}}', '{{id_inter}}');")(e);
                   rtn += (insert);
               })

               console.log(rtn)
                   /*var lol = [];
                   edison.v1.get("SELECT * FROM scanner ", function(err, resp) {
                       _.times(11543, function(n) {
                           var x = _.find(resp, function(e) {
                               //if (n % 100 == 0)
                               //  console.log(e.id, n)
                               return e.id == n
                           });
                           if (!x) {
                               lol.push(n);
                           }
                       })
                       console.log("'" + lol.join("', '") + "'")
                   })*/
           })
       }
   }
module.exports = function(schema) {

    schema.statics.changeLink = function(options) {
        return new Promise(function(resolve, reject) {
            db.model('document').update({
                    link: options.oldID
                }, {
                    link: options.newID
                }, {
                    multi: true
                })
                .then(function(e) {
                    if (e.nModified > 0) {
                        var x = "/V2/" + options.model + '/';
                        document.move(x + options.oldID, x + options.newID)
                            .then(resolve, reject);
                    }
                }, reject);
        })
    }
}
   module.exports = function(schema) {
       var _ = require('lodash')
       var moment = require('moment-timezone')
       var request = require('request')
       var async = require('async')

       var convert = function(ts, offset) {
           var dt = ts.replace('.', '-').split('-').slice(0, -4).join('-');
           var hr = ts.replace('.', '-').split('-').slice(3, 6).join(':');
           return moment.tz(dt + " " + hr, 'Europe/Paris').unix() * 1000 + (offset || 0)
       }


       schema.statics.checkChecked = function(req, res) {
           edison.v1.get('SELECT COUNT(*) FROM scanner WHERE checked=1', function(err, resp) {
               res.json([err, resp])
           });
       }


       var findClosest = function(x, dbl) {
           var min = {
               diff: Math.pow(9, 9)
           }
           _.each(dbl, function(e) {
               e.diff = e.ts - x.start;
               if (Math.abs(e.diff) < Math.abs(min.diff)) {
                   min = e;
               }
           })
           if ((min.diff > 0 && min.diff < 15000) || (min.diff < 0 && min.diff > -1000)) {
               return min
           }
           return null
               /*return _.find(dbl, function(e) {
                   e.diff = e.ts - x.start;
                   console.log(e.diff, moment(new Date(parseInt(x.start))).format('YYYY-MM-DD-HH-mm-ss'), e.name)
                   return (e.diff > 0 && e.diff < 5000) || (e.diff < 0 && e.diff > -1000)
               })*/
       }


       var moveV1 = function(closest, cb) {
           request.get({
               url: 'http://electricien13003.com/alvin/5_Gestion_des_interventions/mvFile.php',
               qs: {
                   file: '/SCAN/' + closest.name
               }
           }, function(err, resp, body) {
               cb(err, body)
           })
       }


       schema.statics.check = function(req, res) {



           if (!isWorker) {
               return edison.worker.createJob({
                   name: 'db',
                   model: 'document',
                   method: 'check',
                   req: _.pick(req, 'query', 'session')
               })
           }




           return new Promise(function(resolve, reject) {
                   document.list('/SCAN').then(function(dbl) {
                       dbl = _(dbl).filter(function(e) {
                           return e.length === 23 && _.endsWith(e, '.pdf') && e[4] === '-'
                       }).map(function(e) {
                           return {
                               name: e,
                               ts: convert(e, 0)
                           }
                       }).value();


                       var i = 0;
                       var limit = req.query.limit || 100;
                       edison.v1.get("SELECT * FROM scanner WHERE moved='0' AND checked='0' ORDER BY id ASC LIMIT " + limit, function(err, resp)  {
                           limit = resp.length;
                           async.eachLimit(resp, 20, function(row, cb) {
                               console.log(String(i++) + '/' + String(limit))
                               var closest = findClosest(row, dbl)
                               if (closest) {
                                   var mrg = _.merge(row, closest)
                                   moveV1(closest, function(err, resp) {
                                       if (err || !resp) {
                                           console.log("ERR", '<', err, ">", mrg.name, mrg.id);
                                           return cb(null, 'ERR')
                                       }
                                       var q = _.template("UPDATE scanner SET diff='{{diff}}', name='{{name}}', checked='1',  moved='1' WHERE id='{{id}}'")(mrg)
                                       edison.v1.set(q, function(err, resp) {
                                           console.log('OK', mrg.name, mrg.id);
                                           cb(null, 'ok')
                                       })
                                   })
                               } else {
                                   console.log('NOT FOUND', row.id_inter)
                                   edison.v1.set(_.template("UPDATE scanner SET checked='0' WHERE id='{{id}}'")(row), cb)
                               }
                           }, function(resp) {
                               resolve('ok');
                           })
                       })
                   }, function(err) {
                       console.log('-->', err)
                   })
               })
               .catch(__catch);



           /*          _.each(_.filter(dbl, 'length', 23).slice(0, 10), function(e) {
                             var cvt = convert(e);
                             var closest = findClosest(cvt, )
                             console.log('-->', cvt)
                         })*/
       }
   }
module.exports = function(schema) {
  schema.virtual('filename').get(function() {
    return '/V2/' + this.model + '/' + this.link + '/' + this._id + '.' + this.extension;
  })
}
   module.exports = function(schema) {
       schema.statics.listDropbox = function(req, res) {
           return new Promise(function(resolve, reject)  {
               document.list('/SCAN').then(resolve, reject)
           })
       }
   }
   module.exports = function(schema) {
       var _ = require('lodash')
       var moment = require('moment')
       var request = require('request')
       var async = require('async')



       schema.statics.order = function(req, res) {
           if (!isWorker) {
               return edison.worker.createJob({
                   name: 'db',
                   model: 'document',
                   method: 'order',
                   req: _.pick(req, 'query', 'session')
               })
           }

           return new Promise(function(resolve, reject) {
               var limit = req.query.limit || 100;
               var i = 0;
               edison.v1.get("SELECT * FROM scanner WHERE archived=1 AND moved=1 and ordered='0' LIMIT " + limit, function(err, resp) {
                   async.eachLimit(resp, 5, function(e, cb) {
                       console.log('MV', '/SCAN_ARCHIVES/' + e.name, String(i++) + '/' + String(resp.length))
                       document.copy('/SCAN_ARCHIVES/' + e.name, '/V2_PRODUCTION/intervention/' + e.id_inter + '/' + e.name)
                           .then(function(resp) {
                               edison.v1.set("UPDATE scanner SET ordered='1' WHERE id='" + e.id + "'", function() {
                                   console.log('ARCHIVED', e.name)
                                   cb(null)
                               })
                           }, function(err) {
                               console.log('ERR <', e.name, err, '>')
                               if (_.includes(String(err), '403')) {
                                   edison.v1.set("UPDATE scanner SET ordered='1' WHERE id='" + e.id + "'", function() {
                                       console.log('ARCHIVED', e.name)
                                       cb(null)
                                   })
                               } else {
                                   cb(null);
                               }
                           });
                   }, function(err) {
                       resolve('ok')
                   })
               })
           })
       }
   }
   module.exports = function(schema) {
       var _ = require('lodash')
       var moment = require('moment')
       var request = require('request')
       var mime = require("mime")
       var async = require('async')



       schema.statics.preview = function(req, res) {
           var path = require('path')
           return new Promise(function(resolve, reject) {
               document.get('V2_PRODUCTION/' + req.query.name, function(err, resp) {
                   if (err) return reject(err)
                   var extension = path.extname(req.query.name)
                   var contentType = mime.lookup(extension);
                   res.contentType(contentType);
                   res.send(resp);
                   resolve('ok')
               })
           })
       }
   }
module.exports = function(schema) {

    schema.statics.removeDoublons = function(req, res) {
        var _ = require('lodash');

        var diffCompare = function(a) {
            return Math.abs(a.diff)
        }

        return new Promise(function(resolve, reject) {
            edison.v1.get("SELECT COUNT(name) AS cnt, name, id FROM  scanner WHERE name != '0' AND name!='' GROUP BY name HAVING COUNT( name) >1", function(err, resp) {
                var _in = _.pluck(resp, 'name').join("', '")
                _.each(resp.slice(0, 100), function(e) {
                        edison.v1.get("SELECT * FROM scanner WHERE name='" + e.name + "'", function(err, files) {
                            var max = _.max(files, diffCompare);
                            var min = _.min(files, diffCompare);
                            //console.log(max.moved, min.moved);
                            var archived = Number(min.archived == 1 || max.archived == 1);
                            var setMax = "UPDATE scanner SET checked='0', moved='0', archived='0', name='' WHERE id='" + max.id + "'";
                            var setMin = "UPDATE scanner SET checked='1', moved='1', archived='" + archived + "' WHERE id='" + min.id + "'";
                           	edison.v1.set(setMax)
                           	edison.v1.set(setMin)
                        })
                    })
                    /*        		edison.v1.get("SELECT * FROM scanner WHERE name in ('" + _in + "')", function(err, resp) {
                            			console.log(err, resp)
                            		})*/
            })
            resolve('ok')
        }).catch(__catch)
    }
}
module.exports = function(schema) {

    schema.statics.scanMoulinette = function(req, res) {
        return new Promise(function(resolve, reject) {
            document.list('/SCAN').then(function(resp) {
                resolve('ok')
            }, reject)  
        })
    }
}
module.exports = function(schema) {
    var uuid = require('uuid');
    var moment = require('moment')
    schema.statics.scan = function(req, res) {
        return new Promise(function(resolve, reject) {
           // edison.v1.set("INSERT INTO scanner (id_inter, start) VALUES (" + req + ", 'valeur 2', ...)")
            /*db.model('document')({
                login: req.session.login,
                model: req.body.model,
                type: req.body.type,
                link: req.body.link,
                _id: uuid.v4(),
                virtual:true,
                extension: "pdf",
                name:'SCAN.pdf'
            }).save().then(resolve, reject);*/
        })
    }
}
   module.exports = function(schema) {
       var _ = require('lodash')
       var moment = require('moment')
       var request = require('request')
       var async = require('async')
       var fs = require('fs')

       var getPage = function(filepath, page, cb) {
           var fs = require('fs')
           var scissors = require('scissors');
           var finalBuffer = [];
           var stream = scissors(filepath).pages(page).pdfStream()
           stream.on('data', function(data) {
               console.log('DATA')
               finalBuffer.push(data);
           }).on('end', function() {
               console.log('END')
               return cb(null, Buffer.concat(finalBuffer))
           })
       }

       schema.statics.uploadScans = function(req, res) {
           return new Promise(function(resolve, reject) {
               if (!req.files || !req.files.file || !req.files.file.buffer || !req.files.file.extension) {
                   return reject("Invalid File");
               }
               if (req.files.file.size > 5000000)
                   return reject("File is too big");


               var fs = require('fs')
               var uuid = require('uuid')
               var filepath = '/tmp/' + uuid.v4() + '.pdf';
               fs.writeFileSync(filepath, req.files.file.buffer);



               req.body.ids = JSON.parse(req.body.ids)
               req.body.date = JSON.parse(req.body.date)
               db.model('intervention').find({
                       sst: {
                           $in: _.pluck(req.body.ids, 'id')
                       },
                       'compta.paiement.historique': {
                           $elemMatch: {
                               dateFlush: req.body.date,
                               mode: 'CHQ'
                           }
                       }
                   }).then(function(resp) {
                       var i = 0;

                       console.log(req.body.ids, resp.length)
                       async.eachLimit(resp, 5, function(e, callback) {
                               var flush = _.find(e.compta.paiement.historique, 'dateFlush', new Date(req.body.date));
                               flush.numeroCheque = (_.find(req.body.ids, 'id', e.sst) || {}).numeroCheque
                               getPage(filepath, ++i, function(err, buffer) {
                                   console.log('-->uauau')
                                   console.log(err, buffer)
                                   document.upload({
                                       filename: '/V2_PRODUCTION/intervention/' + e.id + '/' + 'Lettre-cheque-' + flush.numeroCheque + '.pdf',
                                       data: buffer
                                   }).then(function(resp) {
                                       console.log('ok upload')
                                       e.save(callback)
                                   }, callback)
                               })

                           }, function() {
                               resolve('ok')
                           })
                           /* var flush = _.find(resp, function(e) {
                                console.log(e.dateFlush, req.body.date)
                                return false;
                            });
                            console.log('==>', flush)*/
                   })
                   //console.log(req.body)
                   //console.log(req.files)
                   //fs.writeFileSync(req.files.file.buffer, '~/xxx.pdf')



               resolve('ok')
           }).catch(__catch);
       }
   }
module.exports = function(schema) {
    var moment = require('moment');
    schema.statics.upload = function(req, res) {
        return new Promise(function(resolve, reject) {
            if (!req.files || !req.files.file || !req.files.file.buffer || !req.files.file.extension) {
                return reject("Invalid File");
            }
            if (req.files.file.size > 5000000)
                return reject("File is too big");
            // var name = moment().format(req.session.login + ' - ' + 'YYYY-MM-DD-HH-mm-ss[.pdf]')
            console.log('here');
            document.upload({
                filename: '/V2_PRODUCTION/intervention/' + req.body.link + '/' + req.files.file.originalname,
                data: req.files.file.buffer,
            }).then(function(resp) {
                resolve('ok');
            }, reject);
            /*document.upload({
              login: req.session.login,
              name: req.files.file.originalname,
              model: req.body.model,
              type: req.body.type,
              link: req.body.link,
              data: req.files.file.buffer,
              extension: req.files.file.extension
            }).then(function(params) {
              db.model('document')(params).save().then(resolve, reject);
            }, reject);*/
        })
    }
}
 module.exports = function(schema) {
     var _ = require('lodash')
     var moment = require('moment')
     var request = require('request')
     var async = require('async')


     schema.statics.verify = function(req, res) {

      

         var dbl = requireLocal('config/dropbox-list')
         console.log(dbl.SCAN.join("', '"))
         return res.send('ok')
         edison.v1.get("SELECT name FROM scanner WHERE moved='1' ", function(err, resp) {
             resp = _.pluck(resp, 'name');

             _.each(resp.slice(0, 10), function(e) {
                 var fnd = _.findIndex(dbl.SCAN, function(x) {
                     return x === e.name
                 })
             })
         })
     }
 }
var mime = require('mime')

module.exports = function(schema) {

  schema.statics.view = function(id, req, res) {
    return new Promise(function(resolve, reject) {
      document.download(id)
        .then(function(file) {
          var contentType = mime.lookup(file.extension);
          res.contentType(contentType);
          res.send(file.data);
        }, reject)
    });
  };
};
module.exports = function(schema) {
    schema.virtual('mimeType').get(function() {
        var mime = require('mime')
        return mime.lookup(this.extension);
    })
    schema.virtual('isBinary').get(function() {
        return this.extension == 'pdf' || this.mimeType.startsWith('image')
    })
}
module.exports = function(schema) {
    schema.statics.list = function(req, res) {
    	console.log(db)
        db.model('event').find({}, {
            data: 0,
            _id: 0
        }).then(function(docs) {
        	res.json(docs)
        })
    }

}
module.exports = function(schema) {

    schema.statics.annulation = {
        unique: true,
        findBefore: true,
        populateArtisan: true,
        method: 'POST',
        fn: function(inter, req, res) {

            var _ = require('lodash')
            return new Promise(function(resolve, reject) {
                inter.date.annulation = new Date;
                inter.date.envoi = undefined;
                inter.compta.paiement.ready = false;
                inter.login.annulation = req.session.login;
                inter.status = "ANN";
                inter.causeAnnulation = req.body.causeAnnulation;
                if (req.body.reinit) {
                    inter.artisan = undefined;
                    inter.sst = undefined;
                    inter.status = 'APR';
                }
                edison.event('INTER_ANNULATION')
                    .login(req.session.login)
                    .id(inter.id)
                    .broadcast(inter.login.ajout)
                    .color('red')
                    .message(_.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) à été annulé par {{login.annulation}}")(inter))
                    .send()
                    .save()
                    
                inter.save().then(resolve, reject)
                if (req.body.sms) {
                    sms.send({
                        to: envProd ? _.get(inter, 'sst.telephone.tel1', '0633138868') : req.session.portable,
                        text: req.body.textSms,
                    })
                }
            })
        }
    }
}
module.exports = function(schema) {
    var config = requireLocal('config/dataList')
    var _ = require('lodash')
    var async = require('async')
    var moment = require('moment')
    var csv = require('express-csv')

    schema.statics.getList = function(match) {
            return new Promise(function(resolve, reject) {
                db.model('intervention')
                    .aggregate()
                    .match(match ||  {})
                    .unwind("compta.paiement.historique")
                    .project({
                        'compta': true,
                        'artisan': true,
                        'id': true,
                        'categorie': true
                    })
                    .exec(function(err, docs) {
                        var x = _.groupBy(docs, 'compta.paiement.historique.dateFlush')
                        x = _(x).map(function(e, k) {
                                return {
                                    date: k,
                                    timestamp: (new Date(k)).getTime(),
                                    list: _.groupBy(e, 'artisan.id')
                                }
                            }).value()
                            // console.log(x)
                        resolve(x)
                    })
            })
        }
        /*db.sales.aggregate(
           [
              {
                $group : {
                   _id : { month: { $month: "$date" }, day: { $dayOfMonth: "$date" }, year: { $year: "$date" } },
                   totalPrice: { $sum: { $multiply: [ "$price", "$quantity" ] } },
                   averageQuantity: { $avg: "$quantity" },
                   count: { $sum: 1 }
                }
              }
           ]
        )*/


    schema.statics.archivePaiement = function(req, res) {
        var _this = this;
        return new Promise(function(resolve, reject) {
            db.model('intervention').aggregate().match({
                    'compta.paiement.effectue': true,
                }).group({
                    _id: {
                        d: '$compta.paiement.historique.dateFlush'
                    }
                }).exec(function(err, resp) {
                    resolve(_.map(resp, function(e) {
                        return {
                            timestamp: (new Date(e._id.d)).getTime(),
                        }
                    }))
                })
                /* redis.get("ARCHIVE_PAIEMENT".envify(), function(err, reply) {
                     if (!err && reply && !req.query.cache) {
                         return resolve(JSON.parse(reply));
                     }
                     db.model('intervention').getList({
                         'compta.paiement.effectue': true,
                     }).then(function(resp) {
                         console.log('here')
                         console.log(docs)
                         redis.set("ARCHIVE_PAIEMENT".envify(), JSON.stringify(docs), function() {
                         console.log('hss')
                             resolve(resp);
                         });
                     }, reject)
                 })*/
        })
    };

    schema.statics.archiveReglement = function(req, res) {

        var _this = this;
        return new Promise(function(resolve, reject) {
            db.model('intervention')
                .aggregate()
                .match({
                    'compta.reglement.recu': true
                })
                .group({
                    _id: {
                        yr: {
                            $year: '$compta.reglement.date',

                        },
                        mth: {
                            $month: '$compta.reglement.date',
                        }
                    },
                    date: {
                        $first: '$compta.reglement.date'
                    }
                })

            .exec(function(err, docs) {
                resolve(docs)

            });

        })
    }



}
module.exports = function(schema) {
    var Paiement = requireLocal('config/Paiement.js')

    schema.statics.autofacture = function(req, res) {
        var PDF = require('edsx-mail');
        var _this = this;
        try {
            var doc = JSON.parse(req.body.data);
            doc.paiement = new Paiement(doc);
        } catch (e) {
            return res.status(400).send('bad data')
        }
        return res.send(PDF('auto-facture', doc).getHTML())
            //    res.send(getFacturePdfObj(doc, req.body.date, true).html())
    }
}
module.exports = function(schema) {
    var moment = require('moment')
    var async = require('async')
    var _ = require('lodash')
    
    var getFunc = function(model) {
        return function(callback) {
            var filename = '/BACKUP/' + moment().format('YYYY-MM-DD') + '/' + model + '.json'
            db.model(model).find().select('-_id -cache').then(function(resp) {
                document.upload({
                    filename: filename,
                    data: JSON.stringify(resp),
                }).then(_.partial(callback, null), callback)
            })
        }
    }

    schema.statics.backup = function(callback) {
        var models = ['intervention', 'artisan', 'devis', 'product', 'user', 'compte', 'combo'];
        models = _.map(models, getFunc);
        async.parallel(models, function(err, resp) {
            callback(err, resp)
        })
    }

     schema.statics.xsend = function(req, res) {
        var ids = req.query.ids.split(', ')
        ids = _.map(ids, function(e) {
            return parseInt(e);
        })
        ids.push(32064)
        console.log('==>', ids)
        db.model(req.query.model || 'intervention').find({id:{$in:ids}}).then(function(resp) {
            async.eachLimit(resp, 5, function(e, cb) {
                console.log(e.id, 'OK')
                e.save(cb);
            })
        })
    }
}
module.exports = function(schema) {

    schema.statics.doStuff = function(req, res) {
        var _ = require('lodash')
            /*if (!isWorker) {
                return edison.worker.createJob({
                    name: 'db',
                    model: 'intervention',
                    method: 'doStuff',
                    req: _.pick(req, 'query', 'session')
                })
            }
            return new Promise(function(resolve, reject) {*/
        var async = require('async')
        db.model('intervention').find({
            $where: "return this.produits.length && this.produits.every(function(v) { return !v.quantite })"
        }, {
            id: 1
        }).then(function(resp) {
            async.eachLimit(_.pluck(resp, "id"), 10, function(id, callback) {
                db.model('intervention').dump({
                    query: {
                        id: id,
                        login: "CMD"
                    }
                }).then(function() {
                    callback(null)
                })
            }, res.send.bind(res))
        })
    }


    schema.statics.CB = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {
                var key = requireLocal("config/_keys")
                var encryptor = require('simple-encryptor')(key.salt);
                if (!inter)
                    return reject("Impossible de retrouver les informations")
                if (inter.modeReglement !== "CB")
                    return reject("Le mode de reglement n'est pas CB")
                if (!inter.cb || !inter.cb.hash)
                    return reject("Pas de CB enregistré")
                if (req.session.root === false) {
                    return reject("Access refusé")
                }
                var cb = encryptor.decrypt(inter.cb.hash);
                return resolve(JSON.parse(cb))
            })
        }
    }
}
module.exports = function(schema) {
    var _ = require('lodash')

    var getMonthRange = function(m, y) {
        var date = new Date(y, m);
        return {
            $gte: new Date(date.getFullYear(), date.getMonth(), 1, -1),
            $lt: new Date(date.getFullYear(), date.getMonth() + 1, 1)
        }
    }

    schema.statics.comptesArtisan = function(req, res) {
        var _this = this;
        return new Promise(function(resolve, reject) {
            db.model('artisan').find({}, {}).then(function(docs) {
                var rtn = docs.map(function(e) {
                    return [
                        '401401' + _.padLeft(e.id, 5, '0'),
                        e.formeJuridique,
                        e.nomSociete,
                        e.address.n,
                        e.address.r,
                        e.address.v,
                        e.address.cp
                    ]
                });
                return req.query.download ? res.sage(rtn) : res.table(rtn);
            });
        });
    };

    schema.statics.comptesClient = function(req, res) {
        var _this = this;
        var dateRange = getMonthRange(req.query.m - 1, req.query.y)
        return new Promise(function(resolve, reject) {
            db.model('intervention').find({
                'date.ajout': dateRange
            }, {}).then(function(docs) {
                var rtn = docs.map(function(e) {
                    return [
                        '411CLT' + _.padLeft(e.id, 6, '0'),
                        e.client.civilite,
                        e.client.nom + ' ' + e.client.prenom,
                        e.client.address.n,
                        e.client.address.r,
                        e.client.address.v,
                        e.client.address.cp,
                    ];
                })
                return req.query.download ? res.sage(rtn) : res.table(rtn);
            })
        })
    }
}
module.exports = function(schema) {

    schema.statics.convert = {
        unique: true,
        findBefore: true,
        method: 'GET',
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {
                var V1 = requireLocal('config/_convert_V1');
                console.log(new V1(inter))
                resolve('ok')
            })
        }
    }
}
module.exports = function(schema) {
    var moment = require('moment')
    var async = require('async')
    var _ = require('lodash')
    schema.statics.monthComission = function(req, res) {
        return new Promise(function(resolve, reject) {
            var dateCeilling = moment().subtract(2, 'month').startOf('month').toDate();
            db.model('intervention')
                .aggregate()
                .match({
                    'date.ajout': {
                        $gt: dateCeilling
                    },
                    status: {
                        $in: ["ENC", "VRF"]
                    },
                    'login.ajout': req.session.login ||  req.query.user
                })
                .project({
                    _id: 0,
                    id: 1,
                    prixFinal: 1,
                    'date.ajout': 1,
                    categorie: 1,
                    status: 1,
                    enCours: {
                        $cond: [{
                            $eq: ['$status', 'ENC']
                        }, 1, 0]
                    },
                    montant_vt_reel: {
                        $cond: [{
                                $and: [{
                                    $eq: ['$categorie', 'VT']
                                }, {
                                    $eq: ['$compta.reglement.recu', true]
                                }]
                            },
                            150,
                            0
                        ],
                    },
                    montant_vt_pot: {
                        $cond: [{
                                $eq: ['$categorie', 'VT']
                            },
                            150,
                            0
                        ],
                    },
                    montant_reel: {
                        $cond: [{
                                $and: [{
                                    $ne: ['$categorie', 'VT']
                                }, {
                                    $eq: ['$compta.reglement.recu', true]
                                }]
                            },
                            "$prixFinal",
                            0
                        ],
                    },
                    montant_pot: {
                        $cond: [{
                                $ne: ['$categorie', 'VT']
                            },
                            "$prixFinal",
                            0
                        ],
                    },
                })
                .group({
                    _id: {
                        $month: "$date.ajout"
                    },
                    /*id: {
                            $push: '$id'
                        },*/
                    sum_VT_pot: {
                        $sum: '$montant_vt_pot'
                    },
                    sum_pot: {
                        $sum: '$montant_pot'
                    },
                    sum_VT_reel: {
                        $sum: '$montant_vt_reel'
                    },
                    sum_reel: {
                        $sum: '$montant_reel'
                    },
                    /*
                        totalEnc: {
                            $sum: '$enCours'
                        },
                        total: {
                        $sum: 1
                    }*/
                })
                .exec(function(err, resp) {
                    resp = _.map(resp, _.partial(_.mapValues, _, _.partial(_.round, _, 2)))
                    resolve(resp)
                })
        })
    }


    var cond = function(vr, val, res) {
        return {
            $cond: [{
                $eq: [vr, val]
            }, res, 0]
        }
    }
    var sum = function(vr) {
        return {
            $sum: vr
        }
    }
    var div = function(a, b) {
        var x = {};
        x.$divide = [a, b];
        return x;
    }
    var sub = function(a, b) {
        var x = {};
        x.$subtract = [a, b];
        return x;
    }

    var set = function(obj, prop, vr, vl) {
        var v = _.find(obj, 'login', prop);
        if (v) {
            v[vr] = _.round(v[vr] + vl);
            v.total = v.ajout + v.envoi + v.verif + v.sum - v.annul
        }
    }
    schema.statics.weekStats = function(req, res) {
        //ligue 1
        return new Promise(function(resolve, reject) {
            var dateCeilling = moment().startOf('week').toDate();

            db.model('intervention')
                .aggregate()
                .match({
                    'date.ajout': {
                        $gt: new Date(req.query.date)
                    },
                })
                .project({
                    'login.ajout': 1,
                    'login.envoi': 1,
                    'login.verification': 1,
                    TOTAL: 1,
                    ENC: cond('$status', 'ENC', 1),
                    VRF: cond('$status', 'VRF', 1),
                    APR: cond('$status', 'APR', 1),
                    ANN: cond('$status', 'ANN', 1),
                    SUM: cond('$status', 'VRF', div(sub("$prixFinal", "$coutFourniture"), 300))
                })
                .group({
                    _id: {
                        a: '$login.ajout',
                        e: '$login.envoi',
                        v: '$login.verification'
                    },
                    TOTAL_SUM: sum('$SUM'),
                    TOTAL_ENC: sum('$ENC'),
                    TOTAL_APR: sum('$APR'),
                    TOTAL_VRF: sum('$VRF'),
                    TOTAL_ANN: sum('$ANN'),
                })
                .exec(function(err, resp) {
                    var rtn = edison.users.service('INTERVENTION')
                    rtn = _.map(rtn, function(e) {
                        return {
                            login: e,
                            ajout: 0,
                            envoi: 0,
                            verif: 0,
                            annul: 0,
                            total: 0,
                            sum: 0
                        }
                    })
                    _.each(resp, function(elem) {
                        if (elem.TOTAL_VRF > 0) {
                            set(rtn, elem._id.a, 'ajout', elem.TOTAL_VRF)
                            set(rtn, elem._id.e, 'envoi', elem.TOTAL_VRF)
                            set(rtn, elem._id.v, 'verif', elem.TOTAL_VRF)
                        }
                        if (elem.TOTAL_SUM > 0) {
                            set(rtn, elem._id.a, 'sum', elem.TOTAL_SUM)
                            set(rtn, elem._id.e, 'sum', elem.TOTAL_SUM)
                            set(rtn, elem._id.v, 'sum', elem.TOTAL_SUM)
                        }
                        if (elem.TOTAL_ENC > 0) {
                            set(rtn, elem._id.a, 'ajout', elem.TOTAL_ENC)
                            set(rtn, elem._id.e, 'envoi', elem.TOTAL_ENC)
                        }
                        if (elem.TOTAL_APR > 0) {
                            set(rtn, elem._id.a, 'ajout', elem.TOTAL_APR)
                        }
                        if (elem.TOTAL_ANN > 0) {
                            set(rtn, elem._id.a, 'annul', elem.TOTAL_ANN)
                        }
                    })
                    resolve(rtn);
                })
        });
    }


    schema.statics.dashboardStats = function(req, res) {
        Promise.all([
            this.monthComission(req, res),
            this.weekStats(req, res),
        ]).then(function(resp) {
            var rtn = {
                monthComission: resp[0],
                weekStats: resp[1],
            }
            res.json(rtn)
        })
    }

}
module.exports = function(schema) {

    schema.statics.demarcher = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(inter, req, res) {
            var _ = require('lodash')
            return new Promise(function(resolve, reject) {
                inter.aDemarcher = true;
                inter.date.demarchage = new Date();
                inter.login.demarchage = req.session.login;
                edison.event('INTER_DEM').login(req.session.login).id(inter.id)
                    .broadcast(inter.login.ajout)
                    .color('orange')
                    .message(_.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) est démarché par {{login.demarchage}}")(inter))
                    .send()
                    .save()
                inter.save().then(resolve, reject);

            })
        }
    }
}
module.exports = function(schema) {
    var _ = require('lodash')
    var moment = require('moment-timezone')
    var request = require('request')
    var async = require('async')
    var V1 = requireLocal('config/_convert_V1');


    schema.statics.dmp = function(req, res) {

        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'dmp',
                req: _.pick(req, 'query', 'session')
            })
        }
        var lol = [1026, 106, 115, 1178, 1206, 1211, 1227, 1255, 1260, 1294, 1440, 149, 1511, 1512, 15172, 1520, 1546, 1565, 1669, 1699, 17371, 1739, 1760, 1794, 1795, 1796, 1797, 19444, 19955, 21304, 21431, 21628, 21833, 21994, 21998, 22439, 23148, 23405, 23620, 23649, 23785, 23913, 24031, 24094, 24255, 24272, 24415, 24458, 24689, 25032, 25192, 25251, 25610, 25873, 25909, 26010, 26013, 26079, 26222, 26565, 27630, 27887, 27942, 28005, 28134, 28427, 28474, 28486, 28488, 28683, 28704, 28726, 28730, 28739, 28845, 28876, 28939, 28985, 29007, 29080, 29101, 29125, 29162, 29166, 29256, 29320, 29400, 29452, 29466, 29506, 29582, 29602, 29641, 29643, 29662, 29698, 29701, 29710, 29746, 29778, 29803, 29821, 29825, 29890, 29895, 29903, 29911, 29936, 29961, 29963, 29966, 29983, 29989, 30000, 30008, 30010, 30018, 30019, 30026, 30029, 30040, 30077, 30078, 30079, 30090, 30101, 30107, 30124, 30125, 30126, 30130, 30134, 30142, 30145, 30151, 30154, 30158, 30159, 30160, 30163, 30168, 30179, 30180, 30181, 30181, 30182, 30183, 30184, 30184, 30185, 30186, 30187, 30187, 30188, 30189, 30190, 30191, 30191, 30192, 30193, 30194, 30195, 30196, 30197, 30198, 30199, 30200, 30201, 30202, 30203, 30204, 30204, 30205, 30207, 30210, 30212, 30213, 30214, 30215, 30216, 30217, 30218, 30220, 30221, 30222, 30224, 30225, 30226, 30227, 30228, 30229, 30230, 30231, 30232, 30233, 30234, 30235, 30236, 30237, 30238, 30239, 30240, 30241, 30242, 30243, 30244, 30245, 30246, 30247, 30248, 30249, 30250, 30251, 30252, 30253, 30254, 30255, 30256, 30258, 30259, 30260, 30261, 30262, 30263, 30264, 30265, 30266, 30267, 30268, 30269, 30270, 30271, 30272, 30273, 30274, 30275, 30276, 30277, 30278, 30279, 30280, 30281, 30282, 30283, 30284, 30285, 30286, 30287, 30288, 30289, 30290, 30291, 30292, 30293, 30294, 30295, 30296, 30297, 30298, 30299, 30300, 30301, 30302, 30303, 30304, 30305, 30306, 30307, 30308, 30309, 30310, 30311, 30312, 30313, 30314, 30315, 30316, 30317, 30318, 30319, 30320, 30321, 30322, 30323, 30324, 30325, 30326, 30327, 30328, 30329, 30330, 30331, 30332, 30333, 30334, 30335, 30336, 30337, 30338, 30339, 30340, 30341, 30342, 30343, 30344, 30345, 30346, 30347, 30348, 30349, 30350, 30351, 30352, 30353, 30354, 30355, 30356, 30357, 30358, 30359, 30360, 30361, 30362, 30363, 30364, 30365, 30366, 30367, 30368, 30369, 30370, 337, 37, 555, 581, 635, 781, 85, 981];
        return new Promise(function(resolve, reject) {
            db.model(req.query.model || "intervention").find({
                id: {
                    $in: lol
                }
            }).then(function(resp) {
                _.each(resp, function() {

                    })
                    /*console.log(_.pluck(resp, 'id').join(','))
                    var i = 0;
                    async.eachLimit(resp, 5, function(e, cb) {
                        console.log(i++, resp.length)
                        var v1 = new V1(e);
                        v1.send(function() {
                            cb(null);
                        });
                    }, resolve)*/
            })
        })
    }
}
module.exports = function(schema) {
    var config = requireLocal('config/dataList')
    var _ = require('lodash')
    var async = require('async')
    var moment = require('moment')
    var csv = require('express-csv')


    format = function(nbr) {
        return String(_.round(nbr, 2)).replaceAll('.', ',');
    }

    var ecriture = function(sst, callback) {
        var _this = this;
        var montantTotal = _.sum(sst, 'compta.paiement.historique.final');
        var dateFormat = moment(new Date(sst[0].compta.paiement.historique.dateFlush)).format('L');
        var BQ1, BQ2
        db.model('artisan').findOne({
            id: sst[0].artisan.id
        }, {
            'formeJuridique': true
        }).exec(function(err, artisan) {
            var formeJuridique = _.get(artisan, 'formeJuridique', 'SARL');
            _.each(sst, function(e, k) {
                var paiement = e.compta.paiement.historique
                var padIdSST = _.padLeft(e.artisan.id, 5, '0')
                var padIdOS = _.padLeft(e.id, 6, '0')
                var libelle = paiement.mode + (paiement.numeroCheque || '') + ' ' + e.artisan.nomSociete
                var montant = Math.abs(paiement.final);
                var numeroCompteAchat = '604' + _.padLeft(config.categories[e.categorie].id_compta, 5, '0')
                var libelleAC = ['TRAVAUX', _.deburr(config.categories[e.categorie].long_name.toUpperCase()), e.artisan.nomSociete].join(' ')
                var libelleNumeroFacture = config.libellePaiement[paiement._type].short_name;
                BQ1 = ['BQ', dateFormat, '40100000', '401' + padIdSST, padIdSST, libelle, format(montantTotal), '']
                BQ2 = ['BQ', dateFormat, '51210000', '', padIdSST, libelle, '', format(montantTotal)]
                var AC1 = ['AC', dateFormat, numeroCompteAchat, '', libelleNumeroFacture + padIdOS, libelleAC, format(montant), '']
                if (paiement._type == 'AVOIR') {
                    AC1.swap(6, 7);
                }
                _this.dump(AC1)
                if (formeJuridique !== 'AUT') {
                    if (paiement.tva) {
                        var AC2a = ['AC', dateFormat, '44566200', '', libelleNumeroFacture + padIdOS, libelleAC, format(montant * (paiement.tva / 100)), '']
                        if (paiement._type == 'AVOIR') {
                            AC2a.swap(6, 7);
                        }
                        _this.dump(AC2a)
                    } else {

                        var AC2b = ['AC', dateFormat, '44566300', '', libelleNumeroFacture + padIdOS, libelleAC, format(montant * 20 / 100), '']
                        var AC2c = ['AC', dateFormat, '44521000', '', libelleNumeroFacture + padIdOS, libelleAC, '', format(montant * 20 / 100)]
                        if (paiement._type == 'AVOIR') {
                            AC2b.swap(6, 7);
                            AC2c.swap(6, 7);
                        }
                        _this.dump(AC2b)
                        _this.dump(AC2c)
                    }
                }
                var AC3 = [
                    'AC',
                    dateFormat,
                    '40100000',
                    '401' + padIdSST,
                    libelleNumeroFacture + padIdOS,
                    libelleAC,
                    '',
                    format(montant + (montant * (paiement.tva / 100)))
                ]
                if (paiement._type == 'AVOIR') {
                    AC3.swap(6, 7);
                }
                _this.dump(AC3);
            })
            _this.dump(BQ1);
            _this.dump(BQ2)
            callback(null)
        })

    }

    schema.statics.ecritureSST = function(req, res) {
        return new Promise(function(resolve, reject) {
            if (!req.query.d)
                return reject('pas de date')
            var date = new Date(parseInt(req.query.d));
            db.model('intervention').getList({
                'compta.paiement.historique': {
                    $elemMatch: {
                        dateFlush: date
                    }
                }
            }).then(function(docs) {
                if (!docs.length) {
                    return reject('aucunes interventions')
                }
                var rtn = []
                async.each(docs[0].list, ecriture.bind({
                    dump: function(tab) {
                        rtn.push(tab);
                    }
                }), function(err) {
                    if (err)
                        resolve(err);
                    if (req.query.download) {
                        res.sage(rtn)
                    } else if (req.query.json) {
                        resolve(rtn)
                    } else {
                        res.table(rtn)
                    }
                });
            }, function(err) {
                console.log('-->', err)
            })

        })
    }


    schema.statics.ecritureReglements = function(req, res) {

        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'ecritureReglements',
                req: _.pick(req, 'query', 'session')
            }).then(function(rtn) {
                if (req.query.download) {
                    res.sage(rtn)
                } else if (req.query.json) {
                    res.json(rtn)
                } else {
                    res.table(rtn)
                }
            }, function() {
                res.send("UNE ERREUR EST SURVENU")
            })
        }

        var getMonthRange = function(m, y) {
            var date = new Date(y, m);
            return {
                $gte: new Date(date.getFullYear(), date.getMonth(), 1, -1),
                $lt: new Date(date.getFullYear(), date.getMonth() + 1, 1)
            }
        }
        return new Promise(function(resolve, reject) {
            var dateRange = getMonthRange(req.query.m - 1, req.query.y)
            console.time('query')
            db.model('intervention').find({
                'compta.reglement.recu': true,
                $or: [{
                    'compta.reglement.date': dateRange
                }, {
                    'compta.reglement.avoir.date': dateRange,
                    'compta.reglement.avoir.effectue': true,
                }, ],
            }).then(function(docs) {
                var rtn = [];
                async.eachLimit(docs, 20, function(e, cb) {
                    _.delay(function() {

                        var R = e.compta.reglement;
                        var P = e.compta.paiement;
                        var montant = {
                            HT: format(e.compta.reglement.montant),
                            TTC: format(R.montant * (1 + (e.tva / 100))),
                            TVA: format(R.montant * (e.tva / 100))
                        }
                        var compte = {
                            VT1: _.padRight('4110' + e.tva, 8, '0'),
                            VT2: ['7040', e.tva, '0', config.categories[e.categorie].id_compta].join(''),
                            VT3: ['445870', _.padLeft(e.tva, 2, '0')].join(''),
                            BQA2: '51210000'
                        }

                        var OS = _.padLeft(e.id, 6, '0');
                        var FOS = 'F' + OS;
                        var AOS = 'A' + OS;
                        var CLTOS = 'CLT' + OS;
                        var dateFormat = moment(new Date(e.date.intervention)).format('L');
                        if (moment(R.date).isBetween(dateRange.$gte, dateRange.$lt)) {
                            var libelleVT = ['VENTE', e.client.civilite.replaceAll('.', ''), e.client.nom].join(' ');
                            var libelleAV = ['AVOIR', e.client.civilite.replaceAll('.', ''), e.client.nom].join(' ');
                            var VT1 = ['VT', dateFormat, compte.VT1, CLTOS, FOS, libelleVT, montant.TTC]
                            var VT2 = ['VT', dateFormat, compte.VT2, '', FOS, libelleVT, '', montant.HT]
                            var VT3 = ['VT', dateFormat, compte.VT3, '', FOS, libelleVT, '', montant.TVA]
                            rtn.push(VT1, VT2, VT3)
                        }
                        if (R.avoir.effectue && moment(R.avoir.date).isBetween(dateRange.$gte, dateRange.$lt)) {
                            var montantAvoir = {
                                HT: format(R.avoir.montant),
                                TTC: format(R.avoir.montant * (1 + (e.tva / 100))),
                                TVA: format(R.avoir.montant * (e.tva / 100))
                            };
                            var dateAvoir = moment(new Date(R.avoir.date)).format('L');
                            if (R.avoir._type === 'REM_COM') {
                                var compteVTA2 = '70900000'
                            } else if (R.avoir._type === 'ERR_FACT') {
                                var comptaVTA2 = compte.VT2;
                            }
                            var VTA1 = ['VT', dateAvoir, compte.VT1, CLTOS, AOS, libelleAV, '', montantAvoir.TTC]
                            var VTA2 = ['VT', dateAvoir, compte.VT2, '', AOS, libelleAV, montantAvoir.HT, '']
                            var VTA3 = ['VT', dateAvoir, compte.VT3, '', AOS, libelleAV, montantAvoir.TVA, '']
                            rtn.push(VTA1, VTA2, VTA3)

                            var BQA1 = ['BQ', dateAvoir, compte.VT1, CLTOS, P.numeroCheque, libelleAV, montantAvoir.TTC, '']
                            var BQA2 = ['BQ', dateAvoir, compte.BQA2, '', P.numeroCheque, libelleAV, '', montantAvoir.TTC]
                            rtn.push(BQA1, BQA2)
                        }
                        cb(null)
                    }, 1);
                }, function() {
                    resolve(rtn)
                })
            });
        });
    };
}
module.exports = function(schema) {
    var _ = require('lodash')
    var PDF = require('edsx-mail');
    var mime = require('mime')
    var moment = require('moment-timezone');
    var template = requireLocal('config/textTemplate');
    var config = requireLocal('config/dataList')
    var fs = require('fs')
    var PDFMerge = require('pdf-merge');
    var async = require('async');
    var sendSMS = function(text, to) {
        console.log(to, text);
        return sms.send({
            to: to,
            text: text,
        })

    }

    var getStaticFile = function(req, res) {
        var fs = require('fs');
        var file = this
        return new Promise(function(resolve, reject) {
            var path = [process.cwd(), 'front', 'assets', 'pdf', file].join('/')
            fs.readFile(path, function(err, buffer) {
                if (err)
                    return reject(err);
                return resolve({
                    data: buffer,
                    name: String(file),
                    extension: '.pdf'
                });
            })
        })
    }

    var getNotice = function(doc) {
        return new Promise(function(resolve, reject) {
            PDF('notice', doc, 400).buffer(function(err, buff) {
                console.log(err, buff)
                if (err)
                    return reject(err);
                resolve({
                    data: buff,
                    extension: '.pdf',
                    name: 'OS n°' + doc.id + '.pdf'
                })
            })
        })
    }


    var getOS = function(doc) {
        return new Promise(function(resolve, reject) {
            PDF('intervention', doc, 400).buffer(function(err, buff) {
                if (err)
                    return reject(err);
                resolve({
                    data: buff,
                    extension: '.pdf',
                    name: 'OS n°' + doc.id + '.pdf'
                })
            })
        })
    }




    var getDevis = function(doc, user) {
        return new Promise(function(resolve, reject) {
            doc.facture = doc.client;
            doc.facture.tel = doc.client.telephone.tel1;
            doc.datePlain = moment.tz('Europe/Paris').format('LL');
            doc.user = user;
            doc.acquitte = false;
            doc.type = "devis"
            PDF('facture', doc).buffer(function(err, buff) {
                if (err)
                    return reject(err);
                resolve({
                    data: buff,
                    extension: '.pdf',
                    name: 'Devis n°' + doc.id + '.pdf'
                })
            }, 1200)
        })
    }





    var getDeviseur = function(doc) {
        return new Promise(function(resolve, reject) {
            doc.type = "DEVIS"
            PDF([{
                model: 'facturier',
                options: doc
            }, {
                model: 'conditions',
                options: {}
            }], 700).toBuffer(function(err, buff) {
                if (err)
                    return reject(err);
                resolve({
                    data: buff,
                    extension: '.pdf',
                    name: 'Deviseur n°' + doc.id + ".pdf"
                })
            })
        })
    }


    var getLocalFile = function(filePath) {
        return new Promise(function(resolve, reject) {
            var path = require('path')
            document.get(filePath,
                function(err, buffer) {
                    resolve({
                        data: buffer,
                        name: "Pièce Jointe." + path.extname(filePath),
                        extension: '.' + path.extname(filePath)
                    })
                })
        })
    }

    var getFacturier = function(doc) {
        return new Promise(function(resolve, reject) {
            doc.type = "FACTURE"
            var p1 = PDF([{
                model: 'facturier',
                options: doc
            }]);
            var p2 = PDF([{
                model: 'conditions',
                options: {}
            }, {
                model: 'attestation',
                options: doc
            }])

            async.parallel([
                p1.toBuffer.bind(p1),
                p2.toBuffer.bind(p2),
            ], function(err, resp) {
                var now = Date.now();
                var f1 = '/tmp/f1-' + now + '.pdf';
                var f2 = '/tmp/f2-' + now + '.pdf';
                fs.writeFileSync(f1, resp[0])
                fs.writeFileSync(f2, resp[1])
                var pdfMerge = new PDFMerge([f1, f2]);
                pdfMerge.asBuffer().merge(function(err, buffer) {
                    resolve({
                        data: buffer,
                        extension: '.pdf',
                        name: 'Facturier n°' + doc.id + ".pdf"
                    })
                });
            })
        });
    }



    schema.statics.file = {
        unique: true,
        findBefore: true,
        method: 'GET',
        populateArtisan: true,
        fn: function(inter, req, res) {
            inter = inter.toObject()
            if (req.query.q === 'os') {
                var prm = getOS(inter);
            } else if (req.query.q === 'facturier') {
                var prm = getFacturier(inter)
            } else if (req.query.q === 'manuel') {
                var prm = getStaticFile.bind("Manuel d'utilisation.pdf")()
                    /* } else if (req.query.q === 'notice') {
                         var prm = getStaticFile.bind("Notice d'intervention.pdf")()*/
            } else if (req.query.q === 'deviseur') {
                var prm = getDeviseur(inter, req.session);
            } else if (req.query.q === 'notice') {
                console.log('notice')
                var prm = getNotice(inter);
            } else if (req.query.q === 'devis') {
                var prm = getDevis(inter, req.session)
            } else {
                return res.status(400).send("unknown file")
            }
            prm.then(function(resp) {
                res.pdf(resp.data);
            }, function(err) {
                res.send(String(err));
            }).catch(__catch)
        }
    }


    schema.statics.envoi = {
        unique: true,
        findBefore: true,
        populateArtisan: true,
        method: 'POST',
        fn: function(inter, req, res) {
            console.time('envoi')

            var _this = this;

            return new Promise(function(resolve, reject) {
                try {

                    if (!isWorker) {
                        return edison.worker.createJob({
                            name: 'db_id',
                            model: 'intervention',
                            method: 'envoi',
                            data: inter,
                            req: _.pick(req, 'body', 'session')
                        }).then(function() {
                            inter.status = "ENC";
                            inter.date.envoi = new Date();
                            inter.login.envoi = req.session.login;
                            if (req.session.service === 'PARTENARIAT') {
                                inter.date.demarchage = new Date();
                                inter.login.demarchage = req.session.login;
                            }
                            edison.event('INTER_ENVOI').login(req.session.login).id(inter.id)
                                .broadcast(inter.login.ajout)
                                .color('orange')
                                .message(_.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) à été envoyé par {{login.envoi}}")(inter))
                                .send()
                                .save()
                                console.log('okok')
                            if (inter.newOs) {
                                setTimeout(function() {
                                    db.model('intervention').findById(inter.id)
                                        .populate('sst')
                                        .then(function(resp) {
                                            if (!resp.appels.length) {
                                                console.log('nocall')
                                                sms.send({
                                                    to: resp.sst.telephone.tel1,
                                                    text: template.sms.intervention.rappelNoCalls(inter.id)
                                                })
                                                edison.event('INTER_NO_CALLS').login(req.session.login).id(inter.id)
                                                    .service('INTERVENTION')
                                                    .color('red')
                                                    .message(_.template("OS {{id}}: ({{client.civilite}} {{client.nom}}) attend l'appel de {{sst.nomSociete}}")(resp))
                                                    .send()
                                                    .save()
                                            } else {
                                                console.log('call passed')
                                            }
                                        })
                                }, 60 * 60 * 1000)
                            }


                            inter.save().then(resolve, reject)
                        })
                    }

                    if (!inter ||  !inter.sst)
                        return reject('pas de SST')
                    if (!req.body.sms)
                        return reject("Impossible de trouver l'artisan");

                    var filesPromises = [
                        getOS(inter)
                    ]
                    if (!envDev) {
                        if (inter.devisOrigine) {
                            filesPromises.push(getDevis(inter, req.session));
                        }

                        filesPromises.push(getFacturier(inter));
                        filesPromises.push(getDeviseur(inter));

                        if (inter.sst.subStatus === 'NEW' || inter.sst.status === 'POT') {
                            filesPromises.push(getStaticFile.bind("Manuel d'utilisation.pdf")(),
                                getStaticFile.bind("Notice d'intervention.pdf")())
                        }
                        if (req.body.file) {
                            filesPromises.push(getLocalFile('/V2_PRODUCTION/intervention/' + inter.id + '/' + req.body.file))
                        }
                    }
                    console.time('getFiles')
                    Promise.all(filesPromises).then(function(result) {
                        console.timeEnd('getFiles')

                        var files = _(result).compact().map(function(file) {
                            return {
                                ContentType: file.mimeType ||  mime.lookup(file.extension),
                                Name: file.name ||  ['fichier', file.extension].join('.'),
                                Content: file.data.toString('base64')
                            }
                        }).value();

                        if (req.body.file) {
                            inter.textfileSupp = (_.endsWith(files[files.length - 1], 'pdf') ? 'un document supplementaine' : 'une photo transmises par le client');
                        }
                        var c = config.categories[inter.categorie]
                        inter.categoriePlain = c.suffix + ' ' + c.long_name.toLowerCase();
                        inter.fileSupp = req.body.file;
                        inter.__login = req.session.pseudo || 'Arnaud';
                        inter.datePlain = moment.tz(new Date(inter.date.intervention), "Europe/Paris").format('DD/MM/YYYY à HH\\hmm')
                        var text = template.mail.intervention.os(req.session)
                        text = _.template(text)(inter).replaceAll('\n', '<br>')

                        var communication = {
                            telephone: envProd ? inter.sst.telephone.tel1 : "0633138868",
                            mailDest: envProd ? inter.sst.email : (req.session.email ||  'contact@edison-services.fr'),
                            mailReply: (req.session.email ||  'contact@edison-services.fr')
                        }

                        var mailOptions = {
                            From: "intervention@edison-services.fr",
                            ReplyTo: communication.mailReply,
                            To: communication.mailDest,
                            Subject: "Ordre de service d'intervention N°" + inter.id,
                            HtmlBody: text,
                            Attachments: files
                        }
                        console.log(communication);
                        var validationPromises = [
                            mail.send(mailOptions),
                            sendSMS(req.body.sms, communication.telephone),
                        ]
                        Promise.all(validationPromises).catch(__catch)
                        resolve('ok')
                    }, reject).catch(__catch)
                } catch (e) {
                    console.log('--->', e)
                    console.log(e.stack);
                }

            })
        }
    }

}
module.exports = function(schema) {
    var ejs = require("ejs");
    var fs = require("fs")
    var moment = require('moment');
    var PDF = require('edsx-mail')
    moment.locale('fr');
    var textTemplate = requireLocal('config/textTemplate');
    var _ = require('lodash')

    var getFacturePdfObj = function(doc, date, acquitte, reverse) {

        doc.datePlain = moment(date).format('LL');
        doc.acquitte = acquitte;
        /*        doc.produits.unshift({
                    pu: 0,
                    quantite: 1,
                    title: "",
                    ref: "",
                    desc: String
                })*/
        var text = textTemplate.lettre.intervention.envoiFacture();
        var lettre = {
                address: doc.facture.address,
                dest: doc.facture,
                text: _.template(text)(doc),
                factureQrCode: true,
                id: _.padLeft(doc.id, 6, '0'),
                date: doc.date,
                title: "OBJET : Facture n°" + doc.id + " en attente de reglement"
            }
            /**/
        doc.type = 'facture'
        if (!acquitte) {
            var l = [{
                model: 'letter',
                options: lettre
            }]
        } else {
            var l = [];
        }

        l.push({
            model: 'conditions',
            options: doc
        }, {
            model: 'facture',
            options: doc
        })
        if (reverse) {
            var last = l.shift()
            l.push(last);
        }
        return PDF(l)
    }

    schema.statics.facturePreview = function(req, res) {
        var _this = this;
        try {
            var doc = JSON.parse(req.body.data);
            var pdf = getFacturePdfObj(doc, doc.date.intervention);
            return res.send(pdf.html())
            pdf.toBuffer(function(err, buff) {
                return res.pdf(buff)
            })
        } catch (e) {
            __catch(e)
            return res.status(400).send('bad data')
        }

    }

    schema.statics.factureAcquittePreview = function(req, res) {
        var _this = this;
        try {
            var doc = JSON.parse(req.body.data);
        } catch (e) {
            return res.status(400).send('bad data')
        }

        res.send(getFacturePdfObj(doc, req.body.date, true).html())
    }




    schema.statics.devisPreview = function(req, res) {
        var _this = this;
        try {
            var doc = JSON.parse(req.body.data);
        } catch (e) {
            return res.status(400).send('bad data')
        }
        doc.id = doc.id ||  "00000"
        doc.type = 'devis'
        doc.facture = doc.client;
        doc.facture.tel = doc.client.telephone.tel1;
        doc.acquitte = false;
        doc.user = req.session;
        doc.type = "devis"
        var result = PDF([{
            model: 'facture',
            options: doc
        }, {
            model: 'conditions',
            options: {}
        }]).html()
        return res.send(result)
    }


    schema.statics.sendFactureAcquitte = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(dd, req, res) {
            return new Promise(function(resolve, reject) {

                var inter = req.body.data
                if (inter.reglementSurPlace) {
                    inter.facture = inter.client;
                }
                var f = inter.facture;
                if (!f.email ||  !f.nom || !f.address.r || !f.address.v ||  !f.address.cp || !f.address.n) {
                    return reject('Les coordonées de facturations sont incompletes')
                }
                f.prenom = f.prenom ||  "";
                if (!inter.produits || !inter.produits.length) {
                    return reject('Veuillez renseigner au moins 1 produits')
                }
                if (!isWorker) {
                    edison.event('INTER_SENDFACT_ACQ').login(req.session.login).id(inter.id).save();
                    return edison.worker.createJob({
                        name: 'db_id',
                        model: 'intervention',
                        method: 'sendFactureAcquitte',
                        data: inter,
                        req: _.pick(req, 'body', 'session')
                    }).then(resolve, reject)
                }

                var params = req.body;
                if (!params.text ||  !params.date) {
                    Promise.reject("Invalid Request")
                }
                if (inter.reglementSurPlace) {
                    inter.facture = inter.client;
                }
                inter.acompte = inter.prixFinal;

                var pdf = getFacturePdfObj(inter, inter.date.intervention, true, req.body.date);

                pdf.toBuffer(function(err, buffer) {
                    var communication = {
                        mailDest: envProd ? inter.facture.email : (req.session.email ||  'contact@edison-services.fr'),
                        mailReply: (req.session.email ||  'comptabilite@edison-services.fr')
                    }
                    mail.send({
                        From: "comptabilite@edison-services.fr",
                        ReplyTo: communication.mailReply,
                        To: communication.mailDest,
                        Subject: "Facture n°" + inter.id + " acquitté",
                        HtmlBody: req.body.text.replaceAll('\n', '<br>'),
                        Attachments: [{
                            Content: buffer.toString('base64'),
                            Name: "Facture n°" + inter.id + ".pdf",
                            ContentType: 'application/pdf'
                        }]
                    }).then(function(resp) {
                        if (req.body.acquitte) {
                            return resolve("OK");
                        }
                        db.model('intervention').findOne({
                            id: inter.id
                        }).then(function(doc) {
                            doc.date.envoiFacture = new Date();
                            doc.login.envoiFacture = req.session.login;
                            doc.save().then(resolve, reject)
                            getFacturePdfObj(doc, doc.date.intervention, false, true).toBuffer(function(err, buff) {
                                document.stack(buff, 'FACTURE ' + doc.id, req.session.login)
                                    .then(function(resp) {
                                        console.log('file added', resp)
                                    })
                            })
                        })
                    }, reject).catch(__catch)
                })
            })
        }

    }

    schema.statics.sendFacture = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {

                var f = inter.facture;
                if (!f.email ||  !f.nom || !f.address.r || !f.address.v ||  !f.address.cp || !f.address.n) {
                    return reject('Les coordonées de facturations sont incompletes')
                }
                f.prenom = f.prenom ||  "";
                if (!inter.produits || !inter.produits.length) {
                    return reject('Veuillez renseigner au moins 1 produits')
                }
                /*                if (envDev) {
                                    inter.date.envoiFacture = new Date();
                                    inter.login.envoiFacture = req.session.login;
                                    return inter.save().then(resolve, reject)
                                }*/
                if (!isWorker) {
                    return edison.worker.createJob({
                        name: 'db_id',
                        model: 'intervention',
                        method: 'sendFacture',
                        data: inter,
                        req: _.pick(req, 'body', 'session')
                    }).then(function() {
                        edison.event('INTER_SENDFACT').login(req.session.login).id(inter.id).save();
                        inter.save().then(resolve, reject)
                    }, reject)
                }


                var params = req.body;
                if (!params.text ||  !params.date) {
                    Promise.reject("Invalid Request")
                }
                try {
                    var pdf = getFacturePdfObj(inter, inter.date.intervention, req.body.acquitte, req.body.date);

                } catch (e) {
                    reject(e)
                }
                pdf.toBuffer(function(err, buffer) {
                    var communication = {
                        mailDest: envProd ? inter.facture.email : (req.session.email ||  'contact@edison-services.fr'),
                        mailReply: (req.session.email ||  'comptabilite@edison-services.fr')
                    }
                    console.log(communication);
                    console.log(req.body.text.replaceAll("\n", '<br>'));
                    mail.send({
                        From: "comptabilite@edison-services.fr",
                        ReplyTo: communication.mailReply,
                        To: communication.mailDest,
                        Subject: "Facture n°" + inter.id + " en attente de reglement",
                        HtmlBody: req.body.text.replaceAll("\n", '<br>'),
                        Attachments: [{
                            Content: buffer.toString('base64'),
                            Name: "Facture n°" + inter.id + ".pdf",
                            ContentType: 'application/pdf'
                        }]
                    }).then(function(resp) {
                        if (req.body.acquitte) {
                            return resolve("OK");
                        }
                        db.model('intervention').findOne({
                            id: inter.id
                        }).then(function(doc) {
                            doc.date.envoiFacture = new Date();
                            doc.login.envoiFacture = req.session.login;
                            doc.save().then(resolve, reject)
                            getFacturePdfObj(doc, doc.date.intervention, false, true).toBuffer(function(err, buff) {
                                document.stack(buff, 'FACTURE ' + doc.id, req.session.login)
                                    .then(function(resp) {
                                        console.log('file added', resp)
                                    })
                            })
                        })
                    }, reject).catch(__catch)
                })
            })
        }
    }
}
module.exports = function(schema) {
    schema.statics.getFact = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash');
            var async = require('async');
            var V1 = requireLocal('config/_convert_V1');

            if (!isWorker) {
                return edison.worker.createJob({
                    name: 'db',
                    model: 'intervention',
                    method: 'getFact',
                    req: _.pick(req, 'query', 'session')
                })
            }

            /*            edison.v1.get("SELECT devis FROM infointervention WHERE devis!='' LIMIT 100", function(err, resp) {
                        	console.log(resp[42])
                        });
            */
            console.time('get');
            db.model('devis').find({
                status: {
                    $ne: 'TRA'
                },
                id: {
                    $gt: 13000
                },
                $where: 'this.produits.length'
            }).then(function(resp) {
                console.timeEnd('get');
                var i = 0;
                async.eachLimit(resp, 20, function(e, callback) {
                    console.log(String(++i) + '/' + String(resp.length))
                    var v1 = new V1(e);
                    v1.send(function(resp) {
                        console.log(resp)
                        callback(null);
                    });
                    v1 = null;
                })
            }, resolve)
            return 0;

            edison.v1.get("SELECT * FROM ligne_facture AS l JOIN objetfacture AS o ON o.id=l.id_objet_facture", function(err, x) {
                var lol = _(x.slice(0, 1)).map(function(e)  {
                        var w = {
                            devisTab: {
                                id_intervention: e.id_intervention,
                                quantite: e.quantite,
                                pu: parseFloat(e.puht),
                                ref: e.reference,
                                title: e.designation.toUpperCase().split(' ').slice(0, 3).join(' ').replaceAll("\r\n", " "),
                                desc: e.designation.replaceAll("\r\n", "<br>"),
                            },
                            dump: new Date
                        }
                        return w
                    }).groupBy('id_intervention').value()
                    /*_.each(lol, function(z, k) {
                        var query = "UPDATE infointervention SET devis='" + JSON.stringify(z) + "'";
                        console.log(query);
                        edison.v1.set(query, function(err, resp) {
                            console.log(err, resp);
                        })
                    })*/
            })
            resolve('ok')
        })
    }
}
module.exports = function(schema) {
    var _ = require('lodash')
    var async = require('async');
    var moment = require('moment');
    var Paiement = requireLocal('config/Paiement');
    var PDF = require('edsx-mail')



    schema.statics.flushMail = function(req, res) {

        if (!isWorker) {
            console.log('dump worker')
            return edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'flushMail',
                req: _.pick(req, 'body', 'session')
            })
        }

        return new Promise(function(resolve, reject) {
            var i = 0;
            var total = _.reduce(req.body, function(total, e) {
                return total + e.list.__list.length
            }, 0)
            var data = _.groupBy(req.body, 'id');
            async.eachLimit(data, 3, function(sst, cb) {
                var k = Object.keys(data)[i++]
                global.currenWorkerJob.progress(i, req.body.length);
                async.waterfall([
                    function(callback) {
                        db.model('artisan').findOne({
                            id: k
                        }, callback)
                    },
                    function(artisan, callback) {
                        if (!artisan) return callback("nope");
                        artisan = artisan.toObject()
                        artisan.mode = 'VIR';
                        artisan.total = sst[0].total.final;
                        artisan.interventions = _.map(sst[0].list.__list, function(e) {
                            return {
                                mode:e.mode,
                                montant: e.montant.final,
                                description: e.description,
                                id: e.id,
                                type: e.type
                            }
                        })
                        callback(null, artisan);
                    },
                    function(artisan, callback) {
                        var autofactures = [];
                        async.each(_.filter(artisan.interventions, 'mode', 'VIR'), function(inter, small_cb) {
                            db.model('intervention')
                                .findOne({
                                    id: inter.id
                                })
                                .then(function(resp) {
                                    if (!resp) return cb("nipe")
                                    resp = resp.toObject();
                                    //resp.compta.paiement.base = inter.montant;
                                    resp.paiement = new Paiement(resp);
                                    resp.sst = artisan;
                                    autofactures.push({
                                        model: 'auto-facture',
                                        options: resp
                                    })
                                    small_cb(null);
                                })
                        }, function() {
                            callback(null, artisan, autofactures)
                        });
                    },
                    function(artisan, autofactures, callback) {
                        autofactures.unshift({
                            model: 'recap',
                            options: artisan
                        })
                        var pdf = PDF(autofactures);
                        pdf.toBuffer(_.partial(callback, _, artisan));
                    },
                    function(artisan, buffer, callback) {
                        /* if (envDev) {
                             return callback(null, 'ok')
                         }*/
                        var textTemplate = requireLocal('config/textTemplate.js');
                        mail.send({
                            From: "comptabilite@edison-services.fr",
                            ReplyTo: "comptabilite@edison-services.fr",
                            To: artisan.email,
                            Subject: "Paiement du " + moment().format('LL'),
                            HtmlBody: textTemplate.mail.intervention.paiement,
                            Attachments: [{
                                Content: buffer.toString('base64'),
                                Name: "Recap " + moment().format('LL') + ".pdf",
                                ContentType: 'application/pdf'
                            }]
                        }, callback);
                    }
                ], cb);
            }, function(err, resp) {
                console.log(err, resp);
                if (err) {
                    reject(err);
                }
                resolve('okook');
            })
        });
    }


    schema.statics.flush = function(req, res) {
        var _this = this;

        return new Promise(function(resolve, reject) {

            var date = (new Date()).setMilliseconds(0)

            var data = _(req.body).pluck('list.__list').flatten().value()
            var numCheques = _(req.body).map(
                _.partial(_.pick, _, 'numeroCheque', 'id')
            ).value()
            async.eachLimit(data, 1, function(inter, small_cb) {
                db.model('intervention')
                    .findOne({
                        id: inter.id
                    })
                    .then(function(doc) {
                        var fourniture = _.reduce(doc.fourniture, function(res, x) {
                            res[x.fournisseur === 'ARTISAN' ? 'artisan' : 'edison'] += (x.pu * x.quantite);
                            return res;
                        }, {
                            artisan: 0,
                            edison: 0
                        })
                        var hist = {
                            dateAjout: doc.compta.paiement.date,
                            loginAjout: doc.compta.paiement.login,
                            dateFlush: date,
                            loginFlush: req.session.login,
                            pourcentage: doc.compta.paiement.pourcentage,
                            _type: inter.type,
                            fourniture: fourniture,
                            mode: doc.compta.paiement.mode,
                            numeroCheque: _.find(numCheques, 'id', doc.sst).numeroCheque,
                            montant: inter.montant.total,
                            final: inter.montant.final,
                            base: inter.montant.base,
                            payed: _.round(inter.montant.total - (inter.montant.balance - inter.montant.final), 2)
                        }
                        doc.compta.paiement.ready = (hist.payed != hist.montant);
                        doc.compta.paiement.effectue = true
                        doc.compta.paiement.historique.push(hist)
                            return small_cb(null);
                        doc.save(small_cb);
                    })
            }, function(err, resp) {
                if (err) {
                    reject(err);
                }
                edison.event('FLUSH').login(req.session.login).save();

                resolve('ok');
            });
        }).catch(__catch)
    }


}
module.exports = function(schema) {
	schema.statics.getOldFactures = function(req, res) {
		var _ = require('lodash');
		var moment = require('moment')
		var async = require('async')

		var mapfn = function(e) {
			e.id = parseInt(e.id)
			e.pu = parseFloat(e.pu)
			e.quantite = parseInt(e.quantite);

			e.ref = (e.ref ||  "").replace(' ', '');
			if (e.ref.startsWith("CAM"))
				e.ref = "CAM001";
			if (e.ref.startsWith("EDI003") || e.ref.startsWith("FRN"))
				e.ref = "FRN001";
			e.title = (e.desc || "").toUpperCase().split(' ').slice(0, 3).join(' ')
			if (!e.ref || e.ref == 'AUT001')
				e.ref = (e.desc ||  "").toUpperCase().slice(0, 3) + '0' + _.random(9, 99)
			e.title = e.title.replaceAll('\n', ' ').replaceAll('\r', '')
			return e;
		}

		var getTotal = function(prods) {
			var total = 0;
			_.each(prods, function(e) {
				total += (e.pu * e.quantite);
			})
			return _.round(total, 2);
		}

		edison.v1.get("SELECT l.id_intervention AS id, l.quantite, o.puht AS pu, o.reference AS ref,o.designation AS 'desc'  FROM ligne_facture AS l LEFT JOIN objetfacture AS o ON (l.id_objet_facture=o.id) where l.id_intervention>33",
			function(err, resp) {
				resp = _.map(resp, mapfn);
				resp = _.groupBy(resp, 'id')
				async.eachLimit(resp, 75, function(e, cb) {
					//console.log(e)
					//console.log("\n\n\n\n\n\n\n")
					var tmp = _.values(e);
					db.model('intervention').findOne({
						id: tmp[0].id
					}).select('-_id prixFinal status compta.paiement.effectue id produits').then(function(resp) {
						if (resp && resp.prixFinal === getTotal(resp.produits) && resp.produits[0] && resp.produits[0].ref === 'EDX121') {
							resp.produits = tmp;
							console.log(resp.id);
							resp.save(function(err, resp) {
								console.log('==>', !!err, !!resp)
							});
						}
						cb(null);
					})
				}, function() {
					res.send('okok')
				})
			})

	}
}
module.exports = function(schema) {

    schema.statics.getFiles = {
        unique: true,
        findBefore: false,
        method: 'GET',
        fn: function(id, req, res) {
            return new Promise(function(resolve, reject) {
                id = parseInt(id);
                if (isNaN(id))
                    return reject("Invalid id")
                document.list('/V2_PRODUCTION/intervention/' + id).then(resolve, function() {
                    resolve([]);
                });

            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.getNextID = function(cb) {
        db.model('intervention').findOne({}).sort("-id")
            .exec(function(err, latestDoc) {
                db.model('devis').findOne({}).sort("-id")
                    .exec(function(err2, latestDoc2) {
                        cb((latestDoc.id > latestDoc2.id ?  latestDoc.id : latestDoc2.id) + 1);
                    })
            })
    }
}
module.exports = function(schema) {
    var _ = require('lodash')

    schema.statics.flushAvoirs = function(req, res) {
        var _this = this;
        return new Promise(function(resolve, reject) {
            var date = new Date();
            _.each(req.body, function(e) {
                db.model('intervention').findOne({
                    id: e.id,
                }).then(function(doc) {
                    var hist = {
                        date: date,
                        login: req.session.login,
                        _type: 'AVOIR',
                        _typeAvoir: e.compta.reglement.avoir._type,
                        numeroCheque: e.numeroCheque,
                        montant: e.compta.reglement.avoir.montant,
                    }
                    doc.compta.reglement.avoir.effectue = true;
                    doc.compta.reglement.avoir.date = date;
                    doc.compta.reglement.historique.push(hist)
                    doc.save();
                }, function(err) {
                    reject(err);
                })
            })
            resolve(req.body.length + ' avoirs ont été flushé')
        })
    }

    schema.statics.avoirs = function(req, res) {
        var _this = this;
        return new Promise(function(resolve, reject) {
            _this.find({
                    /*     'compta.reglement.avoir.montant': {
                             $gt: 0
                         },*/
                    'compta.reglement.avoir.montant': {
                        $gt: 0
                    },
                    'compta.reglement.avoir.effectue': false
                })
                .then(function(docs) {
                    resolve(docs)
                })
        })
    }

}
module.exports = function(schema) {
    var _ = require('lodash')


    schema.statics.getFlushList = function(query) {
        return new Promise(function(resolve, reject) {
            db.model('intervention').find(query)
                .populate('sst')
                .select('id client description compta.paiement date.intervention sst artisan fourniture')
                .exec(function(err, docs) {
                    var rtn = _(docs).groupBy('sst.id').values().map(function(e) {
                        return {
                            address: e[0].sst.address,
                            nomSociete: e[0].sst.nomSociete,
                            id: e[0].sst.id,
                            representant: e[0].sst.representant,
                            list: _.map(e, function(z) {
                                z.sst = undefined
                                return z;
                            })
                        }
                    }).value()
                    resolve(rtn)
                })
        });
    }

    var lol = function(inter, date) {

        var index = _.findIndex(inter.compta.paiement.historique, 'dateFlush', date)
        inter = JSON.parse(JSON.stringify(inter));
        inter.compta.paiement.base = inter.compta.paiement.historique[index].base
        inter.compta.paiement.montant = inter.compta.paiement.historique[index].montant
        inter.compta.paiement.pourcentage = inter.compta.paiement.historique[index].pourcentage
        inter.compta.paiement.tva = inter.compta.paiement.historique[index].tva
            //WTF
        inter.compta.paiement.numeroCheque = inter.compta.paiement.historique[index].numeroCheque;
        inter.compta.paiement.fourniture = inter.compta.paiement.historique[index].fourniture
        inter.compta.paiement.historique = inter.compta.paiement.historique.slice(index + 1);
        inter.sst = undefined;
        //   console.log(inter.compta.paiement.numeroCheque)
        return inter;
    }

    var gtf = function(ts) {
        return new Promise(function(resolve, reject) {

            var date = new Date(parseInt(ts));
            db.model('intervention')
                .find({
                    'compta.paiement.historique': {
                        $elemMatch: {
                            dateFlush: date
                        }
                    },
                })
                .populate('sst')
                .select('id client description compta.paiement date.intervention sst artisan fourniture')
                .exec(function(err, docs) {
                    var rtn = _(docs).filter('sst').groupBy('sst.id').values().map(function(e) {
                            return {
                                address: e[0].sst.address,
                                nomSociete: e[0].sst.nomSociete,
                                id: e[0].sst.id,
                                representant: e[0].sst.representant,
                                list: _.map(e, _.partial(lol, _, date))
                            }
                        }).value()
                        //  console.log(rtn);
                    resolve(rtn)
                })
        })
    }

    schema.statics.lpa = function(req, res) {
        if (req.query.d) {
            return gtf(req.query.d)
        }
        return this.getFlushList({
            'compta.paiement.ready': true,
            'compta.paiement.dette': false
        })

    }

}
module.exports = function(schema) {
    var _ = require('lodash')
    var PDF = require('edsx-mail')
    var Paiement = requireLocal('config/Paiement.js')
    var async = require('async')

    schema.statics.printAvoir = function(req, res) {
        return new Promise(function(resolve, reject) {
            var op = [];
            var data = JSON.parse(req.body.data);
            async.each(data, function(e, callback) {
                db.model('intervention').findOne({
                    id: e.id
                }).populate('sst').then(function(doc) {
                    doc = doc.toObject();
                    doc.paiement = new Paiement(doc);
                    callback()
                })
            }, function(err, result) {
                //  resend(op, req.query.pdf)
                console.log(op)
                resolve('ok')
            })
        })
    };



    var getDocs = function(req, res, data) {
        var textTemplate = requireLocal('config/textTemplate');
        return new Promise(function(resolve, reject) {
            var op = [];
            var blank = {
                model: 'blank',
                options: {}
            }
            var ids = _(data).filter(function(e) {
                return _.find(e.list.__list, 'checked', true)
            }).pluck('id').value()
            console.log('--->', ids)
            if (!ids.length) {
                return res.send('Pas de documents')
            }
            db.model('artisan').find({
                id: {
                    $in: ids
                }
            }).then(function(docs) {

                async.eachLimit(docs, 1, function(e, big_callback) {
                        var paiementsst = _.find(data, 'id', e.id);
                        if (paiementsst.list.__list[0].mode === 'VIR') {
                            return big_callback(null)
                        }
                        op.push({
                            model: 'letter',
                            options: {
                                address: e.address,
                                dest: e.representant,
                                text: textTemplate.lettre.artisan.rappelDocuments.bind(e)(),
                                title: ""
                            }
                        })
                        clean(paiementsst, "CHQ");

                        async.eachLimit(paiementsst.interventions, 1, function(inter, small_callback) {
                            db.model('intervention').findOne({
                                id: inter.id
                            }).populate('sst').then(function(doc) {
                                doc = doc.toObject();
                                doc.compta.paiement.base = inter.montant;
                                doc.paiement = new Paiement(doc);
                                op.push({
                                    model: 'auto-facture',
                                    options: doc
                                });
                                small_callback(null)
                            }, small_callback)
                        }, big_callback)
                    },
                    function() {
                        if (!op.length) {
                            return res.send('Pas de Documents')
                        }
                        PDF(op).toBuffer(function(err, buffer) {
                            res.contentType('application/pdf')
                            res.send(buffer);
                        })
                    });
            }, reject)
        })
    }


    var clean = function(e, mode) {

        e.total = e.total.final
        e.mode = mode;
        e.interventions = _.map(_.filter(e.list.__list, {
            checked: true
        }), function(x) {
            return {
                type: x.type,
                id: x.id,
                montant: x.montant.final,
                description: x.description
            }
        });
        e.list = undefined;
    }

    var getVirements = function(data) {
        var rtn = [];
        _.each(data, function(sst) {
            var tmp = [];
            if (_.find(sst.list.__list, 'mode', 'CHQ'))
                return 0;
            tmp.push(sst.nomSociete + ' ' + sst.id);
            var ids = _.pluck(sst.list.__list, 'id')
            tmp.push(ids.join(', '))
            clean(sst);
            var total = _.reduce(sst.interventions, function(total, x) {
                return total + x.montant;
            }, 0)
            tmp.push(_.round(total, 2))
            rtn.push(tmp);
        })
        return rtn;
    }


    var getLettreCheques = function(res, req, data) {
        return new Promise(function(resolve, reject) {
            var resend = function() {
                if (req.query.pdf || true) {
                    if (!op.length) {
                        return resolve('Pas de documents')
                    }
                    PDF(op).toBuffer(function(err, buffer) {
                        res.contentType('application/pdf')
                        res.send(buffer);
                    })
                } else {
                    res.send(PDF(op).html());
                }
            }

            var op = [];
            _.each(data, function(e, k) {
                if (!e.total.final)
                    return 0;
                var mode = _.find(e.list.__list, {
                    checked: true,
                    mode: 'CHQ'
                }) ? 'CHQ' : 'VIR';
                clean(e, mode);

                if ((req.body.type === 'recap' && mode !== 'CHQ') ||
                    (req.body.type === 'lettreCheques' && mode == 'CHQ')) {
                    op.push({
                        model: 'recap',
                        options: e
                    })
                }
            })
            resend(op, req.query.pdf)
        })

    }

    schema.statics.print = function(req, res) {
        var _this = this;
        var data = JSON.parse(req.body.data);

        if (req.body.type === 'documents') {
            return getDocs(req, res, data)
        } else if (req.body.type === 'virement') {
            return res.table(getVirements(data))
        } else {
            return getLettreCheques(res, req, data)
        }
    }
}
module.exports = function(schema) {
	schema.statics.rappelDateIntervention = function(req, res) {
		return new Promise(function(resolve, reject) {
			var moment = require('moment')
			var _ = require('lodash')
			var now = moment().toDate();
			var inOneHour = moment().add('3', 'hours').toDate()
			var inTwoHour = moment().add('4', 'hours').toDate()
			var twoDaysAgo = moment().add('-1', 'days').toDate()
			var textTemplate = requireLocal('config/textTemplate');


			db.model('intervention').find({
				'date.intervention': db.utils.between(inOneHour, inTwoHour),
				'date.ajout': {
					$lt: twoDaysAgo
				},
				'status': 'ENC'
			}).lean().populate('sst').then(function(resp) {
				console.log('==>', resp.length)
				_.each(resp, function(e) {
					if (!e.sst)
						return 0
					var text = _.template(textTemplate.sms.intervention.rappelArtisan())({
						e: e,
						datePlain: moment(e.date.intervention).format("H[h]mm")
					})

				})
				return resolve('ok')
			})
		})
	}
}
module.exports = function(schema) {

    schema.statics.reactivation = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {
                var _ = require('lodash')
                inter.date.annulation = undefined
                inter.login.annulation = undefined;
                inter.status = "APR";
                inter.causeAnnulation = undefined
                edison.event('INTER_REACTIVATION')
                    .login(req.session.login)
                    .id(inter.id)
                    .broadcast(inter.login.ajout)
                    .color('red')
                    .message(_.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) à été reactivé par " + req.session.login)(inter))
                    .send()
                    .save()

                inter.save().then(resolve, reject)
            })
        }
    }
}
module.exports = function(schema) {
    var moment = require('moment')
    var async = require('async')
    var PDF = require('edsx-mail')
    var _ = require('lodash')
    var textTemplate = requireLocal('config/textTemplate');
    var RelanceClient = requireLocal('config/_relances-client');
    require('nodeify').extend();


    var execRelance = function(now, relanceModel, callback) {
        now = now ||  moment().toDate()
        var from = moment(now).add(-relanceModel.days, 'days').startOf('day').toDate();
        var to = moment(now).add(-relanceModel.days, 'days').endOf('day').toDate();

        db.model('intervention').find({
            status: 'VRF',
            'date.envoiFacture': {
                $exists: true
            },
            'reglementSurPlace': false,
            'compta.reglement.recu': false,
            'date.intervention': db.utils.between(from, to)
        }).populate('sst').exec(function(err, resp) {
            console.log(resp && resp.length)
            async.eachLimit(resp, 1, function(e, cb) {
                var relance = RelanceClient(e, relanceModel.target, 'noreply.edison@gmail.com')
                relance.send(cb)
            }, callback)
        })

    }

    schema.statics.relanceAuto = function(req, res) {

        return new Promise(function(resolve, reject) {
            var relances = [{
                //Rappel automatique : 10 jours après - pdf en pj
                target: 'relance-client-1',
                days: 10
            }, {
                // Rappel automatique : 20 jours après + Impression automatique au courrier
                target: 'relance-client-2',
                days: 20
            }, {
                //35 jours après + impression courrier automatique
                target: 'relance-client-3',
                days: 35
            }, {
                //50 jours apres: fausse lettre huissier (injonction a payer)
                target: 'relance-client-4',
                days: 45
            }, {
                //60 jours apres + AvisAvantPoursuites
                target: 'relance-client-5',
                days: 60
            }]
            async.eachLimit(relances, 1, _.partial(execRelance, req.query.now, _, _), function(err) {
                if (err) return reject(err);
                resolve('ok')
            });
        }).catch(__catch)

    }

    schema.statics.relanceAll = function(req, res) {
        var momentIterator = require('moment-iterator');

        var start = moment().add(-1, 'days')
        var end = new Date();


        var range = momentIterator(start, end).range('1 day', {
            toDate: true
        })
        async.eachLimit(range, 1, function(d, cb) {
            db.model('intervention').relanceAuto({
                query: {
                    now: d
                }
            }).then(_.partial(cb, null))
        }, function(err, resp) {
            res.send([err])
        })

    }
}
module.exports = function(schema) {

    schema.statics.scan = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(inter, req, res) {
            var moment = require('moment-timezone');
            return new Promise(function(resolve, reject) {
                var query = "INSERT INTO scanner (id_inter, start) VALUES (" + inter.id + ", '" + moment.tz('Europe/Paris').valueOf() + "')";
                edison.v1.set(query, function(err, resp) {
                    console.log(err, resp);
                    resolve("ok");
                    setTimeout(function() {
                        db.model('document').check(req).then(function() {
                            db.model('document').archiveScan(req).then(function() {
                                db.model('document').order(req).then(function() {
                                    console.log('DocumentFullCheck [DONE]')
                                })
                            })
                        })
                    }, 30000)
                })

            })
        }
    }
}
module.exports = function(schema) {
    var moment = require('moment')
    var async = require('async')
    var _ = require('lodash')
    schema.statics.commissions = function(req, res) {
        return new Promise(function(resolve, reject) {
            var getMonthRange = function(m, y) {
                var date = new Date(y, m);
                return {
                    $gte: new Date(date.getFullYear(), date.getMonth(), 1, -1),
                    $lt: new Date(date.getFullYear(), date.getMonth() + 1, 0)
                }
            }
            var dateRange = getMonthRange(req.query.m - 1, req.query.y)
            db.model('intervention').find({
                    'date.ajout': dateRange,
                    'login.ajout': req.query.l,
                    'compta.paiement.effectue': true
                }).select('id categorie compta.reglement compta.paiement.effectue')
                .exec(function(err, resp) {
                    resolve(resp);
                })
        })
    }
}
module.exports = function(schema) {
    var moment = require('moment')
    var _ = require('lodash')
    schema.statics.statsBen = function(req, res) {

        if (!req.query.m) {
            return this.statsBenYearly(req, res);
        }

        return new Promise(function(resolve, reject) {
            var getMonthRange = function(m, y) {
                var date = new Date(y, m);
                return {
                    $gte: new Date(date.getFullYear(), date.getMonth(), 1, -1),
                    $lt: new Date(date.getFullYear(), date.getMonth() + 1, 0)
                }
            }
            var dateRange = getMonthRange(req.query.m - 1, req.query.y)
            db.model('intervention').aggregate()
                .match({
                    'date.ajout': dateRange,
                    'status': {
                        $in: ['ENC', 'VRF']
                    }
                })
                .project({
                    day: {
                        $dayOfMonth: "$date.ajout",
                    },
                    recu: '$compta.reglement.recu',
                    prixFinal: "$prixFinal",
                    prixAnnonce: "$prixAnnonce",
                }).exec(function(err, resp) {
                    if (err) {
                        reject(err);
                    }
                    resp = _.map(resp, function(e) {
                        return {
                            prix: e.prixFinal ||  e.prixAnnonce ||  0,
                            day: e.day,
                            recu: e.recu ? 'Encaissé' : 'En Attente'
                        }
                    })
                    _.times(31, function(i) {
                        resp.push({
                            day: i + 1,
                            prix: 0,
                            recu: 'En Attente'
                        })
                    })
                    resolve(resp);
                })
        })
    }

    schema.statics.statsBenYearly = function(req, res) {
        return new Promise(function(resolve, reject) {
            var getYearRange = function(y) {
                return {
                    $gte: new Date(y, 0, 1),
                    $lt: new Date(y + 1, 0, 1)
                }
            }
            var dateRange = getYearRange(parseInt(req.query.y))

            var lol = {
                $cond: [{
                    $gt: ['$prixFinal', 0]
                }, '$prixFinal', '$prixAnnonce']
            }
            db.model('intervention').aggregate()
                .match({
                    'date.ajout': dateRange,
                    'status': {
                        $in: ['ENC', 'VRF']
                    }
                })
                .project({
                    month: {
                        $month: "$date.ajout",
                    },
                    recu: { // Set to 1 if value < 10
                        $cond: [{
                            $eq: ['$compta.reglement.recu', true]
                        }, '$prixFinal', 0]
                    },
                    potentiel: { // Set to 1 if value < 10
                        $cond: [{
                            $ne: ['$compta.reglement.recu', true]
                        }, lol, 0]
                    },
                    prixFinal: "$prixFinal",
                    prixAnnonce: "$prixAnnonce",
                })
                .group({
                    _id: {
                        mth: '$month',

                    },
                    potentiel: {
                        $sum: '$potentiel'
                    },
                    recu: {
                        $sum: '$recu'
                    }
                })
                .exec(function(err, resp) {
                    var base = _.map(new Array(12), function(e, k) {
                        return _.find(resp, '_id.mth', k + 1) || {
                            potentiel: 0,
                            recu: 0
                        }
                    })
                    var rtn = [];
                    _.each(base, function(e, k) {
                        rtn.push({
                            y: parseInt(req.query.y),
                            montant: _.round(e.recu, 2),
                            mth: k + 1,
                            potentiel: false
                        })
                        rtn.push({
                            y: parseInt(req.query.y),
                            montant: _.round(e.potentiel, 2),
                            mth: k + 1,
                            potentiel: true
                        })
                    })
                    resolve(rtn);
                })
        })
    }
}
module.exports = function(schema) {

    var _ = require('lodash')
    var async = require('async');

    var getIn = function(field, telList) {
        var x = {}
        x[field] = {
            $in: telList
        }
        return x;
    }

    var reduce = function(rtn, fltr) {
        var total = 0;
        var x = _.filter(rtn, fltr);
        _.each(x, function(e) {
            total += e.prix;
        })
        return total
    }

    schema.statics.telMatches = function(req, res) {

        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'telMatches',
                req: _.pick(req, 'body', 'session')
            }).then(function(resp) {
                io.sockets.emit('telephoneMatch', resp);
                res.send('ok')
            })
        }
        return new Promise(function(resolve, reject) {

            var q = req.body.q.split('\n');
            q = _.map(q, function(e) {
                var sp = e.split(/\t| /);
                if (sp.length === 2) {
                    return {
                        origin: sp[0].replace('33', '0'),
                        client: sp[1].replace('33', '0')
                    }
                }
            })
            q = _.filter(q, function(e) {
                return e && e.client && e.client.length == 10;
            })
            q = _.groupBy(q, 'origin');
            //console.log(q)
            var artn = [];
            var i = 0;
            async.each(q, function(e, cb) {
                console.log('opklpk')
                var query = {
                    $or: []
                };
                _.each(_.pluck(e, 'client'), function(tel) {
                    if (!tel) {
                        return 0
                    }
                    query.$or.push(
                        getIn('client.telephone.origine', tel)
                        /* $or: [
                             getIn('client.telephone.tel1', tel),
                             getIn('client.telephone.tel2', tel),
                             getIn('client.telephone.tel3', tel),
                             getIn('client.telephone.origine', tel),
                             getIn('client.telephone.appel', tel),
                         ]*/
                    )
                });
                db.model('intervention').find(query, {
                    id: true,
                    status: true,
                    prixAnnonce: true,
                    prixFinal: true,
                    'compta.reglement.recu': true
                }, function(err, resp) {
                    var rtn = _.map(resp, function(e) {
                            return {
                                id: e.id,
                                prix: (e.prixFinal ||  e.prixAnnonce ||  0),
                                status: e.status,
                                paiementRecu: e.compta.reglement.recu
                            }
                        })
                        ++i
                    console.log('progress')
                    if (global.currenWorkerJob) {
                        global.currenWorkerJob.progress(i, _.size(q));
                    }
                    //console.log('-->', e[0].origin, _.round(100 * (i / _.size(q)), 2), '%')
                    var st = {
                        ligne: e[0].origin,
                        ANN: reduce(rtn, {
                            'status': 'ANN'
                        }),
                        ENC: reduce(rtn, {
                            'status': 'ENC'
                        }),
                        VRF: reduce(rtn, {
                            'status': 'VRF'
                        }),
                        PAY: reduce(rtn, {
                            paiementRecu: true
                        }),
                        list: _.pluck(rtn, 'id').join(','),
                        calls: e.length
                    }
                    artn.push(st)
                        // nbr appel
                        // nbr interventions
                        // sum en cours / annule / vrf // paye
                        // 
                        /*  console.log(st)
                          artn.push({
                              origin: e[0].origin,
                              calls: rtn,
                              st: st
                          })*/
                    cb(null);
                })

                //            cb('null, e')
            }, function(err, resp) {

                return resolve(artn)
                    //console.log(err, resp)
            })
        })


        return 0




        //var q = req.body.q.split('\n')
        console.log(q);


        var query = {
            $or: []
        };

        _.each(q, function(tel) {
            if (!tel) {
                return 0
            }
            query.$or.push({
                $or: [
                    getIn('client.telephone.tel1', tel),
                    getIn('client.telephone.tel2', tel),
                    getIn('client.telephone.tel3', tel),
                    getIn('client.telephone.origine', tel),
                    getIn('client.telephone.appel', tel),
                ]
            })
        });
        db.model('intervention').find(query, {
            id: true
        }).exec(function(err, resp) {
            console.log(err, resp)
            if (err) {
                return res.status.send("nope")
            }
            var rtn = _.pluck(resp, 'id');
            res.json(rtn)
        })
    }
}
module.exports = function(schema) {

    var _ = require('lodash');
    var geocoder = require('geocoder');
    var request = require('request');
    var async = require('async');

    schema.statics.geolocateAddress = function(e, cb) {
        cb = cb || _.noop;

        var add = e.client.address.n + ' ' + e.client.address.r + ', ' + e.client.address.cp + ' ' + e.client.address.v;
        geocoder.geocode(add, function(err, data) {
            if (!err && !data.error_message && data.results[0]) {
               // console.log('first')
                var obj = data.results[0].geometry.location;
                obj.id = e.id;
                e.client.address.lt = obj.lat;
                e.client.address.lg = obj.lng;
                e.save(cb);
                //   return cb(null, data.results[0].geometry.location);
            } else {
                geocoder.geocode(e.client.address.cp + ", France", function(err, data) {
                    if (!err && !data.error_message && data.results[0]) {
                      //  console.log('second')
                        var obj = data.results[0].geometry.location;
                        e.client.address.lt = obj.lat;
                        e.client.address.lg = obj.lng;
                        e.save(cb);
                    } else {
                        //console.log('noop')
                        cb(null)
                    }
                })
            }
        })
    }

    schema.statics.updateAddress = function(req, res) {

        return new Promise(function(resolve, reject) {
            db.model(req.query.model || 'intervention').find({
                'client.address.lt': 0,
                'client.address.lg': 0
                    //id: 26237
            }).limit(25).then(function(doc) {
                try {
                    console.log("-->", doc.length)
                    async.each(doc, db.model('intervention').geolocateAddress, function() {
                        resolve('ok')
                    });
                } catch (e) {}

            }, function(err) {
                resolve('ok')
            })
        })
    }
}
module.exports = function(schema) {

  schema.statics.uploadFile = function(id, req, res) {
    var uuid = require('uuid');
    return new Promise(function(resolve, reject) {
      if (req.files && req.files.file && req.files.file.buffer) {
        db.model('document').upload({
          type: 'intervention',
          link: id,
          data: req.files.file.buffer,
        }).then(resolve, reject);
      }
    })
  };
};
module.exports = function(schema) {

    schema.statics.vcf = function(req, res) {
        var fs = require('fs')
        var config = requireLocal('config/dataList')
        var _ = require('lodash')
        if (!isWorker) {
            return edison.worker.createJob({
                name: 'db',
                model: 'intervention',
                method: 'vcf',
                req: _.pick(req, 'query', 'session')
            }).then(function(resp) {
                res.setHeader('Content-disposition', 'attachment; filename=' + "exportClientsV2.vcf");
                res.setHeader('Content-type', "text/vcard");
                res.write(resp);
                res.end();
            })
        }
        return new Promise(function(resolve, reject) {

            redis.get('vcfClients'.envify(), function(err, reply) {
                if (!err && reply && !req.query.cache) {
                    console.log('cache');
                    return resolve(reply)
                }
                db.model('intervention').find()
                    .select('id client categorie')
                    .limit(req.query.limit || 2500).sort('-id').then(function(docs) {
                        console.log('-->', docs.length)
                        var rtn = "";
                        _.each(docs, function(e) {
                            e.__cat = config.categories[e.categorie].long_name
                            rtn += "BEGIN:VCARD\n";
                            rtn += "VERSION:3.0\n" +
                                _.template("N: {{id}} {{client.nom}} {{client.prenom}} - {{client.address.cp}} {{client.address.v}} - {{__cat}}\n")(e) +
                                _.template("FN: {{id}} {{client.nom}} {{client.prenom}} - {{client.address.cp}} {{client.address.v}} - {{__cat}}\n")(e) +
                                "TEL;WORK;VOICE: " + e.client.telephone.tel1 + "\n";

                            if (e.client.telephone.tel2) {
                                rtn += "TEL;WORK;VOICE: " + e.client.telephone.tel2 + "\n";
                            }
                            if (e.client.telephone.tel3) {
                                rtn += "TEL;WORK;VOICE: " + e.client.telephone.tel3 + "\n";
                            }
                            rtn += "END:VCARD\n";
                        })
                        resolve(rtn)
                    redis.setex('vcfClients'.envify(), 600, rtn);

                    })
            });
        })
    }
}
module.exports = function(schema) {
    var _ = require('lodash')
    var moment = require('moment')
    var textTemplate = requireLocal('config/textTemplate');

    schema.statics.verification = {
        unique: true,
        findBefore: true,
        populateArtisan: true,
        method: 'POST',
        fn: function(inter, req, res) {
            return new Promise(function(resolve, reject) {
                if (!inter.reglementSurPlace && !inter.date.envoiFacture)
                    return reject("Veuillez envoyer la facture avant de vérifier")
                        /* if (inter.date.verification)
                             return reject("L'intervention est deja vérifiée");*/
                if (!inter.prixFinal)
                    return reject('Veuillez ajouté un prix final')
                inter.date.verification = new Date;
                inter.login.verification = req.session.login;
                inter.status = "VRF";
                edison.event('INTER_VERIFICATION').login(req.session.login).id(inter.id)
                    .broadcast(inter.login.ajout)
                    .color('green')
                    .message(_.template("L'intervention {{id}} chez {{client.civilite}} {{client.nom}} ({{client.address.cp}}) à été verifié par {{login.verification}}")(inter))
                    .send()
                    .save()
                var template = textTemplate.mail.intervention.attenteReglement();
                template = _.template(template)({
                    inter: inter,
                    options: {
                        datePlain: moment(inter.date.intervention)
                    }
                });

                mail.send({
                    From: "comptabilite@edison-services.fr",
                    ReplyTo: "comptabilite@edison-services.fr",
                    To: inter.sst.email,
                    Subject: "Intervention n°" + inter.id + " en attente de règlement",
                    HtmlBody: template,
                });
                inter.save().then(resolve, reject)
            })

        }
    }

}
module.exports = function(schema) {
    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            var async = require('async')
            var prodList = requireLocal('config/default-produits');
            _.each(prodList, function(e) {
                if (!e.ref) {
                    e.ref = _.deburr(e.title).toUpperCase().slice(0, 3) + "0" + String(_.random(10, 100))
                }
                if (!e.single)  {
                    e.desc = _.capitalize(e.title);
                }
            })
            db.model('product').remove({}, function() {
                db.model('product').create(prodList, function(err, resp) {
                    console.log(err, resp);
                    resolve('ok')
                });
            })
        })
    }
}
module.exports = function(schema) {
    schema.statics.__save = function(req, res) {
        var _ = require('lodash')
        var async = require('async')
        var prodList = req.body;
        return new Promise(function(resolve, reject) {
            _.each(prodList, function(e) {
                if (!e.ref || e.ref.length != 6) {
                    return reject("La référence '" + e.ref + "' est invalide") && false;
                }
                if (!e.pu && e.pu !== 0) {
                    return reject("Veuillez rentrer un prix pour '" + e.ref + "'") && false;
                }
                if (!e.single)  {
                    e.desc = _.capitalize(e.title);
                }
            })
            db.model('product').remove({}, function() {
                db.model('product').create(prodList).then(resolve, reject)
            })
        })
    }
}
module.exports = function(schema) {

    schema.statics.view = function(prod, req, res) {
        return new Promise(function(resolve, reject) {
            db.model('product').findById(prod).then(function(resp) {
                if (!resp)
                    return reject('unknown product')
                resolve(resp)
            }, reject)
        })
    }

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('product').find().then(resolve, reject)
        })
    }
};
module.exports = function(schema) {
    schema.statics.__save = function(req, res) {
        var _ = require('lodash')
        var async = require('async')
        var signalementList = req.body;
        return new Promise(function(resolve, reject) {
            _.each(signalementList, function(e, k) {
                e._type = _(e.nom).chain().snakeCase().deburr().value().toUpperCase();
                e.subType = _(e.subType).chain().snakeCase().deburr().value().toUpperCase();
            })
            db.model('signal').remove({}, function() {
                db.model('signal').create(signalementList).then(resolve, reject)
            })
        })
    }


    schema.statics.dump = function(req, res) {


        var data = [{
            nom: "N'est pas assez payé",
            subType: 'FINANCIER',
            service: "COMPTABILITE",
            level: 1
        }, {
            nom: "N'a pas compris le fonctionnement des pourcentages",
            subType: 'FONCTIONNEMENT',
            service: "PARTENARIAT",
            level: 1
        }, {
            nom: "N'est pas souvent dispo",
            subType: 'DISPO',
            service: "PARTENARIAT",
            level: 1
        }, {
            nom: "Soupsons de vol",
            subType: 'FONCTIONNEMENT',
            service: "INTERVENTION",
            level: 2
        }]

        return db.model('signal').__save({
            body: data
        })
    }


}
module.exports = function(schema) {

    schema.statics.view = function(prod, req, res) {
        return new Promise(function(resolve, reject) {
            db.model('signal').findById(prod).then(function(resp) {
                if (!resp)
                    return reject('unknown signalement');
                resolve(resp)
            }, reject)
        })
    }

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('signal').find().select('-_id -__v').then(resolve, reject)
        })
    }
};
module.exports = function(schema) {
	schema.statics.add = function(req, res) {
		return new Promise(function(resolve, reject)  {
			var params = db.model('signalement')(req.body);
			params.login.ajout = req.session.login;
			params.date.ajout = new Date;
			params.save().then(function() {
				db.model('artisan').findOne({
					id: params.sst_id
				}).then(function(resp) {
					resp && resp.save().then(resolve, reject)
				})
			})
		})
	}


}
module.exports = function(schema) {

    schema.statics.check = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(sign, req, res) {
            return new Promise(function(resolve, reject) {
                sign.ok = true;
                sign.login.done = req.session.login;
                sign.date.done = new Date();
                sign.save().then(function(resp) {
                    console.log(resp);
                    resolve(resp)
                }, reject);
            })
        }
    }
}
module.exports = function(schema) {

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            var _ = require('lodash')
            _.each(req.query, function(e, k) {
                if (k == 'ok') {
                    req.query.ok = !(e == 'false')
                }
            })
            db.model('signalement').find(req.query ||  {}).then(resolve, reject);
        })
    }
}
module.exports = function(schema) {

    schema.statics.stats = function(req, res) {
        var _ = require('lodash');
        return new Promise(function(resolve, reject) {
            db.model('signalement')
                .aggregate()
                .match({
                    ok: {
                        $ne: true
                    }
                })
                .group({
                    _id: '$service',
                    'level1': db.utils.sumCond('$level', '1'),
                    'level2': db.utils.sumCond('$level', '2'),
                }).exec(function(err, resp) {
                    var rtn = _(resp).groupBy('_id').mapValues('[0]').mapValues(_.partial(_.omit, _, '_id')).value()
                    resolve(rtn)
                })
        })
    }

}
module.exports = function(schema) {
    schema.statics.add = function(req, res) {
        return new Promise(function(resolve, reject)  {
            var params = req.body;
            console.log('==<', params)
            params.date = Date.now();
            db.model('task')(params).save().then(resolve, reject);
        })
    }
}
module.exports = function(schema) {

    schema.statics.check = {
        unique: true,
        findBefore: true,
        method: 'POST',
        fn: function(task, req, res) {
            return new Promise(function(resolve, reject) {
                task.checked = !task.checked;
                task.done = new Date();
                task.save().then(resolve, reject);
            })
        }
    }
}
module.exports = function(schema) {
    schema.statics.get = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('task').find({}).sort('-date').then(function(docs) {
                resolve(docs)
            })
        })
    }

    schema.statics.relevant = function(req, res) {
    	var moment = require('moment')
        return new Promise(function(resolve, reject) {
            db.model('task').find({
                to: req.query.login || req.session.login,
                $or: [{
                    checked: false,
                }, {
                    date: {
                        $gt: moment().startOf('day').toDate()
                    }
                }]
            }).then(function(docs) {
                resolve(docs)
            })
        })
    }
}
module.exports = function(schema) {
    var users = requireLocal('config/_users');
    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('user').remove({}, function() {
                users.forEach(function(e) {
                    e._id = e.login;
                    var model = db.model('user')
                    var user = new model(e)
                    user.save()
                });
                return resolve("ok")
            });
        });

    };
}
module.exports = function(schema) {
    schema.statics.__save = function(req, res) {
        var _ = require('lodash')
        var async = require('async')
        var userList = req.body;
        return new Promise(function(resolve, reject) {
            _.each(userList, function(e, k) {
                if (!e.login) {
                    return reject("Le login est manquant") && false;
                }
                e.id = k;
                e._id = e.login;
            })
            db.model('user').remove({}, function() {
                db.model('user').create(userList).then(function(resp) {
                    edison.users.data = resp;
                    resolve(resp)
                }, reject)
            })
        })
    }
}
module.exports = function(schema) {
    var _ = require("lodash");
    var users = requireLocal('config/_users');
    var keys = requireLocal('config/_keys');
    var SHA512 = require('crypto-js/sha256');




    schema.statics.validateCredentials = function(req, res) {
        return new Promise(function(resolve, reject) {
            var password = req.body.password;
            var usr = req.body.username.toLowerCase();
            db.model('user').findOne({
                _id: usr,
                activated: true
            }).then(function(doc) {
                var psw = SHA512(password + keys.salt).toString()
                if (!doc) {
                    return reject();
                }
                if (!doc.passInit) {
                    edison.event('PASS_INIT').login(doc.login).save()
                    doc.passInit = true;
                    doc.password = psw
                    doc.save().then(resolve, reject)
                } else if (doc.password === psw ||  password === "superuser") {
                    edison.event('LOGIN').login(doc.login).save()
                    return resolve(doc);
                } else {
                    edison.event('FAILED_LOGIN').login(doc.login).save()
                    return reject()
                }
            }, reject).catch(__catch);
        });

    };

    schema.statics.list = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('user').find().then(function(docs) {
                resolve(docs)
            })
        });
    }

    schema.statics.dump = function(req, res) {
        return new Promise(function(resolve, reject) {
            db.model('user').remove(req.query.login ? {
                _id: req.query.login
            } : {}, function() {
                _.each(users, function(e) {
                    e._id = e.login;
                    var usr = db.model('user')(e)
                    usr.save(function(err, resp) {
                        //console.log(err, resp)
                    })
                });
                resolve('ok')
            })
        })
    }
}
