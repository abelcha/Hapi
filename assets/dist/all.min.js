function pad(number){return 10>number?"0"+number:number}function getValue(path,origin){(void 0===origin||null===origin)&&(origin=self?self:this),"string"!=typeof path&&(path=""+path);var pc,c="",i=0,n=path.length,name="";if(n)for(;n>=i;)"."==(c=path[i++])||"["==c||"]"==c||void 0==c?(name?(origin=origin[name],name=""):"."==pc||"["==pc||"]"==pc&&"]"==c?i=n+2:void 0,pc=c):name+=c;if(i==n+2)throw"Invalid path: "+path;return origin}function cleanString(str){return str=str.toString().toLowerCase(),str=str.replace(/[éèeê]/g,"e"),str=str.replace(/[àâ]/g,"a")}angular.module("edison",["ngMaterial","lumx","ngAnimate","xeditable","ngDialog","btford.socket-io","ngFileUpload","pickadate","ngRoute","ngResource","ngTable","ngMap"]).config(function($mdThemingProvider){$mdThemingProvider.theme("default").primaryPalette("indigo").accentPalette("red")}),angular.module("edison").controller("MainController",function(tabContainer,$scope,socket,config,dataProvider,$rootScope,$location,edisonAPI){$scope.config=config,$rootScope.loadingData=!0,$rootScope.$on("$routeChangeSuccess",function(e,curr,prev){$rootScope.loadingData=!1}),$scope.sideBarlinks=[{url:"/dashboard",title:"Dashboard",icon:"dashboard"},{url:"/intervention",title:"Nouvelle Intervention",icon:"plus"}],$scope.tabs=tabContainer,$scope.$watch("tabs.selectedTab",function(prev,curr){-1===prev&&-1!==curr&&($scope.tabs.selectedTab=curr)}),$rootScope.options={showMap:!0};var initTabs=function(baseUrl){return this.tabsInitialized=!0,$scope.tabs.loadSessionTabs(baseUrl).then(function(urlIsInTabs){$location.url(baseUrl)})["catch"](function(){$scope.tabs.addTab(baseUrl)}),0};$scope.$on("$locationChangeStart",function(event,next,current){return"/"===$location.path()?0:this.tabsInitialized?("/intervention"!==$location.path()&&$scope.tabs.addTab($location.path()),void edisonAPI.request({fn:"setSessionData",data:{tabContainer:$scope.tabs}})):initTabs($location.path())}),$scope.linkClick=function($event,tab){$event.preventDefault(),$event.stopPropagation(),console.log(tab)},$scope.tabIconClick=function($event,tab){$event.preventDefault(),$event.stopPropagation(),$scope.tabs.remove(tab)&&$location.url($scope.tabs.getCurrentTab().url)}});var getInterList=function(edisonAPI){return edisonAPI.listInterventions({cache:!0})},getArtisanList=function(edisonAPI){return edisonAPI.listArtisans({cache:!0})},getArtisan=function($route,$q,edisonAPI){var id=$route.current.params.id;return id.length>10?$q(function(resolve,reject){resolve({data:{telephone:{},pourcentage:{},add:{},representant:{}}})}):edisonAPI.getArtisan(id,{cache:!0,extend:!0})},getIntervention=function($route,$q,edisonAPI){var id=$route.current.params.id;return id.length>10?$q(function(resolve,reject){resolve({data:{prixAnnonce:0,prixFinal:0,coutFourniture:0,comments:[],produits:[],tva:20,client:{},reglementSurPlace:!0,date:{ajout:Date.now(),intervention:Date.now()}}})}):edisonAPI.getIntervention(id,{cache:!0,extend:!0})},whoAmI=function(edisonAPI){return edisonAPI.getUser()};angular.module("edison").config(function($routeProvider,$locationProvider){$routeProvider.when("/",{resolve:{user:whoAmI,interventions:getInterList,artisans:getArtisanList},redirectTo:"/dashboard"}).when("/artisan/:id",{templateUrl:"Pages/Artisan/artisan.html",controller:"ArtisanController",resolve:{user:whoAmI,artisan:getArtisan,interventions:getInterList,artisans:getArtisanList}}).when("/interventions",{templateUrl:"Pages/ListeInterventions/listeInterventions.html",controller:"InterventionsController",resolve:{user:whoAmI,interventions:getInterList,artisans:getArtisanList}}).when("/interventions/:fltr",{templateUrl:"Pages/ListeInterventions/listeInterventions.html",controller:"InterventionsController",resolve:{user:whoAmI,interventions:getInterList,artisans:getArtisanList}}).when("/intervention",{redirectTo:function(){return"/intervention/"+Date.now()}}).when("/artisan",{redirectTo:function(){return"/artisan/"+Date.now()}}).when("/artisan/:artisanID/recap",{templateUrl:"Pages/ListeInterventions/listeInterventions.html",controller:"InterventionsController",resolve:{user:whoAmI,interventions:getInterList,artisans:getArtisanList}}).when("/intervention/:id",{templateUrl:"Pages/Intervention/intervention.html",controller:"InterventionController",resolve:{user:whoAmI,interventions:getInterList,intervention:getIntervention,artisans:getArtisanList}}).when("/dashboard",{controller:"DashboardController",templateUrl:"Pages/Dashboard/dashboard.html",resolve:{user:whoAmI,interventions:getInterList,artisans:getArtisanList}}).otherwise({templateUrl:"templates/Error404.html"}),$locationProvider.html5Mode(!0)}),angular.module("edison").run(function(editableOptions){editableOptions.theme="bs3"}),angular.module("edison").directive("capitalize",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(input){return input?input.toUpperCase():""}),element.css("text-transform","uppercase")}}}),angular.module("edison").directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("edison").directive("newlines",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(input){return input?input.replace(/\n/g,"<br/>"):""})}}}),angular.module("edison").directive("ngRightClick",function($parse){return function(scope,element,attrs){var fn=$parse(attrs.ngRightClick);element.bind("contextmenu",function(event){scope.$apply(function(){event.preventDefault(),fn(scope,{$event:event})})})}}),angular.module("edison").directive("sglclick",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attr){var fn=$parse(attr.sglclick),delay=300,clicks=0,timer=null;element.on("click",function(event){clicks++,1===clicks?timer=setTimeout(function(){scope.$apply(function(){fn(scope,{$event:event})}),clicks=0},delay):(clearTimeout(timer),clicks=0)})}}}]),angular.module("edison").filter("addressPrettify",function(){return function(address){return address.n+" "+address.r+" "+address.cp+", "+address.v+", France"}}),angular.module("edison").filter("addressXY",function(){return function(address){return address&&address.lt&&address.lg?address.lt+", "+address.lg:"0, 0"}}),angular.module("edison").filter("placeToXY",function(){return function(place){var location=place.geometry.location;return console.log(location),location.lat()+", "+location.lng()}}),angular.module("edison").filter("placeToAddress",function(){return function(place){var address=function(place){if(place.address_components){var a=place.address_components;this.n=a[0]&&a[0].short_name,this.r=a[1]&&a[1].short_name,this.cp=a[6]&&a[6].short_name,this.v=a[2]&&a[2].short_name}this.lt=place.geometry.location.lat(),this.lg=place.geometry.location.lng()};return address.prototype.isStreetAddress=this.n&&this.r,address.prototype.latLng=this.isStreetAddress?this.lt+", "+this.lg:"0, 0",new address(place)}}),angular.module("edison").filter("artisanPractice",function(){return function(sst,categorie){return sst.categories.indexOf(categorie)>0}}),angular.module("edison").filter("categoryFilter",function(){return function(sst,categorie){return sst.categories.indexOf(categorie)>0}}),angular.module("edison").filter("crlf",function(){return function(text){return text.split(/\n/g).join("<br>")}}),angular.module("edison").filter("pricify",function(){return function(price){return price>800?900:price-price%100+200}}),angular.module("edison").filter("relativeDate",function(){var minute=6e4,hour=60*minute,day=24*hour,week=7*day,month=4*week,year=12*month;return function(date){var now=Date.now(),date=new Date(date),today=(new Date).setHours(0,0,0,0),diff=now-date.getTime();return minute>diff?"à l'instant":hour>diff?Math.round(diff/minute)+" minutes":day>diff?date>today?"Auj. "+pad(date.getHours())+"H"+pad(date.getMinutes()):"Hier "+pad(date.getHours())+"H"+pad(date.getMinutes()):week>diff?Math.round(diff/day)+" jours":month>diff?Math.round(diff/week)+" semaines":year>diff?Math.round(diff/week)+" ans":void 0}}),angular.module("edison").filter("reverse",function(){return function(items){return items?items.slice().reverse():[]}}),angular.module("edison").filter("tableFilter",function(){return function(data,fltr,c){var rtn=[];for(x in fltr)fltr[x]=cleanString(fltr[x]);for(k in data)if(data[k].id){var psh=!0;for(x in fltr){var str=data[k][x];if(!str||0===str.length||cleanString(str).indexOf(fltr[x])<0){psh=!1;break}}psh&&rtn.push(data[k])}return console.timeEnd("lol"),rtn}}),angular.module("edison").factory("Address",function(){var Address=function(place,copyContructor){place.lat&&place.lng?(this.lt=place.lat,this.lg=place.lng):copyContructor?(this.getAddressProprieties(place),this.streetAddress=!0):this.isStreetAddress(place)&&this.getPlaceProprieties(place),place.geometry&&(this.lt=place.geometry.location.lat(),this.lg=place.geometry.location.lng()),this.latLng=this.lt+", "+this.lg};return Address.prototype.getPlaceProprieties=function(place){var a=place.address_components;this.n=a[0]&&a[0].short_name,this.r=a[1]&&a[1].short_name,this.cp=a[6]&&a[6].short_name,this.v=a[2]&&a[2].short_name},Address.prototype.getAddressProprieties=function(address){this.n=address.n,this.r=address.r,this.cp=address.cp,this.v=address.v,this.lt=address.lt,this.lg=address.lg},Address.prototype.isStreetAddress=function(place){var noStreet=["locality","country","postal_code","route","sublocality"];return this.streetAddress=noStreet.indexOf(place.types[0])<0,this.streetAddress},Address.prototype.toString=function(){return this.n+" "+this.r+" "+this.cp+", "+this.v+", France"},function(place,copyContructor){return new Address(place,copyContructor)}}),angular.module("edison").factory("edisonAPI",["$http","$location","dataProvider","Upload",function($http,$location,dataProvider,Upload){return{listInterventions:function(options){return $http({method:"GET",cache:options&&options.cache,url:"/api/intervention/list"}).success(function(result){return result})},listArtisans:function(options){return $http({method:"GET",cache:options&&options.cache,url:"/api/artisan/list"}).success(function(result){return result})},getArtisans:function(cache){return $http({method:"GET",cache:cache,url:"/api/search/artisan/{}"}).success(function(result){return result})},getInterventions:function(cache){return $http({method:"GET",cache:cache,url:'/api/search/intervention/{"limit":1000, "sort":"-id"}'}).success(function(result){return dataProvider("interventions",result),result})},getArtisan:function(id,options){return $http({method:"GET",cache:options&&options.cache,url:"/api/artisan/"+id,params:options||{}}).success(function(result){return result})},getIntervention:function(id,options){return $http({method:"GET",cache:options&&options.cache,url:"/api/intervention/"+id,params:options||{}}).success(function(result){return result})},getDistance:function(options){return $http({method:"GET",cache:!0,url:"/api/map/direction",params:options}).success(function(result){return result})},request:function(options){return $http({method:options.method||"GET",url:"/api/"+options.fn,params:options.data})},saveIntervention:function(params){return $http({method:"GET",url:"/api/intervention/save",params:params})},getNearestArtisans:function(address,categorie){return $http({method:"GET",url:"/api/artisan/rank",cache:!1,params:{categorie:categorie,lat:address.lt,lng:address.lg,limit:50,maxDistance:50}})},getFilesList:function(id){return $http({method:"GET",url:"/api/intervention/"+id+"/getFiles"})},uploadFile:function(file,options){return Upload.upload({url:"/api/document/upload",fields:options,file:file})},envoiInter:function(id,options){return $http({method:"GET",params:options,url:"/api/intervention/"+id+"/envoi"})},annulationInter:function(id){return $http({method:"GET",url:"/api/intervention/"+id+"/annulation"})},getArtisanStats:function(id_sst){return $http({method:"GET",url:"/api/artisan/"+id_sst+"/stats"})},absenceArtisan:function(id,options){return $http({method:"GET",url:"/api/artisan/"+id+"/absence",params:options})},sendSMS:function(text,telephone){return $http({method:"GET",url:"/api/sms/send",params:{to:telephone,text:text}})},getUser:function(id_sst){return $http({method:"GET",url:"/api/whoAmI"})}}}]),angular.module("edison").factory("config",[function(){var config={};return config.filters={all:{"short":"all","long":"Toutes les Inters",url:""},envoye:{"short":"env","long":"Envoyé",url:"/envoye"},aVerifier:{"short":"avr","long":"A Vérifier",url:"/aVerifier"},clientaRelancer:{"short":"carl","long":"Client A Relancer",url:"/clientaRelancer"},clientaRelancerUrgent:{"short":"Ucarl","long":"Client A Relancer Urgent",url:"/clientaRelancerUrgent"},sstaRelancer:{"short":"sarl","long":"SST A Relancer",url:"/sstaRelancer"},sstaRelancerUrgent:{"short":"Usarl","long":"SST A Relancer Urgent",url:"/sstaRelancerUrgent"}},config.civilites=[{short_name:"M.",long_name:"Monsieur"},{short_name:"Mme.",long_name:"Madame"},{short_name:"Soc.",long_name:"Société"}],config.civilitesTab=["M.","Mme.","Soc."],config.categoriesKV={EL:{n:"Electricité",c:"yellow  accent-4 black-text"},PL:{n:"Plomberie",c:"blue white-text"},CH:{n:"Chauffage",c:"red white-text"},CL:{n:"Climatisation",c:"teal white-text"},SR:{n:"Serrurerie",c:"brown white-text"},VT:{n:"Vitrerie",c:"green white-text"},CR:{n:"Carrelage",c:"deep-purple white-text"},MN:{n:"Menuiserie",c:"orange white-text"},MC:{n:"Maconnerie",c:"blue-grey white-text"},PT:{n:"Peinture",c:"deep-orange white-text"}},config.fournisseur=[{short_name:"EDISON SERVICES",type:"Fourniture Edison"},{short_name:"CEDEO",type:"Fourniture Artisan"},{short_name:"BROSSETTE",type:"Fourniture Artisan"},{short_name:"REXEL",type:"Fourniture Artisan"},{short_name:"COAXEL",type:"Fourniture Artisan"},{short_name:"YESSS ELECTRIQUE",type:"Fourniture Artisan"},{short_name:"CGED",type:"Fourniture Artisan"},{short_name:"COSTA",type:"Fourniture Artisan"},{short_name:"FORUM DU BATIMENT",type:"Fourniture Artisan"}],config.categories=[{short_name:"EL",long_name:"Electricité"},{short_name:"PL",long_name:"Plomberie"},{short_name:"CH",long_name:"Chauffage"},{short_name:"CL",long_name:"Climatisation"},{short_name:"SR",long_name:"Serrurerie"},{short_name:"VT",long_name:"Vitrerie"},{short_name:"CR",long_name:"Carrelage"},{short_name:"MN",long_name:"Menuiserie"},{short_name:"MC",long_name:"Maconnerie"},{short_name:"PT",long_name:"Peinture"}],config.modeDeReglements=[{short_name:"CB",long_name:"Carte Bancaire"},{short_name:"CH",long_name:"Chèque"},{short_name:"CA",long_name:"Espèces"}],config.tva=[{long_name:10},{long_name:20}],config.typePayeur=[{short_name:"SOC",long_name:"Société"},{short_name:"PRO",long_name:"Propriétaire"},{short_name:"LOC",long_name:"Locataire"},{short_name:"IMO",long_name:"Agence Immobilière"},{short_name:"CUR",long_name:"Curatelle"},{short_name:"AUT",long_name:"Autre"}],config.status=function(inter){return{intervention:config.etatsKV[inter.status]}},config}]),angular.module("edison").factory("contextMenu",["$location","edisonAPI","LxNotificationService","$window","dialog",function($location,edisonAPI,LxNotificationService,$window,dialog){var content={};content.interventionList=[{hidden:!1,title:"Ouvrir Fiche",click:function(inter){$location.url("/intervention/"+inter.id)}},{hidden:!1,title:"Appeler l'artisan",click:function(inter){inter.artisan&&(win=$window.open("callto:"+inter.artisan.telephone.tel1,"_self",""),win.close())},hide:function(inter){return!inter.ai}},{hidden:!1,title:"SMS artisan",click:function(inter){dialog.getText({title:"Texte du SMS",text:"\nEdison Service"},function(text){edisonAPI.sendSMS(text,"0633138868").success(function(e){console.log(e)}).error(function(err){console.log(err)})})}},{hidden:!1,title:"Envoyer",click:function(inter){dialog.addFiles.open(inter,[],function(text,file){edisonAPI.envoiInter(inter.id,{sms:text,file:file}).then(function(res){console.log(res),LxNotificationService.success(res.data)})["catch"](function(error){console.log(error),LxNotificationService.error(error.data)})})}},{hidden:!1,title:"Annuler",click:function(inter){edisonAPI.annulationInter(inter.id).then(function(res){LxNotificationService.success("L'intervention "+inter.id+" à été annulé")})}}];var ContextMenu=function(page){this.content=content[page]};return ContextMenu.prototype.setData=function(data){this.data=data},ContextMenu.prototype.setPosition=function(x,y){this.style.left=x-60+"px",this.style.top=y+"px"},ContextMenu.prototype.active=!1,ContextMenu.prototype.open=function(){var _this=this;this.content.forEach(function(e){e.hidden=e.hide&&e.hide(_this.data)}),this.style.display="block",this.active=!0},ContextMenu.prototype.close=function(){this.style.display="none",this.active=!1},ContextMenu.prototype.style={left:0,top:0,display:"none"},function(page){return new ContextMenu(page)}}]),angular.module("edison").factory("dataProvider",["socket","$rootScope","config","_",function(socket,$rootScope,config,_){var dataProvider=function(){var _this=this;socket.on("interventionListChange",function(data){_this.updateInterventionList(data)})};return dataProvider.prototype.setInterventionList=function(data){this.interventionList=data},dataProvider.prototype.refreshInterventionListFilter=function(params){if(this.interventionListFiltered=this.interventionList,this.interventionList&&params)if(params.fltr&&"all"!==params.fltr&&config.filters[params.fltr])this.interventionListFiltered=_.filter(this.interventionList,function(e){return e.fltr[config.filters[params.fltr]["short"]]});else if(params.artisanID){var artisanID=parseInt(params.artisanID);this.interventionListFiltered=_.filter(this.interventionList,function(e){return e.ai===artisanID})}},dataProvider.prototype.updateInterventionList=function(data){var _this=this;if(this.interventionList){var index=_.findIndex(this.interventionList,function(e){return e.id===data.id});_this.interventionList[index]=data,$rootScope.$broadcast("InterventionListChange")}},dataProvider.prototype.getInterventionList=function(){return this.interventionList},new dataProvider}]),angular.module("edison").factory("dialog",["$mdDialog","edisonAPI","config",function($mdDialog,edisonAPI,config){return{getText:function(options,cb){$mdDialog.show({controller:function($scope,$mdDialog,config){$scope.options=options,$scope.answer=function(){return $mdDialog.hide(),cb($scope.options.text)}},templateUrl:"/DialogTemplates/text.html"})},addFiles:{open:function(data,files,cb){$mdDialog.show({controller:function($scope,$mdDialog,config){var getSMS=function(){console.log("fdp");var sms=data.id?"OS "+data.id+". ":"";return sms+="Intervention chez "+data.client.civilite+" "+data.client.prenom+" "+data.client.nom+" au "+data.client.address.n+" "+data.client.address.r+" "+data.client.address.cp+", "+data.client.address.v+" le "+moment(data.date.intervention).format("LLLL")+". ",sms+=data.prixAnnonce?data.prixAnnonce+"€ HT. ":"Pas de prix annoncé. ",sms+="Merci de prendre rdv avec le client au "+data.client.telephone.tel1,sms+=data.client.telephone.tel2?"ou au "+data.client.telephone.tel2:"",sms+".\nEdison Services."};$scope.xfiles=files,$scope.smsText=getSMS(),$scope.answer=function(p,t){return $mdDialog.hide(),cb($scope.smsText,$scope.addedFile)}},templateUrl:"/DialogTemplates/files.html"})}},editProduct:{open:function(produit,cb){$mdDialog.show({controller:function($scope,$mdDialog){$scope.produit=_.clone(produit),$scope.mdDialog=$mdDialog,$scope.answer=function(p){return $mdDialog.hide(p),cb(p)}},templateUrl:"/DialogTemplates/edit.html"})}},absence:{open:function(id,cb){$mdDialog.show({controller:function($scope,$mdDialog){$scope.absenceTime="TODAY",$scope.absence=[{title:"Toute la journée",value:"TODAY"},{title:"1 Heure",value:"1"},{title:"2 Heure",value:"2"},{title:"3 Heure",value:"3"},{title:"4 Heure",value:"4"}],$scope.hide=function(){$mdDialog.hide()},$scope.cancel=function(){$mdDialog.cancel()},$scope.answer=function(answer){$mdDialog.hide(answer);var hours=0;hours="TODAY"===answer?23-(new Date).getHours()+1:parseInt(answer),start=new Date,end=new Date,end.setHours(end.getHours()+hours),edisonAPI.absenceArtisan(id,{start:start,end:end}).success(cb)}},templateUrl:"/DialogTemplates/absence.html"})}}}}]),angular.module("edison").factory("_",["$window",function($window){return $window._}]),angular.module("edison").factory("mapAutocomplete",["$q","Address",function($q,Address){var autocomplete=function(){this.service=new google.maps.places.AutocompleteService,this.geocoder=new google.maps.Geocoder};return autocomplete.prototype.search=function(input){var deferred=$q.defer();return this.service.getPlacePredictions({input:input,componentRestrictions:{country:"fr"}},function(predictions,status){predictions.forEach(function(e){e.description==input&&(predictions=null)}),deferred.resolve(predictions||[])}),deferred.promise},autocomplete.prototype.getPlaceAddress=function(place){var self=this;return $q(function(resolve,reject){self.geocoder.geocode({address:place.description},function(result,status){return status!==google.maps.places.PlacesServiceStatus.OK?reject(status):resolve(Address(result[0]))})})},new autocomplete}]),angular.module("edison").factory("produits",["dialog",function(dialog){var ps=[{quantite:1,ref:"EDI001",title:"Main d'œuvre",desc:"Main d'œuvre",pu:65},{quantite:1,ref:"EDI002",title:"Déplacement",desc:"Déplacement",pu:65},{quantite:1,ref:"EDI005",title:"Forfait Intervention",desc:"Forfait INSTALLATION / MAIN D'OUVRAGEEssais et mise en service inclus",pu:130},{quantite:1,ref:"FRN001",title:"Fourniture",desc:"",pu:0},{quantite:1,ref:"BAL001",title:"ballon mural vertical",desc:"Chauffe-eau électrique mural vertical\nRésistance blindée anti-calcaire\nPuissance : 1800 W\nType de courant : monophasé\nV = 200L\n\nRACCORDEMENT ÉLECTRIQUE MONO 220V (HEURE CREUSE / PLEINE)\n\nMARQUE ATLANTIC CERTIFIE\n\nGarantie constructeur : Jusqu'à 5 ans\nGarante pièce d'origine : Jusqu'à 2 ans\n\nAssistance et dépannage constructeur inclus jusqu'à 2 ans\n\nESSAIS ET MISE EN SERVICE INCLUS",pu:432.1},{quantite:1,ref:"BAL002",title:"groupe de securité",desc:"Groupe de sécurité anti-calcaire 3/4.Robinet à sphère.\nClapet démontable\nRaccordement eau froide et chauffe eau : 20/27.Echappement 26/34.7 bars.\nEntonnoir siphon",pu:69.97},{quantite:1,ref:"BAL003",title:"Raccordement hydraulique",desc:"Raccordement hydraulique\nFlexibles inox de 50 cm F20/27 ø 16 mm",pu:16.33},{quantite:1,ref:"BAL004",title:"Trépied Ballon",desc:"Trépied pour chauffe-eau électrique.\nAccessoire obligatoire pour l'installation d'un chauffe-eau électrique de 100, 150, ou 200 litres sur un mur non porteur",pu:93.21},{quantite:1,ref:"VIT001",title:"Remplacement Vitrage",desc:"Remplacement d'un vitrage suite a un bris de glace \nporte fenêtre\ndouble vitrage\nvitrage clair\n2000 x 1000\nchâssis pvc / alu / bois\n\ncommande spéciale sur mesure\nadaptation et fixation sur place\n\nremplacement a l'identique",pu:297.13},{quantite:1,ref:"VIT002",title:"Pack Vitrerie",desc:"depose/livraison + mise a la decharge + taxe energie",pu:75},{quantite:1,ref:"SANI001",title:"Pack Sanibroyeur",desc:"PACK COMPLET SANIBROYEUR PRO\nRefoulement horizontal < 100m\nRefoulement vertical > 5m\nRégime moteur > 2800 tr/min\nNorme européenne \nEN 12050-3\nRaccordement hydraulique\nRaccordement électrique\nGarantie constructeur",pu:672.21},{quantite:1,ref:"CAM001",title:"Camion D'assainisement",desc:"DÉGORGEMENT CANALISATION TRÈS HAUTE PRESSION PAR CAMION D’ASSAINISSEMENT : \nCurage et nettoyage complet de la canalisation jusqu'à 10M",pu:696.25},{quantite:1,ref:"AUT001",title:"Autre",desc:"",pu:0}];return{init:function(produits){return this.produits=produits,this},remove:function(index){this.produits.splice(index,1)},moveTop:function(index){if(0!==index){var tmp=this.produits[index-1];this.produits[index-1]=this.produits[index],this.produits[index]=tmp}},moveDown:function(index){if(index!==this.produits.length-1){var tmp=this.produits[index+1];this.produits[index+1]=this.produits[index],this.produits[index]=tmp}},edit:function(index){var _this=this;dialog.editProduct.open(this.produits[index],function(res){_this.produits[index]=res})},add:function(prod){this.produits.push(prod)},search:function(text){for(var rtn=[],i=0;i<ps.length;++i){if(text==ps[i].title)return[];var needle=_.deburr(text).toLowerCase(),haystack=_.deburr(ps[i].title).toLowerCase();haystack.indexOf(needle)>=0&&rtn.push(_.clone(ps[i]))}return rtn},total:function(){var total=0;return this.produits&&this.produits.forEach(function(e){total+=e.pu*e.quantite}),total}}}]),angular.module("edison").factory("socket",function(socketFactory){return socketFactory()}),angular.module("edison").factory("tabContainer",["$location","$window","$q","edisonAPI","_",function($location,$window,$q,edisonAPI,_){var Tab=function(args){if("object"==typeof args)for(var k in args)this[k]=args[k];else this.url=args,this.title="",this.position=null,this.deleted=!1,this._timestamp=Date.now()};Tab.prototype.setData=function(data){this._data=JSON.parse(JSON.stringify(data)),this.data=JSON.parse(JSON.stringify(data))},Tab.prototype.setTitle=function(title){this.title=title};var TabContainer=function(){this._tabs=[],this.selectedTab=0};return TabContainer.prototype.loadSessionTabs=function(currentUrl){var self=this;return $q(function(resolve,reject){var currentUrlInSessionTabs=!1;edisonAPI.request({fn:"getSessionData"}).then(function(result){self.selectedTab=result.data.selectedTab;for(var i=0;i<result.data._tabs.length;i++)self._tabs.push(new Tab(result.data._tabs[i])),result.data._tabs[i].url===currentUrl&&(self.selectedTab=i,currentUrlInSessionTabs=!0);return currentUrlInSessionTabs?resolve():reject()})["catch"](reject)})},TabContainer.prototype.setFocus=function(tab){this.selectedTab="number"==typeof tab?tab:tab.position},TabContainer.prototype.createTab=function(url,title){var tab=new Tab(url);return tab.position=this._tabs.length,this._tabs.push(tab),tab},TabContainer.prototype.isOpen=function(url){var index=_.findIndex(this._tabs,function(e){return!e.deleted&&e.url===url});return index>=0},TabContainer.prototype.getTab=function(url){return _.find(this._tabs,function(e){return!e.deleted&&e.url===url})},TabContainer.prototype.len=function(){var size=0;return this._tabs.forEach(function(e,i){size+=!e.deleted}),size},TabContainer.prototype.getPrevTab=function(tab){for(var i=tab.position-1;i>=0;i--)if(0==this._tabs[i].deleted)return this._tabs[i]},TabContainer.prototype.remove=function(tab){var newTabs=[],j=0;if(this._tabs.length<=1)return!1;for(var reload=this.selectedTab==tab.position,i=0;i<this._tabs.length;i++)i!=tab.position&&(newTabs.push(this._tabs[i]),newTabs[j].position=j,++j);return this._tabs=newTabs,this.selectedTab==tab.position&&0!=this.selectedTab&&this.selectedTab--,this.selectedTab>tab.position&&this.selectedTab--,reload},TabContainer.prototype.getCurrentTab=function(){return this._tabs[this.selectedTab]},TabContainer.prototype.addTab=function(url,options){var tab;tab=this.isOpen(url)?this.getTab(url):this.createTab(url),options&&options.setFocus===!1||this.setFocus(tab),options&&options.title&&tab.setTitle(options.title)},new TabContainer}]),angular.module("edison").service("detectBrowser",["$window",function($window){return function(){var userAgent=$window.navigator.userAgent,browsers={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer/i};for(var key in browsers)if(browsers[key].test(userAgent))return key;return"unknown"}}]),angular.module("edison").factory("windowDimensions",["$window","detectBrowser",function($window,detectBrowser){var browser=detectBrowser();return{height:function(){return"safari"===browser?document.documentElement.clientHeight:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight},width:function(){return console.log("watchDimensions"),"safari"===browser?document.documentElement.clientWidth:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth}}}]),angular.module("edison").directive("watchWindowResize",["$window","$timeout","windowDimensions",function($window,$timeout,windowDimensions){return{link:function($scope){$scope.getDimensions=function(){$scope.$broadcast("watchWindowResize::resize",{height:windowDimensions.height(),width:windowDimensions.width()})},angular.element($window).on("resize",function(e){$timeout.cancel($scope.resizing),$scope.resizing=$timeout(function(){$scope.getDimensions()},300)})}}}]),angular.module("edison").controller("ArtisanController",function(tabContainer,$location,$mdSidenav,$interval,ngDialog,LxNotificationService,edisonAPI,config,$routeParams,$scope,windowDimensions,artisan){$scope.config=config,$scope.tab=tabContainer.getCurrentTab();parseInt($routeParams.id);if(!$scope.tab.data){if($routeParams.id.length>12)$scope.tab.isNew=!0,$scope.tab.setTitle("@"+moment().format("HH:mm").toString());else if($scope.tab.setTitle("@"+$routeParams.id),!artisan)return alert("Impossible de trouver les informations !"),$location.url("/dashboard"),$scope.tabs.remove($scope.tab),0;$scope.tab.setData(artisan.data)}}),angular.module("edison").controller("DashboardController",function(tabContainer,$location,$scope,$rootScope,interventions,artisans){$scope.tab=tabContainer.getCurrentTab(),$scope.tab.setTitle("dashBoard")}),angular.module("edison").controller("InterventionMapController",function($scope,$q,$interval,$window,Address,dialog,mapAutocomplete,edisonAPI){$scope.autocomplete=mapAutocomplete,$scope.tab.data.client.address?($scope.tab.data.artisan&&($scope.zoom=12),$scope.tab.data.client.address&&($scope.tab.data.client.address=Address($scope.tab.data.client.address,!0),$scope.mapCenter=$scope.tab.data.client.address)):($scope.mapCenter=Address({lat:46.3333,lng:2.6}),$scope.zoom=6),$scope.showInterMarker=function(){return $scope.mapCenter&&$scope.mapCenter.latLng&&$scope.tab.data.client&&$scope.tab.data.client.address&&$scope.tab.data.client.address.latLng?$scope.tab.data.client.address.latLng==$scope.mapCenter.latLng:!1},$scope.changeAddress=function(place,searchText){mapAutocomplete.getPlaceAddress(place).then(function(addr){$scope.zoom=12,$scope.mapCenter=addr,addr.streetAddress&&($scope.tab.data.client.address=addr),$scope.searchArtisans()},function(err){console.log(err)})},$scope.$watch("tab.data.sst",function(id_sst){console.log("==>",id_sst),id_sst&&$q.all([edisonAPI.getArtisan(id_sst,{cache:!0}),edisonAPI.getArtisanStats(id_sst,{cache:!0})]).then(function(result){$scope.tab.data.artisan=result[0].data,$scope.tab.data.artisan.stats=result[1].data,result[0].data.address&&edisonAPI.getDistance({origin:result[0].data.address.lt+", "+result[0].data.address.lg,destination:$scope.tab.data.client.address.lt+", "+$scope.tab.data.client.address.lg}).then(function(result){$scope.tab.data.artisan.stats.direction=result.data})})}),$scope.dialog=dialog,$scope.sstAbsence=function(id){id&&dialog.absence.open(id,function(){$scope.searchArtisans()})},$scope.showMap=function(){$scope.loadMap=!0},$scope.loadMap=$scope.tab.isNew,$scope.getStaticMap=function(){var q="?width="+.8*$window.outerWidth;return $scope.tab.data.client&&$scope.tab.data.client.address&&$scope.tab.data.client.address.latLng&&(q+="&origin="+$scope.tab.data.client.address.latLng),$scope.tab.data.artisan&&$scope.tab.data.artisan.id&&(q+="&destination="+$scope.tab.data.artisan.address.lt+","+$scope.tab.data.artisan.address.lg),"/api/map/staticDirections"+q}}),angular.module("edison").controller("InterventionController",function($window,$scope,$location,$routeParams,ngDialog,dialog,LxNotificationService,Upload,tabContainer,edisonAPI,produits,config,intervention,artisans,user){$scope.artisans=artisans.data,$scope.config=config,$scope.tab=tabContainer.getCurrentTab();parseInt($routeParams.id);if(!$scope.tab.data)if($scope.tab.setData(intervention.data),$scope.tab.data.sst=intervention.data.artisan?intervention.data.artisan.id:0,
$routeParams.id.length>12)$scope.tab.isNew=!0,$scope.tab.data.tmpID=$routeParams.id,$scope.tab.setTitle("#"+moment(new Date(parseInt($scope.tab.data.tmpID)).toISOString()).format("HH:mm").toString());else if($scope.tab.setTitle("#"+$routeParams.id),!intervention)return alert("Impossible de trouver les informations !"),$location.url("/dashboard"),$scope.tabs.remove($scope.tab),0;$scope.showMap=!1,$scope.produits=produits.init($scope.tab.data.produits||[]),$scope.addProduct=function(prod){produits.add(prod),$scope.searchProd=""},$scope.clickUpload=function(){angular.element(".input-file__input").trigger("click")},$scope.previsualiseFacture=function(){var url="/api/intervention/facturePreview?html=true&data=";$window.open(url+JSON.stringify($scope.tab.data),"_blank")},$scope.addComment=function(){$scope.tab.data.comments.push({login:user.data.login,text:$scope.commentText,date:new Date}),$scope.commentText=""},$scope.changeCategorie=function(key){$scope.tab.data.categorie=key},$scope.onFileUpload=function(file){file&&edisonAPI.uploadFile(file,{link:$scope.tab.data.id||$scope.tab.data.tmpID,model:"intervention",type:"fiche"}).success(function(){$scope.fileUploadText="",$scope.loadFilesList()})},$scope.loadFilesList=function(){edisonAPI.getFilesList($scope.tab.data.id||$scope.tab.data.tmpID).then(function(result){$scope.files=result.data},console.log)},$scope.loadFilesList();var action={envoi:function(result){dialog.addFiles.open($scope.tab.data,$scope.files,function(text,file){edisonAPI.envoiInter(result.data.id,{sms:text,file:file}).then(function(res){console.log(res),LxNotificationService.success(res.data)})["catch"](function(error){console.log(error),LxNotificationService.error(error.data)})})},annulation:function(result){edisonAPI.annulationInter(result.data.id).then(function(res){console.log(res),LxNotificationService.success("L'intervention "+result.data.id+" à été annulé")})}};$scope.saveInter=function(options){edisonAPI.saveIntervention({data:$scope.tab.data}).then(function(result){LxNotificationService.success("Les données de l'intervention "+result.data.id+" ont à été enregistré"),options&&1==options.envoi?action.envoi(result):options&&options.annulation&&action.annulation(result),$location.url("/interventions"),$scope.tabs.remove($scope.tab)})["catch"](function(error){LxNotificationService.error(error.data)})},$scope.clickOnArtisanMarker=function(event,sst){$scope.tab.data.sst=sst.id},$scope.searchArtisans=function(){console.log("search"),edisonAPI.getNearestArtisans($scope.tab.data.client.address,$scope.tab.data.categorie).success(function(result){$scope.nearestArtisans=result})},$scope.tab.data.client.address&&$scope.searchArtisans()}),angular.module("edison").controller("statsController",function($scope){console.log("hey"),$scope.labels=["Download Sales","In-Store Sales","Mail-Order Sales"],$scope.data=[300,500,100]}),angular.module("edison").controller("InterventionsController",function(tabContainer,$window,contextMenu,edisonAPI,dataProvider,$routeParams,$location,$scope,$q,$rootScope,$filter,config,ngTableParams,interventions){$scope.tab=tabContainer.getCurrentTab(),$scope.recap=$routeParams.artisanID,$scope.tab.setTitle($scope.recap?"Recap@"+$routeParams.artisanID:$routeParams.fltr?config.filters[$routeParams.fltr]["long"]:"Interventions"),$scope.api=edisonAPI,$scope.config=config,$scope.dataProvider=dataProvider,$scope.dataProvider.getInterventionList()||$scope.dataProvider.setInterventionList(interventions.data),$scope.dataProvider.refreshInterventionListFilter($routeParams);var tableParameters={page:1,total:$scope.dataProvider.interventionListFiltered.length,filter:{},count:100},tableSettings={total:$scope.dataProvider.interventionListFiltered,getData:function($defer,params){var data=$scope.dataProvider.interventionListFiltered;data=$filter("tableFilter")(data,params.filter()),params.total(data.length),data=$filter("orderBy")(data,params.orderBy()),$defer.resolve(data.slice((params.page()-1)*params.count(),params.page()*params.count()))},filterDelay:150};$scope.tableParams=new ngTableParams(tableParameters,tableSettings),$rootScope.$on("InterventionListChange",function(){$scope.dataProvider.refreshInterventionListFilter($routeParams),$scope.tableParams.reload()}),$scope.contextMenu=contextMenu("interventionList"),$scope.getStaticMap=function(inter){return q="?width=500&height=250&precision=0&zoom=10&origin="+inter.client.address.lt+", "+inter.client.address.lg,"/api/map/staticDirections"+q},$scope.rowRightClick=function($event,inter){$scope.contextMenu.setPosition($event.pageX,$event.pageY),$scope.contextMenu.setData(inter),$scope.contextMenu.open(),edisonAPI.getIntervention(inter.id,{extend:!0}).then(function(resp){$scope.contextMenu.setData(resp.data)})},$scope.rowClick=function($event,inter,doubleClick){return $scope.contextMenu.active?$scope.contextMenu.close():void($event.metaKey||$event.ctrlKey?tabContainer.addTab("/intervention/"+inter.id,{title:"#"+inter.id,setFocus:!1,allowDuplicates:!1}):$rootScope.expendedRow===inter.id?$rootScope.expendedRow=-1:$q.all([edisonAPI.getIntervention(inter.id),edisonAPI.getArtisanStats(inter.ai)]).then(function(result){$rootScope.expendedRow=inter.id,$rootScope.expendedRowData=result[0].data,$rootScope.expendedRowData.artisanStats=result[1].data}))}});