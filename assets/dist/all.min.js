function gMap(client){var self=this;ZOOM_OVERVIEW=6,ZOOM_BASIC=10,ZOOM_MAX=17,ICON_GREY="/img/map/grey.png",ICON_RED="/img/map/red.png",ICON_BLUE="/img/map/blue.png",ICON_GREEN="/img/map/green.png",INFOWINDOW_PRELOADER='<div id="InfoWindow"><img style="margin-left:23px;width:40px" src="/img/map/preloader.gif"></div>',INPUT_CLIENT=document.getElementById("pac-input"),INPUT_FACTURATION=document.getElementById("facture_geocoder"),this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.circles=[],this.getMap=function(){return self.map},this.createMarker=function(options,visibility){options.map=self.map,options.anchorPoint=new google.maps.Point(0,-29);var marker=new google.maps.Marker(options);return marker.setVisible(visibility),options.onclick&&google.maps.event.addListener(marker,"click",options.onclick),marker},this.showArtisanRoute=function(newArtisan,client){if(client.address){var request={origin:client.serializeAddress(newArtisan.add),destination:client.serializeAddress(client.address),travelMode:google.maps.TravelMode.DRIVING};self.directionsService.route(request,function(response,status){status==google.maps.DirectionsStatus.OK&&(self.directionsDisplay.setMap(self.getMap()),self.directionsDisplay.setOptions({preserveViewport:!0,suppressMarkers:!0}),self.directionsDisplay.setDirections(response))})}},this.drawCircle=function(add,radius,id){self.circles[id]=new google.maps.Circle({center:new google.maps.LatLng(add.lt,add.lg),radius:radius,strokeColor:"#2680F3",strokeOpacity:.9,strokeWeight:3,fillColor:"#2680F3",fillOpacity:.01}),self.circles[id].setMap(self.getMap())},this.setClientPlace=function(newPlace){newPlace.geometry.viewport?self.map.fitBounds(newPlace.geometry.viewport):(self.map.setCenter(newPlace.geometry.location),self.map.setZoom(ZOOM_BASIC)),client.marker&&client.marker.setMap(null),client.marker=self.createMarker({title:"Client",animation:google.maps.Animation.DROP,position:newPlace.geometry.location,icon:ICON_GREY,onclick:function(){self.map.setCenter(client.marker.position),self.map.setZoom(self.map.getZoom()==ZOOM_MAX?ZOOM_BASIC:ZOOM_MAX)}},!1),client.infoWindow=new google.maps.InfoWindow({content:INFOWINDOW_PRELOADER,pixelOffset:new google.maps.Size(0,25)}),client.infoWindow.open(self.map,client.marker),google.maps.event.addListener(client.infoWindow,"closeclick",function(){client.marker.setVisible(!0)}),newPlace.address_components&&client.setAddress(newPlace),self.map.setZoom(ZOOM_BASIC)},self.map=new google.maps.Map(document.getElementById("map-canvas"),{center:new google.maps.LatLng(46.52863469527167,2.43896484375),zoom:ZOOM_OVERVIEW}),self.map.controls[google.maps.ControlPosition.TOP_LEFT].push(INPUT_CLIENT),self.autocomplete=new google.maps.places.Autocomplete(INPUT_CLIENT),self.autocomplete.setComponentRestrictions(),self.autocomplete.bindTo("bounds",self.map),self.placeChanged=function(){place=self.autocomplete.getPlace(),"undefined"==typeof place.address_components?(new google.maps.places.AutocompleteService).getPlacePredictions({input:place.name,offset:place.length},function(list,status){(new google.maps.Geocoder).geocode({address:list[0].description},function(results,status){status==google.maps.GeocoderStatus.OK&&self.setClientPlace(results[0])})}):(self.setClientPlace(place),client.getInfoQuartier(place))};var payeurAutocomplete=new google.maps.places.Autocomplete(INPUT_FACTURATION,{types:["geocode"]});google.maps.event.addListener(payeurAutocomplete,"place_changed",function(){console.log("payer adress have changed")})}function pad(number){return 10>number?"0"+number:number}function getValue(path,origin){(void 0===origin||null===origin)&&(origin=self?self:this),"string"!=typeof path&&(path=""+path);var pc,c="",i=0,n=path.length,name="";if(n)for(;n>=i;)"."==(c=path[i++])||"["==c||"]"==c||void 0==c?(name?(origin=origin[name],name=""):"."==pc||"["==pc||"]"==pc&&"]"==c?i=n+2:void 0,pc=c):name+=c;if(i==n+2)throw"Invalid path: "+path;return origin}function cleanString(str){return str=str.toString().toLowerCase(),str=str.replace(/[éèeê]/g,"e"),str=str.replace(/[àâ]/g,"a")}angular.module("edison",["ngMaterial","lumx","ngAnimate","ngDialog","btford.socket-io","pickadate","ngRoute","ngResource","ngTable","ngMap"]).config(function($mdThemingProvider){$mdThemingProvider.theme("default").primaryPalette("indigo").accentPalette("red")}),angular.module("edison").controller("MainController",function(tabContainer,$scope,socket,dataProvider,$rootScope,$location,edisonAPI){$rootScope.loadingData=!0,$rootScope.$on("$routeChangeSuccess",function(e,curr,prev){$rootScope.loadingData=!1}),$scope.sideBarlinks=[{url:"/interventions",title:"Liste Interventions",icon:"tasks"},{url:"/dashboard",title:"Dashboard",icon:"dashboard"},{url:"/intervention",title:"Nouvelle Intervention",icon:"plus"}],$scope.tabs=tabContainer,$scope.$watch("tabs.selectedTab",function(prev,curr){-1===prev&&-1!==curr&&($scope.tabs.selectedTab=curr)}),$rootScope.options={showMap:!0};var initTabs=function(baseUrl){return this.tabsInitialized=!0,$scope.tabs.loadSessionTabs(baseUrl).then(function(urlIsInTabs){$location.url(baseUrl)})["catch"](function(){$scope.tabs.addTab(baseUrl)}),0};$scope.$on("$locationChangeStart",function(event,next,current){return"/"===$location.path()?0:this.tabsInitialized?("/intervention"!==$location.path()&&$scope.tabs.addTab($location.path()),void edisonAPI.request({fn:"setSessionData",data:{tabContainer:$scope.tabs}})):initTabs($location.path())}),$scope.tabIconClick=function($event,tab){$event.preventDefault(),$event.stopPropagation(),$scope.tabs.remove(tab)&&$location.url($scope.tabs.getCurrentTab().url)}});var getInterList=function(edisonAPI){return edisonAPI.listInterventions({cache:!0})},getArtisanList=function(edisonAPI){return edisonAPI.listArtisans({cache:!0})},getIntervention=function($route,$q,edisonAPI){var id=$route.current.params.id;return id.length>10?$q(function(resolve,reject){resolve({data:{client:{},reglementSurPlace:!0,date:{ajout:Date.now(),intervention:Date.now()}}})}):edisonAPI.getIntervention(id,{cache:!0,extend:!0})};angular.module("edison").config(function($routeProvider,$locationProvider){$routeProvider.when("/",{redirectTo:"/dashboard"}).when("/artisan/:id",{templateUrl:"Pages/Artisan/artisan.html",controller:"ArtisanController",resolve:{interventions:getInterList,artisans:getArtisanList}}).when("/interventions",{templateUrl:"Pages/ListeInterventions/listeInterventions.html",controller:"InterventionsController",resolve:{interventions:getInterList,artisans:getArtisanList}}).when("/intervention",{redirectTo:function(){return"/intervention/"+Date.now()}}).when("/intervention/:id",{templateUrl:"Pages/Intervention/intervention.html",controller:"InterventionController",resolve:{interventions:getInterList,intervention:getIntervention,artisans:getArtisanList}}).when("/dashboard",{controller:"DashboardController",templateUrl:"Pages/Dashboard/dashboard.html",resolve:{interventions:getInterList,artisans:getArtisanList}}).otherwise({templateUrl:"templates/Error404.html"}),$locationProvider.html5Mode(!0)}),Array.prototype.findIndex||(Array.prototype.findIndex=function(predicate){if(null==this)throw new TypeError("Array.prototype.findIndex appelé sur null ou undefined");if("function"!=typeof predicate)throw new TypeError("predicate doit être une fonction");for(var value,list=Object(this),length=list.length>>>0,thisArg=arguments[1],i=0;length>i;i++)if(value=list[i],predicate.call(thisArg,value,i,list))return i;return-1}),Array.prototype.find||(Array.prototype.find=function(predicate){if(null==this)throw new TypeError("Array.prototype.find a été appelé sur null ou undefined");if("function"!=typeof predicate)throw new TypeError("predicate doit être une fonction");for(var value,list=Object(this),length=list.length>>>0,thisArg=arguments[1],i=0;length>i;i++)if(value=list[i],predicate.call(thisArg,value,i,list))return value;return void 0}),angular.module("edison").directive("capitalize",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){modelCtrl.$parsers.push(function(input){return input?input.toUpperCase():""}),element.css("text-transform","uppercase")}}}),angular.module("edison").directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("edison").directive("sglclick",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attr){var fn=$parse(attr.sglclick),delay=300,clicks=0,timer=null;element.on("click",function(event){clicks++,1===clicks?timer=setTimeout(function(){scope.$apply(function(){fn(scope,{$event:event})}),clicks=0},delay):(clearTimeout(timer),clicks=0)})}}}]),angular.module("edison").filter("addressPrettify",function(){return function(address){return address.n+" "+address.r+" "+address.cp+", "+address.v+", France"}}),angular.module("edison").filter("addressXY",function(){return function(address){return address&&address.lt&&address.lg?address.lt+", "+address.lg:"0, 0"}}),angular.module("edison").filter("placeToXY",function(){return function(place){var location=place.geometry.location;return console.log(location),location.lat()+", "+location.lng()}}),angular.module("edison").filter("placeToAddress",function(){return function(place){var address=function(place){if(place.address_components){var a=place.address_components;this.n=a[0]&&a[0].short_name,this.r=a[1]&&a[1].short_name,this.cp=a[6]&&a[6].short_name,this.v=a[2]&&a[2].short_name}this.lt=place.geometry.location.lat(),this.lg=place.geometry.location.lng()};return address.prototype.isStreetAddress=this.n&&this.r,address.prototype.latLng=this.isStreetAddress?this.lt+", "+this.lg:"0, 0",new address(place)}}),angular.module("edison").filter("artisanPractice",function(){return console.log("swag"),function(sst,categorie){return console.log("sst, categorie"),sst.categories.indexOf(categorie)>0}}),angular.module("edison").filter("categoryFilter",function(){return function(sst,categorie){return sst.categories.indexOf(categorie)>0}}),angular.module("edison").filter("pricify",function(){return function(price){return price>800?900:price-price%100+200}}),angular.module("edison").filter("relativeDate",function(){var minute=6e4,hour=60*minute,day=24*hour,week=7*day,month=4*week,year=12*month;return function(date){var now=Date.now(),date=new Date(date),today=(new Date).setHours(0,0,0,0),diff=now-date.getTime();return minute>diff?"à l'instant":hour>diff?Math.round(diff/minute)+" minutes":day>diff?date>today?"Auj. "+pad(date.getHours())+"H"+pad(date.getMinutes()):"Hier "+pad(date.getHours())+"H"+pad(date.getMinutes()):week>diff?Math.round(diff/day)+" jours":month>diff?Math.round(diff/week)+" semaines":year>diff?Math.round(diff/week)+" ans":void 0}}),angular.module("edison").filter("tableFilter",function(){return function(data,fltr,c){console.time("lol");var rtn=[];for(x in fltr)fltr[x]=cleanString(fltr[x]);for(k in data)if(data[k].id){var psh=!0;for(x in fltr){var str=data[k][x];if(!str||0===str.length||cleanString(str).indexOf(fltr[x])<0){psh=!1;break}}psh&&rtn.push(data[k])}return console.timeEnd("lol"),rtn}}),angular.module("edison").factory("Address",function(){var Address=function(place,copyContructor){place.lat&&place.lng?(this.lt=place.lat,this.lg=place.lng):copyContructor?(this.getAddressProprieties(place),this.streetAddress=!0):this.isStreetAddress(place)&&this.getPlaceProprieties(place),place.geometry&&(this.lt=place.geometry.location.lat(),this.lg=place.geometry.location.lng()),this.latLng=this.lt+", "+this.lg};return Address.prototype.getPlaceProprieties=function(place){var a=place.address_components;this.n=a[0]&&a[0].short_name,this.r=a[1]&&a[1].short_name,this.cp=a[6]&&a[6].short_name,this.v=a[2]&&a[2].short_name},Address.prototype.getAddressProprieties=function(address){this.n=address.n,this.r=address.r,this.cp=address.cp,this.v=address.v,this.lt=address.lt,this.lg=address.lg},Address.prototype.isStreetAddress=function(place){var noStreet=["locality","country","postal_code","route","sublocality"];return this.streetAddress=noStreet.indexOf(place.types[0])<0,this.streetAddress},Address.prototype.toString=function(){return this.n+" "+this.r+" "+this.cp+", "+this.v+", France"},function(place,copyContructor){return new Address(place,copyContructor)}}),angular.module("edison").factory("edisonAPI",["$http","$location","dataProvider",function($http,$location,dataProvider){return{listInterventions:function(options){return $http({method:"GET",cache:options&&options.cache,url:"/api/intervention/list"}).success(function(result){return result})},listArtisans:function(options){return $http({method:"GET",cache:options&&options.cache,url:"/api/artisan/list"}).success(function(result){return result})},getArtisans:function(cache){return $http({method:"GET",cache:cache,url:"/api/search/artisan/{}"}).success(function(result){return result})},getInterventions:function(cache){return $http({method:"GET",cache:cache,url:'/api/search/intervention/{"limit":1000, "sort":"-id"}'}).success(function(result){return dataProvider("interventions",result),result})},getArtisan:function(id,options){return $http({method:"GET",cache:options&&options.cache,url:"/api/artisan/"+id,params:options||{}}).success(function(result){return result})},getIntervention:function(id,options){return $http({method:"GET",cache:options&&options.cache,url:"/api/intervention/"+id,params:options||{}}).success(function(result){return result})},getDistance:function(options){return $http({method:"GET",cache:!0,url:"/api/map/direction",params:options}).success(function(result){return result})},request:function(options){return $http({method:options.method||"GET",url:"/api/"+options.fn,params:options.data})},saveIntervention:function(data){return $http({method:"GET",url:"/api/intervention/save",params:data})},getNearestArtisans:function(address,categorie){return $http({method:"GET",url:"/api/artisan/rank",cache:!0,params:{categorie:categorie,lat:address.lt,lng:address.lg,limit:50,maxDistance:50}})},getArtisanStats:function(id_sst){return $http({method:"GET",url:"/api/artisan/"+id_sst+"/stats"})},absenceArtisan:function(id,options){return $http({method:"GET",url:"/api/artisan/"+id+"/absence",params:options})}}}]),angular.module("edison").factory("config",[function(){var config={};return config.civilites=[{short_name:"M.",long_name:"Monsieur"},{short_name:"Mme.",long_name:"Madame"},{short_name:"Soc.",long_name:"Société"}],config.civilitesTab=["M.","Mme.","Soc."],config.categoriesKV={EL:{n:"Electricité",c:"yellow  darken-2 black-text"},PL:{n:"Plomberie",c:"blue"},CH:{n:"Chauffage",c:"red"},CL:{n:"Climatisation",c:" teal darken-3"},SR:{n:"Serrurerie",c:"brown"},VT:{n:"Vitrerie",c:" green darken-3"},CR:{n:"Carrelage",c:""},MN:{n:"Menuiserie",c:""},MC:{n:"Maconnerie",c:""},PT:{n:"Peinture",c:""}},config.categories=[{short_name:"EL",long_name:"Electricité"},{short_name:"PL",long_name:"Plomberie"},{short_name:"CH",long_name:"Chauffage"},{short_name:"CL",long_name:"Climatisation"},{short_name:"SR",long_name:"Serrurerie"},{short_name:"VT",long_name:"Vitrerie"},{short_name:"CR",long_name:"Carrelage"},{short_name:"MN",long_name:"Menuiserie"},{short_name:"MC",long_name:"Maconnerie"},{short_name:"PT",long_name:"Peinture"}],config.modeDeReglements=[{short_name:"CB",long_name:"Carte Bancaire"},{short_name:"CH",long_name:"Chèque"},{short_name:"CA",long_name:"Espèces"}],config.etatsKV={ENC:{n:"En Cours",c:"orange"},INT:{n:"Confirmé",c:"green accent-4"},APR:{n:"A Progr.",c:"blue"},ANN:{n:"Annuler",c:"red"},DEV:{n:"Devis",c:"light-blue"}},config.typePayeur=[{short_name:"SOC",long_name:"Société"},{short_name:"PRO",long_name:"Propriétaire"},{short_name:"LOC",long_name:"Locataire"},{short_name:"IMO",long_name:"Agence Immobilière"},{short_name:"CUR",long_name:"Curatelle"},{short_name:"AUT",long_name:"Autre"}],config.status=function(inter){return{intervention:config.etatsKV[inter.status]}},config}]),angular.module("edison").factory("dataProvider",["$timeout","socket","$rootScope",function($timeout,socket,$rootScope){var dataProvider=function(){var _this=this;socket.on("interventionListChange",function(data){_this.updateInterventionList(data)})};return dataProvider.prototype.setInterventionList=function(data){this.interventionList=data},dataProvider.prototype.updateInterventionList=function(data){var _this=this;if(this.interventionList){var index=this.interventionList.findIndex(function(e){return e.id===data.id});_this.interventionList[index]=data,console.log("interchange"),$rootScope.$broadcast("InterventionListChange")}},dataProvider.prototype.getInterventionList=function(){return this.interventionList},new dataProvider}]),angular.module("edison").factory("mapAutocomplete",["$q","Address",function($q,Address){var autocomplete=function(){this.service=new google.maps.places.AutocompleteService,this.geocoder=new google.maps.Geocoder};return autocomplete.prototype.search=function(input){var deferred=$q.defer();return this.service.getPlacePredictions({input:input,componentRestrictions:{country:"fr"}},function(predictions,status){deferred.resolve(predictions||[])}),deferred.promise},autocomplete.prototype.getPlaceAddress=function(place){var self=this;return $q(function(resolve,reject){self.geocoder.geocode({address:place.description},function(result,status){return status!==google.maps.places.PlacesServiceStatus.OK?reject(status):resolve(Address(result[0]))})})},new autocomplete}]),angular.module("edison").factory("socket",function(socketFactory){return socketFactory()}),angular.module("edison").factory("tabContainer",["$location","$window","$q","edisonAPI",function($location,$window,$q,edisonAPI){var Tab=function(args){if("object"==typeof args)for(var k in args)this[k]=args[k];else this.url=args,this.title="",this.position=null,this.deleted=!1,this._timestamp=Date.now()};Tab.prototype.setData=function(data){this._data=JSON.parse(JSON.stringify(data)),this.data=JSON.parse(JSON.stringify(data))},Tab.prototype.setTitle=function(title){this.title=title};var TabContainer=function(){this._tabs=[],this.selectedTab=0};return TabContainer.prototype.loadSessionTabs=function(currentUrl){var self=this;return $q(function(resolve,reject){var currentUrlInSessionTabs=!1;edisonAPI.request({fn:"getSessionData"}).then(function(result){self.selectedTab=result.data.selectedTab;for(var i=0;i<result.data._tabs.length;i++)self._tabs.push(new Tab(result.data._tabs[i])),result.data._tabs[i].url===currentUrl&&(self.selectedTab=i,currentUrlInSessionTabs=!0);return currentUrlInSessionTabs?resolve():reject()})["catch"](reject)})},TabContainer.prototype.setFocus=function(tab){this.selectedTab="number"==typeof tab?tab:tab.position},TabContainer.prototype.createTab=function(url,title){var tab=new Tab(url);return tab.position=this._tabs.length,this._tabs.push(tab),tab},TabContainer.prototype.isOpen=function(url){var index=this._tabs.findIndex(function(e){return!e.deleted&&e.url===url});return index>=0},TabContainer.prototype.getTab=function(url){return this._tabs.find(function(e){return!e.deleted&&e.url===url})},TabContainer.prototype.len=function(){var size=0;return this._tabs.forEach(function(e,i){size+=!e.deleted}),size},TabContainer.prototype.getPrevTab=function(tab){for(var i=tab.position-1;i>=0;i--)if(0==this._tabs[i].deleted)return this._tabs[i]},TabContainer.prototype.remove=function(tab){var newTabs=[],j=0;if(this._tabs.length<=1)return!1;for(var reload=this.selectedTab==tab.position,i=0;i<this._tabs.length;i++)i!=tab.position&&(newTabs.push(this._tabs[i]),newTabs[j].position=j,++j);return this._tabs=newTabs,this.selectedTab==tab.position&&0!=this.selectedTab&&this.selectedTab--,this.selectedTab>tab.position&&this.selectedTab--,reload},TabContainer.prototype.getCurrentTab=function(){return this._tabs[this.selectedTab]},TabContainer.prototype.addTab=function(url,options){var tab;tab=this.isOpen(url)?this.getTab(url):this.createTab(url),options&&options.setFocus===!1||this.setFocus(tab),options&&options.title&&tab.setTitle(options.title)},new TabContainer}]),angular.module("edison").service("detectBrowser",["$window",function($window){return function(){var userAgent=$window.navigator.userAgent,browsers={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer/i};for(var key in browsers)if(browsers[key].test(userAgent))return key;return"unknown"}}]),angular.module("edison").factory("windowDimensions",["$window","detectBrowser",function($window,detectBrowser){var browser=detectBrowser();return{height:function(){return"safari"===browser?document.documentElement.clientHeight:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight},width:function(){return console.log("watchDimensions"),"safari"===browser?document.documentElement.clientWidth:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth}}}]),angular.module("edison").directive("watchWindowResize",["$window","$timeout","windowDimensions",function($window,$timeout,windowDimensions){return{link:function($scope){$scope.getDimensions=function(){$scope.$broadcast("watchWindowResize::resize",{height:windowDimensions.height(),width:windowDimensions.width()})},angular.element($window).on("resize",function(e){$timeout.cancel($scope.resizing),$scope.resizing=$timeout(function(){$scope.getDimensions()},300)})}}}]),angular.module("edison").controller("ArtisanController",function(tabContainer,$location,$mdSidenav,$interval,ngDialog,LxNotificationService,edisonAPI,config,$routeParams,$scope,windowDimensions,interventions,artisans){$scope.tab=tabContainer.getCurrentTab();var id=parseInt($routeParams.id);if(!$scope.tab.data)if($routeParams.id.length>12)$scope.tab.isNew=!0,$scope.tab.setTitle("@"+moment().format("HH:mm").toString()),$scope.tab.setData({telephone:{},pourcentage:{},add:{},representant:{}});else{var sst=artisans.data.find(function(e){return e.id===id});if($scope.tab.setTitle("@"+sst.nomSociete.substr(0,10)),!sst)return alert("Impossible de trouver les informations !"),$location.url("/dashboard"),$scope.tabs.remove($scope.tab),0;$scope.tab.setData(sst)}}),angular.module("edison").controller("DashboardController",function(tabContainer,$location,$scope,$rootScope,interventions,artisans){$scope.tab=tabContainer.getCurrentTab(),$scope.tab.setTitle("dashBoard")}),angular.module("edison").controller("InterventionMapController",function($scope,$q,$interval,$window,$mdDialog,Address,mapAutocomplete,edisonAPI){function DialogController($scope,$mdDialog){$scope.absenceTime="TODAY",$scope.absence=[{title:"Toute la journée",value:"TODAY"},{title:"1 Heure",value:"1"},{title:"2 Heure",value:"2"},{title:"3 Heure",value:"3"},{title:"4 Heure",value:"4"}],$scope.hide=function(){$mdDialog.hide()},$scope.cancel=function(){$mdDialog.cancel()},$scope.answer=function(answer){$mdDialog.hide(answer)}}$scope.autocomplete=mapAutocomplete,$scope.tab.data.client.address?($scope.tab.data.artisan&&($scope.zoom=12,$scope.tab.data.artisan.address=Address($scope.tab.data.artisan.address,!0)),$scope.tab.data.client.address&&($scope.tab.data.client.address=Address($scope.tab.data.client.address,!0),$scope.mapCenter=$scope.tab.data.client.address)):($scope.mapCenter=Address({lat:46.3333,lng:2.6}),$scope.zoom=6),$scope.showInterMarker=function(){return $scope.mapCenter&&$scope.mapCenter.latLng&&$scope.tab.data.client&&$scope.tab.data.client.address&&$scope.tab.data.client.address.latLng?$scope.tab.data.client.address.latLng==$scope.mapCenter.latLng:!1},$scope.changeAddress=function(place){mapAutocomplete.getPlaceAddress(place).then(function(addr){$scope.zoom=12,$scope.mapCenter=addr,addr.streetAddress&&($scope.tab.data.client.address=addr,$scope.searchText="lol"),$scope.searchArtisans()},function(err){console.log(err)})},$scope.$watch("tab.data.sst",function(id_sst){$q.all([edisonAPI.getArtisan(id_sst,{cache:!0}),edisonAPI.getArtisanStats(id_sst,{cache:!0})]).then(function(result){$scope.tab.data.artisan=result[0].data,$scope.tab.data.artisan.stats=result[1].data,result[0].data.address&&edisonAPI.getDistance({origin:result[0].data.address.lt+", "+result[0].data.address.lg,destination:$scope.tab.data.client.address.lt+", "+$scope.tab.data.client.address.lg}).then(function(result){$scope.tab.data.artisan.stats.direction=result.data})})}),$scope.openDialog=function(ev){$mdDialog.show({controller:DialogController,templateUrl:"/Pages/Intervention/dialog-box.html",targetEvent:ev}).then(function(time){var hours=0;hours="TODAY"===time?23-(new Date).getHours()+1:parseInt(time),start=new Date,end=new Date,end.setHours(end.getHours()+hours),edisonAPI.absenceArtisan($scope.tab.data.artisan.id,{start:start,end:end})})},$scope.showMap=function(){$scope.loadMap=!0},$scope.loadMap=$scope.tab.isNew,$scope.getStaticMap=function(){var q="?width="+.8*$window.outerWidth;return $scope.tab.data.client&&$scope.tab.data.client.address&&$scope.tab.data.client.address.latLng&&(q+="&origin="+$scope.tab.data.client.address.latLng),$scope.tab.data.artisan&&$scope.tab.data.artisan.id&&(q+="&destination="+$scope.tab.data.artisan.address.lt+","+$scope.tab.data.artisan.address.lg),"/api/map/staticDirections"+q}}),angular.module("edison").controller("InterventionController",function($scope,$location,$routeParams,ngDialog,LxNotificationService,tabContainer,edisonAPI,config,intervention,artisans){$scope.artisans=artisans.data,$scope.config=config,$scope.tab=tabContainer.getCurrentTab();parseInt($routeParams.id);if(!$scope.tab.data){if($routeParams.id.length>12)$scope.tab.isNew=!0,$scope.tab.setTitle("#"+moment().format("HH:mm").toString());else if($scope.tab.setTitle("#"+$routeParams.id),!intervention)return alert("Impossible de trouver les informations !"),$location.url("/dashboard"),$scope.tabs.remove($scope.tab),0;$scope.tab.setData(intervention.data),$scope.tab.data.sst=intervention.data.artisan?intervention.data.artisan.id:0}$scope.showMap=!1,$scope.saveInter=function(send,cancel){edisonAPI.saveIntervention({send:send,cancel:cancel,data:$scope.tab.data}).then(function(data){LxNotificationService.success("L'intervention "+data.data+" à été enregistré"),$location.url("/interventions"),$scope.tabs.remove($scope.tab)})["catch"](function(response){LxNotificationService.error(response.data)})},$scope.clickOnArtisanMarker=function(event,sst){$scope.tab.data.sst=sst.id},$scope.searchArtisans=function(){edisonAPI.getNearestArtisans($scope.tab.data.client.address,$scope.tab.data.categorie).success(function(result){$scope.nearestArtisans=result})},$scope.tab.data.client.address&&$scope.searchArtisans()}),angular.module("edison").controller("InterventionsController",function(tabContainer,$window,edisonAPI,dataProvider,$location,$scope,$q,$rootScope,$filter,config,ngTableParams,interventions){$scope.api=edisonAPI,$scope.config=config,$scope.dataProvider=dataProvider,$scope.dataProvider.getInterventionList()||$scope.dataProvider.setInterventionList(interventions.data);var tableParameters={page:1,total:$scope.dataProvider.interventionList.length,filter:{},count:100},tableSettings={total:$scope.dataProvider.interventionList,getData:function($defer,params){console.log("getdata");var data=$scope.dataProvider.interventionList;data=$filter("tableFilter")(data,params.filter()),params.total(data.length),data=$filter("orderBy")(data,params.orderBy()),$defer.resolve(data.slice((params.page()-1)*params.count(),params.page()*params.count()))},filterDelay:150};$scope.tableParams=new ngTableParams(tableParameters,tableSettings),$scope.tab=tabContainer.getCurrentTab(),$scope.tab.setTitle("Interventions"),$rootScope.$on("InterventionListChange",function(){$scope.tableParams.reload()}),$scope.getStaticMap=function(inter){return q="?width=500&height=250&precision=0&zoom=10&origin="+inter.client.address.lt+", "+inter.client.address.lg,"/api/map/staticDirections"+q},$scope.expendedRow=-1,$scope.rowClick=function($event,inter,doubleClick){doubleClick?$location.url("/intervention/"+inter.id):$event.metaKey||$event.ctrlKey?tabContainer.addTab("/intervention/"+inter.id,{title:"#"+inter.id,setFocus:!1,allowDuplicates:!1}):$scope.expendedRow===inter.id?$scope.expendedRow=-1:$q.all([edisonAPI.getIntervention(inter.id),edisonAPI.getArtisanStats(inter.ai)]).then(function(result){$scope.expendedRow=inter.id,$scope.expendedRowData=result[0].data,$scope.expendedRowData.artisanStats=result[1].data})}});